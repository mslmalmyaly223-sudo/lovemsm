<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø²Ø§ÙŠÙ„Ùˆ - Zailo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@900&display=swap" rel="stylesheet">
    
    <style>
        html, body {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: none;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color, #f3f4f6);
            color: var(--text-color, #1f2937);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; 
            touch-action: pan-y;
            transition: background-color 0.3s, color 0.3s;
        }

        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --nav-bg: #ffffff;
            --card-bg: #ffffff;
            --chat-bg: #e0f2fe;
            --bubble-me-bg: #22c55e;
            --bubble-me-text: #ffffff;
            --bubble-other-bg: #ffffff;
            --bubble-other-text: #1f2937;
            --border-color: #f3f4f6;
            --vh: 1vh;
        }
        
        body.dark-theme {
            --bg-color: #111827;
            --text-color: #f9fafb;
            --nav-bg: #1f2937;
            --card-bg: #1f2937;
            --chat-bg: #030712;
            --bubble-me-bg: #2563eb;
            --bubble-me-text: #ffffff;
            --bubble-other-bg: #374151;
            --bubble-other-text: #f9fafb;
            --border-color: #374151;
        }

        .theme-bg { background-color: var(--bg-color); }
        .theme-card { background-color: var(--card-bg); color: var(--text-color); border-color: var(--border-color); }
        .theme-nav { background-color: var(--nav-bg); border-color: var(--border-color); }
        .theme-text { color: var(--text-color); }
        
        .chat-container-bg { background-color: var(--chat-bg); transition: background-color 0.3s; }
        .bubble-me { background-color: var(--bubble-me-bg); color: var(--bubble-me-text); }
        .bubble-other { background-color: var(--bubble-other-bg); color: var(--bubble-other-text); border: 1px solid var(--border-color); }

        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            will-change: scroll-position;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #splash-screen { background-color: #0a192f; }

        @keyframes wormSlide {
            0% { transform: translateX(100vw) scaleX(2.5) scaleY(0.4); opacity: 0; }
            40% { transform: translateX(20vw) scaleX(0.6) scaleY(1.4); opacity: 1; }
            70% { transform: translateX(-5vw) scaleX(1.2) scaleY(0.8); }
            100% { transform: translateX(0) scaleX(1) scaleY(1); opacity: 1; }
        }

        @keyframes glow-sync {
            0% { text-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4); transform: scale(1); }
            100% { text-shadow: 0 0 25px rgba(255, 215, 0, 1), 0 0 50px rgba(255, 215, 0, 0.8), 0 0 75px rgba(255, 215, 0, 0.6); transform: scale(1.05); }
        }

        @keyframes fadeUpText {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .elegant-z {
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-weight: 900;
            color: #ffd700; 
            font-size: 8rem;
            line-height: 1;
            margin-bottom: 5px;
            display: inline-block;
            animation: wormSlide 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards,
                       glow-sync 2s 1.2s cubic-bezier(0.25, 1, 0.5, 1) infinite alternate;
        }

        .elegant-text {
            font-family: 'Cairo', sans-serif;
            color: #ffd700;
            letter-spacing: 1px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            opacity: 0;
            animation: fadeUpText 0.8s 1s forwards;
        }

        .modal-slide-in { animation: slideIn 0.35s forwards cubic-bezier(0.175, 0.885, 0.32, 1.1); }
        .modal-slide-out { animation: slideOut 0.3s forwards cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0.8; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        .btn-tap {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
            position: relative;
            overflow: hidden;
        }
        .btn-tap:active { transform: scale(0.95); opacity: 0.8; }

        .bg-xylo { background: linear-gradient(135deg, #1d4ed8, #6d28d9); }
        .text-xylo { color: #4f46e5; }
        
        .ptr-container { transition: transform 0.3s ease; position: relative; }
        #ptr-spinner { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .text-unread { font-weight: 900 !important; color: #000 !important; }
        body.dark-theme .text-unread { color: #fff !important; }
        
        #mentions-dropdown {
            position: absolute; bottom: 100%; left: 0; right: 0; background: var(--card-bg); border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 200; display: none;
        }

        .msg-row { transition: transform 0.2s ease-out; touch-action: pan-y; width: 100%; position: relative; }
        .reply-icon-indicator {
            position: absolute; top: 50%; transform: translateY(-50%);
            opacity: 0; transition: opacity 0.2s; color: var(--text-color); font-size: 20px;
        }

        .sub-tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .sub-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; font-weight: normal; }

        .reaction-badge {
            position: absolute; bottom: -8px; 
            background: rgba(255,255,255,0.9); border-radius: 50%; padding: 2px; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .story-ring {
            padding: 2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .story-ring.viewed {
            background: #9ca3af;
        }

        #chat-modal {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        .telegram-menu {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            width: 240px;
            transform-origin: center bottom;
            animation: popTelegram 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards;
        }
        body.dark-theme .telegram-menu {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(255,255,255,0.05);
        }
        @keyframes popTelegram { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        @keyframes floatPet {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-4px) rotate(2deg); }
        }
        @keyframes breathePet {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .pet-animate { 
            animation: floatPet 3s ease-in-out infinite, breathePet 4s ease-in-out infinite; 
            transform-origin: center bottom;
        }
        .pet-glow-gold { filter: drop-shadow(0 0 12px rgba(255,215,0,0.8)); }
        
        .pet-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .pet-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .pet-popup-content {
            background: linear-gradient(135deg, #fff8e7, #ffecd6);
            color: #1f2937;
            padding: 30px 25px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 600;
            line-height: 1.6;
            max-width: 85%;
            width: 350px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3), 0 0 0 3px rgba(255,215,0,0.4);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,215,0,0.5);
            word-break: break-word;
            white-space: pre-wrap;
            position: relative;
            animation: floatPopup 3s ease-in-out infinite;
        }

        .pet-popup-content.show {
            transform: scale(1);
        }

        @keyframes floatPopup {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.02); }
        }

        .pet-popup-content::before {
            content: 'âœ¨';
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 30px;
            filter: drop-shadow(0 5px 5px rgba(255,215,0,0.5));
        }

        .pet-popup-content::after {
            content: 'ğŸ’¬';
            position: absolute;
            bottom: -15px;
            right: 20px;
            font-size: 30px;
            filter: drop-shadow(0 5px 5px rgba(255,215,0,0.5));
        }

        body.dark-theme .pet-popup-content {
            background: linear-gradient(135deg, #2d3748, #1a2634);
            color: #f9fafb;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5), 0 0 0 3px rgba(255,215,0,0.3);
        }

        @keyframes blinkCursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .typing-cursor::after {
            content: '|';
            animation: blinkCursor 1s infinite;
            margin-right: 2px;
        }
        
        .link-internal {
            color: #2563eb;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        body.dark-theme .link-internal {
            color: #4ade80;
        }
        
        .link-external {
            color: #2563eb;
            font-weight: 600;
            cursor: default;
        }
        body.dark-theme .link-external {
            color: #4ade80;
        }
        
        .selectable-text {
            -webkit-user-select: all;
            user-select: all;
        }
        
        .pin-popup {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 300px;
            animation: pinPopup 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        body.dark-theme .pin-popup {
            background: rgba(30, 41, 59, 0.95);
        }
        @keyframes pinPopup {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pin-option {
            transition: all 0.2s;
        }
        .pin-option:active {
            transform: scale(0.95);
        }
        
        .pin-love {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 20px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 8px;
        }
        
        .pin-normal {
            background: #9ca3af;
            color: white;
            border-radius: 20px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 8px;
        }
        
        .highlight-message {
            animation: highlight 2s ease-in-out;
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            border-radius: 12px;
            transition: all 0.3s;
        }
        body.dark-theme .highlight-message {
            border: 2px solid #4ade80 !important;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
        }
        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); background-color: rgba(59, 130, 246, 0.1); }
            100% { transform: scale(1); }
        }
        
        .profile-link-btn {
            background: #f3f4f6;
            color: #1f2937;
            border-radius: 9999px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        body.dark-theme .profile-link-btn {
            background: #374151;
            color: #f9fafb;
        }
        .profile-link-btn:active {
            transform: scale(0.95);
        }
        
        .delete-popup {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 320px;
            animation: pinPopup 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        body.dark-theme .delete-popup {
            background: rgba(30, 41, 59, 0.95);
        }
        
        #badge-requests {
            display: none;
            position: absolute;
            top: 2px;
            right: 20px;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .gender-option {
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .gender-option.selected {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.05);
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            padding-top: 60px;
            color: white;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            margin-bottom: 10px;
        }

        .action-button {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            padding: 12px 24px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .action-button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        .mute-badge {
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 11px;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .create-post-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin: 10px;
        }

        .create-post-textarea {
            width: 100%;
            min-height: 150px;
            background: var(--bg-color);
            border: none;
            border-radius: 15px;
            padding: 15px;
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            outline: none;
        }

        .create-note-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .create-note-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            margin: 20px auto;
        }

        .create-note-textarea {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            min-height: 120px;
            resize: none;
            outline: none;
            width: 100%;
        }
        .create-note-textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .load-more-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            padding: 10px 20px;
            margin: 10px auto;
            display: block;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more-btn:active {
            transform: scale(0.95);
        }

        /* Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø§Ù„Ùƒ */
        .admin-panel-btn {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            margin-top: 16px;
        }

        /* Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº */
        .report-reason {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 16px;
            margin: 4px 0;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }
        .report-reason:active {
            transform: scale(0.98);
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        /* Ø²Ø± Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #admin-reports-badge {
            position: absolute;
            top: -2px;
            right: 30px;
            background-color: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: bold;
            border: 2px solid var(--card-bg);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col antialiased pb-safe theme-bg">

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div id="splash-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="splash-content flex flex-col items-center justify-center">
            <div class="elegant-z">Z</div>
            <h1 class="text-6xl font-black elegant-text mt-2">Ø²Ø§ÙŠÙ„Ùˆ</h1>
        </div>
    </div>

    <!-- 2. Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-white overflow-y-auto hide-scrollbar smooth-scroll">
        <div class="min-h-screen flex flex-col items-center justify-center p-6">
            <h1 class="text-6xl font-black xylo-brand mb-10 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600" style="font-family: 'Cairo', sans-serif;">Ø²Ø§ÙŠÙ„Ùˆ</h1>
            
            <div id="login-form" class="w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.login()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <div class="flex justify-between text-sm text-blue-600 font-semibold mt-4">
                    <button onclick="UI.switchAuth('register')" class="p-2 btn-tap">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                    <button onclick="UI.switchAuth('forgot')" class="p-2 btn-tap">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
                </div>
            </div>

            <div id="register-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <input type="text" id="reg-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="email" id="reg-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="reg-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.register()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©</button>
                
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„</button>
            </div>

            <div id="forgot-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h2>
                <p class="text-sm text-gray-500 text-center mb-4">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</p>
                <input type="email" id="forgot-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.resetPassword()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <!-- 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ -->
    <div id="setup-profile-screen" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 smooth-scroll">
        <h2 class="text-3xl font-bold mb-2 text-center text-gray-800">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„Ø­Ø³Ø§Ø¨</h2>
        <p class="text-gray-500 mb-4 text-center">Ø§Ø¬Ø¹Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù…ÙŠØ²Ø§Ù‹ Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©</p>
        
        <label for="profile-upload" class="relative cursor-pointer mb-4 btn-tap inline-block">
            <div id="profile-preview-container" class="w-40 h-40 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-4 border-dashed border-blue-400 shadow-inner">
                <i class="ph ph-camera text-5xl text-gray-400"></i>
                <img id="profile-preview-img" class="hidden w-full h-full object-cover">
            </div>
            <div class="absolute bottom-1 right-1 bg-blue-600 p-3 rounded-full text-white border-4 border-white shadow-md">
                <i class="ph ph-plus font-bold text-lg"></i>
            </div>
            <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="Auth.handleImageUpload(event)">
        </label>

        <div class="w-full max-w-xs mb-6">
            <p class="text-center text-gray-700 font-bold mb-3">Ø§Ø®ØªØ± Ø¬Ù†Ø³Ùƒ</p>
            <div class="flex gap-4 justify-center">
                <div id="gender-male" class="gender-option flex flex-col items-center p-4 rounded-2xl bg-gray-100 cursor-pointer btn-tap" onclick="App.selectGender('male')">
                    <i class="ph-fill ph-gender-male text-4xl text-blue-600"></i>
                    <span class="font-bold mt-1">ÙˆÙ„Ø¯</span>
                </div>
                <div id="gender-female" class="gender-option flex flex-col items-center p-4 rounded-2xl bg-gray-100 cursor-pointer btn-tap" onclick="App.selectGender('female')">
                    <i class="ph-fill ph-gender-female text-4xl text-pink-600"></i>
                    <span class="font-bold mt-1">Ø¨Ù†Øª</span>
                </div>
            </div>
            <p id="gender-error" class="text-red-500 text-xs text-center mt-2 hidden">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³</p>
        </div>

        <button onclick="Auth.completeProfileSetup()" class="btn-tap w-full max-w-xs bg-xylo text-white font-bold py-4 rounded-xl shadow-lg">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>

    <!-- 4. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app" class="hidden flex-1 flex flex-col h-screen w-full relative">
        
        <header class="theme-nav px-4 py-3 flex justify-between items-center z-20 relative shadow-sm border-b">
            <h1 class="text-3xl font-black text-blue-600" style="font-family: 'Cairo', sans-serif;">Ø²Ø§ÙŠÙ„Ùˆ</h1>
            <div class="flex gap-3">
                <button onclick="UI.openModal('search-modal')" class="w-10 h-10 rounded-full theme-card flex items-center justify-center btn-tap border">
                    <i class="ph ph-magnifying-glass text-xl"></i>
                </button>
            </div>
        </header>

        <nav class="theme-nav w-full z-10 shadow-sm sticky top-0 border-b">
            <div class="flex justify-between items-center px-2">
                <button onclick="UI.switchTab('home')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-blue-600 border-b-2 border-blue-600 transition-colors btn-tap">
                    <i class="ph-fill ph-house text-2xl"></i>
                </button>
                <button onclick="UI.switchTab('notes')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors btn-tap">
                    <div class="relative">
                        <i class="ph ph-users text-2xl"></i>
                        <span id="badge-requests" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow-sm"></span>
                    </div>
                </button>
                <button onclick="UI.switchTab('messages')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-chat-circle-text text-2xl"></i>
                    <span id="badge-messages" class="hidden absolute top-1 right-1/4 bg-blue-600 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('notifications')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-bell text-2xl"></i>
                    <span id="badge-notifications" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('settings')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors btn-tap">
                    <i class="ph ph-list text-2xl"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto hide-scrollbar smooth-scroll relative ptr-container" id="main-content-area">
            <div id="ptr-spinner" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center">
                <i class="ph ph-arrow-circle-down animate-spin text-blue-600 text-2xl"></i>
            </div>
            
            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <div id="tab-home" class="p-2 space-y-3 pb-6">
                <div class="theme-card p-3 rounded-xl shadow-sm flex gap-3 items-center border">
                    <img id="current-user-avatar-home" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <div class="flex-1 theme-bg hover:opacity-80 transition-colors rounded-full px-4 py-2.5 flex items-center cursor-pointer btn-tap" onclick="UI.openModal('create-post-modal')">
                        <span class="text-sm opacity-60">Ø¨Ù… ØªÙÙƒØ±ØŸ</span>
                    </div>
                </div>
                <div id="feed-container" class="space-y-3">
                    <div class="text-center text-gray-400 py-10"><i class="ph ph-spinner-gap animate-spin text-3xl mx-auto mb-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
            <div id="tab-messages" class="hidden p-2">
                <div class="flex justify-between items-center p-2 mb-2">
                    <h2 class="text-xl font-bold theme-text">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
                </div>
                <div id="chats-container" class="theme-card rounded-xl shadow-sm overflow-hidden min-h-[400px] border">
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
            <div id="tab-notes" class="hidden p-2 space-y-3 flex flex-col h-full">
                <div class="theme-card rounded-xl shadow-sm p-4 shrink-0 border">
                    <div class="flex overflow-x-auto smooth-scroll hide-scrollbar gap-4 pb-2 pt-2 items-start" id="notes-container" style="scroll-snap-type: x mandatory;">
                        <div class="inline-flex flex-col items-center relative cursor-pointer shrink-0 btn-tap w-16" onclick="App.checkAndCreateNote()" style="scroll-snap-align: start;">
                            <div class="relative">
                                <img id="current-user-avatar-note" class="w-16 h-16 rounded-full object-cover border-2 border-transparent p-0.5" style="border-color: var(--bg-color);">
                                <div class="absolute bottom-0 right-0 bg-blue-600 rounded-full p-1 border-2" style="border-color: var(--card-bg);" id="my-note-plus-icon">
                                    <i class="ph ph-plus text-white text-xs font-bold"></i>
                                </div>
                            </div>
                            <span class="text-[11px] font-bold mt-1 w-full text-center truncate theme-text">Ø£Ù†Øª</span>
                        </div>
                    </div>
                </div>

                <div class="theme-card rounded-xl shadow-sm flex-1 flex flex-col overflow-hidden border">
                    <div class="flex border-b" style="border-color: var(--border-color);">
                        <button onclick="App.switchFriendsSubTab('requests')" id="subtab-requests" class="flex-1 py-3 text-center text-sm font-bold sub-tab-active btn-tap transition-colors">
                            <span class="relative inline-block">
                                Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                                <span id="badge-requests-subtab" class="hidden absolute -top-1 -left-2 w-2 h-2 bg-red-500 rounded-full"></span>
                            </span>
                        </button>
                        <button onclick="App.switchFriendsSubTab('friends')" id="subtab-friends" class="flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
                        <button onclick="App.switchFriendsSubTab('suggestions')" id="subtab-suggestions" class="flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto smooth-scroll p-3 relative">
                        <div id="subtab-content-requests" class="space-y-3"></div>
                        <div id="subtab-content-friends" class="hidden space-y-3"></div>
                        <div id="subtab-content-suggestions" class="hidden space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
            <div id="tab-notifications" class="hidden p-2">
                <h2 class="text-xl font-bold p-2 mb-2 theme-text">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
                <div id="notifications-container" class="theme-card rounded-xl shadow-sm overflow-hidden min-h-[400px] border">
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div id="tab-settings" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-6 theme-text">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
                
                <div class="theme-card rounded-xl p-4 shadow-sm flex items-center gap-4 mb-6 cursor-pointer btn-tap border" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <img id="settings-avatar" src="" class="w-14 h-14 rounded-full object-cover bg-gray-200 border border-gray-100">
                    <div class="flex-1 flex items-center gap-1">
                        <h3 id="settings-name" class="font-bold text-lg leading-tight theme-text">...</h3>
                    </div>
                    <i class="ph ph-caret-left text-gray-400 text-xl"></i>
                </div>

                <div class="space-y-3">
                    <div class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ph-fill ph-moon text-xl"></i></div>
                            <span id="theme-text-label" class="font-semibold text-right theme-text">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="theme-toggle" class="sr-only peer" onchange="App.toggleTheme(this.checked)">
                            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <button onclick="UI.openModal('edit-profile-modal')" class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-user-pen text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right theme-text">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('privacy-modal')" class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="ph-fill ph-lock-key text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right theme-text">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('account-settings-modal')" class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ph-fill ph-gear text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right theme-text">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø£Ù…Ø§Ù†</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <!-- Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ -->
                    <button id="admin-panel-btn" onclick="UI.openModal('admin-panel-modal')" class="hidden admin-panel-btn w-full p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap border border-red-200">
                        <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="ph-fill ph-shield text-xl"></i></div>
                        <span class="font-bold flex-1 text-right text-white">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                        <span id="admin-reports-badge" class="hidden">0</span>
                        <i class="ph ph-caret-left text-white"></i>
                    </button>

                    <button onclick="Auth.logout()" class="w-full bg-red-50 p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap mt-8 border border-red-100">
                        <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="ph-fill ph-sign-out text-xl"></i></div>
                        <span class="font-bold flex-1 text-right text-red-600">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… -->
    <div id="msg-box" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-[200] opacity-0 pointer-events-none transition-opacity duration-300 flex items-center gap-2 text-sm font-semibold">
        <span id="msg-box-text">Ø±Ø³Ø§Ù„Ø©</span>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« -->
    <div id="search-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="p-4 theme-card border-b flex items-center gap-3">
            <button onclick="UI.closeModal('search-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <div class="flex-1 relative">
                <input type="text" id="search-input" oninput="App.searchUsers()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡..." class="w-full theme-bg border rounded-full py-2.5 px-4 pr-10 outline-none focus:ring-2 focus:ring-blue-100 theme-text">
                <i class="ph ph-magnifying-glass absolute right-3 top-3 opacity-50 text-lg"></i>
            </div>
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto smooth-scroll p-2 space-y-1">
            <div class="text-center opacity-50 py-10 mt-10">
                <i class="ph ph-magnifying-glass text-4xl mb-2 block mx-auto"></i>
                Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            </div>
        </div>
    </div>

    <div id="mentions-dropdown" class="smooth-scroll border-t-2 border-blue-500 theme-card"></div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± -->
    <div id="create-post-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
        <div class="theme-card rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative border">
            <div class="p-4 border-b flex items-center justify-between z-10">
                <button onclick="UI.closeModal('create-post-modal')" class="p-2 font-bold text-gray-500 btn-tap rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                <span class="font-bold text-lg">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±</span>
                <button onclick="App.createPost()" class="bg-blue-600 text-white px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">Ù†Ø´Ø±</button>
            </div>
            <div class="p-5 flex flex-col items-center">
                <img id="create-post-avatar" src="" class="w-14 h-14 rounded-full object-cover border border-gray-100 mb-4 shadow-sm">
                <textarea id="post-text-input" placeholder="Ø¨Ù… ØªÙÙƒØ±ØŸ Ø§Ø³ØªØ®Ø¯Ù… @ Ù„Ø°ÙƒØ± ØµØ¯ÙŠÙ‚" class="w-full theme-bg border border-[var(--border-color)] rounded-2xl p-4 text-center font-semibold text-lg outline-none resize-none theme-text min-h-[120px]" rows="4"></textarea>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø© -->
    <div id="create-note-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
        <div class="w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative rounded-3xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="p-4 flex items-center justify-between w-full">
                <button onclick="UI.closeModal('create-note-modal')" class="p-2 text-white font-bold btn-tap drop-shadow-md">Ø¥Ù„ØºØ§Ø¡</button>
                <span class="font-bold text-white text-lg">Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                <button onclick="App.createNote()" class="bg-white text-purple-700 px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">Ù…Ø´Ø§Ø±ÙƒØ©</button>
            </div>
            <div class="p-6 flex flex-col items-center justify-center">
                <img id="create-note-preview-avatar" src="" class="w-20 h-20 rounded-full border-4 border-white shadow-lg mb-6">
                <textarea id="note-text-input" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ 24 Ø³Ø§Ø¹Ø©..." class="w-full bg-transparent border-none text-white text-2xl font-bold text-center outline-none resize-none placeholder-white/60" rows="3" maxlength="60"></textarea>
                <p class="text-white/50 text-xs mt-2">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 60 Ø­Ø±ÙØ§Ù‹</p>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø±Ø¶ -->
    <div id="note-view-modal" class="hidden fixed inset-0 bg-black/95 z-[100] flex flex-col modal-slide-in select-none">
        <div id="story-progress-container" class="absolute top-2 left-2 right-2 flex gap-1 z-20">
            </div>

        <div class="p-4 pt-6 flex items-center gap-3 absolute top-0 w-full z-10 bg-gradient-to-b from-black/80 to-transparent">
            <img id="nv-avatar" class="w-10 h-10 rounded-full border border-gray-600 object-cover cursor-pointer btn-tap" onclick="App.viewProfileFromNote()">
            <div class="flex-1 flex flex-col cursor-pointer" onclick="App.viewProfileFromNote()">
                <div class="flex items-center gap-1">
                    <h3 id="nv-name" class="text-white font-bold text-sm">...</h3>
                </div>
                <span id="nv-time" class="text-gray-300 text-[10px]">...</span>
            </div>
            
            <button id="nv-options-btn" class="hidden w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center btn-tap"><i class="ph ph-dots-three-vertical text-xl"></i></button>
            <button onclick="App.closeStoryViewer()" class="w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center btn-tap"><i class="ph ph-x text-lg"></i></button>
        </div>
        
        <div class="absolute inset-0 z-0 flex">
            <div class="w-1/3 h-full cursor-pointer" onclick="App.prevStory()"></div>
            <div id="story-pause-area" class="w-1/3 h-full cursor-pointer"></div>
            <div class="w-1/3 h-full cursor-pointer" onclick="App.nextStory()"></div>
        </div>

        <div class="flex-1 flex items-center justify-center p-6 relative pointer-events-none">
            <div id="nv-text" class="text-white text-3xl font-black text-center leading-relaxed whitespace-pre-wrap drop-shadow-lg">...</div>
        </div>

        <div id="note-bottom-section" class="p-4 w-full flex flex-col gap-3 z-10 bg-gradient-to-t from-black/80 to-transparent pb-safe relative">
            <div id="note-reply-section" class="hidden flex gap-3 items-center w-full">
                <input type="text" id="note-reply-input" placeholder="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©..." class="flex-1 bg-white/10 text-white placeholder-white/50 border border-white/20 rounded-full px-5 py-3 outline-none text-sm focus:bg-white/20 transition-colors backdrop-blur-sm relative z-20">
                <button onmousedown="event.preventDefault(); App.sendNoteReply();" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shadow-lg shrink-0 relative z-20"><i class="ph-fill ph-paper-plane-right text-xl"></i></button>
            </div>
            <div id="note-viewers-section" class="hidden flex flex-col items-center w-full relative z-20">
                <button onclick="App.showNoteViewers()" class="flex flex-col items-center gap-1 text-white opacity-80 hover:opacity-100 transition-opacity btn-tap p-2">
                    <i class="ph ph-eye text-2xl"></i>
                    <span id="note-viewers-count" class="text-sm font-bold">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="viewers-list-modal" class="hidden fixed inset-0 z-[110] flex flex-col justify-end bg-black/50">
        <div class="theme-card w-full h-[60vh] rounded-t-3xl flex flex-col modal-slide-in shadow-2xl relative">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="font-bold text-lg"><i class="ph ph-eye"></i> Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙˆÙ†</span>
                <button onclick="UI.closeModal('viewers-list-modal')" class="w-8 h-8 theme-bg rounded-full flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
            </div>
            <div id="viewers-list-container" class="flex-1 overflow-y-auto smooth-scroll p-2"></div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="manage-note-modal" class="hidden fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-4">
        <div class="theme-card rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative border">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
            </div>
            <div class="p-4 space-y-4">
                <textarea id="edit-note-input" class="w-full theme-bg p-4 rounded-xl outline-none text-center font-bold text-lg resize-none border" rows="2" maxlength="60"></textarea>
                <div class="flex flex-col gap-2">
                    <button onclick="App.updateNote()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="App.deleteNote()" class="w-full bg-red-50 text-red-600 font-bold py-3 rounded-xl btn-tap">Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
                    <button onclick="UI.closeModal('manage-note-modal')" class="w-full opacity-60 font-bold py-3 rounded-xl btn-tap">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª -->
    <div id="comments-modal" class="hidden fixed inset-0 z-[80] flex flex-col justify-end bg-black/50">
        <div class="theme-card w-full h-[85vh] rounded-t-3xl flex flex-col modal-slide-in shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="font-bold text-lg">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
                <button onclick="UI.closeModal('comments-modal')" class="w-8 h-8 theme-bg rounded-full flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
            </div>
            <div id="comments-list" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-5">
            </div>
            <div class="p-3 border-t flex gap-2 items-center theme-card pb-safe z-10">
                <img id="comment-my-avatar" src="" class="w-9 h-9 rounded-full object-cover">
                <input type="text" id="comment-input" placeholder="Ø§Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹... (Ø§Ø³ØªØ®Ø¯Ù… @)" class="flex-1 theme-bg border rounded-full px-4 py-2.5 outline-none text-sm transition-colors">
                <button onmousedown="event.preventDefault(); App.addComment();" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shrink-0 shadow-md"><i class="ph-fill ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm theme-card z-10">
            <button onclick="UI.closeModal('edit-profile-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
            <button onclick="App.saveProfile()" class="bg-blue-600 text-white px-4 py-1.5 rounded-full font-bold btn-tap text-sm">Ø­ÙØ¸</button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto smooth-scroll flex-1">
            <div class="flex flex-col items-center mb-4">
                <label for="edit-profile-pic" class="relative cursor-pointer group btn-tap">
                    <img id="edit-profile-img" src="" class="w-28 h-28 rounded-full object-cover border-4 border-gray-100 shadow-sm">
                    <div class="absolute bottom-0 right-0 bg-blue-600 p-2.5 rounded-full text-white border-2 border-white shadow-md"><i class="ph ph-camera"></i></div>
                    <input type="file" id="edit-profile-pic" accept="image/*" class="hidden" onchange="App.handleEditImage(event)">
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl space-y-4 border">
                <div>
                    <label class="text-xs font-bold opacity-60 block mb-1">Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="edit-name" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 font-bold text-lg transition-colors theme-text">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 block mb-1">Ø§Ù„Ù…Ø¹Ø±Ù (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 10 Ø£ÙŠØ§Ù…)</label>
                    <input type="text" id="edit-username" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 dir-ltr text-left font-mono text-lg transition-colors disabled:opacity-50 theme-text" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_.]/g, '')">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 block mb-1">Ø§Ù„Ù†Ø¨Ø°Ø©</label>
                    <textarea id="edit-bio" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 resize-none transition-colors theme-text" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ø¹Ù† Ù†ÙØ³Ùƒ..."></textarea>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© -->
    <div id="privacy-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="theme-card p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('privacy-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
        </div>
        <div class="p-4 space-y-3 smooth-scroll overflow-y-auto">
            <div class="theme-card p-4 rounded-2xl shadow-sm flex justify-between items-center border">
                <div>
                    <h4 class="font-bold">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h4>
                    <p class="text-xs opacity-60 mt-0.5">Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¢Ø®Ø±ÙŠÙ† Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ù„Ùƒ</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-requests" class="sr-only peer" onchange="App.updatePrivacy('allowRequests', this.checked)">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm flex justify-between items-center border">
                <div>
                    <h4 class="font-bold">Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ</h4>
                    <p class="text-xs opacity-60 mt-0.5">Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ Ø¹Ù† ØºÙŠØ± Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-private" class="sr-only peer" onchange="App.updatePrivacy('isPrivate', this.checked)">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm flex justify-between items-center border">
                <div>
                    <h4 class="font-bold">Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙŠ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</h4>
                    <p class="text-xs opacity-60 mt-0.5">Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-show-suggestions" class="sr-only peer" onchange="App.updatePrivacy('showInSuggestions', this.checked)">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm space-y-3 border">
                <h4 class="font-bold border-b pb-2">Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø±Ø¤ÙŠØ© Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</h4>
                <select id="priv-friends-vis" class="w-full theme-bg p-3 rounded-xl outline-none border focus:border-blue-500 theme-text" onchange="App.updatePrivacy('friendsVisibility', this.value)">
                    <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                    <option value="friends">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙ‚Ø·</option>
                    <option value="only_me">Ø£Ù†Ø§ ÙÙ‚Ø·</option>
                </select>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm space-y-3 border">
                <h4 class="font-bold border-b pb-2">Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ù…Ø±Ø§Ø³Ù„ØªÙŠ</h4>
                <select id="priv-msgs" class="w-full theme-bg p-3 rounded-xl outline-none border focus:border-blue-500 theme-text" onchange="App.updatePrivacy('messagePrivacy', this.value)">
                    <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                    <option value="friends">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙ‚Ø·</option>
                    <option value="only_me">Ø£Ù†Ø§ ÙÙ‚Ø·</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† -->
    <div id="account-settings-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="theme-card p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('account-settings-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø£Ù…Ø§Ù†</span>
        </div>
        <div class="p-4 space-y-4">
            <button onclick="UI.openModal('blocked-users-modal')" class="w-full theme-card p-5 rounded-2xl shadow-sm border flex items-center gap-4 btn-tap">
                <div class="w-12 h-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center"><i class="ph-fill ph-prohibit text-2xl"></i></div>
                <div class="flex-1 text-right">
                    <h3 class="font-bold text-lg">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</h3>
                    <p class="text-xs opacity-60 mt-0.5">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</p>
                </div>
                <i class="ph ph-caret-left opacity-50"></i>
            </button>

            <div class="theme-card rounded-2xl shadow-sm border overflow-hidden">
                <button onclick="document.getElementById('password-section-content').classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('-rotate-90')" class="w-full p-5 flex items-center gap-4 btn-tap">
                    <div class="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i class="ph-fill ph-shield-warning text-2xl"></i></div>
                    <div class="flex-1 text-right">
                        <h3 class="font-bold text-lg">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
                    </div>
                    <i class="ph ph-caret-down opacity-50 chevron transition-transform duration-300"></i>
                </button>
                <div id="password-section-content" class="hidden px-5 pb-5 pt-2 border-t">
                    <p class="text-sm opacity-60 mb-4">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ù„Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø¨Ø£Ù…Ø§Ù†.</p>
                    <button onclick="Auth.resetPasswordFromSettings()" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-xl border border-red-100 btn-tap">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØºÙŠÙŠØ±</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† -->
    <div id="blocked-users-modal" class="hidden fixed inset-0 theme-bg z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm theme-card z-10 sticky top-0">
            <button onclick="UI.closeModal('blocked-users-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-4" id="blocked-list-container">
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-50 dark:bg-gray-900 z-[110] flex flex-col modal-slide-in">
        
        <div class="p-3 border-b flex items-center gap-3 theme-card shadow-sm sticky top-0 z-30">
            <button onclick="UI.closeModal('profile-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
        </div>

        <div class="flex-1 overflow-y-auto smooth-scroll pb-10 relative">
            <div class="flex flex-col items-center pt-6">
                <img id="vp-image" src="" class="w-24 h-24 rounded-full object-cover shadow-sm border-2 border-white dark:border-gray-800">
                <h2 id="vp-name" class="text-xl font-bold text-gray-900 dark:text-white mt-3">...</h2>
                <p id="vp-last-seen" class="text-gray-500 dark:text-gray-400 text-xs mt-1">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ...</p>
            </div>
            
            <div class="flex justify-center gap-2.5 mt-5 px-4" id="vp-action-container">
                </div>

            <div class="mt-6 w-full">
                <div class="bg-white dark:bg-gray-800 p-4 shadow-sm border-y border-gray-100 dark:border-gray-700 w-full text-center flex flex-col gap-3">
                    <div class="pb-3 border-b border-gray-100 dark:border-gray-700">
                        <p class="text-[10px] text-gray-400 mb-1.5">Ø§Ù„Ù†Ø¨Ø°Ø©</p>
                        <p id="vp-bio" class="text-gray-800 dark:text-gray-200 text-[14px] font-medium whitespace-pre-wrap leading-relaxed inline-block">...</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 mb-1.5">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                        <p id="vp-username" class="text-gray-800 dark:text-gray-200 text-[14px] font-bold dir-ltr inline-block text-blue-600">@...</p>
                    </div>
                </div>
            </div>
            
            <div class="px-4 mt-6">
               
                
                <!-- Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
                <div class="mt-6">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-xl theme-text">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
                        <span class="text-gray-500 font-bold" id="vp-friends-count-text">0</span>
                    </div>
                    <div class="friends-grid" id="vp-friends-grid"></div>
                </div>
                
                <!-- Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                <div class="mt-8" id="vp-posts-container">
                    <h3 class="font-bold text-xl theme-text mb-4">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>
                    <div class="text-center opacity-50 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="pin-chat-popup" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[150] flex items-center justify-center" onclick="if(event.target === this) UI.closeModal('pin-chat-popup')">
        <div class="pin-popup overflow-hidden">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <button onclick="App.pinChat('love'); UI.closeModal('pin-chat-popup')" class="pin-option w-full bg-red-50 text-red-600 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>ØªØ«Ø¨ÙŠØª (Ø§Ù„Ø­Ø¨ ğŸŒšâ™¥)</span>
                    <i class="ph-fill ph-heart text-xl"></i>
                </button>
                <button onclick="App.pinChat('normal'); UI.closeModal('pin-chat-popup')" class="pin-option w-full bg-gray-100 text-gray-700 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>ØªØ«Ø¨ÙŠØª (Ø´Ø®Øµ Ø¹Ø§Ø¯ÙŠ ğŸ™„)</span>
                    <i class="ph-fill ph-push-pin text-xl"></i>
                </button>
                <button onclick="App.unpinChat(); UI.closeModal('pin-chat-popup')" class="pin-option w-full bg-gray-200 text-gray-800 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª</span>
                    <i class="ph-fill ph-push-pin-slash text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="delete-chat-popup" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[150] flex items-center justify-center" onclick="if(event.target === this) UI.closeModal('delete-chat-popup')">
        <div class="delete-popup overflow-hidden">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <button onclick="App.deleteChatHistory('me'); UI.closeModal('delete-chat-popup')" class="pin-option w-full bg-orange-50 text-orange-600 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>Ø­Ø°Ù Ù„Ø¯ÙŠ ÙÙ‚Ø·</span>
                    <i class="ph-fill ph-trash text-xl"></i>
                </button>
                <button onclick="App.deleteChatHistory('everyone'); UI.closeModal('delete-chat-popup')" class="pin-option w-full bg-red-50 text-red-600 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹</span>
                    <i class="ph-fill ph-trash-simple text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="mute-chat-popup" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[150] flex items-center justify-center" onclick="if(event.target === this) UI.closeModal('mute-chat-popup')">
        <div class="pin-popup overflow-hidden">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <button onclick="App.muteChat(1); UI.closeModal('mute-chat-popup')" class="pin-option w-full bg-gray-100 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©</span>
                </button>
                <button onclick="App.muteChat(24); UI.closeModal('mute-chat-popup')" class="pin-option w-full bg-gray-100 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©</span>
                </button>
                <button onclick="App.muteChat(0); UI.closeModal('mute-chat-popup')" class="pin-option w-full bg-gray-200 p-4 rounded-2xl flex items-center justify-between font-bold btn-tap">
                    <span>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…</span>
                </button>
            </div>
        </div>
    </div>

    <div id="chat-modal" class="hidden fixed inset-0 theme-bg z-[90] flex flex-col modal-slide-in">
        <div class="theme-card p-3 border-b flex items-center justify-between shadow-sm z-20 relative">
            <div class="flex items-center gap-3 flex-1">
                <button onclick="UI.closeModal('chat-modal')" class="p-2 theme-bg border rounded-full btn-tap shrink-0" id="chat-back-button"><i class="ph ph-arrow-right text-lg"></i></button>
                <div class="relative cursor-pointer shrink-0" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                    <img id="chat-user-img" src="" class="w-11 h-11 rounded-full object-cover">
                    <span id="chat-online-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full hidden"></span>
                </div>
                <div class="flex-1 overflow-hidden min-w-0 cursor-pointer" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                    <h3 id="chat-user-name" class="font-bold leading-tight truncate">...</h3>
                    <p id="chat-user-status" class="text-[11px] opacity-60 truncate mt-0.5">...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="App.toggleMuteChat()" class="hidden w-9 h-9 rounded-full theme-bg border flex items-center justify-center btn-tap relative" id="chat-mute-btn">
                    <i class="ph ph-bell-simple-z text-lg"></i>
                </button>
                <div id="chat-pet-container" class="w-12 h-12 flex items-center justify-center relative shrink-0 cursor-pointer btn-tap"></div>
            </div>
        </div>
        
        <div id="chat-background" class="flex-1 overflow-hidden flex flex-col relative chat-container-bg">
            <div id="chat-messages-container" class="flex-1 overflow-y-auto smooth-scroll p-4 flex flex-col relative z-10 pb-4 overflow-x-hidden">
                <div id="live-typing-bubble" class="hidden bubble-other rounded-2xl rounded-bl-sm p-3 shadow-sm self-start mb-2 text-[15px] opacity-70 w-fit max-w-[80%] transition-all duration-300">
                    <span class="typing-cursor font-medium"></span>
                </div>
            </div>

        <div id="replying-to-container" class="hidden theme-card border-t px-4 py-2 flex items-center justify-between shadow-[0_-2px_10px_rgba(0,0,0,0.02)] z-10 relative">
            <div class="flex flex-col border-r-4 border-blue-500 pr-3">
                <span class="text-xs font-bold text-blue-600" id="reply-to-name">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰...</span>
                <span class="text-sm opacity-80 truncate max-w-[250px]" id="reply-to-text">...</span>
            </div>
            <button onclick="App.cancelReply()" class="w-8 h-8 rounded-full theme-bg flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
        </div>

        <div class="p-3 theme-card border-t flex gap-2 items-end pb-safe z-20 relative">
            <textarea id="chat-input" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©..." class="flex-1 theme-bg border border-transparent rounded-3xl px-5 py-3 outline-none resize-none max-h-28 hide-scrollbar text-[15px] transition-colors theme-text focus:border-blue-500" rows="1" oninput="this.style.height = '';this.style.height = Math.min(this.scrollHeight, 112) + 'px'; App.handleTyping(this.value);"></textarea>
            <button onmousedown="event.preventDefault(); App.sendMessage();" ontouchstart="event.preventDefault(); App.sendMessage();" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 transition-colors text-white rounded-full flex items-center justify-center shrink-0 btn-tap shadow-md mb-0.5"><i class="ph-fill ph-paper-plane-right text-xl pointer-events-none"></i></button>
        </div>
    </div>
</div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center" onclick="if(event.target === this) UI.closeModal('action-modal')">
        <div id="action-modal-content" class="telegram-menu flex flex-col text-sm font-semibold theme-text"></div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ù…Ù†Ø´ÙˆØ± Ù…ÙØ±Ø¯ -->
    <div id="single-post-modal" class="hidden fixed inset-0 theme-bg z-[85] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 theme-card shadow-sm sticky top-0 z-10">
            <button onclick="UI.closeModal('single-post-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-2" id="single-post-container"></div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ù†Ø´ÙˆØ± (Ø¬Ø¯ÙŠØ¯Ø©) -->
    <div id="report-post-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
        <div class="theme-card rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative border">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg text-red-600">Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ù†Ø´ÙˆØ±</h3>
            </div>
            <div class="p-5">
                <p class="text-sm mb-4 text-center">Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº:</p>
                <div class="space-y-2">
                    <div class="report-reason" onclick="App.submitReport('post', window.currentReportPostId, 'ØªØ­Ø±ÙŠØ¶')">
                        <span class="font-bold">ØªØ­Ø±ÙŠØ¶</span>
                    </div>
                    <div class="report-reason" onclick="App.submitReport('post', window.currentReportPostId, 'Ø¥Ø³Ø§Ø¡Ø©')">
                        <span class="font-bold">Ø¥Ø³Ø§Ø¡Ø©</span>
                    </div>
                    <div class="report-reason" onclick="App.submitReport('post', window.currentReportPostId, 'Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚')">
                        <span class="font-bold">Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚</span>
                    </div>
                    <div class="report-reason" onclick="App.submitReport('post', window.currentReportPostId, 'Ø§Ù†ØªÙ‡Ø§Ùƒ Ø®ØµÙˆØµÙŠØ©')">
                        <span class="font-bold">Ø§Ù†ØªÙ‡Ø§Ùƒ Ø®ØµÙˆØµÙŠØ©</span>
                    </div>
                    <div class="report-reason" onclick="App.submitReport('post', window.currentReportPostId, 'Ø³Ø¨Ø¨ Ø¢Ø®Ø±')">
                        <span class="font-bold">Ø³Ø¨Ø¨ Ø¢Ø®Ø±</span>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t text-center">
                <button onclick="UI.closeModal('report-post-modal')" class="text-gray-500 font-bold py-2 px-4 rounded-xl btn-tap">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø¬Ø¯ÙŠØ¯Ø©) -->
    <div id="edit-post-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
        <div class="theme-card rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative border">
            <div class="p-4 border-b flex items-center justify-between">
                <button onclick="UI.closeModal('edit-post-modal')" class="p-2 font-bold text-gray-500 btn-tap rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                <span class="font-bold text-lg">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span>
                <button onclick="App.updatePost()" class="bg-blue-600 text-white px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">Ø­ÙØ¸</button>
            </div>
            <div class="p-5">
                <textarea id="edit-post-input" class="w-full bg-gray-50 dark:bg-gray-800 border rounded-2xl p-4 text-center font-semibold text-lg outline-none resize-none theme-text min-h-[120px]" rows="4"></textarea>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø§Ù„Ùƒ (Ø¬Ø¯ÙŠØ¯Ø©) -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 theme-bg z-[130] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm theme-card">
            <button onclick="UI.closeModal('admin-panel-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
        </div>
        
        <div class="flex-1 overflow-y-auto smooth-scroll p-4">
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="flex gap-2 mb-6">
                <button onclick="App.switchAdminTab('reports')" id="admin-tab-reports" class="flex-1 py-3 text-center font-bold border-b-2 border-blue-600 text-blue-600 btn-tap">Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª</button>
                <button onclick="App.switchAdminTab('banned')" id="admin-tab-banned" class="flex-1 py-3 text-center font-bold border-b-2 border-transparent btn-tap">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</button>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª -->
            <div id="admin-reports-tab">
                <div id="reports-list" class="space-y-3"></div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† -->
            <div id="admin-banned-tab" class="hidden">
                <div class="theme-card p-4 rounded-xl border mb-4">
                    <div class="relative">
                        <input type="text" id="admin-search-input" oninput="App.searchUsersForBan()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…Ø¹Ø±Ù..." class="w-full theme-bg border rounded-full py-3 px-4 pr-10 outline-none focus:ring-2 focus:ring-red-100">
                        <i class="ph ph-magnifying-glass absolute right-3 top-3 opacity-50 text-lg"></i>
                    </div>
                    <div id="admin-search-results" class="mt-3 space-y-2"></div>
                </div>
                
                <button onclick="App.showBannedUsers()" class="w-full theme-card p-4 rounded-xl border flex items-center justify-center gap-2 btn-tap">
                    <i class="ph ph-prohibit text-xl"></i>
                    <span class="font-bold">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
                </button>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·) -->
                <div id="banned-users-list" class="mt-4 hidden space-y-2"></div>
            </div>
        </div>
    </div>
    
    <div id="reactions-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[150] flex items-center justify-center" onclick="if(event.target === this) UI.closeModal('reactions-modal')">
        <div class="theme-card rounded-3xl p-5 shadow-2xl modal-slide-in w-[90%] max-w-sm border border-[var(--border-color)]">
            <h3 class="text-center font-bold mb-4 text-sm opacity-60">Ø§Ø®ØªØ± ØªÙØ§Ø¹Ù„Ø§Ù‹</h3>
            <div class="grid grid-cols-5 gap-4 justify-items-center">
                <button onclick="App.selectReaction('ğŸ‘ğŸ»')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ‘ğŸ»</button>
                <button onclick="App.selectReaction('ğŸ‘ğŸ»')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ‘ğŸ»</button>
                <button onclick="App.selectReaction('â¤')" class="text-3xl btn-tap hover:scale-125 transition-transform">â¤</button>
                <button onclick="App.selectReaction('ğŸ¤£')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ¤£</button>
                <button onclick="App.selectReaction('ğŸ’”')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ’”</button>
                <button onclick="App.selectReaction('ğŸŒš')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸŒš</button>
                <button onclick="App.selectReaction('ğŸ¥²')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ¥²</button>
                <button onclick="App.selectReaction('ğŸ”¥')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ”¥</button>
                <button onclick="App.selectReaction('ğŸ’•')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ’•</button>
                <button onclick="App.selectReaction('ğŸ˜‰')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ˜‰</button>
                <button onclick="App.selectReaction('ğŸ™‚')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ™‚</button>
                <button onclick="App.selectReaction('ğŸ˜¢')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ˜¢</button>
                <button onclick="App.selectReaction('ğŸ˜­')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ˜­</button>
                <button onclick="App.selectReaction('ğŸ˜’')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ˜’</button>
                <button onclick="App.selectReaction('ğŸ˜”')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ˜”</button>
                <button onclick="App.selectReaction('ğŸ¥º')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ¥º</button>
                <button onclick="App.selectReaction('ğŸ˜')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ˜</button>
                <button onclick="App.selectReaction('ğŸ«£')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ«£</button>
                <button onclick="App.selectReaction('ğŸ’‹')" class="text-3xl btn-tap hover:scale-125 transition-transform">ğŸ’‹</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, query, orderBy, limit, startAfter, getDocs, where, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDe7WeScgMaRAK7PzExvkzppb2XOcdAI0k",
                authDomain: "communication-5dd27.firebaseapp.com",
                databaseURL: "https://communication-5dd27-default-rtdb.firebaseio.com",
                projectId: "communication-5dd27",
                storageBucket: "communication-5dd27.firebasestorage.app",
                messagingSenderId: "79255528858",
                appId: "1:79255528858:web:6c75eee637561056b28623"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xylo-app-123';

        const USERS_PATH = `artifacts/${appId}/public/data/users`;
        const POSTS_PATH = `artifacts/${appId}/public/data/posts`;
        const COMMENTS_PATH = `artifacts/${appId}/public/data/comments`;
        const REQUESTS_PATH = `artifacts/${appId}/public/data/requests`;
        const FRIENDS_PATH = `artifacts/${appId}/public/data/friends`;
        const MESSAGES_PATH = `artifacts/${appId}/public/data/messages`;
        const NOTES_PATH = `artifacts/${appId}/public/data/notes`;
        const NOTIFS_PATH = `artifacts/${appId}/public/data/notifications`;
        const TYPING_PATH = `artifacts/${appId}/public/data/typing`; 
        const PINS_PATH = `artifacts/${appId}/public/data/pins`;
        const MUTES_PATH = `artifacts/${appId}/public/data/mutes`;
        const REPORTS_PATH = `artifacts/${appId}/public/data/reports`; // Ø¬Ø¯ÙŠØ¯
        const BANNED_PATH = `artifacts/${appId}/public/data/banned`; // Ø¬Ø¯ÙŠØ¯

        window.Memory = {
            users: {}, posts: [], comments: [], requests: [], friends: [], messages: [], notes: [], notifications: [], pins: [], mutes: [], reports: [], banned: []
        };

        window.currentUser = null;
        window.currentChatUserId = null;
        window.currentPostIdForComment = null;
        window.currentManageNoteId = null;
        window.noteViewAuthorId = null; 
        window.replyingToMessage = null; 
        window.selectedGender = null;
        window.selectedEditGender = null;
        window.messagesLimit = 25;
        window.lastVisibleMessage = null;
        window.hasMoreMessages = true;
        window.currentMessagePage = 0;
        window.allMessages = [];
        window.currentReportPostId = null; // Ø¬Ø¯ÙŠØ¯
        window.currentEditPostId = null; // Ø¬Ø¯ÙŠØ¯
        window.MASTER_EMAIL = "mslmalmyaly223@gmail.com"; // Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø§Ù„Ùƒ

        if(window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.documentElement.style.setProperty('--vh', `${window.visualViewport.height * 0.01}px`);
                const chatModal = document.getElementById('chat-modal');
                if(!chatModal.classList.contains('hidden')) {
                    const container = document.getElementById('chat-messages-container');
                    if(container) container.scrollTop = container.scrollHeight;
                }
            });
            document.documentElement.style.setProperty('--vh', `${window.visualViewport.height * 0.01}px`);
        }

        const escapeHTML = (str) => {
            if(!str) return '';
            return str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag] || tag));
        };

        // ØªØ¹Ø¯ÙŠÙ„ 10: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù†ØµÙˆØµ
        const parseTextWithLinks = (text, isMessage = false) => {
            if(!text) return '';
            const escaped = escapeHTML(text);
            
            // Ù†Ù…Ø· Ù„Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            
            let parsed = escaped.replace(urlRegex, (url) => {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· Ù„ØªØ·Ø¨ÙŠÙ‚ Ø²Ø§ÙŠÙ„Ùˆ (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ?post= Ø£Ùˆ ?user=)
                try {
                    const urlObj = new URL(url);
                    const postParam = urlObj.searchParams.get('post');
                    const userParam = urlObj.searchParams.get('user');
                    
                    if(postParam) {
                        return `<span class="link-internal" onclick="event.stopPropagation(); App.openSinglePost('${postParam}')">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span>`;
                    } else if (userParam) {
                        return `<span class="link-internal" onclick="event.stopPropagation(); UI.openProfileByUsername('${userParam}')">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨</span>`;
                    }
                } catch(e) {
                    // Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­
                }
                
                // Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ - Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ø³Ø® Ø¨Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
                return `<span class="link-external selectable-text" title="Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù†Ø³Ø®">${url}</span>`;
            });
            
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù†Ø´Ù†
            parsed = parsed.replace(/@([\w_.]+)/g, (match, username) => {
                const exists = Object.values(Memory.users).find(u => u.username === username);
                if(exists) {
                    return `<span class="link-internal" onclick="event.stopPropagation(); UI.openProfileByUsername('${username}')">${match}</span>`;
                }
                return match; 
            });
            
            return parsed;
        };

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const isDeviceBanned = async (uid) => {
            const bannedDoc = await getDoc(doc(db, BANNED_PATH, uid));
            return bannedDoc.exists();
        };

        // Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        const banDevice = async (uid) => {
            const user = Memory.users[uid];
            if(!user) return;
            
            await setDoc(doc(db, BANNED_PATH, uid), {
                uid: uid,
                email: user.email,
                timestamp: Date.now()
            });
            
            // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø­Ø§Ù„ÙŠØ§Ù‹
            if(auth.currentUser && auth.currentUser.uid === uid) {
                await signOut(auth);
            }
        };

        // Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²
        const unbanDevice = async (uid) => {
            await deleteDoc(doc(db, BANNED_PATH, uid));
        };

        window.PullToRefresh = {
            startY: 0, isPulling: false, spinner: null, container: null,
            init: () => {
                PullToRefresh.container = document.getElementById('main-content-area');
                PullToRefresh.spinner = document.getElementById('ptr-spinner');
                
                PullToRefresh.container.addEventListener('touchstart', e => {
                    if (PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.startY = e.touches[0].clientY;
                        PullToRefresh.isPulling = true;
                        PullToRefresh.spinner.style.transition = 'none';
                    }
                }, {passive: true});

                PullToRefresh.container.addEventListener('touchmove', e => {
                    if (!PullToRefresh.isPulling) return;
                    const y = e.touches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    if (diff > 0 && PullToRefresh.container.scrollTop <= 0) {
                        e.preventDefault();
                        let pullDistance = Math.min(diff * 0.4, 70); 
                        PullToRefresh.spinner.style.transform = `translate(-50%, ${pullDistance}px) rotate(${pullDistance*2}deg)`;
                        PullToRefresh.spinner.style.opacity = Math.min(pullDistance / 50, 1);
                    }
                }, {passive: false});

                PullToRefresh.container.addEventListener('touchend', e => {
                    if (!PullToRefresh.isPulling) return;
                    PullToRefresh.isPulling = false;
                    PullToRefresh.spinner.style.transition = 'transform 0.3s, opacity 0.3s';
                    
                    const y = e.changedTouches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    
                    if (diff > 80 && PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.spinner.style.transform = `translate(-50%, 50px) rotate(360deg)`;
                        PullToRefresh.spinner.classList.add('animate-spin');
                        
                        setTimeout(() => {
                            App.renderFeed();
                            App.renderNotifications();
                            PullToRefresh.spinner.classList.remove('animate-spin');
                            PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                            PullToRefresh.spinner.style.opacity = 0;
                            UI.showMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                        }, 1000);
                    } else {
                        PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                        PullToRefresh.spinner.style.opacity = 0;
                    }
                }, {passive: true});
            }
        };

        window.Mentions = {
            activeInput: null,
            setup: () => {
                const inputs = ['post-text-input', 'note-text-input', 'comment-input'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('input', (e) => Mentions.checkTrigger(e.target));
                        el.addEventListener('blur', () => setTimeout(() => document.getElementById('mentions-dropdown').style.display = 'none', 200));
                    }
                });
            },
            checkTrigger: (input) => {
                Mentions.activeInput = input;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const words = textBeforeCursor.split(/\s/);
                const lastWord = words[words.length - 1];

                const dropdown = document.getElementById('mentions-dropdown');
                
                if (lastWord.startsWith('@')) {
                    const query = lastWord.substring(1).toLowerCase();
                    Mentions.showList(query, input);
                } else {
                    dropdown.style.display = 'none';
                }
            },
            showList: (query, input) => {
                const dropdown = document.getElementById('mentions-dropdown');
                dropdown.innerHTML = '';
                
                const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                
                let results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    friendsIds.includes(u.uid) &&
                    (u.username.toLowerCase().includes(query) || u.name.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const mentionsCount = currentUser.mentionsCount || {};
                results.sort((a,b) => (mentionsCount[b.uid] || 0) - (mentionsCount[a.uid] || 0));

                results.forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'p-3 flex items-center gap-3 border-b hover:opacity-80 cursor-pointer btn-tap';
                    item.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-8 h-8 rounded-full object-cover border">
                        <div>
                            <div class="font-bold text-sm">${u.name}</div>
                            <div class="text-[10px] opacity-60">@${u.username}</div>
                        </div>
                    `;
                    item.onmousedown = (e) => {
                        e.preventDefault(); 
                        Mentions.selectUser(u.username, u.uid);
                    };
                    dropdown.appendChild(item);
                });

                const rect = input.getBoundingClientRect();
                dropdown.style.bottom = 'auto';
                dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                if(input.id === 'comment-input' || input.id === 'post-text-input') {
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '60px'; 
                }
                
                dropdown.style.display = 'block';
            },
            selectUser: (username, uid) => {
                const input = Mentions.activeInput;
                if(!input) return;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const textAfterCursor = text.substring(cursorPos);
                
                const words = textBeforeCursor.split(/\s/);
                words.pop(); 
                
                const newTextBefore = (words.length > 0 ? words.join(' ') + ' ' : '') + '@' + username + ' ';
                input.value = newTextBefore + textAfterCursor;
                input.focus();
                input.setSelectionRange(newTextBefore.length, newTextBefore.length);
                
                document.getElementById('mentions-dropdown').style.display = 'none';
                App.incrementMentionCount(uid);
            }
        };

        window.UI = {
            showMessage: (msg) => {
                const box = document.getElementById('msg-box');
                document.getElementById('msg-box-text').innerText = msg;
                box.style.opacity = '1';
                setTimeout(() => { box.style.opacity = '0'; }, 3000);
            },
            switchAuth: (formId) => {
                ['login-form', 'register-form', 'forgot-form'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`${formId}-form`).classList.remove('hidden');
            },
            showScreen: (screenId) => {
                ['splash-screen', 'auth-screen', 'setup-profile-screen', 'main-app'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            switchTab: (tabId) => {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                    btn.querySelector('i').classList.remove('ph-fill');
                    btn.querySelector('i').classList.add('ph');
                });
                const activeBtn = document.querySelector(`.nav-btn[onclick="UI.switchTab('${tabId}')"]`);
                if(activeBtn) {
                    activeBtn.classList.remove('text-gray-500', 'border-transparent');
                    activeBtn.classList.add('text-blue-600', 'border-blue-600');
                    activeBtn.querySelector('i').classList.remove('ph');
                    activeBtn.querySelector('i').classList.add('ph-fill');
                }

                ['tab-home', 'tab-messages', 'tab-notes', 'tab-notifications', 'tab-settings'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                
                App.updateLastActive();
                
                if(tabId === 'messages') App.renderChats(); 
                if(tabId === 'notes') {
                    // Ø­Ø°ÙÙ†Ø§ Ø³Ø·Ø± Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø·Ø© Ø·Ø§Ù„Ù…Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚
                    App.switchFriendsSubTab('friends');
                }
                if(tabId === 'notifications') document.getElementById('badge-notifications').classList.add('hidden');

                document.getElementById('main-content-area').scrollTop = 0;
            },
            openModal: (modalId, data = null) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                if (modal.firstElementChild && (modal.firstElementChild.classList.contains('modal-slide-in') || modal.firstElementChild.classList.contains('modal-slide-out'))) {
                    modal.firstElementChild.classList.remove('modal-slide-out');
                    modal.firstElementChild.classList.add('modal-slide-in');
                }

                if (modalId === 'profile-modal' && data) {
                    App.renderUserProfile(data);
                } else if (modalId === 'chat-modal' && data) {
                    window.currentChatUserId = data;
                    App.cancelReply(); 
                    App.renderChatInfo(data);
                    App.loadMessages(); // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ 25 Ø±Ø³Ø§Ù„Ø©
                    App.markChatAsRead(data); 
                } else if (modalId === 'comments-modal' && data) {
                    window.currentPostIdForComment = data;
                    document.getElementById('comment-my-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    App.renderComments();
                } else if (modalId === 'edit-profile-modal') {
                    document.getElementById('edit-name').value = currentUser.name || '';
                    document.getElementById('edit-bio').value = currentUser.bio || '';
                    document.getElementById('edit-profile-img').src = currentUser.photo || App.getDefaultAvatar();
                    
                    const usernameInput = document.getElementById('edit-username');
                    usernameInput.value = currentUser.username || '';
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) {
                        usernameInput.disabled = true;
                        UI.showMessage('ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ (Ù…Ø±Ø© ÙƒÙ„ 10 Ø£ÙŠØ§Ù…)');
                    } else {
                        usernameInput.disabled = false;
                    }
                    
                    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù†Ø³ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    window.selectedEditGender = currentUser.gender || 'male';
                    document.getElementById('edit-gender-male').classList.remove('selected');
                    document.getElementById('edit-gender-female').classList.remove('selected');
                    if(currentUser.gender === 'male') {
                        document.getElementById('edit-gender-male').classList.add('selected');
                    } else {
                        document.getElementById('edit-gender-female').classList.add('selected');
                    }
                } else if (modalId === 'privacy-modal') {
                    document.getElementById('priv-requests').checked = currentUser.allowRequests !== false;
                    document.getElementById('priv-private').checked = currentUser.isPrivate === true;
                    document.getElementById('priv-show-suggestions').checked = currentUser.showInSuggestions !== false;
                    document.getElementById('priv-friends-vis').value = currentUser.friendsVisibility || 'all';
                    document.getElementById('priv-msgs').value = currentUser.messagePrivacy || 'all';
                } else if (modalId === 'create-note-modal') {
                    document.getElementById('create-note-preview-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    document.getElementById('note-text-input').value = '';
                } else if (modalId === 'blocked-users-modal') {
                    App.renderBlockedUsers(); 
                } else if (modalId === 'report-post-modal' && data) {
                    window.currentReportPostId = data;
                } else if (modalId === 'edit-post-modal' && data) {
                    const post = Memory.posts.find(p => p.id === data);
                    if(post) {
                        window.currentEditPostId = data;
                        document.getElementById('edit-post-input').value = post.text;
                    }
                }
            },
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal.firstElementChild && modal.firstElementChild.classList.contains('modal-slide-in')) {
                    modal.firstElementChild.classList.remove('modal-slide-in');
                    modal.firstElementChild.classList.add('modal-slide-out');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                } else {
                    modal.classList.add('hidden');
                }
            },
            openProfileByUsername: (username) => {
                const u = Object.values(Memory.users).find(user => user.username === username);
                if(u) {
                    UI.closeModal('comments-modal');
                    UI.closeModal('note-view-modal');
                    UI.closeModal('single-post-modal');
                    UI.openModal('profile-modal', u.uid);
                } else {
                    UI.showMessage('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
            }
        };

        let tempPhotoBase64 = null;

        window.Auth = {
            init: async () => {
                UI.showScreen('splash-screen');

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e){}
                } 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²
                        const isBanned = await isDeviceBanned(user.uid);
                        if(isBanned) {
                            UI.showMessage('Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
                            await signOut(auth);
                            return;
                        }

                        const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                        if (userDoc.exists()) {
                            window.currentUser = userDoc.data();
                            if(!window.currentUser.blockedUsers) window.currentUser.blockedUsers = [];
                            if(!window.currentUser.mentionsCount) window.currentUser.mentionsCount = {};
                            if(window.currentUser.showInSuggestions === undefined) window.currentUser.showInSuggestions = true;
                            
                            const savedTheme = localStorage.getItem('xylo-theme');
                            if(savedTheme === 'dark') {
                                document.body.classList.add('dark-theme');
                                const themeToggle = document.getElementById('theme-toggle');
                                if(themeToggle) themeToggle.checked = true;
                            }

                            setTimeout(() => { App.startCore(); }, 500); 
                            
                            const urlParams = new URLSearchParams(window.location.search);
                            const postIdParam = urlParams.get('post');
                            const userParam = urlParams.get('user');
                            if(postIdParam) {
                                setTimeout(() => App.openSinglePost(postIdParam), 1000);
                            } else if (userParam) {
                                setTimeout(() => UI.openProfileByUsername(userParam), 1000);
                            }
                        } else {
                            setTimeout(() => { UI.showScreen('setup-profile-screen'); }, 500);
                        }
                    } else {
                        window.currentUser = null;
                        setTimeout(() => { UI.showScreen('auth-screen'); }, 2000);
                    }
                });
            },
            register: async () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                if(!name || !email || !password) return UI.showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                
                try {
                    UI.showMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...');
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    window.tempRegData = { uid: cred.user.uid, name, email };
                    UI.showScreen('setup-profile-screen');
                } catch (error) {
                    UI.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø±Ø¨Ù…Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø¶Ø¹ÙŠÙ');
                }
            },
            login: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if(!email || !password) return UI.showMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                try {
                    UI.showMessage('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    UI.showMessage('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            },
            resetPassword: async () => {
                const email = document.getElementById('forgot-email').value;
                if(!email) return UI.showMessage('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                try {
                    await sendPasswordResetEmail(auth, email);
                    UI.showMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ø¨Ø±ÙŠØ¯Ùƒ');
                    UI.switchAuth('login');
                } catch(e) { UI.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
            },
            resetPasswordFromSettings: async () => {
                if(auth.currentUser && auth.currentUser.email) {
                    try {
                        await sendPasswordResetEmail(auth, auth.currentUser.email);
                        UI.showMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø¨Ø±ÙŠØ¯Ùƒ');
                    } catch(e) { UI.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
                }
            },
            logout: async () => {
                App.updateLastActive(true); 
                await signOut(auth);
                window.location.reload();
            },
            handleImageUpload: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; const MAX_HEIGHT = 400;
                        let width = img.width; let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        tempPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        document.getElementById('profile-preview-img').src = tempPhotoBase64;
                        document.getElementById('profile-preview-img').classList.remove('hidden');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },
            completeProfileSetup: async () => {
                if(!window.tempRegData && !auth.currentUser) return;
                
                if(!window.selectedGender) {
                    document.getElementById('gender-error').classList.remove('hidden');
                    return;
                }
                
                UI.showMessage('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨...');
                const uid = window.tempRegData ? window.tempRegData.uid : auth.currentUser.uid;
                const name = window.tempRegData ? window.tempRegData.name : 'Ù…Ø³ØªØ®Ø¯Ù…';
                const email = window.tempRegData ? window.tempRegData.email : '';
                
                const userData = {
                    uid: uid,
                    name: name,
                    email: email,
                    photo: tempPhotoBase64 || App.getDefaultAvatar(),
                    username: 'user_' + Math.floor(Math.random() * 1000000),
                    bio: '',
                    allowRequests: true,
                    isPrivate: false,
                    showInSuggestions: true,
                    friendsVisibility: 'all',
                    messagePrivacy: 'all',
                    lastActive: Date.now(),
                    lastUsernameChange: 0,
                    lastGenderChange: 0,
                    blockedUsers: [],
                    mentionsCount: {},
                    gender: window.selectedGender
                };

                await setDoc(doc(db, USERS_PATH, uid), userData);
                window.currentUser = userData;
                App.startCore();
            }
        };

        window.App = {
            getDefaultAvatar: () => "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>",
            
            selectGender: (gender) => {
                window.selectedGender = gender;
                document.getElementById('gender-error').classList.add('hidden');
                document.getElementById('gender-male').classList.remove('selected');
                document.getElementById('gender-female').classList.remove('selected');
                if(gender === 'male') {
                    document.getElementById('gender-male').classList.add('selected');
                } else {
                    document.getElementById('gender-female').classList.add('selected');
                }
            },

            selectEditGender: (gender) => {
                const sixtyDaysInMs = 60 * 24 * 60 * 60 * 1000;
                const lastChange = currentUser.lastGenderChange || 0;
                if (Date.now() - lastChange < sixtyDaysInMs && gender !== currentUser.gender) {
                    UI.showMessage('ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ù†Ø³ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 60 ÙŠÙˆÙ…');
                    return;
                }
                
                window.selectedEditGender = gender;
                document.getElementById('edit-gender-male').classList.remove('selected');
                document.getElementById('edit-gender-female').classList.remove('selected');
                if(gender === 'male') {
                    document.getElementById('edit-gender-male').classList.add('selected');
                } else {
                    document.getElementById('edit-gender-female').classList.add('selected');
                }
            },

            toggleTheme: (isDark) => {
                const themeLabel = document.getElementById('theme-text-label');
                if(isDark) {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('xylo-theme', 'dark');
                    if(themeLabel) themeLabel.innerText = "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ";
                } else {
                    document.body.classList.remove('dark-theme');
                    localStorage.setItem('xylo-theme', 'light');
                    if(themeLabel) themeLabel.innerText = "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ";
                }
            },

            startCore: () => {
                UI.showScreen('main-app');
                App.updateUIWithUserData();
                App.setupListeners();
                App.updateLastActive();
                Mentions.setup();
                PullToRefresh.init();
                setInterval(App.updateLastActive, 60000);
                
                const themeToggle = document.getElementById('theme-toggle');
                if(themeToggle) themeToggle.checked = document.body.classList.contains('dark-theme');

                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
                const userEmail = currentUser?.email || (auth.currentUser ? auth.currentUser.email : '');
                if(userEmail && userEmail.toLowerCase() === window.MASTER_EMAIL.toLowerCase()) {
                    document.getElementById('admin-panel-btn').classList.remove('hidden');
                }

                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø¶Ø¨Ø· Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ø¨Ø¯Ù‚Ø©
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        App.updateLastActive(true); // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                    } else if (document.visibilityState === "visible") {
                        App.updateLastActive(false); // Ø¹Ø§Ø¯ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
                    }
                });
            },

            updateUIWithUserData: () => {
                const photo = currentUser.photo || App.getDefaultAvatar();
                document.getElementById('current-user-avatar-home').src = photo;
                document.getElementById('current-user-avatar-note').src = photo;
                document.getElementById('settings-avatar').src = photo;
                document.getElementById('settings-name').innerText = currentUser.name;
                document.getElementById('create-post-avatar').src = photo;
            },

            updateLastActive: async (forceOffline = false) => {
                if(!currentUser) return;
                // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ø·ÙŠÙ‡ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙØ¹Ù„ÙŠØŒ Ù„ÙŠØ³ Ù†Ø§Ù‚Øµ 6 Ø¯Ù‚Ø§Ø¦Ù‚
                const now = forceOffline ? (Date.now() - (1 * 60 * 1000)) : Date.now();
                currentUser.lastActive = now;
                try {
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { lastActive: now });
                } catch(e){}
            },

            setupListeners: () => {
                const errHandler = (e) => console.error("Firebase Read Error:", e);

                onSnapshot(collection(db, USERS_PATH), (snap) => {
                    snap.docs.forEach(d => {
                        const data = d.data();
                        Memory.users[d.id] = data;
                        if(d.id === currentUser.uid) {
                            currentUser.blockedUsers = data.blockedUsers || [];
                            currentUser.mentionsCount = data.mentionsCount || {};
                            App.updateUIWithUserData();
                        }
                    });
                    App.renderChats(); 
                    App.renderFeed(); 
                }, errHandler);

                onSnapshot(collection(db, POSTS_PATH), (snap) => {
                    Memory.posts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFeed();
                }, errHandler);

                onSnapshot(collection(db, COMMENTS_PATH), (snap) => {
                    Memory.comments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(window.currentPostIdForComment) App.renderComments();
                    App.renderFeed(); 
                }, errHandler);

                onSnapshot(collection(db, REQUESTS_PATH), (snap) => {
                    Memory.requests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFriendsTab('requests'); 
                    
                    const myRequests = Memory.requests.filter(r => r.to === currentUser.uid);
                    const badgeSubtab = document.getElementById('badge-requests-subtab'); // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
                    const badgeMainNav = document.getElementById('badge-requests');    // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø²Ø± Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡)
                    
                    if(myRequests.length > 0) {
                        if(badgeSubtab) badgeSubtab.classList.remove('hidden');
                        if(badgeMainNav) badgeMainNav.classList.remove('hidden');
                    } else {
                        if(badgeSubtab) badgeSubtab.classList.add('hidden');
                        if(badgeMainNav) badgeMainNav.classList.add('hidden');
                    }
                }, errHandler);

                onSnapshot(collection(db, FRIENDS_PATH), (snap) => {
                    Memory.friends = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderNotes();
                    App.renderFriendsTab('friends'); 
                    App.renderFriendsTab('suggestions'); 
                }, errHandler);

                onSnapshot(collection(db, NOTES_PATH), (snap) => {
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    Memory.notes = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                        .filter(n => (now - n.timestamp) < oneDay);
                    App.renderNotes();
                }, errHandler);

                onSnapshot(collection(db, MESSAGES_PATH), (snap) => {
                    Memory.messages = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderChats();
                    
                    if(window.currentChatUserId) {
                        let needsRender = false;
                        
                        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©)
                        const isChatOpen = !document.getElementById('chat-modal').classList.contains('hidden');
                        if (isChatOpen && window.currentChatUserId) {
                            const unreadInChat = snap.docs.filter(d => d.data().senderId === window.currentChatUserId && !d.data().read && d.data().participants.includes(currentUser.uid));
                            if(unreadInChat.length > 0) {
                                unreadInChat.forEach(d => updateDoc(d.ref, {read: true}));
                            }
                        }

                        // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø¯Ù‚Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙƒØ±Ø§Ø±
                        snap.docChanges().forEach(change => {
                            const msgData = {id: change.doc.id, ...change.doc.data()};
                            
                            if(msgData.participants.includes(currentUser.uid) && msgData.participants.includes(window.currentChatUserId)) {
                                const existingIndex = window.allMessages.findIndex(m => m.id === msgData.id);
                                
                                if (change.type === 'added') {
                                    if(existingIndex === -1) {
                                        window.allMessages.push(msgData);
                                        needsRender = true;
                                    }
                                } else if (change.type === 'modified') {
                                    if(existingIndex !== -1) {
                                        window.allMessages[existingIndex] = msgData;
                                        needsRender = true;
                                    }
                                } else if (change.type === 'removed') {
                                    if(existingIndex !== -1) {
                                        window.allMessages.splice(existingIndex, 1);
                                        needsRender = true;
                                    }
                                }
                            }
                        });

                        if(needsRender) {
                            // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ ÙˆÙ‡Ù…ÙŠØ© Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø£ÙŠ ØªØ¹Ø§Ø±Ø¶
                            window.allMessages = window.allMessages.filter(m => !m.id.startsWith('temp-'));
                            window.allMessages.sort((a,b) => a.timestamp - b.timestamp);
                            App.renderMessages(false);
                        }
                    }
                }, errHandler);

                onSnapshot(collection(db, TYPING_PATH), (snap) => {
                    if(!window.currentChatUserId) return;
                    const typingDoc = snap.docs.find(d => d.id === `${window.currentChatUserId}_${currentUser.uid}`);
                    const bubble = document.getElementById('live-typing-bubble');
                    if(typingDoc && typingDoc.data().text) {
                        if(Date.now() - typingDoc.data().timestamp < 5000) {
                            bubble.innerText = typingDoc.data().text;
                            bubble.classList.remove('hidden');
                            const container = document.getElementById('chat-messages-container');
                            container.scrollTop = container.scrollHeight;
                            return;
                        }
                    }
                    bubble.classList.add('hidden');
                }, errHandler);

                onSnapshot(collection(db, NOTIFS_PATH), (snap) => {
                    Memory.notifications = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                            .filter(n => n.to === currentUser.uid);
                    App.renderNotifications();
                }, errHandler);

                onSnapshot(collection(db, PINS_PATH), (snap) => {
                    Memory.pins = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderChats();
                }, errHandler);

                onSnapshot(collection(db, MUTES_PATH), (snap) => {
                    Memory.mutes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderChats();
                }, errHandler);

                // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)
                onSnapshot(collection(db, REPORTS_PATH), (snap) => {
                    Memory.reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(currentUser && currentUser.email === window.MASTER_EMAIL) {
                        App.updateReportsBadge();
                        if(!document.getElementById('admin-panel-modal').classList.contains('hidden')) {
                            App.renderReports();
                        }
                    }
                }, errHandler);

                // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
                onSnapshot(collection(db, BANNED_PATH), (snap) => {
                    Memory.banned = snap.docs.map(d => ({id: d.id, ...d.data()}));
                }, errHandler);
            },

            handleTyping: async (text) => {
                const otherUid = window.currentChatUserId;
                if(!otherUid || !currentUser) return;
                try {
                    await setDoc(doc(db, TYPING_PATH, `${currentUser.uid}_${otherUid}`), {
                        text: text,
                        timestamp: Date.now()
                    });
                } catch(e){}
            },

            getPetCharacterSVG: (level) => {
                let skinColor = "#fca5a5";
                let shirtColor, pantsColor, eyeExpr, mouthExpr, accessoriesHTML, auraHTML;
                
                const sadFace = `<circle cx="42" cy="38" r="3" fill="#1f2937"/><circle cx="58" cy="38" r="3" fill="#1f2937"/><path d="M45 55 Q 50 50 55 55" stroke="#1f2937" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
                const neutralFace = `<circle cx="42" cy="38" r="3" fill="#1f2937"/><circle cx="58" cy="38" r="3" fill="#1f2937"/><path d="M45 52 L 55 52" stroke="#1f2937" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
                const happyFace = `<circle cx="42" cy="38" r="3.5" fill="#1f2937"/><circle cx="58" cy="38" r="3.5" fill="#1f2937"/><path d="M44 50 Q 50 58 56 50" stroke="#1f2937" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
                const coolFace = `<path d="M 38 36 L 46 38 L 38 40 Z" fill="#1f2937"/><path d="M 62 36 L 54 38 L 62 40 Z" fill="#1f2937"/><path d="M43 52 Q 50 56 57 50" stroke="#1f2937" stroke-width="2" fill="none" stroke-linecap="round"/>`;
                
                auraHTML = "";
                accessoriesHTML = "";
                
                switch(level) {
                    case 1:
                        shirtColor = "#78716c"; pantsColor = "#57534e"; eyeExpr = sadFace;
                        accessoriesHTML = `<path d="M40 65 L48 65 L45 72 Z" fill="#a8a29e" opacity="0.6"/><line x1="42" y1="67" x2="46" y2="70" stroke="#444" stroke-width="1"/>`;
                        break;
                    case 2:
                        shirtColor = "#a8a29e"; pantsColor = "#78716c"; eyeExpr = neutralFace;
                        break;
                    case 3:
                        shirtColor = "#60a5fa"; pantsColor = "#475569"; eyeExpr = happyFace;
                        break;
                    case 4:
                        shirtColor = "#34d399"; pantsColor = "#334155"; eyeExpr = happyFace;
                        accessoriesHTML = `<circle cx="65" cy="70" r="3" fill="#fbbf24"/>`;
                        break;
                    case 5:
                        shirtColor = "#f43f5e"; pantsColor = "#1e293b"; eyeExpr = happyFace;
                        accessoriesHTML = `<circle cx="65" cy="70" r="3" fill="#fbbf24"/><path d="M30 20 Q 50 10 70 20 Q 50 25 30 20" fill="#3b82f6"/>`;
                        break;
                    case 6:
                        shirtColor = "#a855f7"; pantsColor = "#0f172a"; eyeExpr = coolFace;
                        accessoriesHTML = `<path d="M38 35 h24 v6 h-24 z" fill="#111827" rx="2"/><line x1="50" y1="60" x2="50" y2="80" stroke="#fbbf24" stroke-width="2"/>`;
                        break;
                    case 7:
                        shirtColor = "#ffffff"; pantsColor = "#000000"; eyeExpr = happyFace;
                        accessoriesHTML = `<path d="M35 60 L 50 80 L 65 60" fill="#1e293b"/><path d="M48 60 L 52 60 L 50 70 Z" fill="#ef4444"/>`;
                        break;
                    case 8:
                        shirtColor = "#000000"; pantsColor = "#000000"; eyeExpr = coolFace;
                        accessoriesHTML = `<path d="M35 60 L 50 75 L 65 60 Z" fill="#ffffff"/><path d="M48 60 L 52 60 L 50 70 Z" fill="#000000"/><path d="M30 25 L 30 10 L 70 10 L 70 25 Z" fill="#111827"/><path d="M25 25 L 75 25 L 75 28 L 25 28 Z" fill="#111827"/><circle cx="45" cy="65" r="2" fill="#fbbf24"/><circle cx="55" cy="65" r="2" fill="#fbbf24"/>`;
                        break;
                    case 9:
                        shirtColor = "#1e1b4b"; pantsColor = "#000000"; eyeExpr = happyFace;
                        accessoriesHTML = `<path d="M20 60 Q 15 80 20 95 L 80 95 Q 85 80 80 60 Z" fill="#dc2626" opacity="0.9"/><path d="M35 15 L 42 5 L 50 15 L 58 5 L 65 15 L 65 25 L 35 25 Z" fill="#fbbf24"/><circle cx="42" cy="12" r="2" fill="#ef4444"/><circle cx="50" cy="18" r="2" fill="#3b82f6"/><circle cx="58" cy="12" r="2" fill="#22c55e"/><path d="M40 60 Q 50 70 60 60" stroke="#fbbf24" stroke-width="3" fill="none"/>`;
                        break;
                    case 10:
                        shirtColor = "#172554"; pantsColor = "#000000"; eyeExpr = happyFace;
                        auraHTML = `<circle cx="50" cy="50" r="45" fill="#fef08a" opacity="0.3" filter="blur(4px)"/><circle cx="50" cy="50" r="35" fill="#fbbf24" opacity="0.4" filter="blur(2px)"/>`;
                        accessoriesHTML = `<path d="M15 55 Q 10 80 15 100 L 85 100 Q 90 80 85 55 Z" fill="#7f1d1d" stroke="#fbbf24" stroke-width="2"/><path d="M30 15 L 40 0 L 50 10 L 60 0 L 70 15 L 70 25 L 30 25 Z" fill="#fbbf24"/><circle cx="40" cy="10" r="3" fill="#ef4444"/><circle cx="50" cy="15" r="3" fill="#8b5cf6"/><circle cx="60" cy="10" r="3" fill="#ef4444"/><path d="M40 60 L 50 75 L 60 60" stroke="#fbbf24" stroke-width="4" fill="none"/><polygon points="50,68 53,75 50,82 47,75" fill="#06b6d4"/><line x1="80" y1="40" x2="80" y2="100" stroke="#fbbf24" stroke-width="4" stroke-linecap="round"/><circle cx="80" cy="40" r="6" fill="#06b6d4"/><path d="M 10 30 L 15 35 M 15 30 L 10 35" stroke="#fbbf24" stroke-width="2"/><path d="M 85 20 L 90 25 M 90 20 L 85 25" stroke="#fbbf24" stroke-width="2"/>`;
                        break;
                }

                return `
                <svg class="w-full h-full pet-animate ${level >= 9 ? 'pet-glow-gold' : ''}" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    ${auraHTML}
                    <line x1="42" y1="80" x2="42" y2="95" stroke="${skinColor}" stroke-width="6" stroke-linecap="round"/>
                    <line x1="58" y1="80" x2="58" y2="95" stroke="${skinColor}" stroke-width="6" stroke-linecap="round"/>
                    <line x1="35" y1="65" x2="25" y2="75" stroke="${skinColor}" stroke-width="5" stroke-linecap="round"/>
                    <line x1="65" y1="65" x2="75" y2="75" stroke="${skinColor}" stroke-width="5" stroke-linecap="round"/>
                    <rect x="37" y="75" width="26" height="10" rx="3" fill="${pantsColor}"/>
                    <rect x="33" y="55" width="34" height="22" rx="6" fill="${shirtColor}"/>
                    <rect x="25" y="20" width="50" height="40" rx="20" fill="${skinColor}"/>
                    ${eyeExpr}
                    <circle cx="33" cy="45" r="4" fill="#f87171" opacity="0.4"/>
                    <circle cx="67" cy="45" r="4" fill="#f87171" opacity="0.4"/>
                    ${accessoriesHTML}
                </svg>
                `;
            },

            updateChatPet: (msgs) => {
                const container = document.getElementById('chat-pet-container');
                if(!msgs || msgs.length === 0) {
                    container.innerHTML = ''; 
                    const existingPopup = document.getElementById('pet-popup-overlay');
                    if(existingPopup) existingPopup.remove();
                    return;
                }

                const totalMsgs = msgs.length;
                const lastMsg = msgs[msgs.length - 1];
                const daysSinceLastMsg = (Date.now() - lastMsg.timestamp) / (1000 * 60 * 60 * 24);
                
                let level = 1;
                
                if(daysSinceLastMsg >= 3) {
                    level = 1;
                } else {
                    if (totalMsgs >= 1000) level = 10;
                    else if (totalMsgs >= 500) level = 9;
                    else if (totalMsgs >= 300) level = 8;
                    else if (totalMsgs >= 150) level = 7;
                    else if (totalMsgs >= 80) level = 6;
                    else if (totalMsgs >= 40) level = 5;
                    else if (totalMsgs >= 20) level = 4;
                    else if (totalMsgs >= 10) level = 3;
                    else if (totalMsgs >= 5) level = 2;
                }

                let popupMessage = "";
                if (daysSinceLastMsg >= 1 && daysSinceLastMsg < 3) {
                    popupMessage = "ğŸš¨ Ø§Ù†Ù‚Ø°ÙˆÙ†ÙŠ!\nØ±Ø§Ø­ Ø§Ø±Ø¬Ø¹ ÙÙ‚ÙŠØ± ØªÙƒÙ„Ù…Ùˆ Ø¹Ù„Ù‰ Ø§ÙŠ Ø´ÙŠ...\nÙ†Ù…ÙŠÙ…Ø© Ø§Ùˆ ØºÙŠØ¨Ø© Ø§Ù„Ù…Ù‡Ù… ØªØªÙƒÙ„Ù…ÙˆÙ† ğŸ˜­";
                } else if (daysSinceLastMsg >= 3) {
                    popupMessage = "ğŸ’” Ù„Ù„Ø£Ø³Ù Ø±Ø¬Ø¹Øª ÙÙ‚ÙŠØ±...\nÙ…Ø§ ØªÙƒÙ„Ù…ØªÙˆ ÙˆÙŠØ§ÙŠ 3 Ø§ÙŠØ§Ù… ğŸ˜¢";
                } else {
                    popupMessage = "  Ù‡Ù„Ùˆ Ø§Ù†ÙŠ Ø·Ø±ÙÙƒÙ… Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø´ÙŠØ·Ø§Ù† ğŸ˜‚!\nÙ„Ø§ Ù„Ø§ Ø§Ø´Ø§Ù‚Ø© Ø§Ù†ÙŠ Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ø§Ø°Ø§ Ù…Ø§ ØªØªÙƒÙ„Ù…ÙˆÙ†\n ÙƒÙ„ ÙŠÙˆÙ… Ø§Ø±Ø¬Ø¹ ÙÙ‚ÙŠØ± ğŸ’” Ù…Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙƒ... ";
                }

                container.setAttribute('data-pet-message', popupMessage);
                container.setAttribute('data-pet-level', level);
                container.innerHTML = App.getPetCharacterSVG(level);

                const existingPopup = document.getElementById('pet-popup-overlay');
                if(existingPopup) existingPopup.remove();

                container.onclick = (e) => {
                    e.stopPropagation();
                    App.showPetPopup(popupMessage);
                };
            },

            showPetPopup: (message) => {
                if(window.petPopupVisible) {
                    App.hidePetPopup();
                    return;
                }

                const existingPopup = document.getElementById('pet-popup-overlay');
                if(existingPopup) existingPopup.remove();

                const overlay = document.createElement('div');
                overlay.id = 'pet-popup-overlay';
                overlay.className = 'pet-popup-overlay';
                
                const content = document.createElement('div');
                content.className = 'pet-popup-content';
                content.textContent = message;
                
                overlay.appendChild(content);
                document.body.appendChild(overlay);

                setTimeout(() => {
                    overlay.classList.add('show');
                    content.classList.add('show');
                }, 10);

                window.petPopupVisible = true;

                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        App.hidePetPopup();
                    }
                };
            },

            hidePetPopup: () => {
                const overlay = document.getElementById('pet-popup-overlay');
                if(overlay) {
                    overlay.classList.remove('show');
                    setTimeout(() => {
                        overlay.remove();
                    }, 300);
                }
                window.petPopupVisible = false;
            },

            isFriend: (uid1, uid2) => {
                return Memory.friends.some(f => 
                    (f.user1 === uid1 && f.user2 === uid2) || 
                    (f.user1 === uid2 && f.user2 === uid1)
                );
            },
            isBlocked: (uid) => {
                return currentUser.blockedUsers?.includes(uid);
            },
            isMuted: (otherUid) => {
                const mute = Memory.mutes.find(m => 
                    m.userId === currentUser.uid && m.chatId === otherUid && m.until > Date.now()
                );
                return !!mute;
            },
            timeAgo: (timestamp) => {
                if(!timestamp) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                if (seconds < 60) return "Ø§Ù„Ø¢Ù†";
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
                const days = Math.floor(hours / 24);
                return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
            },
            isOnline: (lastActive) => {
                if(!lastActive) return false;
                return (Date.now() - lastActive) < (5 * 60 * 1000);
            },
            parseMentions: (text) => {
                return parseTextWithLinks(text);
            },
            notifyMentions: async (text, type, linkId) => {
                const matches = text.match(/@([\w_.]+)/g);
                if(!matches) return;
                const usernames = matches.map(m => m.substring(1));
                const usersArray = Object.values(Memory.users);
                
                for(let un of usernames) {
                    const mentionedUser = usersArray.find(u => u.username === un);
                    if(mentionedUser && mentionedUser.uid !== currentUser.uid && !App.isBlocked(mentionedUser.uid)) {
                        await App.sendNotification(mentionedUser.uid, `Ù‚Ø§Ù… Ø¨Ø°ÙƒØ±Ùƒ ÙÙŠ ${type}`, linkId);
                    }
                }
            },
            incrementMentionCount: async (uid) => {
                let counts = currentUser.mentionsCount || {};
                counts[uid] = (counts[uid] || 0) + 1;
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { mentionsCount: counts });
            },

            // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·)
            showPostOptions: (postId, authorId) => {
                const content = document.getElementById('action-modal-content');
                const isMyPost = authorId === currentUser.uid;
                
                let buttons = '';
                
                if(isMyPost) {
                    // Ù„Ù„Ù…Ø§Ù„Ùƒ: ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¨Ù„Ø§Øº
                    buttons += `
                        <button onclick="App.editPost('${postId}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-green-50 btn-tap text-green-600">
                            <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span> <i class="ph-fill ph-pencil-simple text-lg"></i>
                        </button>
                    `;
                }
                
                // Ø²Ø± Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù„Ù„Ø¬Ù…ÙŠØ¹
                buttons += `
                    <button onclick="App.reportPost('${postId}')" class="w-full flex justify-between items-center p-4 hover:bg-red-50 btn-tap text-red-600">
                        <span>Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span> <i class="ph-fill ph-flag text-lg"></i>
                    </button>
                `;
                
                content.innerHTML = buttons;
                UI.openModal('action-modal');
            },

            // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø´ÙˆØ±
            editPost: (postId) => {
                UI.closeModal('action-modal');
                UI.openModal('edit-post-modal', postId);
            },

            // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ±
            updatePost: async () => {
                const newText = document.getElementById('edit-post-input').value.trim();
                if(!newText || !window.currentEditPostId) return;
                
                await updateDoc(doc(db, POSTS_PATH, window.currentEditPostId), { text: newText });
                UI.closeModal('edit-post-modal');
                UI.showMessage('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±');
            },

            // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ù†Ø´ÙˆØ±
            reportPost: (postId) => {
                UI.closeModal('action-modal');
                UI.openModal('report-post-modal', postId);
            },

            // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº
            submitReport: async (type, targetId, reason) => {
                if(!targetId) return;
                
                await addDoc(collection(db, REPORTS_PATH), {
                    type: type,
                    targetId: targetId,
                    reportedBy: currentUser.uid,
                    reason: reason,
                    timestamp: Date.now(),
                    status: 'pending'
                });
                
                UI.closeModal('report-post-modal');
                UI.showMessage('ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ');
            },

            // Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            switchAdminTab: (tabId) => {
                document.getElementById('admin-tab-reports').className = 'flex-1 py-3 text-center font-bold border-b-2 border-transparent';
                document.getElementById('admin-tab-banned').className = 'flex-1 py-3 text-center font-bold border-b-2 border-transparent';
                
                if(tabId === 'reports') {
                    document.getElementById('admin-tab-reports').className = 'flex-1 py-3 text-center font-bold border-b-2 border-blue-600 text-blue-600';
                    document.getElementById('admin-reports-tab').classList.remove('hidden');
                    document.getElementById('admin-banned-tab').classList.add('hidden');
                    App.renderReports();
                } else {
                    document.getElementById('admin-tab-banned').className = 'flex-1 py-3 text-center font-bold border-b-2 border-blue-600 text-blue-600';
                    document.getElementById('admin-reports-tab').classList.add('hidden');
                    document.getElementById('admin-banned-tab').classList.remove('hidden');
                }
            },

            updateReportsBadge: () => {
                const pendingReports = Memory.reports.filter(r => r.status === 'pending');
                const badge = document.getElementById('admin-reports-badge');
                if(pendingReports.length > 0) {
                    badge.classList.remove('hidden');
                    badge.innerText = pendingReports.length;
                } else {
                    badge.classList.add('hidden');
                }
            },

            // ÙÙŠ Ø¯Ø§Ù„Ø© renderReportsØŒ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:
renderReports: () => {
    const container = document.getElementById('reports-list');
    container.innerHTML = '';
    
    const pendingReports = Memory.reports.filter(r => r.status === 'pending').sort((a,b) => b.timestamp - a.timestamp);
    
    if(pendingReports.length === 0) {
        container.innerHTML = '<div class="text-center opacity-50 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¨Ù„Ø§ØºØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
        return;
    }

    pendingReports.forEach(report => {
        const reporter = Memory.users[report.reportedBy];
        const post = Memory.posts.find(p => p.id === report.targetId);
        const postAuthor = post ? Memory.users[post.authorId] : null;
        
        if(!reporter || !post || !postAuthor) return;

        const el = document.createElement('div');
        el.className = 'theme-card p-4 rounded-xl border space-y-3';
        el.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="text-sm font-bold text-red-600">${report.reason}</span>
                <span class="text-xs opacity-60">${App.timeAgo(report.timestamp)}</span>
            </div>
            <div class="flex items-center gap-2 justify-between border-t pt-3">
                <div class="flex-1">
                    <p class="text-xs opacity-60">Ø§Ù„Ù…Ø¨Ù„Øº:</p>
                    <div class="flex items-center gap-2 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${reporter.uid}')">
                        <img src="${reporter.photo || App.getDefaultAvatar()}" class="w-6 h-6 rounded-full">
                        <span class="font-bold text-sm">${reporter.name}</span>
                    </div>
                </div>
                <div class="flex-1">
                    <p class="text-xs opacity-60">ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±:</p>
                    <div class="flex items-center gap-2 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${postAuthor.uid}')">
                        <img src="${postAuthor.photo || App.getDefaultAvatar()}" class="w-6 h-6 rounded-full">
                        <span class="font-bold text-sm">${postAuthor.name}</span>
                    </div>
                </div>
            </div>
            <div class="border-t pt-3">
                <p class="text-sm opacity-80">${post.text.substring(0, 100)}${post.text.length > 100 ? '...' : ''}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="App.banReporter('${report.id}', '${reporter.uid}')" class="flex-1 bg-red-500 text-white p-2 rounded-xl text-sm font-bold btn-tap">Ø­Ø¸Ø± Ø§Ù„Ù…Ø¨Ù„Øº</button>
                <button onclick="App.banPostOwner('${report.id}', '${postAuthor.uid}')" class="flex-1 bg-red-600 text-white p-2 rounded-xl text-sm font-bold btn-tap">Ø­Ø¸Ø± ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
                <button onclick="App.rejectReport('${report.id}')" class="flex-1 bg-gray-500 text-white p-2 rounded-xl text-sm font-bold btn-tap">Ø±ÙØ¶</button>
            </div>
        `;
        container.appendChild(el);
    });
},

            banReporter: async (reportId, reporterUid) => {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                    await banDevice(reporterUid);
                    await updateDoc(doc(db, REPORTS_PATH, reportId), { status: 'processed' });
                    UI.showMessage('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                    App.renderReports();
                }
            },

            banPostOwner: async (reportId, ownerUid) => {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                    const report = Memory.reports.find(r => r.id === reportId);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø­ØªÙ‰ Ù„Ùˆ ÙƒÙ†Øª ØªØ®ØªØ¨Ø±Ù‡ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ
                    if (report && report.reportedBy) {
                        await addDoc(collection(db, NOTIFS_PATH), {
                            to: report.reportedBy,
                            from: currentUser.uid,
                            text: 'Ù‚Ù…Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¨Ù„Ø§ØºÙƒ ÙˆØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù„Ø§Ø²Ù… Ø¨Ø­Ù‚ Ø§Ù„Ù…Ø®Ø§Ù„Ù. Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø³Ø§Ù‡Ù…ØªÙƒ ÙÙŠ Ø¬Ø¹Ù„ Ø²Ø§ÙŠÙ„Ùˆ Ù…Ø¬ØªÙ…Ø¹Ø§Ù‹ Ø¢Ù…Ù†Ø§Ù‹ ğŸ›¡ï¸',
                            linkId: null,
                            timestamp: Date.now(),
                            read: false
                        });
                    }

                    await banDevice(ownerUid); 
                    await updateDoc(doc(db, REPORTS_PATH, reportId), { status: 'processed' });
                    
                    UI.showMessage('ØªÙ… Ø­Ø¸Ø± ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº');
                    App.renderReports();
                }
            },

            rejectReport: async (reportId) => {
                const report = Memory.reports.find(r => r.id === reportId);
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„
                if (report && report.reportedBy) {
                    await addDoc(collection(db, NOTIFS_PATH), {
                        to: report.reportedBy,
                        from: currentUser.uid,
                        text: 'Ù‚Ù…Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¨Ù„Ø§ØºÙƒ ÙˆÙ„Ù… Ù†Ø¬Ø¯ Ø£ÙŠ Ø§Ù†ØªÙ‡Ø§Ùƒ Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒ ğŸ¤',
                        linkId: null,
                        timestamp: Date.now(),
                        read: false
                    });
                }

                await updateDoc(doc(db, REPORTS_PATH, reportId), { status: 'rejected' });
                
                UI.showMessage('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº');
                App.renderReports();
            },

            rejectReport: async (reportId) => {
                const report = Memory.reports.find(r => r.id === reportId);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„Ù‡
                if (report && report.reportedBy) {
                    await App.sendNotification(report.reportedBy, 'Ù‚Ù…Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¨Ù„Ø§ØºÙƒ ÙˆÙ„Ù… Ù†Ø¬Ø¯ Ø£ÙŠ Ø§Ù†ØªÙ‡Ø§Ùƒ Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒ ğŸ¤', null);
                }

                await updateDoc(doc(db, REPORTS_PATH, reportId), { status: 'rejected' });
                
                UI.showMessage('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº');
                App.renderReports();
            },

            rejectReport: async (reportId) => {
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¥Ø¨Ù„Ø§Øº
                const report = Memory.reports.find(r => r.id === reportId);
                
                await updateDoc(doc(db, REPORTS_PATH, reportId), { status: 'rejected' });
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø¨Ù„Øº Ø¨Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø§ ÙŠØ®Ø§Ù„Ù Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†
                if (report && report.reportedBy) {
                    App.sendNotification(report.reportedBy, 'Ù‚Ù…Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¨Ù„Ø§ØºÙƒ ÙˆÙ„Ù… Ù†Ø¬Ø¯ Ø£ÙŠ Ø§Ù†ØªÙ‡Ø§Ùƒ Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒ ğŸ¤', null);
                }

                UI.showMessage('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº');
                App.renderReports();
            },

            searchUsersForBan: () => {
                const query = document.getElementById('admin-search-input').value.toLowerCase().trim();
                const container = document.getElementById('admin-search-results');
                container.innerHTML = '';

                if(!query) return;

                const results = Object.values(Memory.users).filter(u => 
                    u.username.toLowerCase().includes(query) ||
                    u.name.toLowerCase().includes(query)
                ).slice(0, 5);

                results.forEach(u => {
                    const isBanned = Memory.banned.some(b => b.id === u.uid);
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3 theme-card rounded-xl border';
                    el.innerHTML = `
                        <div class="flex items-center gap-2">
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-8 h-8 rounded-full">
                            <div>
                                <span class="font-bold block">${u.name}</span>
                                <span class="text-xs opacity-60">@${u.username}</span>
                            </div>
                        </div>
                        <button onclick="App.${isBanned ? 'unbanUser' : 'banUser'}('${u.uid}')" class="${isBanned ? 'bg-green-500' : 'bg-red-500'} text-white px-3 py-1 rounded-full text-sm font-bold btn-tap">
                            ${isBanned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}
                        </button>
                    `;
                    container.appendChild(el);
                });
            },

            banUser: async (uid) => {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                    await banDevice(uid);
                    document.getElementById('admin-search-input').value = '';
                    document.getElementById('admin-search-results').innerHTML = '';
                    UI.showMessage('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                }
            },

            unbanUser: async (uid) => {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                    await unbanDevice(uid);
                    document.getElementById('admin-search-input').value = '';
                    document.getElementById('admin-search-results').innerHTML = '';
                    UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                }
            },

            showBannedUsers: () => {
                const list = document.getElementById('banned-users-list');
                if(list.classList.contains('hidden')) {
                    list.innerHTML = '';
                    Memory.banned.forEach(b => {
                        const user = Memory.users[b.id];
                        if(!user) return;
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between p-3 theme-card rounded-xl border';
                        el.innerHTML = `
                            <div class="flex items-center gap-2">
                                <img src="${user.photo || App.getDefaultAvatar()}" class="w-8 h-8 rounded-full">
                                <div>
                                    <span class="font-bold block">${user.name}</span>
                                    <span class="text-xs opacity-60">@${user.username}</span>
                                </div>
                            </div>
                            <button onclick="App.unbanUser('${user.uid}')" class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold btn-tap">
                                Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±
                            </button>
                        `;
                        list.appendChild(el);
                    });
                    list.classList.remove('hidden');
                } else {
                    list.classList.add('hidden');
                }
            },

            renderFeed: () => {
                const container = document.getElementById('feed-container');
                container.innerHTML = '';
                
                const sortedPosts = [...Memory.posts].sort((a,b) => b.timestamp - a.timestamp);
                let visibleCount = 0;

                sortedPosts.forEach(post => {
                    const author = Memory.users[post.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    if(author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid)) return;
                    
                    visibleCount++;
                    const isLiked = post.likes && post.likes.includes(currentUser.uid);
                    const likesCount = post.likes ? post.likes.length : 0;
                    const commentsCount = Memory.comments.filter(c => c.postId === post.id).length;
                    const parsedText = App.parseMentions(post.text);

                    const postEl = document.createElement('div');
                    postEl.className = 'theme-card rounded-2xl shadow-sm border overflow-hidden mb-3';
                    postEl.innerHTML = `
                        <div class="p-3.5 flex items-center justify-between">
                            <div class="flex items-center gap-3 cursor-pointer group btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                                <img src="${author.photo || App.getDefaultAvatar()}" class="w-11 h-11 rounded-full object-cover border border-gray-100">
                                <div>
                                    <h4 class="font-bold leading-tight group-hover:text-blue-600 transition-colors flex items-center gap-1 theme-text">${author.name}</h4>
                                    <span class="text-xs opacity-60">${App.timeAgo(post.timestamp)}</span>
                                </div>
                            </div>
                            <button onclick="App.showPostOptions('${post.id}', '${author.uid}')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-colors btn-tap">
                                <i class="ph ph-dots-three-vertical text-lg"></i>
                            </button>
                        </div>
                        <div class="px-4 py-2 theme-text text-[15px] leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-4 py-3 text-xs opacity-60 flex justify-between items-center mt-2 border-b" style="border-color: var(--border-color);">
                            <div class="flex items-center gap-1"><i class="ph-fill ph-thumbs-up text-blue-500"></i> ${likesCount}</div>
                            <div>${commentsCount} ØªØ¹Ù„ÙŠÙ‚</div>
                        </div>
                        <div class="flex p-1">
                            <button onclick="App.toggleLike('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl btn-tap font-semibold transition-colors ${isLiked ? 'text-blue-600 bg-blue-50' : 'theme-text hover:bg-gray-100/10'}">
                                <i class="${isLiked ? 'ph-fill' : 'ph'} ph-thumbs-up text-xl"></i> Ø£Ø¹Ø¬Ø¨Ù†ÙŠ
                            </button>
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl theme-text font-semibold hover:bg-gray-100/10 transition-colors btn-tap">
                                <i class="ph ph-chat-centered text-xl"></i> ØªØ¹Ù„ÙŠÙ‚
                            </button>
                            <button onclick="App.sharePost('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl theme-text font-semibold hover:bg-gray-100/10 transition-colors btn-tap">
                                <i class="ph ph-share-network text-xl"></i> Ù…Ø´Ø§Ø±ÙƒØ©
                            </button>
                        </div>
                    `;
                    container.appendChild(postEl);
                });

                if(visibleCount === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-newspaper text-4xl mb-2 block mx-auto"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                }
            },

            createPost: async () => {
                const text = document.getElementById('post-text-input').value.trim();
                if(!text) return UI.showMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± ÙØ§Ø±Øº');
                
                UI.closeModal('create-post-modal');
                document.getElementById('post-text-input').value = '';
                
                const postRef = await addDoc(collection(db, POSTS_PATH), {
                    authorId: currentUser.uid, text: text, timestamp: Date.now(), likes: []
                });
                App.notifyMentions(text, 'Ù…Ù†Ø´ÙˆØ±', postRef.id);
                UI.showMessage('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
            },

            deletePost: async (postId) => {
                if(confirm('Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ')) {
                    await deleteDoc(doc(db, POSTS_PATH, postId));
                    UI.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±');
                }
            },

            toggleLike: async (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                if(!post) return;
                
                let newLikes = post.likes ? [...post.likes] : [];
                if(newLikes.includes(currentUser.uid)) {
                    newLikes = newLikes.filter(id => id !== currentUser.uid);
                } else {
                    newLikes.push(currentUser.uid);
                    if(post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                        App.sendNotification(post.authorId, 'Ø£Ø¹Ø¬Ø¨ Ø¨Ù…Ù†Ø´ÙˆØ±Ùƒ', postId);
                    }
                }
                await updateDoc(doc(db, POSTS_PATH, postId), { likes: newLikes });
            },

            sharePost: async (postId) => {
                const shareUrl = window.location.origin + window.location.pathname + '?post=' + postId;
                if (navigator.share) {
                    try { await navigator.share({ title: 'ØªØ·Ø¨ÙŠÙ‚ Ø²Ø§ÙŠÙ„Ùˆ', url: shareUrl }); } catch (err) {}
                } else {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        UI.showMessage("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
                    }).catch(() => {
                        const tempInput = document.createElement("input");
                        tempInput.value = shareUrl;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand("copy");
                        document.body.removeChild(tempInput);
                        UI.showMessage("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
                    });
                }
            },

            openSinglePost: (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                const container = document.getElementById('single-post-container');
                
                if(!post) {
                    container.innerHTML = '<div class="text-center py-20 opacity-60">Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
                    UI.openModal('single-post-modal');
                    return;
                }
                
                if(App.isBlocked(post.authorId)) {
                    container.innerHTML = '<div class="text-center py-20 opacity-60">Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¤ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const author = Memory.users[post.authorId];
                if(!author) {
                    container.innerHTML = '<div class="text-center py-20 opacity-60">ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
                    UI.openModal('single-post-modal');
                    return;
                }
                
                if(author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid)) {
                    container.innerHTML = '<div class="text-center py-20 opacity-60">Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø®Ø§Øµ ÙˆÙ„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const parsedText = App.parseMentions(post.text);
                const likesCount = post.likes ? post.likes.length : 0;
                
                container.innerHTML = `
                    <div class="theme-card rounded-2xl shadow-sm border overflow-hidden mt-4">
                        <div class="p-4 flex items-center gap-3 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            <div>
                                <h4 class="font-bold text-lg flex items-center gap-1 theme-text">${author.name}</h4>
                                <span class="text-sm opacity-60">${App.timeAgo(post.timestamp)}</span>
                            </div>
                        </div>
                        <div class="px-5 py-3 theme-text text-lg leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-5 py-3 text-sm opacity-60 border-t mt-2 flex justify-between" style="border-color: var(--border-color);">
                            <span class="font-bold text-blue-600">${likesCount} Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª</span>
                        </div>
                        <div class="p-4">
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap shadow-md">Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
                        </div>
                    </div>
                `;
                UI.openModal('single-post-modal');
            },

            renderComments: () => {
                if(!window.currentPostIdForComment) return;
                const container = document.getElementById('comments-list');
                container.innerHTML = '';
                
                const postComments = Memory.comments
                    .filter(c => c.postId === window.currentPostIdForComment)
                    .sort((a,b) => a.timestamp - b.timestamp);

                if(postComments.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-chat-centered text-4xl mb-2 block mx-auto"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚</div>';
                    return;
                }

                postComments.forEach(c => {
                    const author = Memory.users[c.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    const parsedText = App.parseMentions(c.text);

                    const el = document.createElement('div');
                    el.className = 'flex gap-3 items-start';
                    el.innerHTML = `
                        <img src="${author.photo || App.getDefaultAvatar()}" class="w-10 h-10 rounded-full object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openProfileByUsername('${author.username}')">
                        <div class="flex-1">
                            <div class="theme-bg rounded-2xl rounded-tr-sm p-3.5 inline-block min-w-[50%] max-w-full shadow-sm border">
                                <h5 class="font-bold text-sm theme-text cursor-pointer flex items-center gap-1" onclick="UI.openProfileByUsername('${author.username}')">${author.name}</h5>
                                <p class="theme-text text-[15px] mt-1 break-words">${parsedText}</p>
                            </div>
                            <span class="text-[11px] opacity-60 mx-2 mt-1 block">${App.timeAgo(c.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
                setTimeout(() => container.scrollTop = container.scrollHeight, 10);
            },

            addComment: async () => {
                const inputEl = document.getElementById('comment-input');
                const text = inputEl.value.trim();
                const postId = window.currentPostIdForComment;
                if(!text || !postId) return;
                
                inputEl.value = '';
                inputEl.focus(); 
                
                await addDoc(collection(db, COMMENTS_PATH), {
                    postId: postId, authorId: currentUser.uid, text: text, timestamp: Date.now()
                });

                const post = Memory.posts.find(p => p.id === postId);
                if(post && post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                    App.sendNotification(post.authorId, 'Ø¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ùƒ', postId);
                }
                App.notifyMentions(text, 'ØªØ¹Ù„ÙŠÙ‚', postId);
            },

            // --- Ø¨Ø¯Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ØªÙˆØ±ÙŠØ§Øª (Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª) Ø§Ù„Ù…Ø­Ø¯Ø« ---
            renderNotes: () => {
                const container = document.getElementById('notes-container');
                const myBtnContainer = container.firstElementChild.outerHTML;
                container.innerHTML = myBtnContainer;

                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ¹Ø§Ù„Ø© ÙÙ‚Ø· ÙˆØªØ¬Ù…ÙŠØ¹Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const activeNotes = Memory.notes.filter(n => (now - n.timestamp) < oneDay).sort((a,b) => a.timestamp - b.timestamp);
                
                const groupedNotes = {};
                activeNotes.forEach(n => {
                    if(!groupedNotes[n.authorId]) groupedNotes[n.authorId] = [];
                    groupedNotes[n.authorId].push(n);
                });

                const myNotes = groupedNotes[currentUser.uid] || [];
                const myBtnEl = container.firstElementChild;
                const myAvatar = myBtnEl.querySelector('#current-user-avatar-note');
                const myPlusIcon = myBtnEl.querySelector('#my-note-plus-icon');
                
                // Ø±Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ù‚Ø·Ø¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Gradient)
                const getConicGradient = (count, isAllViewed) => {
                    if(count === 0) return '';
                    if(count === 1) return `conic-gradient(${isAllViewed ? '#9ca3af' : '#3b82f6'} 100%, transparent 0)`;
                    
                    const gap = 5; // Ø§Ù„ÙØ±Ø§Øº Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
                    const segment = (360 - (count * gap)) / count;
                    let grad = [];
                    let currentAngle = 0;
                    const color = isAllViewed ? '#9ca3af' : '#3b82f6'; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ

                    for(let i=0; i<count; i++) {
                        grad.push(`${color} ${currentAngle}deg ${currentAngle + segment}deg`);
                        grad.push(`transparent ${currentAngle + segment}deg ${currentAngle + segment + gap}deg`);
                        currentAngle += segment + gap;
                    }
                    return `conic-gradient(${grad.join(', ')})`;
                };

                if(myNotes.length > 0) {
                    const isAllViewed = myNotes.every(n => n.viewers && n.viewers.includes(currentUser.uid));
                    myAvatar.parentElement.style.background = getConicGradient(myNotes.length, isAllViewed);
                    myAvatar.parentElement.style.padding = '3px';
                    myAvatar.parentElement.style.borderRadius = '50%';
                    myAvatar.classList.replace('border-transparent', 'border-white');
                    
                    // Ø§Ù„Ø³Ù‡Ù… Ø§Ù„ØµØºÙŠØ± Ù„Ù„Ø¥Ø¶Ø§ÙØ© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 5)
                    if(myNotes.length < 5) {
                        myPlusIcon.classList.remove('hidden');
                        myPlusIcon.innerHTML = '<i class="ph ph-plus text-white text-[10px] font-bold"></i>';
                        myPlusIcon.onclick = (e) => { e.stopPropagation(); UI.openModal('create-note-modal'); };
                    } else {
                        myPlusIcon.classList.add('hidden');
                    }
                    
                    myBtnEl.onclick = () => App.startStorySession(currentUser.uid, groupedNotes);
                } else {
                    myAvatar.src = currentUser.photo || App.getDefaultAvatar();
                    myAvatar.parentElement.style.background = 'none';
                    myAvatar.classList.replace('border-white', 'border-transparent');
                    myPlusIcon.classList.remove('hidden');
                    myBtnEl.onclick = () => UI.openModal('create-note-modal');
                }

                // Ø±Ø³Ù… Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
                Object.keys(groupedNotes).forEach(authorId => {
                    if(authorId === currentUser.uid) return; // ØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if(!App.isFriend(currentUser.uid, authorId) || App.isBlocked(authorId)) return;

                    const author = Memory.users[authorId];
                    if(!author) return;

                    const userNotes = groupedNotes[authorId];
                    const isAllViewed = userNotes.every(n => n.viewers && n.viewers.includes(currentUser.uid));

                    const el = document.createElement('div');
                    el.className = 'inline-flex flex-col items-center cursor-pointer shrink-0 btn-tap w-16';
                    el.style.scrollSnapAlign = 'start';
                    const shortName = author.name.split(' ')[0];
                    
                    el.innerHTML = `
                        <div class="relative rounded-full" style="background: ${getConicGradient(userNotes.length, isAllViewed)}; padding: 3px;">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-14 h-14 rounded-full object-cover border-2 border-[var(--bg-color)] shadow-sm">
                        </div>
                        <span class="text-[11px] font-bold mt-1 w-full text-center truncate theme-text ${!isAllViewed ? 'text-blue-600' : ''}">${shortName}</span>
                    `;
                    el.onclick = () => { App.startStorySession(authorId, groupedNotes); };
                    
                    // Ø§Ù„ØªÙŠ Ù„Ù… ØªØ´Ø§Ù‡Ø¯Ù‡Ø§ ØªØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹
                    if(isAllViewed) container.appendChild(el);
                    else container.insertBefore(el, container.children[1]);
                });
            },

            // Ù…Ù†Ø·Ù‚ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ØªÙˆØ±ÙŠØ§Øª
            storyTimer: null,
            currentStoryAuthorId: null,
            currentStoryIndex: 0,
            allStoryGroups: {},
            storyAuthorsOrder: [],

            startStorySession: (authorId, groupedNotes) => {
                App.allStoryGroups = groupedNotes;
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ† (Ø§Ù„Ø°ÙŠ Ø¶ØºØ·Øª Ø¹Ù„ÙŠÙ‡ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ØªØ´Ø§Ù‡Ø¯Ù‡Ù…)
                App.storyAuthorsOrder = Object.keys(groupedNotes).filter(id => id !== currentUser.uid && App.isFriend(currentUser.uid, id) && !App.isBlocked(id));
                if(authorId !== currentUser.uid) {
                    App.storyAuthorsOrder = [authorId, ...App.storyAuthorsOrder.filter(id => id !== authorId)];
                } else {
                    App.storyAuthorsOrder = [currentUser.uid]; // Ø¥Ø°Ø§ Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ÙØ³Ù‡ ÙŠØ´Ø§Ù‡Ø¯ Ù†ÙØ³Ù‡ ÙÙ‚Ø·
                }

                App.currentStoryAuthorId = authorId;
                App.currentStoryIndex = 0;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø³ØªÙˆØ±ÙŠ ØºÙŠØ± Ù…Ø´Ø§Ù‡ÙØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const notes = App.allStoryGroups[authorId];
                const firstUnreadIndex = notes.findIndex(n => !(n.viewers && n.viewers.includes(currentUser.uid)));
                if(firstUnreadIndex !== -1) App.currentStoryIndex = firstUnreadIndex;

                UI.openModal('note-view-modal');
                App.renderCurrentStory();
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ØªÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ Ø¨Ø§Ù„ÙˆØ³Ø·
                const pauseArea = document.getElementById('story-pause-area');
                pauseArea.onmousedown = () => clearTimeout(App.storyTimer);
                pauseArea.ontouchstart = () => clearTimeout(App.storyTimer);
                pauseArea.onmouseup = () => App.resumeStoryTimer();
                pauseArea.ontouchend = () => App.resumeStoryTimer();
            },

            renderCurrentStory: async () => {
                clearTimeout(App.storyTimer);
                const authorId = App.currentStoryAuthorId;
                const notes = App.allStoryGroups[authorId];
                const author = Memory.users[authorId];
                if(!notes || !author) return App.closeStoryViewer();

                const note = notes[App.currentStoryIndex];
                window.noteViewId = note.id;
                window.noteViewAuthorId = authorId;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                document.getElementById('nv-avatar').src = author.photo || App.getDefaultAvatar();
                document.getElementById('nv-name').innerText = author.name;
                document.getElementById('nv-time').innerText = App.timeAgo(note.timestamp);
                document.getElementById('nv-text').innerHTML = App.parseMentions(note.text);

                // Ø±Ø³Ù… Ø£Ø´Ø±Ø·Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
                const progContainer = document.getElementById('story-progress-container');
                progContainer.innerHTML = '';
                notes.forEach((n, idx) => {
                    const bar = document.createElement('div');
                    bar.className = 'flex-1 h-1 bg-white/30 rounded-full overflow-hidden';
                    let innerClass = 'h-full bg-white transition-all duration-[5000ms] ease-linear w-0';
                    
                    if(idx < App.currentStoryIndex) innerClass = 'h-full bg-white w-full'; // ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡
                    else if (idx === App.currentStoryIndex) innerClass = 'h-full bg-white w-0'; // Ø§Ù„Ø­Ø§Ù„ÙŠ
                    
                    bar.innerHTML = `<div id="story-prog-inner-${idx}" class="${innerClass}"></div>`;
                    progContainer.appendChild(bar);
                });

                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„ÙŠ
                setTimeout(() => {
                    const currentBar = document.getElementById(`story-prog-inner-${App.currentStoryIndex}`);
                    if(currentBar) currentBar.style.width = '100%';
                }, 50);

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
                if(authorId !== currentUser.uid) {
                    let viewers = note.viewers || [];
                    if(!viewers.includes(currentUser.uid)) {
                        viewers.push(currentUser.uid);
                        try { await updateDoc(doc(db, NOTES_PATH, note.id), { viewers }); } catch(e){}
                    }
                    document.getElementById('note-reply-section').classList.remove('hidden');
                    document.getElementById('note-reply-section').classList.add('flex');
                    document.getElementById('note-viewers-section').classList.add('hidden');
                    document.getElementById('nv-options-btn').classList.add('hidden');
                } else {
                    document.getElementById('note-reply-section').classList.add('hidden');
                    document.getElementById('note-viewers-section').classList.remove('hidden');
                    document.getElementById('note-viewers-section').classList.add('flex');
                    document.getElementById('nv-options-btn').classList.remove('hidden');
                    document.getElementById('note-viewers-count').innerText = (note.viewers || []).length;
                    document.getElementById('nv-options-btn').onclick = () => {
                        App.openManageNote(note.id, note.text);
                        App.closeStoryViewer();
                    };
                }

                App.resumeStoryTimer();
            },

            resumeStoryTimer: () => {
                clearTimeout(App.storyTimer);
                App.storyTimer = setTimeout(() => {
                    App.nextStory();
                }, 5000); // 5 Ø«ÙˆØ§Ù†ÙŠ Ù„ÙƒÙ„ Ø³ØªÙˆØ±ÙŠ
            },

            nextStory: () => {
                const notes = App.allStoryGroups[App.currentStoryAuthorId];
                if(App.currentStoryIndex < notes.length - 1) {
                    App.currentStoryIndex++;
                    App.renderCurrentStory();
                } else {
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ù„ÙŠ
                    const currentAuthorIdx = App.storyAuthorsOrder.indexOf(App.currentStoryAuthorId);
                    if(currentAuthorIdx !== -1 && currentAuthorIdx < App.storyAuthorsOrder.length - 1) {
                        App.currentStoryAuthorId = App.storyAuthorsOrder[currentAuthorIdx + 1];
                        App.currentStoryIndex = 0;
                        App.renderCurrentStory();
                    } else {
                        App.closeStoryViewer();
                    }
                }
            },

            prevStory: () => {
                if(App.currentStoryIndex > 0) {
                    App.currentStoryIndex--;
                    App.renderCurrentStory();
                } else {
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚
                    const currentAuthorIdx = App.storyAuthorsOrder.indexOf(App.currentStoryAuthorId);
                    if(currentAuthorIdx > 0) {
                        App.currentStoryAuthorId = App.storyAuthorsOrder[currentAuthorIdx - 1];
                        App.currentStoryIndex = App.allStoryGroups[App.currentStoryAuthorId].length - 1; // Ø¢Ø®Ø± Ø³ØªÙˆØ±ÙŠ Ù„Ù‡
                        App.renderCurrentStory();
                    }
                }
            },

            closeStoryViewer: () => {
                clearTimeout(App.storyTimer);
                UI.closeModal('note-view-modal');
                App.renderNotes(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬
            },
            // --- Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ØªÙˆØ±ÙŠØ§Øª ---
            
            viewNoteFull: async (note, author) => {
                document.getElementById('nv-avatar').src = author.photo || App.getDefaultAvatar();
                document.getElementById('nv-name').innerText = author.name;
                document.getElementById('nv-time').innerText = App.timeAgo(note.timestamp);
                document.getElementById('nv-text').innerHTML = App.parseMentions(note.text);
                
                window.noteViewAuthorId = author.uid;
                window.noteViewId = note.id;
                
                if(author.uid !== currentUser.uid) {
                    let viewers = note.viewers || [];
                    if(!viewers.includes(currentUser.uid)) {
                        viewers.push(currentUser.uid);
                        try { await updateDoc(doc(db, NOTES_PATH, note.id), { viewers }); } catch(e){}
                    }
                    
                    document.getElementById('note-reply-section').classList.remove('hidden');
                    document.getElementById('note-reply-section').classList.add('flex');
                    document.getElementById('note-viewers-section').classList.add('hidden');
                    document.getElementById('nv-options-btn').classList.add('hidden');
                    document.getElementById('note-reply-input').value = '';
                } else {
                    document.getElementById('note-reply-section').classList.add('hidden');
                    document.getElementById('note-reply-section').classList.remove('flex');
                    document.getElementById('note-viewers-section').classList.remove('hidden');
                    document.getElementById('note-viewers-section').classList.add('flex');
                    document.getElementById('nv-options-btn').classList.remove('hidden');
                    
                    document.getElementById('note-viewers-count').innerText = (note.viewers || []).length;
                    
                    document.getElementById('nv-options-btn').onclick = () => {
                        App.openManageNote(note.id, note.text);
                        UI.closeModal('note-view-modal');
                    };
                }

                UI.openModal('note-view-modal');
            },
            
            showNoteViewers: () => {
                const note = Memory.notes.find(n => n.id === window.noteViewId);
                if(!note) return;
                const container = document.getElementById('viewers-list-container');
                container.innerHTML = '';
                const viewers = note.viewers || [];
                
                if(viewers.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-60 py-10 mt-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙˆÙ† Ø¨Ø¹Ø¯</div>';
                } else {
                    viewers.forEach(uid => {
                        const u = Memory.users[uid];
                        if(!u) return;
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 theme-bg rounded-2xl border mb-2 cursor-pointer btn-tap';
                        el.onclick = () => { UI.closeModal('viewers-list-modal'); UI.closeModal('note-view-modal'); UI.openModal('profile-modal', u.uid); };
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-10 h-10 rounded-full object-cover border">
                            <span class="font-bold theme-text">${u.name}</span>
                        `;
                        container.appendChild(el);
                    });
                }
                UI.openModal('viewers-list-modal');
            },

            viewProfileFromNote: () => {
                if(window.noteViewAuthorId) {
                    UI.closeModal('note-view-modal');
                    UI.openModal('profile-modal', window.noteViewAuthorId);
                }
            },
            sendNoteReply: async () => {
                const inputEl = document.getElementById('note-reply-input');
                const text = inputEl.value.trim();
                if(!text || !window.noteViewAuthorId) return;
                
                const note = Memory.notes.find(n => n.id === window.noteViewId);
                if(!note) return;
                
                inputEl.value = '';
                inputEl.focus();

                await addDoc(collection(db, MESSAGES_PATH), {
                    participants: [currentUser.uid, window.noteViewAuthorId],
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    read: false,
                    isNoteReply: true,
                    replyNoteText: note.text 
                });

                UI.showMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø®Ø§Øµ');
                UI.closeModal('note-view-modal');
            },

            checkAndCreateNote: () => {
                const myActiveNote = Memory.notes.find(n => n.authorId === currentUser.uid);
                if(myActiveNote) App.viewNoteFull(myActiveNote, currentUser); 
                else UI.openModal('create-note-modal');
            },

            createNote: async () => {
                const text = document.getElementById('note-text-input').value.trim();
                if(!text) return UI.showMessage('Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹');
                
                // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯Ø¯ (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5 Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù†Ø´Ø·Ø©)
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                const myActiveNotes = Memory.notes.filter(n => n.authorId === currentUser.uid && (now - n.timestamp) < oneDay);
                if(myActiveNotes.length >= 5) {
                    return UI.showMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø£ÙƒØ«Ø± Ù…Ù† 5 Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ…');
                }

                UI.closeModal('create-note-modal');
                await addDoc(collection(db, NOTES_PATH), {
                    authorId: currentUser.uid, text: text, timestamp: Date.now(), viewers: []
                });
                App.notifyMentions(text, 'Ù…Ù„Ø§Ø­Ø¸Ø©', null);
                UI.showMessage('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© (ØµØ§Ù„Ø­Ø© Ù„Ù€ 24 Ø³Ø§Ø¹Ø©)');
            },

            openManageNote: (id, currentText) => {
                window.currentManageNoteId = id;
                document.getElementById('edit-note-input').value = currentText;
                UI.openModal('manage-note-modal');
            },

            updateNote: async () => {
                const newText = document.getElementById('edit-note-input').value.trim();
                if(!newText || !window.currentManageNoteId) return;
                await updateDoc(doc(db, NOTES_PATH, window.currentManageNoteId), { text: newText });
                App.notifyMentions(newText, 'Ù…Ù„Ø§Ø­Ø¸Ø©', null);
                UI.closeModal('manage-note-modal');
                UI.showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
            },

            deleteNote: async () => {
                if(!window.currentManageNoteId) return;
                await deleteDoc(doc(db, NOTES_PATH, window.currentManageNoteId));
                window.currentManageNoteId = null;
                UI.closeModal('manage-note-modal');
                UI.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
            },

            switchFriendsSubTab: (tabId) => {
                ['requests', 'friends', 'suggestions'].forEach(id => {
                    document.getElementById(`subtab-${id}`).className = 'flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors';
                    document.getElementById(`subtab-content-${id}`).classList.add('hidden');
                });
                
                document.getElementById(`subtab-${tabId}`).className = 'flex-1 py-3 text-center text-sm font-bold sub-tab-active btn-tap transition-colors';
                document.getElementById(`subtab-content-${tabId}`).classList.remove('hidden');
                
                App.renderFriendsTab(tabId);
            },
            
            renderFriendsTab: (tabId) => {
                const container = document.getElementById(`subtab-content-${tabId}`);
                if(!container) return;
                container.innerHTML = '';

                if(tabId === 'requests') {
                    const myRequests = Memory.requests.filter(r => r.to === currentUser.uid);
                    
                    if(myRequests.length === 0) {
                        container.innerHTML = '<div class="text-center opacity-50 py-10 mt-6"><i class="ph ph-user-plus text-4xl mb-2 block mx-auto"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
                        return;
                    }
                    myRequests.forEach(req => {
                        const fromUser = Memory.users[req.from];
                        if(!fromUser || App.isBlocked(fromUser.uid)) return;
                        const el = document.createElement('div');
                        el.className = 'flex flex-col p-3 theme-card rounded-2xl border shadow-sm gap-3';
                        el.innerHTML = `
                            <div class="flex items-center gap-3 cursor-pointer group" onclick="UI.openModal('profile-modal', '${fromUser.uid}')">
                                <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                                <div class="flex flex-col">
                                    <span class="font-bold theme-text group-hover:text-blue-600 truncate flex items-center gap-1">${fromUser.name}</span>
                                    <span class="text-xs opacity-60">${App.timeAgo(req.timestamp)}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 w-full">
                                <button onclick="App.acceptRequest('${req.id}', '${req.from}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl btn-tap shadow-sm transition-colors text-sm">Ù‚Ø¨ÙˆÙ„</button>
                                <button onclick="App.declineRequest('${req.id}')" class="flex-1 theme-bg border font-bold py-2 rounded-xl btn-tap transition-colors text-sm">Ø±ÙØ¶</button>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else if (tabId === 'friends') {
                    const myFriendsRelations = Memory.friends.filter(f => f.user1 === currentUser.uid || f.user2 === currentUser.uid);
                    const myFriends = myFriendsRelations.map(f => {
                        const friendId = f.user1 === currentUser.uid ? f.user2 : f.user1;
                        return Memory.users[friendId];
                    }).filter(u => u !== undefined && !App.isBlocked(u.uid));

                    if(myFriends.length === 0) {
                        container.innerHTML = '<div class="text-center opacity-50 py-10 mt-6"><i class="ph ph-users text-4xl mb-2 block mx-auto"></i>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                        return;
                    }
                    myFriends.forEach(u => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 theme-card hover:opacity-80 rounded-2xl cursor-pointer btn-tap border shadow-sm transition-colors';
                        el.onclick = () => UI.openModal('profile-modal', u.uid);
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                            <div class="flex-1">
                                <h4 class="font-bold theme-text flex items-center gap-1">${u.name}</h4>
                                <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else if (tabId === 'suggestions') {
                    const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                    const requestedIds = Memory.requests.filter(r => r.from === currentUser.uid).map(r => r.to);
                    
                    let suggestions = [];
                    
                    const friendsOfFriends = new Set();
                    friendsIds.forEach(friendId => {
                        const friendFriends = Memory.friends
                            .filter(f => f.user1 === friendId || f.user2 === friendId)
                            .map(f => f.user1 === friendId ? f.user2 : f.user1)
                            .filter(id => 
                                id !== currentUser.uid && 
                                !friendsIds.includes(id) && 
                                !requestedIds.includes(id) &&
                                !App.isBlocked(id)
                            );
                        friendFriends.forEach(id => friendsOfFriends.add(id));
                    });
                    
                    let otherSuggestions = Object.values(Memory.users).filter(u => 
                        u.uid !== currentUser.uid && 
                        !friendsIds.includes(u.uid) && 
                        !requestedIds.includes(u.uid) &&
                        !App.isBlocked(u.uid) &&
                        u.allowRequests !== false &&
                        u.showInSuggestions !== false &&
                        u.gender === currentUser.gender
                    );
                    
                    suggestions = [
                        ...Array.from(friendsOfFriends).map(id => Memory.users[id]).filter(u => u && u.gender === currentUser.gender && u.showInSuggestions !== false),
                        ...otherSuggestions.filter(u => !friendsOfFriends.has(u.uid))
                    ];
                    
                    suggestions = suggestions.slice(0, 10); 

                    if(suggestions.length === 0) {
                        container.innerHTML = '<div class="text-center opacity-50 py-10 mt-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                        return;
                    }
                    suggestions.forEach(u => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 theme-card rounded-2xl border shadow-sm';
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                                <h4 class="font-bold theme-text flex items-center gap-1">${u.name}</h4>
                                <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                            </div>
                            <button onclick="App.sendFriendRequest('${u.uid}')" class="bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full font-bold text-sm btn-tap hover:bg-blue-100">Ø¥Ø¶Ø§ÙØ©</button>
                        `;
                        container.appendChild(el);
                    });
                }
            },

            sendFriendRequest: async (toUid) => {
                await addDoc(collection(db, REQUESTS_PATH), {
                    from: currentUser.uid, to: toUid, timestamp: Date.now()
                });
                App.sendNotification(toUid, 'Ø£Ø±Ø³Ù„ Ù„Ùƒ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©', null);
                UI.showMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
                App.renderFriendsTab('suggestions');
                if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(toUid);
            },
            cancelRequest: async (reqId, uid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨');
                if(uid && !document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
            },
            acceptRequest: async (reqId, fromUid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                await addDoc(collection(db, FRIENDS_PATH), {
                    user1: currentUser.uid, user2: fromUid, timestamp: Date.now()
                });
                App.sendNotification(fromUid, 'ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©', null);
                UI.showMessage('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨');
                if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(fromUid);
            },
            declineRequest: async (reqId) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨');
            },
            unfriend: async (uid) => {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµØ¯Ø§Ù‚Ø©ØŸ')) {
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) {
                        await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));
                        UI.showMessage('ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµØ¯Ø§Ù‚Ø©');
                        UI.closeModal('action-modal'); 
                        if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
                    }
                }
            },

            blockUser: async (uid) => {
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                    const updatedBlocks = [...(currentUser.blockedUsers || []), uid];
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                    currentUser.blockedUsers = updatedBlocks;
                    
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));

                    UI.closeModal('action-modal');
                    UI.closeModal('chat-modal');
                    UI.showMessage('ØªÙ… Ø§Ù„Ø­Ø¸Ø± Ø¨Ù†Ø¬Ø§Ø­');
                    App.startCore(); 
                }
            },
            unblockUser: async (uid) => {
                const updatedBlocks = (currentUser.blockedUsers || []).filter(id => id !== uid);
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                currentUser.blockedUsers = updatedBlocks;
                UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±');
                if(!document.getElementById('blocked-users-modal').classList.contains('hidden')){
                    App.renderBlockedUsers();
                }
                if(!document.getElementById('profile-modal').classList.contains('hidden')){
                    App.renderUserProfile(uid);
                }
            },
            renderBlockedUsers: () => {
                const container = document.getElementById('blocked-list-container');
                container.innerHTML = '';
                const blockedList = currentUser.blockedUsers || [];
                if(blockedList.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-20 mt-10"><i class="ph ph-prohibit text-4xl mb-2 block mx-auto"></i>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</div>';
                    return;
                }
                blockedList.forEach(uid => {
                    const u = Memory.users[uid];
                    if(!u) return;
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 theme-card rounded-2xl border mb-2';
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                        <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <h4 class="font-bold theme-text">${u.name}</h4>
                            <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                        </div>
                        <button class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full font-bold text-sm btn-tap" onclick="App.unblockUser('${u.uid}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
                    `;
                    container.appendChild(el);
                });
            },

            searchUsers: () => {
                const query = document.getElementById('search-input').value.toLowerCase().trim();
                const container = document.getElementById('search-results');
                container.innerHTML = '';

                if(!query) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-magnifying-glass text-4xl mb-2 block mx-auto"></i>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>';
                    return;
                }

                const results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    !App.isBlocked(u.uid) &&
                    (u.name.toLowerCase().includes(query) || u.username.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                    return;
                }

                results.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 theme-card hover:opacity-80 rounded-2xl cursor-pointer btn-tap border transition-colors';
                    el.onclick = () => {
                        UI.closeModal('search-modal');
                        UI.openModal('profile-modal', u.uid);
                    };
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold theme-text flex items-center gap-1">${u.name}</h4>
                            <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            renderUserProfile: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;

                document.getElementById('vp-name').innerText = u.name;
                document.getElementById('vp-username').innerText = '@' + u.username;
                document.getElementById('vp-bio').innerText = u.bio || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©';
                document.getElementById('vp-image').src = u.photo || App.getDefaultAvatar();

                // Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ø¨Ø¯Ù‚Ø©
                const isOnline = App.isOnline(u.lastActive);
                if(isOnline) {
                    document.getElementById('vp-last-seen').innerText = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
                    document.getElementById('vp-last-seen').className = 'text-blue-500 text-sm mt-1 font-medium';
                } else {
                    const date = new Date(u.lastActive);
                    const dateStr = date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' });
                    const timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('vp-last-seen').innerText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ${dateStr} Ø§Ù„Ø³Ø§Ø¹Ø© ${timeStr}`;
                    document.getElementById('vp-last-seen').className = 'text-gray-500 dark:text-gray-400 text-sm mt-1';
                }

                const actionContainer = document.getElementById('vp-action-container');
                actionContainer.innerHTML = '';

                const isMe = uid === currentUser.uid;
                const isFriend = App.isFriend(currentUser.uid, uid);
                const hasSentReq = Memory.requests.some(r => r.from === currentUser.uid && r.to === uid);
                const hasReceivedReq = Memory.requests.some(r => r.from === uid && r.to === currentUser.uid);
                const receivedReqId = hasReceivedReq ? Memory.requests.find(r => r.from === uid && r.to === currentUser.uid).id : null;
                const sentReqId = hasSentReq ? Memory.requests.find(r => r.from === currentUser.uid && r.to === uid).id : null;
                const isBlocked = App.isBlocked(uid);
                const isMuted = App.isMuted(uid);
                const canMessage = u.messagePrivacy === 'all' || (u.messagePrivacy === 'friends' && isFriend) || (u.messagePrivacy === 'only_me' && isMe);

                const btnClass = "flex flex-col items-center justify-center bg-white dark:bg-gray-800 rounded-2xl w-20 h-16 shadow-sm btn-tap gap-1 text-gray-800 dark:text-white";
                const iconClass = "text-2xl";
                const textClass = "text-[11px] font-medium";

                if (isMe) {
                    actionContainer.innerHTML = `
                        <button onclick="copyProfileLink('${u.username}')" class="${btnClass} w-24">
                            <i class="ph ph-copy ${iconClass}"></i><span class="${textClass}">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</span>
                        </button>
                    `;
                } else if (isBlocked) {
                    actionContainer.innerHTML = `
                        <button onclick="App.unblockUser('${uid}')" class="${btnClass} w-24 text-red-500">
                            <i class="ph ph-lock-key-open ${iconClass}"></i><span class="${textClass}">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</span>
                        </button>
                    `;
                } else {
                    let buttons = '';
                    
                    // 1. Ø²Ø± Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©
                    if (canMessage) {
                        buttons += `<button onclick="UI.closeModal('profile-modal'); UI.openModal('chat-modal', '${uid}')" class="${btnClass}">
                            <i class="ph ph-chat-circle ${iconClass}"></i><span class="${textClass}">Ù…Ø±Ø§Ø³Ù„Ø©</span>
                        </button>`;
                    }
                    
                    // 2. Ø²Ø± Ø§Ù„ÙƒØªÙ…
                    buttons += `<button onclick="App.toggleMutePermanent('${uid}')" class="${btnClass}">
                        <i class="ph ${isMuted ? 'ph-bell-simple-slash' : 'ph-bell-simple'} ${iconClass}"></i><span class="${textClass}">${isMuted ? 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ…' : 'ÙƒØªÙ…'}</span>
                    </button>`;

                    // 3. Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                    buttons += `<button onclick="copyProfileLink('${u.username}')" class="${btnClass}">
                        <i class="ph ph-link ${iconClass}"></i><span class="${textClass}">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</span>
                    </button>`;

                    // 4. Ø²Ø± Ø§Ù„ØµØ¯Ø§Ù‚Ø©
                    if (isFriend) {
                        buttons += `<button onclick="App.unfriend('${uid}')" class="${btnClass} text-red-500">
                            <i class="ph ph-user-minus ${iconClass}"></i><span class="${textClass}">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø©</span>
                        </button>`;
                    } else if (hasReceivedReq) {
                        buttons += `<button onclick="App.acceptRequest('${receivedReqId}', '${uid}')" class="${btnClass} text-green-500">
                            <i class="ph ph-check ${iconClass}"></i><span class="${textClass}">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</span>
                        </button>`;
                    } else if (hasSentReq) {
                        buttons += `<button onclick="App.cancelRequest('${sentReqId}', '${uid}')" class="${btnClass}">
                            <i class="ph ph-x ${iconClass}"></i><span class="${textClass}">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</span>
                        </button>`;
                    } else if (u.allowRequests !== false) {
                        buttons += `<button onclick="App.sendFriendRequest('${uid}')" class="${btnClass}">
                            <i class="ph ph-user-plus ${iconClass}"></i><span class="${textClass}">Ø¥Ø¶Ø§ÙØ©</span>
                        </button>`;
                    }
                    
                    actionContainer.innerHTML = buttons;
                }

                const friendsGrid = document.getElementById('vp-friends-grid');
                friendsGrid.innerHTML = '';
                
                let canSeeFriends = false;
                if(isMe || u.friendsVisibility === 'all') canSeeFriends = true;
                else if (u.friendsVisibility === 'friends' && isFriend) canSeeFriends = true;

                if (canSeeFriends && !isBlocked) {
                    const userFriendsRelations = Memory.friends.filter(f => f.user1 === uid || f.user2 === uid);
                    const userFriendsIds = userFriendsRelations.map(f => f.user1 === uid ? f.user2 : f.user1);
                    document.getElementById('vp-friends-count-text').innerText = userFriendsIds.length;

                    if(userFriendsIds.length > 0) {
                        const friendsToShow = userFriendsIds.slice(0, 6);
                        friendsToShow.forEach(fid => {
                            const friend = Memory.users[fid];
                            if(friend) {
                                const el = document.createElement('div');
                                el.className = 'flex flex-col items-center gap-1 cursor-pointer btn-tap';
                                el.onclick = () => UI.openModal('profile-modal', fid);
                                el.innerHTML = `
                                    <img src="${friend.photo || App.getDefaultAvatar()}" class="w-full aspect-square rounded-xl object-cover border border-gray-200 shadow-sm">
                                    <span class="text-[11px] font-bold theme-text w-full text-center truncate px-1">${friend.name.split(' ')[0]}</span>
                                `;
                                friendsGrid.appendChild(el);
                            }
                        });
                    } else {
                        friendsGrid.innerHTML = '<div class="col-span-3 text-center opacity-50 py-4 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡</div>';
                    }
                } else {
                    document.getElementById('vp-friends-count-text').innerText = '';
                    friendsGrid.innerHTML = '<div class="col-span-3 text-center opacity-50 py-4 text-sm"><i class="ph ph-lock-key text-xl block mb-1"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø®Ø§ØµØ©</div>';
                }
            },

            showMessageOptions: (msgId, isMe, text, isPinned) => {
                const content = document.getElementById('action-modal-content');
                let buttons = `
                    <button onclick="App.copyText('${escapeHTML(text).replace(/'/g, "\\'")}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
                        <span>Ù†Ø³Ø® Ø§Ù„Ù†Øµ</span> <i class="ph-fill ph-copy text-lg text-gray-500"></i>
                    </button>
                    <button onclick="App.togglePinMessage('${msgId}', ${isPinned})" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap text-blue-600">
                        <span>${isPinned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª' : 'ØªØ«Ø¨ÙŠØª'}</span> <i class="ph-fill ${isPinned ? 'ph-push-pin-slash' : 'ph-push-pin'} text-lg"></i>
                    </button>
                `;
                
                if(isMe) {
                    buttons += `
                        <button onclick="App.editMessage('${msgId}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-green-50 btn-tap text-green-600">
                            <span>ØªØ¹Ø¯ÙŠÙ„</span> <i class="ph-fill ph-pencil-simple text-lg"></i>
                        </button>
                    `;
                }
                
                buttons += `
                    ${isMe ? `
                    <button onclick="App.deleteMessage('${msgId}', 'all')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-red-50 btn-tap text-red-500">
                        <span>Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹</span> <i class="ph-fill ph-trash text-lg"></i>
                    </button>
                    ` : ''}
                    <button onclick="App.deleteMessage('${msgId}', 'me')" class="w-full flex justify-between items-center p-4 hover:bg-orange-50 btn-tap text-orange-500">
                        <span>Ø­Ø°Ù Ù…Ù† Ø¹Ù†Ø¯ÙŠ</span> <i class="ph-fill ph-trash-simple text-lg"></i>
                    </button>
                `;
                
                content.innerHTML = buttons;
                UI.openModal('action-modal');
            },
            
            editMessage: async (msgId) => {
                const msg = Memory.messages.find(m => m.id === msgId);
                const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', msg.text);
                if(newText && newText.trim() && newText !== msg.text) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ (Optimistic UI)
                    msg.text = newText.trim();
                    msg.edited = true;
                    const allMsgIndex = window.allMessages.findIndex(m => m.id === msgId);
                    if(allMsgIndex !== -1) window.allMessages[allMsgIndex].text = newText.trim();
                    App.renderMessages(true); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠØ±
                    
                    UI.closeModal('action-modal');
                    UI.showMessage('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');

                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                    updateDoc(doc(db, MESSAGES_PATH, msgId), { text: newText.trim(), edited: true });
                }
            },
            
            copyText: (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    UI.showMessage("ØªÙ… Ø§Ù„Ù†Ø³Ø®!");
                    UI.closeModal('action-modal');
                }).catch(() => {
                    const tempInput = document.createElement("textarea");
                    tempInput.value = text;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    UI.showMessage("ØªÙ… Ø§Ù„Ù†Ø³Ø®!");
                    UI.closeModal('action-modal');
                });
            },
            
            togglePinMessage: async (msgId, isPinned) => {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø±ÙÙŠÙ†
                await updateDoc(doc(db, MESSAGES_PATH, msgId), { pinned: !isPinned });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                const msgIndex = window.allMessages.findIndex(m => m.id === msgId);
                if(msgIndex !== -1) window.allMessages[msgIndex].pinned = !isPinned;
                
                const memoryIndex = Memory.messages.findIndex(m => m.id === msgId);
                if(memoryIndex !== -1) Memory.messages[memoryIndex].pinned = !isPinned;

                App.renderMessages(true); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø§Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª
                UI.showMessage(isPinned ? "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†" : "ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø·Ø±ÙÙŠÙ†");
                UI.closeModal('action-modal');
            },
            
            deleteMessage: async (msgId, type) => {
                if(type === 'all') {
                    await deleteDoc(doc(db, MESSAGES_PATH, msgId));
                } else if (type === 'me') {
                    await updateDoc(doc(db, MESSAGES_PATH, msgId), { deletedFor: arrayUnion(currentUser.uid) });
                }
                UI.closeModal('action-modal');
            },
            
            showReactionsModal: (msgId) => {
                window.currentReactionMsgId = msgId;
                UI.openModal('reactions-modal');
            },

            selectReaction: (emoji) => {
                if(window.currentReactionMsgId) {
                    App.reactToMessage(window.currentReactionMsgId, emoji);
                    UI.closeModal('reactions-modal');
                }
            },

            reactToMessage: async (msgId, reactionEmoji) => {
                const msg = Memory.messages.find(m => m.id === msgId);
                if(!msg) return;
                const currentReactions = msg.reactions || {};
                
                // Ø¥Ø°Ø§ Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙŠØ­Ø°ÙÙ‡ØŒ ÙˆØ¥Ø°Ø§ Ø§Ø®ØªØ§Ø± ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ³ØªØ¨Ø¯Ù„Ù‡
                if(currentReactions[currentUser.uid] === reactionEmoji) {
                    delete currentReactions[currentUser.uid];
                } else {
                    currentReactions[currentUser.uid] = reactionEmoji;
                }
                
                // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‡Ù…ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                msg.reactions = currentReactions;
                App.renderMessages(); 
                
                // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await updateDoc(doc(db, MESSAGES_PATH, msgId), { reactions: currentReactions });
            },

            showPinChatPopup: (otherUid) => {
                window.pinChatTarget = otherUid;
                UI.openModal('pin-chat-popup');
            },
            
            pinChat: async (type) => {
                const otherUid = window.pinChatTarget;
                if(!otherUid) return;
                
                const existingPin = Memory.pins.find(p => 
                    p.userId === currentUser.uid && p.chatId === otherUid
                );
                if(existingPin) {
                    await deleteDoc(doc(db, PINS_PATH, existingPin.id));
                }
                
                await addDoc(collection(db, PINS_PATH), {
                    userId: currentUser.uid,
                    chatId: otherUid,
                    type: type,
                    timestamp: Date.now()
                });
                
                UI.showMessage('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
            },
            
            unpinChat: async () => {
                const otherUid = window.pinChatTarget;
                if(!otherUid) return;
                
                const existingPin = Memory.pins.find(p => 
                    p.userId === currentUser.uid && p.chatId === otherUid
                );
                if(existingPin) {
                    await deleteDoc(doc(db, PINS_PATH, existingPin.id));
                    UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
                }
            },

            toggleMuteChat: () => {
                UI.openModal('mute-chat-popup');
            },

            muteChat: async (hours) => {
                const otherUid = window.currentChatUserId;
                if(!otherUid) return;
                
                const existingMute = Memory.mutes.find(m => 
                    m.userId === currentUser.uid && m.chatId === otherUid
                );
                if(existingMute) {
                    await deleteDoc(doc(db, MUTES_PATH, existingMute.id));
                }
                
                if(hours > 0) {
                    await addDoc(collection(db, MUTES_PATH), {
                        userId: currentUser.uid,
                        chatId: otherUid,
                        until: Date.now() + (hours * 60 * 60 * 1000)
                    });
                    UI.showMessage(`ØªÙ… ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù…Ø¯Ø© ${hours} Ø³Ø§Ø¹Ø©`);
                } else {
                    UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
                }
                
                const muteBtn = document.getElementById('chat-mute-btn').querySelector('i');
                if(hours > 0) {
                    muteBtn.className = 'ph-fill ph-bell-simple-slash text-lg';
                } else {
                    muteBtn.className = 'ph ph-bell-simple-z text-lg';
                }
            },

            // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© showChatOptions Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:
showChatOptions: (otherUid, event) => {
    if (event) {
        event.stopPropagation();
    }
    
    const isMyFriend = App.isFriend(currentUser.uid, otherUid);
    const content = document.getElementById('action-modal-content');
    
    const isPinned = Memory.pins.some(p => 
        p.userId === currentUser.uid && p.chatId === otherUid
    );
    
    let buttons = '';
    
    if(isPinned) {
        buttons += `
            <button onclick="App.unpinChatFromOptions('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
                <span>Ø¥Ù„ØºØ§Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span> <i class="ph-fill ph-push-pin-slash text-lg text-gray-500"></i>
            </button>
        `;
    } else {
        buttons += `
            <button onclick="App.showPinChatPopup('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
                <span>ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span> <i class="ph-fill ph-push-pin text-lg text-gray-500"></i>
            </button>
        `;
    }
    
    buttons += `
        <button onclick="App.toggleMutePermanent('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
<span>${App.isMuted(otherUid) ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…' : 'ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©'}</span> <i class="ph-fill ${App.isMuted(otherUid) ? 'ph-bell-simple-slash' : 'ph-bell-simple-z'} text-lg text-gray-500"></i>
</button>
        ${isMyFriend ? `
        <button onclick="App.unfriend('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
            <span>Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span> <i class="ph-fill ph-user-minus text-lg text-gray-500"></i>
        </button>
        ` : ''}
        <button onclick="App.blockUser('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-orange-50 btn-tap text-orange-500">
            <span>Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span> <i class="ph-fill ph-prohibit text-lg"></i>
        </button>
        <button onclick="App.showDeleteChatPopup('${otherUid}')" class="w-full flex justify-between items-center p-4 hover:bg-red-50 btn-tap text-red-500">
            <span>Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span> <i class="ph-fill ph-trash text-lg"></i>
        </button>
    `;
    
    content.innerHTML = buttons;
    UI.openModal('action-modal');
},
            
            unpinChatFromOptions: async (otherUid) => {
                const existingPin = Memory.pins.find(p => 
                    p.userId === currentUser.uid && p.chatId === otherUid
                );
                if(existingPin) {
                    await deleteDoc(doc(db, PINS_PATH, existingPin.id));
                    UI.closeModal('action-modal');
                    UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
                }
            },
            
            showDeleteChatPopup: (otherUid) => {
                window.deleteChatTarget = otherUid;
                UI.closeModal('action-modal');
                UI.openModal('delete-chat-popup');
            },
            
            // Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙˆØ§Ù„Ø¯Ø§Ø¦Ù…
            toggleMutePermanent: async (uid) => {
                if(!uid) return;
                try {
                    const isMuted = App.isMuted(uid);
                    if(isMuted) {
                        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…
                        const existingMute = Memory.mutes.find(m => m.userId === currentUser.uid && m.chatId === uid);
                        if(existingMute) await deleteDoc(doc(db, MUTES_PATH, existingMute.id));
                        UI.showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ… ğŸ””');
                    } else {
                        // ÙƒØªÙ… Ø¯Ø§Ø¦Ù… (Ù„Ù…Ø¯Ø© 10 Ø³Ù†ÙˆØ§Øª)
                        await addDoc(collection(db, MUTES_PATH), {
                            userId: currentUser.uid, chatId: uid, until: Date.now() + (10 * 365 * 24 * 60 * 60 * 1000)
                        });
                        UI.showMessage('ØªÙ… ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… ğŸ”•');
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                    if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
                    if(!document.getElementById('chat-modal').classList.contains('hidden')) App.renderChatInfo(uid);
                    App.renderChats();
                    UI.closeModal('action-modal'); 
                } catch (error) {
                    console.error("Error muting:", error);
                    UI.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                }
            },
            
            deleteChatHistory: async (type) => {
                const otherUid = window.deleteChatTarget;
                if(!otherUid) return;
                
                const msgsToDelete = Memory.messages.filter(m => 
                    m.participants.includes(currentUser.uid) && 
                    m.participants.includes(otherUid)
                );
                
                if(type === 'everyone') {
                    for(let msg of msgsToDelete) {
                        await deleteDoc(doc(db, MESSAGES_PATH, msg.id));
                    }
                    UI.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹');
                } else {
                    for(let msg of msgsToDelete) {
                        await updateDoc(doc(db, MESSAGES_PATH, msg.id), { 
                            deletedFor: arrayUnion(currentUser.uid) 
                        });
                    }
                    UI.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·');
                }
                
                UI.closeModal('chat-modal');
            },

            renderChats: () => {
                const container = document.getElementById('chats-container');
                container.innerHTML = '';
                
                const chatUsers = {};
                let totalUnreadCount = 0; 

                Memory.messages.forEach(msg => {
                    if(msg.participants.includes(currentUser.uid)) {
                        const otherUid = msg.participants.find(id => id !== currentUser.uid);
                        if(App.isBlocked(otherUid)) return;
                        if(msg.deletedFor && msg.deletedFor.includes(currentUser.uid)) return;

                        if(!chatUsers[otherUid]) chatUsers[otherUid] = { lastMsg: msg, unreadCount: 0 };
                        
                        if(chatUsers[otherUid].lastMsg.timestamp < msg.timestamp) {
                            chatUsers[otherUid].lastMsg = msg;
                        }
                        
                        if(msg.senderId === otherUid && !msg.read) {
                            chatUsers[otherUid].unreadCount++;
                            // ØªÙ… Ø­Ø°Ù Ø¹Ø¯Ø§Ø¯ (totalUnreadCount) Ù…Ù† Ù‡Ù†Ø§ Ù„Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø³Ø§Ø¨Ù‡ Ø¨Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                        }
                    }
                });

                let chatsArray = Object.entries(chatUsers);
                
                chatsArray = chatsArray.map(([uid, data]) => {
                    const pin = Memory.pins.find(p => p.userId === currentUser.uid && p.chatId === uid);
                    const mute = Memory.mutes.find(m => m.userId === currentUser.uid && m.chatId === uid && m.until > Date.now());
                    
                    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø°Ø§ Ø§Ù„Ø´Ø®Øµ ØºÙŠØ± Ù…ÙƒØªÙˆÙ… ÙˆØ¹Ù†Ø¯Ù‡ Ø±Ø³Ø§Ø¦Ù„ØŒ Ù†Ø¶ÙŠÙÙ‡Ù… Ù„Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
                    if (!mute && data.unreadCount > 0) {
                        totalUnreadCount += data.unreadCount;
                    }

                    return [uid, {...data, pin, mute}];
                });
                
                chatsArray.sort((a, b) => {
                    if(a[1].pin && !b[1].pin) return -1;
                    if(!a[1].pin && b[1].pin) return 1;
                    if(a[1].pin && b[1].pin) {
                        if(a[1].pin.type === 'love' && b[1].pin.type !== 'love') return -1;
                        if(a[1].pin.type !== 'love' && b[1].pin.type === 'love') return 1;
                    }
                    return b[1].lastMsg.timestamp - a[1].lastMsg.timestamp;
                });

                if(chatsArray.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-chat-circle-dots text-4xl mb-2 block mx-auto"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</div>';
                    document.getElementById('badge-messages').classList.add('hidden');
                    return;
                }

                chatsArray.forEach(([otherUid, chatData]) => {
                    const lastMsg = chatData.lastMsg;
                    const u = Memory.users[otherUid];
                    if(!u) return;

                    // Ù‡Ù†Ø§ Ù†Ø®ÙÙŠ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø®Øµ Ù…ÙƒØªÙˆÙ…
                    const isUnread = chatData.unreadCount > 0 && !chatData.mute;
                    const isOnline = App.isOnline(u.lastActive);
                    const pin = chatData.pin;
                    const mute = chatData.mute;

                    const el = document.createElement('div');
                    const unreadClass = isUnread ? 'bg-blue-50/20' : 'hover:opacity-80';
                    el.className = `flex items-center gap-3 p-3 border-b cursor-pointer btn-tap transition-colors theme-card ${unreadClass}`;
                    
                    let pressTimer;
                    let isLongPress = false; 
                    
                    const startPress = (e) => { 
                        isLongPress = false;
                        pressTimer = setTimeout(() => {
                            isLongPress = true; 
                            App.showChatOptions(u.uid, e);
                        }, 600); 
                    };
                    const cancelPress = () => clearTimeout(pressTimer);
                    
                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = (e) => {
                        if(pressTimer) clearTimeout(pressTimer);
                        if(isLongPress) {
                            e.preventDefault();
                            return; 
                        }
                        UI.openModal('chat-modal', u.uid);
                    };

                    let tickHtml = '';
                    if(lastMsg.senderId === currentUser.uid) {
                        tickHtml = lastMsg.read ? '<i class="ph-fill ph-checks text-blue-500 text-[13px] ml-1"></i>' : '<i class="ph ph-check opacity-50 text-[13px] ml-1"></i>';
                    }

                    let msgPreview = lastMsg.text ? lastMsg.text.replace(/\n/g, ' ') : '';
                    if (lastMsg.isNoteReply) {
                        msgPreview = lastMsg.senderId === currentUser.uid ? 'Ø±Ø¯ÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©' : 'ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ';
                    }
                    
                    if (!Memory.typingStatus) Memory.typingStatus = {};
                    const typingData = Memory.typingStatus[`${otherUid}_${currentUser.uid}`];
                    let isTypingNow = false;
                    if(typingData && typingData.text && (Date.now() - typingData.timestamp < 5000)) {
                        isTypingNow = true;
                        msgPreview = `<span class="text-blue-500 font-bold animate-pulse">ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...</span>`;
                        tickHtml = ''; 
                    }
                    
                    let pinHtml = '';
                    if(pin) {
                        if(pin.type === 'love') {
                            pinHtml = '<span class="pin-love"><i class="ph-fill ph-heart"></i> Ø§Ù„Ø­Ø¨</span>';
                        } else {
                            pinHtml = '<span class="pin-normal"><i class="ph-fill ph-push-pin"></i></span>';
                        }
                    }
                    
                    let muteHtml = '';
                    if(mute) {
                        muteHtml = '<span class="mute-badge mr-1"><i class="ph-fill ph-bell-simple-slash"></i></span>';
                    }

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-14 h-14 rounded-full object-cover border border-gray-100">
                            ${isOnline ? '<span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                            ${pinHtml}
                        </div>
                        <div class="flex-1 overflow-hidden pr-1 relative">
                            <div class="flex justify-between items-center mb-0.5">
                                <h4 class="font-bold truncate text-[15px] flex items-center gap-1 ${isUnread ? 'theme-text' : 'opacity-90'}">${u.name} ${muteHtml}</h4>
                                <span class="text-xs ${isUnread ? 'font-bold text-blue-600' : 'opacity-60'} whitespace-nowrap">${App.timeAgo(lastMsg.timestamp)}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm truncate flex-1 flex items-center gap-0.5 ${isUnread ? 'text-unread' : (lastMsg.senderId !== currentUser.uid ? 'font-medium opacity-90' : 'opacity-60')}">
                                    ${tickHtml} ${msgPreview}
                                </p>
                                ${isUnread ? `<span class="bg-blue-600 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center shrink-0 shadow-sm mr-2">${chatData.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (ÙÙ‚Ø· Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø£Ø´Ø®Ø§Øµ ØºÙŠØ± Ù…ÙƒØªÙˆÙ…ÙŠÙ†)
                if(totalUnreadCount > 0) {
                    const badge = document.getElementById('badge-messages');
                    badge.classList.remove('hidden');
                    badge.innerText = totalUnreadCount > 9 ? '+9' : totalUnreadCount;
                } else {
                    document.getElementById('badge-messages').classList.add('hidden');
                }
            },

            markChatAsRead: async (otherUid) => {
                const unreadMsgs = Memory.messages.filter(m => 
                    m.participants.includes(currentUser.uid) && 
                    m.participants.includes(otherUid) &&
                    m.senderId === otherUid && 
                    !m.read
                );
                for(let msg of unreadMsgs) {
                    await updateDoc(doc(db, MESSAGES_PATH, msg.id), { read: true });
                }
            },

            renderChatInfo: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;
                document.getElementById('chat-user-img').src = u.photo || App.getDefaultAvatar();
                document.getElementById('chat-user-name').innerText = u.name;
                
                const isOnline = App.isOnline(u.lastActive);
                document.getElementById('chat-online-dot').style.display = isOnline ? 'block' : 'none';
                document.getElementById('chat-user-status').innerText = isOnline ? 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†' : `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ${App.timeAgo(u.lastActive)}`;
                
                const isMuted = App.isMuted(uid);
                const muteBtnIcon = document.getElementById('chat-mute-btn').querySelector('i');
                if(isMuted) {
                    muteBtnIcon.className = 'ph-fill ph-bell-simple-slash text-lg';
                } else {
                    muteBtnIcon.className = 'ph ph-bell-simple-z text-lg';
                }
            },

            setReplyMode: (msgId, text, senderName) => {
                window.replyingToMessage = msgId;
                document.getElementById('reply-to-name').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${senderName}`;
                document.getElementById('reply-to-text').innerText = text;
                document.getElementById('replying-to-container').classList.remove('hidden');
                document.getElementById('chat-input').focus();
            },
            cancelReply: () => {
                window.replyingToMessage = null;
                document.getElementById('replying-to-container').classList.add('hidden');
            },

            highlightMessage: (msgId) => {
                const container = document.getElementById('chat-messages-container');
                const msgElement = container.querySelector(`[data-msg-id="${msgId}"]`);
                if(msgElement) {
                    msgElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    msgElement.classList.add('highlight-message');
                    setTimeout(() => {
                        msgElement.classList.remove('highlight-message');
                    }, 2000);
                }
            },

            loadMessages: async () => {
                // ØªÙ… Ø­Ø°Ù Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ (25 Ø±Ø³Ø§Ù„Ø©)
                // Ù†Ø³ØªØ¯Ø¹ÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… ÙÙˆØ±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                App.renderMessages();
            },

            loadMoreMessages: async () => {
                // Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­ØªØ§Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©ØŒ ØªØ±ÙƒÙ†Ø§Ù‡Ø§ ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡
                return; 
            },

            renderMessages: () => {
                const otherUid = window.currentChatUserId;
                if(!otherUid) return;

                const container = document.getElementById('chat-messages-container');
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠØ¯)
                let msgs = Memory.messages.filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid));
                
                // Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„)
                msgs = msgs.sort((a,b) => a.timestamp - b.timestamp);
                msgs = msgs.filter(m => !(m.deletedFor && m.deletedFor.includes(currentUser.uid)));

                App.updateChatPet(msgs);

                // ØªÙØ±ÙŠØº Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· Ù…Ø¹ Ø¥Ø¨Ù‚Ø§Ø¡ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
                Array.from(container.children).forEach(child => {
                    if(child.id !== 'live-typing-bubble') child.remove();
                });

                const pinnedMsg = msgs.find(m => m.pinned);
                if(pinnedMsg) {
                    const pinEl = document.createElement('div');
                    pinEl.className = 'sticky top-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b p-2 mb-4 rounded-xl shadow-sm z-20 flex items-center justify-between cursor-pointer theme-text';
                    pinEl.innerHTML = `<div class="flex-1 overflow-hidden pr-2 border-r-4 border-blue-500"><span class="text-xs font-bold text-blue-600 block"><i class="ph-fill ph-push-pin"></i> Ø±Ø³Ø§Ù„Ø© Ù…Ø«Ø¨ØªØ©</span><span class="text-sm truncate block opacity-80">${escapeHTML(pinnedMsg.text)}</span></div>`;
                    pinEl.onclick = () => { App.highlightMessage(pinnedMsg.id); };
                    container.appendChild(pinEl);
                }

                if(msgs.length === 0) {
                    container.innerHTML += '<div class="text-center opacity-50 py-10 mt-auto theme-text">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ‘‹</div>';
                    return;
                }

                msgs.forEach(m => {
                    const isMe = m.senderId === currentUser.uid;
                    const row = document.createElement('div');
                    // Ù…Ø³Ø§ÙØ© Ø³ÙÙ„ÙŠØ© Ø£ÙƒØ¨Ø± Ù„ØªØ±Ùƒ Ù…Ø¬Ø§Ù„ Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
                    row.className = `msg-row flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
                    row.setAttribute('data-msg-id', m.id);

                    const el = document.createElement('div');
                    el.className = `max-w-[80%] rounded-2xl p-3 shadow-sm relative break-words ${isMe ? 'bubble-me rounded-br-sm' : 'bubble-other rounded-bl-sm'}`;
                    
                    // --- Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ ÙˆØ§Ù„Ø¶ØºØ· Ø§Ù„Ù…ÙØ±Ø¯ ---
                    let clickTimer = null;
                    let lastClickTime = 0;
                    
                    el.onclick = (e) => {
                        e.stopPropagation();
                        const currentTime = new Date().getTime();
                        const timeDiff = currentTime - lastClickTime;
                        
                        if (timeDiff < 300) {
                            // ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¶ØºØ· Ù…Ø²Ø¯ÙˆØ¬! Ù†Ù„ØºÙŠ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ÙØ±Ø¯ ÙˆÙ†ÙØªØ­ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
                            clearTimeout(clickTimer);
                            App.showReactionsModal(m.id);
                            lastClickTime = 0; // ØªØµÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª
                        } else {
                            // Ø¶ØºØ· Ù…ÙØ±Ø¯ (Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù„ÙŠØ³ Ø¶ØºØ·Ø§Ù‹ Ù…Ø²Ø¯ÙˆØ¬Ø§Ù‹)
                            lastClickTime = currentTime;
                            clickTimer = setTimeout(() => {
                                App.showMessageOptions(m.id, isMe, m.text, m.pinned);
                            }, 300); 
                        }
                    };
                    
                    let replyIcon = document.createElement('i');
                    replyIcon.className = `ph-fill ph-reply reply-icon-indicator ${isMe ? '-left-8' : '-right-8'}`;
                    row.appendChild(replyIcon);

                    let startX = 0, startY = 0, currentX = 0;
                    let isSwiping = false;
                    row.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; isSwiping = false; }, {passive: true});
                    row.addEventListener('touchmove', (e) => {
                        if(!startX || !startY) return;
                        currentX = e.touches[0].clientX; let diffX = currentX - startX; let diffY = e.touches[0].clientY - startY;
                        if (diffX < -10 && Math.abs(diffX) > Math.abs(diffY)) { 
                            isSwiping = true;
                            if(e.cancelable) e.preventDefault();
                            let translate = Math.max(diffX, -70); 
                            row.style.transform = `translateX(${translate}px)`;
                            replyIcon.style.opacity = Math.abs(translate) / 70;
                        }
                    }, {passive: false});
                    row.addEventListener('touchend', (e) => {
                        if(!isSwiping) return;
                        row.style.transform = `translateX(0)`; replyIcon.style.opacity = 0;
                        if (currentX - startX < -50) { 
                            App.setReplyMode(m.id, m.text, isMe ? 'Ù†ÙØ³Ùƒ' : Memory.users[m.senderId].name);
                        }
                        startX = 0; isSwiping = false;
                    });

                    // Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠÙ† Ø§Ù„Ù…Ø¶Ø¨ÙˆØ·
                    const tickHtml = isMe ? (m.read ? '<i class="ph-fill ph-checks text-blue-500 text-[16px] ml-1 drop-shadow-sm"></i>' : '<i class="ph ph-check opacity-70 text-[16px] ml-1"></i>') : '';
                    
// --- ØªØ¬Ù‡ÙŠØ² Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…Ø¹ ØµÙˆØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª) ---
                    let reactionsHtml = '';
                    if (m.reactions && Object.keys(m.reactions).length > 0) {
                        const reactionGroups = {}; // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ { 'â¤ï¸': ['uid1', 'uid2'] }
                        Object.entries(m.reactions).forEach(([uid, emoji]) => {
                            if (!reactionGroups[emoji]) reactionGroups[emoji] = [];
                            reactionGroups[emoji].push(uid);
                        });

                        let bubbles = '';
                        Object.entries(reactionGroups).forEach(([emoji, uids]) => {
                            let avatarsHtml = '';
                            uids.forEach(uid => {
                                const user = Memory.users[uid];
                                if (user) {
                                    // ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø¬Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØµØºÙŠØ±
                                    avatarsHtml += `<img src="${user.photo || App.getDefaultAvatar()}" class="w-5 h-5 min-w-[20px] shrink-0 rounded-full border border-blue-100 dark:border-blue-900 -ml-1.5 inline-block object-cover z-10 relative">`;
                                }
                            });
                            
                            // ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ Ù„Ø·ÙŠÙØ© Ù…Ø«Ù„ Ø§Ù„ØªÙ„ÙƒØ±Ø§Ù…)
                            bubbles += `
                                <div class="bg-blue-100 dark:bg-blue-900/60 border border-blue-200 dark:border-blue-800 rounded-full pl-2 pr-1 py-0.5 flex items-center gap-1.5 shadow-sm cursor-pointer btn-tap" onclick="App.showReactionsModal('${m.id}')">
                                    <span class="text-[14px] -mt-0.5">${emoji}</span>
                                    <div class="flex pl-1">${avatarsHtml}</div>
                                </div>
                            `;
                        });
                        reactionsHtml = `<div class="absolute -bottom-3 ${isMe ? 'right-2' : 'left-2'} flex gap-1 z-20">${bubbles}</div>`;
                    }
                    
                    let messageContentHtml = '';
                    if (m.isNoteReply && m.replyNoteText) {
                        // ØªØµÙ…ÙŠÙ… ÙŠØ­Ø§ÙƒÙŠ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ØªÙˆØ±ÙŠ (Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ ÙˆØ¨ÙŠØ¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ÙŠ)
                        messageContentHtml = `
                            <div class="flex items-center gap-2.5 mb-1 bg-black/5 dark:bg-white/10 p-1.5 rounded-xl border border-black/10 dark:border-white/10">
                                <div class="w-9 h-12 rounded-lg bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900 flex items-center justify-center p-1.5 overflow-hidden shrink-0 shadow-inner">
                                    <span class="text-[7px] font-bold text-center leading-tight line-clamp-3">${escapeHTML(m.replyNoteText)}</span>
                                </div>
                                <div class="flex-1 overflow-hidden pr-1">
                                    <span class="text-[11px] font-bold text-blue-500 block mb-0.5">Ù…Ù„Ø§Ø­Ø¸Ø©</span>
                                    <span class="text-[14px] truncate block theme-text">${parseTextWithLinks(m.text, true)}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        messageContentHtml = `<p class="text-[15px] leading-relaxed whitespace-pre-wrap">${parseTextWithLinks(m.text, true)}</p>`;
                    }

                    el.innerHTML = `${messageContentHtml}<span class="text-[10px] mt-1.5 flex justify-end items-center gap-1 font-medium opacity-80">${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ${tickHtml}</span>${reactionsHtml}`;
                    
                    row.appendChild(el);
                    container.appendChild(row);
                });

                const typingBubble = document.getElementById('live-typing-bubble');
                if(typingBubble) container.appendChild(typingBubble);

                // Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            },

            sendMessage: async () => {
                const otherUid = window.currentChatUserId;
                const inputEl = document.getElementById('chat-input');
                const text = inputEl.value.trim();
                if(!text || !otherUid) return;

                inputEl.value = '';
                inputEl.style.height = ''; 
                inputEl.focus(); 
                
                try { await deleteDoc(doc(db, TYPING_PATH, `${currentUser.uid}_${otherUid}`)); } catch(e){}

                const payload = {
                    participants: [currentUser.uid, otherUid],
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    read: false 
                };

                if(window.replyingToMessage) {
                    payload.replyToId = window.replyingToMessage;
                    App.cancelReply();
                }
                
                await addDoc(collection(db, MESSAGES_PATH), payload);
                // Firebase Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ ÙˆØ¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± onSnapshot
            },

            sendNotification: async (toUid, text, linkId) => {
                if(toUid === currentUser.uid) return;
                await addDoc(collection(db, NOTIFS_PATH), {
                    to: toUid, from: currentUser.uid, text: text, linkId: linkId, timestamp: Date.now(), read: false
                });
            },
            deleteNotification: async (notifId) => {
                await deleteDoc(doc(db, NOTIFS_PATH, notifId));
                UI.closeModal('action-modal');
                UI.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
            },
            markNotificationRead: async (notifId) => {
                await updateDoc(doc(db, NOTIFS_PATH, notifId), { read: true });
            },
            showNotifOptions: (notifId) => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <button onclick="App.deleteNotification('${notifId}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-red-50 btn-tap text-red-500">
                        <span>Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</span> <i class="ph-fill ph-trash text-lg"></i>
                    </button>
                `;
                UI.openModal('action-modal');
            },
            renderNotifications: () => {
                const container = document.getElementById('notifications-container');
                container.innerHTML = '';
                
                const notifs = [...Memory.notifications].sort((a,b) => b.timestamp - a.timestamp);
                const unreadExists = notifs.some(n => !n.read && !App.isBlocked(n.from));
                
                if(notifs.length > 0 && unreadExists) document.getElementById('badge-notifications').classList.remove('hidden');
                else document.getElementById('badge-notifications').classList.add('hidden');
                
                if(notifs.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-bell-ringing text-4xl mb-2 block mx-auto"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
                    return;
                }

                notifs.forEach(n => {
                    const fromUser = Memory.users[n.from];
                    if(!fromUser || App.isBlocked(n.from)) return; 

                    const el = document.createElement('div');
                    const isUnread = !n.read;
                    el.className = `flex items-center gap-3 p-3.5 border-b cursor-pointer transition-colors btn-tap theme-card ${isUnread ? 'bg-blue-50/20' : 'hover:opacity-80'}`;
                    
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showNotifOptions(n.id), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);
                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = () => {
                        if(pressTimer) clearTimeout(pressTimer);
                        if(isUnread) App.markNotificationRead(n.id);
                        if(n.linkId) UI.openModal('comments-modal', n.linkId);
                        else UI.openModal('profile-modal', n.from);
                    };

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            ${isUnread ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-600 rounded-full border-2 border-white"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <p class="text-[15px] leading-tight ${isUnread ? 'theme-text font-bold' : 'opacity-80'}"><span class="font-bold flex items-center gap-1">${fromUser.name}</span> ${n.text}</p>
                            <span class="text-xs font-semibold ${isUnread ? 'text-blue-600' : 'opacity-60'} mt-1 block">${App.timeAgo(n.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            handleEditImage: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 300; canvas.height = 300;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 300, 300);
                        const b64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('edit-profile-img').src = b64;
                        window.tempEditPhoto = b64;
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },

            saveProfile: async () => {
                const name = document.getElementById('edit-name').value.trim();
                const usernameInput = document.getElementById('edit-username');
                const username = usernameInput.value.trim();
                const bio = document.getElementById('edit-bio').value.trim();
                
                if(!name || (!username && !usernameInput.disabled)) return UI.showMessage('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¹Ø±Ù Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');
                const updates = { name, bio };

                if(!usernameInput.disabled && username !== currentUser.username) {
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) return UI.showMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙƒÙ„ 10 Ø£ÙŠØ§Ù…');

                    const isTaken = Object.values(Memory.users).some(u => u.username === username && u.uid !== currentUser.uid);
                    if(isTaken) return UI.showMessage('Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø±Ù Ù…Ø®ØªÙ„Ù');

                    updates.username = username;
                    updates.lastUsernameChange = Date.now();
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¬Ù†Ø³ Ø¥Ø°Ø§ ØªØºÙŠØ±
                if(window.selectedEditGender && window.selectedEditGender !== currentUser.gender) {
                    const sixtyDaysInMs = 60 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastGenderChange || 0;
                    if (Date.now() - lastChange >= sixtyDaysInMs) {
                        updates.gender = window.selectedEditGender;
                        updates.lastGenderChange = Date.now();
                    }
                }

                if(window.tempEditPhoto) updates.photo = window.tempEditPhoto;

                await updateDoc(doc(db, USERS_PATH, currentUser.uid), updates);
                Object.assign(currentUser, updates);
                window.tempEditPhoto = null;
                App.updateUIWithUserData();
                UI.closeModal('edit-profile-modal');
                UI.showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
            },

            updatePrivacy: async (key, value) => {
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { [key]: value });
                currentUser[key] = value;
                UI.showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙˆØµÙŠØ©');
            }

        };

        // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
        window.copyProfileLink = (username) => {
            const link = `${window.location.origin}${window.location.pathname}?user=${username}`;
            navigator.clipboard.writeText(link).then(() => {
                UI.showMessage('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
            }).catch(() => {
                const tempInput = document.createElement("input");
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                UI.showMessage('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
            });
        };

        // Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø©)
        document.addEventListener('DOMContentLoaded', () => {
            const chatModal = document.getElementById('chat-modal');
            let touchStartX = 0;
            let touchStartY = 0;
            let isPageSwiping = false;
            
            chatModal.addEventListener('touchstart', (e) => {
                if(e.target.closest('#chat-back-button')) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isPageSwiping = false;
                chatModal.style.transition = 'none'; // Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
            }, {passive: true});
            
            chatModal.addEventListener('touchmove', (e) => {
                if(!touchStartX) return;
                const diffX = e.touches[0].clientX - touchStartX;
                const diffY = e.touches[0].clientY - touchStartY;
                
                if(diffX > 20 && Math.abs(diffX) > Math.abs(diffY) && !chatModal.classList.contains('hidden')) {
                    isPageSwiping = true;
                    
                    // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ø¹Ù…Ù„ ØªØ£Ø«ÙŠØ± Ø·ÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©
                    const progress = Math.min(diffX / window.innerWidth, 1);
                    const angle = progress * 65; // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø·ÙŠ Ø§Ù„Ù‚ØµÙˆÙ‰
                    
                    chatModal.style.transformOrigin = 'right center';
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¸ÙˆØ± ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Ù† ÙˆØ§Ù„Ø´ÙØ§ÙÙŠØ©
                    chatModal.style.transform = `perspective(1500px) rotateY(${-angle}deg) translateX(${diffX * 0.4}px)`;
                    chatModal.style.opacity = 1 - (progress * 0.6);
                }
            }, {passive: true});
            
            chatModal.addEventListener('touchend', (e) => {
                if(!isPageSwiping) return;
                const diffX = e.changedTouches[0].clientX - touchStartX;
                
                chatModal.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
                
                if(diffX > 100) { 
                    // Ø¥ÙƒÙ…Ø§Ù„ Ø·ÙŠ Ø§Ù„ÙˆØ±Ù‚Ø© ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙÙ„Ø§Øª
                    chatModal.style.transform = 'perspective(1500px) rotateY(-90deg) translateX(100px)';
                    chatModal.style.opacity = '0';
                    
                    setTimeout(() => {
                        UI.closeModal('chat-modal');
                        setTimeout(() => {
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                            chatModal.style.transform = '';
                            chatModal.style.opacity = '';
                            chatModal.style.transformOrigin = '';
                        }, 300);
                    }, 300);
                } else {
                    // Ø§Ø±ØªØ¯Ø§Ø¯ Ø§Ù„ÙˆØ±Ù‚Ø© Ù„Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ ÙƒØ§ÙÙŠØ§Ù‹
                    chatModal.style.transform = 'perspective(1500px) rotateY(0deg) translateX(0)';
                    chatModal.style.opacity = '1';
                }
                
                touchStartX = 0; isPageSwiping = false;
            });
        });

        window.onload = () => {
            Auth.init();
        };
        
    </script>
</body>
</html>
