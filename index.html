<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>زايلو - Xylo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    
    <style>
        /* إعدادات التطبيق الأساسية */
        html, body {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: none;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color, #f3f4f6);
            color: var(--text-color, #1f2937);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; 
            touch-action: pan-y;
            transition: background-color 0.3s, color 0.3s;
        }

        /* متغيرات الألوان للوضع الليلي والنهاري */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --nav-bg: #ffffff;
            --card-bg: #ffffff;
            --chat-bg: #e0f2fe;
            --bubble-me-bg: #22c55e;
            --bubble-me-text: #ffffff;
            --bubble-other-bg: #ffffff;
            --bubble-other-text: #1f2937;
            --border-color: #f3f4f6;
            --vh: 1vh; /* للمطلب 3: ارتفاع الكيبورد */
        }
        
        body.dark-theme {
            --bg-color: #111827;
            --text-color: #f9fafb;
            --nav-bg: #1f2937;
            --card-bg: #1f2937;
            --chat-bg: #030712;
            --bubble-me-bg: #2563eb;
            --bubble-me-text: #ffffff;
            --bubble-other-bg: #374151;
            --bubble-other-text: #f9fafb;
            --border-color: #374151;
        }

        .theme-bg { background-color: var(--bg-color); }
        .theme-card { background-color: var(--card-bg); color: var(--text-color); border-color: var(--border-color); }
        .theme-nav { background-color: var(--nav-bg); border-color: var(--border-color); }
        .theme-text { color: var(--text-color); }
        
        .chat-container-bg { background-color: var(--chat-bg); transition: background-color 0.3s; }
        .bubble-me { background-color: var(--bubble-me-bg); color: var(--bubble-me-text); }
        .bubble-other { background-color: var(--bubble-other-bg); color: var(--bubble-other-text); border: 1px solid var(--border-color); }

        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            will-change: scroll-position;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* شاشة البداية المحدثة */
        #splash-screen {
            background-color: #0a192f; 
        }
        @keyframes glow-sync {
            0% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3); transform: scale(0.95) translateX(25px); opacity: 0; }
            50% { text-shadow: 0 0 20px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.6); transform: scale(1.05) translateX(-5px); opacity: 1; }
            100% { text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.5); transform: scale(1) translateX(-15px); opacity: 1; }
        }
        /* المطلب 1: انميشن الحرف Z لليمين */
        .elegant-z {
            font-family: 'Great Vibes', cursive;
            color: #ffd700; 
            font-size: 10rem;
            line-height: 1;
            /* تم إضافة التوجيه لليمين في الـ Keyframes أعلاه وفي الـ Margin */
            margin-right: -25px; 
            animation: glow-sync 2s cubic-bezier(0.25, 1, 0.5, 1) infinite alternate; /* يستمر التوهج حتى اكتمال التحميل */
            margin-bottom: -10px;
        }
        .elegant-text {
            color: #ffd700;
            animation: glow-sync 2s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            letter-spacing: 2px;
        }

        .modal-slide-in { animation: slideIn 0.35s forwards cubic-bezier(0.175, 0.885, 0.32, 1.1); }
        .modal-slide-out { animation: slideOut 0.3s forwards cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0.8; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        .btn-tap {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
            position: relative;
            overflow: hidden;
        }
        .btn-tap:active { transform: scale(0.95); opacity: 0.8; }

        .bg-xylo { background: linear-gradient(135deg, #1d4ed8, #6d28d9); }
        .text-xylo { color: #4f46e5; }
        
        .ptr-container { transition: transform 0.3s ease; position: relative; }
        #ptr-spinner { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .text-unread { font-weight: 900 !important; color: #000 !important; }
        body.dark-theme .text-unread { color: #fff !important; }
        
        #mentions-dropdown {
            position: absolute; bottom: 100%; left: 0; right: 0; background: var(--card-bg); border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 200; display: none;
        }

        /* سحب الرسالة */
        .msg-row { transition: transform 0.2s ease-out; touch-action: pan-y; width: 100%; position: relative; }
        .reply-icon-indicator {
            position: absolute; top: 50%; transform: translateY(-50%);
            opacity: 0; transition: opacity 0.2s; color: var(--text-color); font-size: 20px;
        }

        .sub-tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .sub-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; font-weight: normal; }

        /* التفاعل بالقلب */
        .reaction-badge {
            position: absolute; bottom: -8px; 
            background: rgba(255,255,255,0.9); border-radius: 50%; padding: 2px; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .story-ring {
            padding: 2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            border-radius: 50%;
        }

        /* المطلب 3: تعديل ارتفاع نافذة المحادثة للتوافق مع الكيبورد */
        #chat-modal {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        /* المطلب 8: قائمة التلكرام */
        .telegram-menu {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            width: 240px;
            transform-origin: center bottom;
            animation: popTelegram 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards;
        }
        body.dark-theme .telegram-menu {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(255,255,255,0.05);
        }
        @keyframes popTelegram { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* المطلب 6: انميشن الكائن */
        @keyframes floatPet {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-3px) rotate(2deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        .pet-animate { animation: floatPet 3s ease-in-out infinite; }
        .pet-glow { filter: drop-shadow(0 0 8px rgba(255,215,0,0.6)); }

        /* المطلب 5: انميشن الكتابة الحية */
        @keyframes blinkCursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .typing-cursor::after {
            content: '|';
            animation: blinkCursor 1s infinite;
            margin-right: 2px;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col antialiased pb-safe theme-bg">

    <!-- 1. شاشة البداية -->
    <div id="splash-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="splash-content">
            <div class="elegant-z">Z</div>
            <h1 class="text-5xl font-black elegant-text mt-2">زايلو</h1>
        </div>
    </div>

    <!-- 2. قسم المصادقة -->
    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-white overflow-y-auto hide-scrollbar smooth-scroll">
        <div class="min-h-screen flex flex-col items-center justify-center p-6">
            <h1 class="text-6xl font-black xylo-brand mb-10 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">زايلو</h1>
            
            <div id="login-form" class="w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">تسجيل الدخول</h2>
                <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="login-password" placeholder="كلمة السر" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.login()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">تسجيل الدخول</button>
                <div class="flex justify-between text-sm text-blue-600 font-semibold mt-4">
                    <button onclick="UI.switchAuth('register')" class="p-2 btn-tap">إنشاء حساب جديد</button>
                    <button onclick="UI.switchAuth('forgot')" class="p-2 btn-tap">نسيت كلمة السر؟</button>
                </div>
            </div>

            <div id="register-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">حساب جديد</h2>
                <input type="text" id="reg-name" placeholder="اسم الحساب" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="email" id="reg-email" placeholder="البريد الإلكتروني" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="reg-password" placeholder="كلمة السر" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.register()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">إنشاء حساب مباشرة</button>
                
                <div class="relative flex py-4 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">أو</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- زر تسجيل جوجل -->
                <button onclick="Auth.loginWithGoogle()" class="btn-tap w-full bg-white border border-gray-300 text-[#3c4043] font-bold py-3 rounded-full flex items-center justify-center gap-3 shadow-sm hover:bg-gray-50 transition-colors">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48" class="abcRioButtonSvg"><g><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></g></svg>
                    تسجيل بحساب كوكل
                </button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">لدي حساب بالفعل</button>
            </div>

            <div id="forgot-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">استعادة كلمة السر</h2>
                <p class="text-sm text-gray-500 text-center mb-4">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لإعادة تعيين كلمة السر.</p>
                <input type="email" id="forgot-email" placeholder="البريد الإلكتروني" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.resetPassword()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">إرسال الرمز</button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">العودة لتسجيل الدخول</button>
            </div>
        </div>
    </div>

    <!-- 3. إعداد الصورة الشخصية -->
    <div id="setup-profile-screen" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 smooth-scroll">
        <h2 class="text-3xl font-bold mb-2 text-center text-gray-800">اختيار صورة للحساب</h2>
        <p class="text-gray-500 mb-8 text-center">اجعل حسابك مميزاً بإضافة صورة شخصية</p>
        
        <label for="profile-upload" class="relative cursor-pointer mb-8 btn-tap inline-block">
            <div id="profile-preview-container" class="w-40 h-40 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-4 border-dashed border-blue-400 shadow-inner">
                <i class="ph ph-camera text-5xl text-gray-400"></i>
                <img id="profile-preview-img" class="hidden w-full h-full object-cover">
            </div>
            <div class="absolute bottom-1 right-1 bg-blue-600 p-3 rounded-full text-white border-4 border-white shadow-md">
                <i class="ph ph-plus font-bold text-lg"></i>
            </div>
            <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="Auth.handleImageUpload(event)">
        </label>

        <button onclick="Auth.completeProfileSetup()" class="btn-tap w-full max-w-xs bg-xylo text-white font-bold py-4 rounded-xl shadow-lg">التالي</button>
    </div>

    <!-- 4. التطبيق الرئيسي -->
    <div id="main-app" class="hidden flex-1 flex flex-col h-screen w-full relative">
        
        <header class="theme-nav px-4 py-3 flex justify-between items-center z-20 relative shadow-sm border-b">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter" style="letter-spacing: 1px;">زايلو</h1>
            <div class="flex gap-3">
                <button onclick="UI.openModal('search-modal')" class="w-10 h-10 rounded-full theme-card flex items-center justify-center btn-tap border">
                    <i class="ph ph-magnifying-glass text-xl"></i>
                </button>
            </div>
        </header>

        <nav class="theme-nav w-full z-10 shadow-sm sticky top-0 border-b">
            <div class="flex justify-between items-center px-2">
                <button onclick="UI.switchTab('home')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-blue-600 border-b-2 border-blue-600 transition-colors btn-tap">
                    <i class="ph-fill ph-house text-2xl"></i>
                </button>
                <button onclick="UI.switchTab('notes')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-users text-2xl"></i>
                    <span id="badge-requests" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('messages')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-chat-circle-text text-2xl"></i>
                    <span id="badge-messages" class="hidden absolute top-1 right-1/4 bg-blue-600 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('notifications')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-bell text-2xl"></i>
                    <span id="badge-notifications" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('settings')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors btn-tap">
                    <i class="ph ph-list text-2xl"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto hide-scrollbar smooth-scroll relative ptr-container" id="main-content-area">
            <div id="ptr-spinner" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center">
                <i class="ph ph-arrow-circle-down animate-spin text-blue-600 text-2xl"></i>
            </div>
            
            <!-- القسم الأول: الرئيسية -->
            <div id="tab-home" class="p-2 space-y-3 pb-6">
                <div class="theme-card p-3 rounded-xl shadow-sm flex gap-3 items-center border">
                    <img id="current-user-avatar-home" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <div class="flex-1 theme-bg hover:opacity-80 transition-colors rounded-full px-4 py-2.5 flex items-center cursor-pointer btn-tap" onclick="UI.openModal('create-post-modal')">
                        <span class="text-sm opacity-60">بم تفكر؟</span>
                    </div>
                </div>
                <div id="feed-container" class="space-y-3">
                    <div class="text-center text-gray-400 py-10"><i class="ph ph-spinner-gap animate-spin text-3xl mx-auto mb-2"></i>جاري التحميل...</div>
                </div>
            </div>

            <!-- القسم الثاني: الرسائل -->
            <div id="tab-messages" class="hidden p-2">
                <div class="flex justify-between items-center p-2 mb-2">
                    <h2 class="text-xl font-bold theme-text">الرسائل</h2>
                </div>
                <div id="chats-container" class="theme-card rounded-xl shadow-sm overflow-hidden min-h-[400px] border">
                </div>
            </div>

            <!-- القسم الثالث: الأصدقاء والملاحظات -->
            <div id="tab-notes" class="hidden p-2 space-y-3 flex flex-col h-full">
                <div class="theme-card rounded-xl shadow-sm p-4 shrink-0 border">
                    <div class="flex overflow-x-auto smooth-scroll hide-scrollbar gap-4 pb-2 pt-2 items-start" id="notes-container" style="scroll-snap-type: x mandatory;">
                        <div class="inline-flex flex-col items-center relative cursor-pointer shrink-0 btn-tap w-16" onclick="App.checkAndCreateNote()" style="scroll-snap-align: start;">
                            <div class="relative">
                                <img id="current-user-avatar-note" class="w-16 h-16 rounded-full object-cover border-2 border-transparent p-0.5" style="border-color: var(--bg-color);">
                                <div class="absolute bottom-0 right-0 bg-blue-600 rounded-full p-1 border-2" style="border-color: var(--card-bg);" id="my-note-plus-icon">
                                    <i class="ph ph-plus text-white text-xs font-bold"></i>
                                </div>
                            </div>
                            <span class="text-[11px] font-bold mt-1 w-full text-center truncate theme-text">أنت</span>
                        </div>
                    </div>
                </div>

                <div class="theme-card rounded-xl shadow-sm flex-1 flex flex-col overflow-hidden border">
                    <div class="flex border-b" style="border-color: var(--border-color);">
                        <button onclick="App.switchFriendsSubTab('requests')" id="subtab-requests" class="flex-1 py-3 text-center text-sm font-bold sub-tab-active btn-tap transition-colors">الطلبات</button>
                        <button onclick="App.switchFriendsSubTab('friends')" id="subtab-friends" class="flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors">الأصدقاء</button>
                        <button onclick="App.switchFriendsSubTab('suggestions')" id="subtab-suggestions" class="flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors">اقتراحات</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto smooth-scroll p-3 relative">
                        <div id="subtab-content-requests" class="space-y-3"></div>
                        <div id="subtab-content-friends" class="hidden space-y-3"></div>
                        <div id="subtab-content-suggestions" class="hidden space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- القسم الرابع: الإشعارات -->
            <div id="tab-notifications" class="hidden p-2">
                <h2 class="text-xl font-bold p-2 mb-2 theme-text">الإشعارات</h2>
                <div id="notifications-container" class="theme-card rounded-xl shadow-sm overflow-hidden min-h-[400px] border">
                </div>
            </div>

            <!-- القسم الخامس: الإعدادات -->
            <div id="tab-settings" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-6 theme-text">القائمة</h2>
                
                <div class="theme-card rounded-xl p-4 shadow-sm flex items-center gap-4 mb-6 cursor-pointer btn-tap border" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <img id="settings-avatar" src="" class="w-14 h-14 rounded-full object-cover bg-gray-200 border border-gray-100">
                    <div class="flex-1 flex items-center gap-1">
                        <h3 id="settings-name" class="font-bold text-lg leading-tight theme-text">...</h3>
                    </div>
                    <i class="ph ph-caret-left text-gray-400 text-xl"></i>
                </div>

                <div class="space-y-3">
                    <div class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ph-fill ph-moon text-xl"></i></div>
                            <span class="font-semibold text-right theme-text">الوضع الليلي</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="theme-toggle" class="sr-only peer" onchange="App.toggleTheme(this.checked)">
                            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <button onclick="UI.openModal('edit-profile-modal')" class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-user-pen text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right theme-text">تعديل الملف الشخصي</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('privacy-modal')" class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="ph-fill ph-lock-key text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right theme-text">الخصوصية</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('account-settings-modal')" class="w-full theme-card p-4 rounded-xl shadow-sm border flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ph-fill ph-gear text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right theme-text">إعدادات الحساب والأمان</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="Auth.logout()" class="w-full bg-red-50 p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap mt-8 border border-red-100">
                        <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="ph-fill ph-sign-out text-xl"></i></div>
                        <span class="font-bold flex-1 text-right text-red-600">تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- رسائل النظام -->
    <div id="msg-box" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-[200] opacity-0 pointer-events-none transition-opacity duration-300 flex items-center gap-2 text-sm font-semibold">
        <span id="msg-box-text">رسالة</span>
    </div>

    <!-- نافذة البحث -->
    <div id="search-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="p-4 theme-card border-b flex items-center gap-3">
            <button onclick="UI.closeModal('search-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <div class="flex-1 relative">
                <input type="text" id="search-input" oninput="App.searchUsers()" placeholder="ابحث عن أصدقاء..." class="w-full theme-bg border rounded-full py-2.5 px-4 pr-10 outline-none focus:ring-2 focus:ring-blue-100 theme-text">
                <i class="ph ph-magnifying-glass absolute right-3 top-3 opacity-50 text-lg"></i>
            </div>
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto smooth-scroll p-2 space-y-1">
            <div class="text-center opacity-50 py-10 mt-10">
                <i class="ph ph-magnifying-glass text-4xl mb-2 block mx-auto"></i>
                اكتب للبحث عن مستخدمين
            </div>
        </div>
    </div>

    <div id="mentions-dropdown" class="smooth-scroll border-t-2 border-blue-500 theme-card"></div>

    <!-- نافذة إنشاء منشور -->
    <div id="create-post-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in relative">
        <div class="p-4 border-b flex items-center justify-between theme-card shadow-sm z-10">
            <button onclick="UI.closeModal('create-post-modal')" class="p-2 font-bold btn-tap rounded-lg">إلغاء</button>
            <span class="font-bold text-lg">إنشاء منشور</span>
            <button onclick="App.createPost()" class="bg-blue-600 text-white px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">نشر</button>
        </div>
        <div class="p-4 flex gap-3 flex-1 overflow-y-auto smooth-scroll relative">
            <img id="create-post-avatar" src="" class="w-12 h-12 rounded-full object-cover border border-gray-100">
            <textarea id="post-text-input" placeholder="بم تفكر؟ استخدم @ لذكر صديق" class="flex-1 resize-none outline-none text-lg pt-2 hide-scrollbar bg-transparent theme-text" rows="10"></textarea>
        </div>
    </div>

    <!-- نافذة إنشاء ملاحظة -->
    <div id="create-note-modal" class="hidden fixed inset-0 z-[70] flex flex-col modal-slide-in relative" style="background-color: #1f2937;">
        <div class="p-4 flex items-center justify-between absolute w-full top-0 z-10 border-none">
            <button onclick="UI.closeModal('create-note-modal')" class="p-2 text-white font-bold btn-tap drop-shadow-md">إلغاء</button>
            <button onclick="App.createNote()" class="bg-white text-gray-900 px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">مشاركة</button>
        </div>
        <div class="flex-1 p-8 flex flex-col items-center justify-center relative">
            <img id="create-note-preview-avatar" src="" class="w-20 h-20 rounded-full border-4 border-gray-700 mb-6 object-cover shadow-lg">
            <textarea id="note-text-input" placeholder="اكتب ملاحظة لـ 24 ساعة... (استخدم @)" class="w-full bg-transparent text-white text-center text-3xl outline-none resize-none placeholder-white/30 font-bold" rows="3" maxlength="60"></textarea>
            <p class="text-white/50 text-xs mt-4">الحد الأقصى 60 حرفاً</p>
        </div>
    </div>

    <!-- الملاحظات عرض -->
    <div id="note-view-modal" class="hidden fixed inset-0 bg-black/95 z-[100] flex flex-col modal-slide-in">
        <div class="p-4 flex items-center gap-3 absolute top-0 w-full z-10 bg-gradient-to-b from-black/80 to-transparent">
            <img id="nv-avatar" class="w-10 h-10 rounded-full border border-gray-600 object-cover cursor-pointer btn-tap" onclick="App.viewProfileFromNote()">
            <div class="flex-1 flex flex-col cursor-pointer" onclick="App.viewProfileFromNote()">
                <div class="flex items-center gap-1">
                    <h3 id="nv-name" class="text-white font-bold text-sm">...</h3>
                </div>
                <span id="nv-time" class="text-gray-300 text-[10px]">...</span>
            </div>
            
            <button id="nv-options-btn" class="hidden w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center btn-tap"><i class="ph ph-dots-three-vertical text-xl"></i></button>
            <button onclick="UI.closeModal('note-view-modal')" class="w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center btn-tap"><i class="ph ph-x text-lg"></i></button>
        </div>
        
        <div class="flex-1 flex items-center justify-center p-6 relative">
            <div id="nv-text" class="text-white text-3xl font-black text-center leading-relaxed whitespace-pre-wrap">...</div>
        </div>

        <div id="note-bottom-section" class="p-4 w-full flex flex-col gap-3 z-10 bg-gradient-to-t from-black/80 to-transparent pb-safe relative">
            <div id="note-reply-section" class="hidden flex gap-3 items-center w-full">
                <input type="text" id="note-reply-input" placeholder="إرسال رسالة..." class="flex-1 bg-white/10 text-white placeholder-white/50 border border-white/20 rounded-full px-5 py-3 outline-none text-sm focus:bg-white/20 transition-colors backdrop-blur-sm">
                <!-- المطلب 4: منع فقدان التركيز عند الارسال -->
                <button onmousedown="event.preventDefault(); App.sendNoteReply();" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shadow-lg shrink-0"><i class="ph-fill ph-paper-plane-right text-xl"></i></button>
            </div>
            <div id="note-viewers-section" class="hidden flex flex-col items-center w-full">
                <button onclick="App.showNoteViewers()" class="flex flex-col items-center gap-1 text-white opacity-80 hover:opacity-100 transition-opacity btn-tap p-2">
                    <i class="ph ph-eye text-2xl"></i>
                    <span id="note-viewers-count" class="text-sm font-bold">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة المشاهدين المنبثقة -->
    <div id="viewers-list-modal" class="hidden fixed inset-0 z-[110] flex flex-col justify-end bg-black/50">
        <div class="theme-card w-full h-[60vh] rounded-t-3xl flex flex-col modal-slide-in shadow-2xl relative">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="font-bold text-lg"><i class="ph ph-eye"></i> المشاهدون</span>
                <button onclick="UI.closeModal('viewers-list-modal')" class="w-8 h-8 theme-bg rounded-full flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
            </div>
            <div id="viewers-list-container" class="flex-1 overflow-y-auto smooth-scroll p-2"></div>
        </div>
    </div>

    <!-- نافذة تعديل الملاحظة المنبثقة -->
    <div id="manage-note-modal" class="hidden fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-4">
        <div class="theme-card rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative border">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">تعديل الملاحظة</h3>
            </div>
            <div class="p-4 space-y-4">
                <textarea id="edit-note-input" class="w-full theme-bg p-4 rounded-xl outline-none text-center font-bold text-lg resize-none border" rows="2" maxlength="60"></textarea>
                <div class="flex flex-col gap-2">
                    <button onclick="App.updateNote()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap">حفظ التعديل</button>
                    <button onclick="UI.closeModal('manage-note-modal')" class="w-full opacity-60 font-bold py-3 rounded-xl btn-tap">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة التعليقات -->
    <div id="comments-modal" class="hidden fixed inset-0 z-[80] flex flex-col justify-end bg-black/50">
        <div class="theme-card w-full h-[85vh] rounded-t-3xl flex flex-col modal-slide-in shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="font-bold text-lg">التعليقات</span>
                <button onclick="UI.closeModal('comments-modal')" class="w-8 h-8 theme-bg rounded-full flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
            </div>
            <div id="comments-list" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-5">
            </div>
            <div class="p-3 border-t flex gap-2 items-center theme-card pb-safe z-10">
                <img id="comment-my-avatar" src="" class="w-9 h-9 rounded-full object-cover">
                <input type="text" id="comment-input" placeholder="اضف تعليقاً... (استخدم @)" class="flex-1 theme-bg border rounded-full px-4 py-2.5 outline-none text-sm transition-colors">
                <button onmousedown="event.preventDefault(); App.addComment();" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shrink-0 shadow-md"><i class="ph-fill ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل الملف الشخصي -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm theme-card z-10">
            <button onclick="UI.closeModal('edit-profile-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">تعديل الملف الشخصي</span>
            <button onclick="App.saveProfile()" class="bg-blue-600 text-white px-4 py-1.5 rounded-full font-bold btn-tap text-sm">حفظ</button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto smooth-scroll flex-1">
            <div class="flex flex-col items-center mb-4">
                <label for="edit-profile-pic" class="relative cursor-pointer group btn-tap">
                    <img id="edit-profile-img" src="" class="w-28 h-28 rounded-full object-cover border-4 border-gray-100 shadow-sm">
                    <div class="absolute bottom-0 right-0 bg-blue-600 p-2.5 rounded-full text-white border-2 border-white shadow-md"><i class="ph ph-camera"></i></div>
                    <input type="file" id="edit-profile-pic" accept="image/*" class="hidden" onchange="App.handleEditImage(event)">
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl space-y-4 border">
                <div>
                    <label class="text-xs font-bold opacity-60 block mb-1">الاسم</label>
                    <input type="text" id="edit-name" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 font-bold text-lg transition-colors theme-text">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 block mb-1">المعرف (مرة واحدة كل 10 أيام)</label>
                    <input type="text" id="edit-username" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 dir-ltr text-left font-mono text-lg transition-colors disabled:opacity-50 theme-text" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_.]/g, '')">
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 block mb-1">النبذة (Bio)</label>
                    <textarea id="edit-bio" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 resize-none transition-colors theme-text" rows="3"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الخصوصية -->
    <div id="privacy-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="theme-card p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('privacy-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">إعدادات الخصوصية</span>
        </div>
        <div class="p-4 space-y-3 smooth-scroll overflow-y-auto">
            <div class="theme-card p-4 rounded-2xl shadow-sm flex justify-between items-center border">
                <div>
                    <h4 class="font-bold">استقبال طلبات الصداقة</h4>
                    <p class="text-xs opacity-60 mt-0.5">السماح للآخرين بإرسال طلبات لك</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-requests" class="sr-only peer" onchange="App.updatePrivacy('allowRequests', this.checked)">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm flex justify-between items-center border">
                <div>
                    <h4 class="font-bold">حساب خاص</h4>
                    <p class="text-xs opacity-60 mt-0.5">إخفاء منشوراتك عن غير الأصدقاء</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-private" class="sr-only peer" onchange="App.updatePrivacy('isPrivate', this.checked)">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm space-y-3 border">
                <h4 class="font-bold border-b pb-2">من يمكنه رؤية أصدقائي</h4>
                <select id="priv-friends-vis" class="w-full theme-bg p-3 rounded-xl outline-none border focus:border-blue-500 theme-text" onchange="App.updatePrivacy('friendsVisibility', this.value)">
                    <option value="all">الجميع</option>
                    <option value="friends">الأصدقاء فقط</option>
                    <option value="only_me">أنا فقط</option>
                </select>
            </div>
            <div class="theme-card p-4 rounded-2xl shadow-sm space-y-3 border">
                <h4 class="font-bold border-b pb-2">من يمكنه مراسلتي</h4>
                <select id="priv-msgs" class="w-full theme-bg p-3 rounded-xl outline-none border focus:border-blue-500 theme-text" onchange="App.updatePrivacy('messagePrivacy', this.value)">
                    <option value="all">الجميع</option>
                    <option value="friends">الأصدقاء فقط</option>
                    <option value="closed">مغلق (لا أحد)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- إعدادات الحساب والمحظورين -->
    <div id="account-settings-modal" class="hidden fixed inset-0 theme-bg z-[70] flex flex-col modal-slide-in">
        <div class="theme-card p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('account-settings-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">إعدادات الحساب والأمان</span>
        </div>
        <div class="p-4 space-y-4">
            <button onclick="UI.openModal('blocked-users-modal')" class="w-full theme-card p-5 rounded-2xl shadow-sm border flex items-center gap-4 btn-tap">
                <div class="w-12 h-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center"><i class="ph-fill ph-prohibit text-2xl"></i></div>
                <div class="flex-1 text-right">
                    <h3 class="font-bold text-lg">المستخدمين المحظورين</h3>
                    <p class="text-xs opacity-60 mt-0.5">إدارة الأشخاص المحظورين</p>
                </div>
                <i class="ph ph-caret-left opacity-50"></i>
            </button>

            <div class="theme-card rounded-2xl shadow-sm border overflow-hidden">
                <button onclick="document.getElementById('password-section-content').classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('-rotate-90')" class="w-full p-5 flex items-center gap-4 btn-tap">
                    <div class="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i class="ph-fill ph-shield-warning text-2xl"></i></div>
                    <div class="flex-1 text-right">
                        <h3 class="font-bold text-lg">تغيير كلمة السر</h3>
                    </div>
                    <i class="ph ph-caret-down opacity-50 chevron transition-transform duration-300"></i>
                </button>
                <div id="password-section-content" class="hidden px-5 pb-5 pt-2 border-t">
                    <p class="text-sm opacity-60 mb-4">سيتم إرسال رابط لبريدك الإلكتروني لإعادة تعيين كلمة السر الخاصة بك بأمان.</p>
                    <button onclick="Auth.resetPasswordFromSettings()" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-xl border border-red-100 btn-tap">إرسال رابط التغيير</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة المحظورين -->
    <div id="blocked-users-modal" class="hidden fixed inset-0 theme-bg z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm theme-card z-10 sticky top-0">
            <button onclick="UI.closeModal('blocked-users-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">المحظورين</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-4" id="blocked-list-container">
        </div>
    </div>

    <!-- الملف الشخصي -->
    <div id="profile-modal" class="hidden fixed inset-0 theme-bg z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 bg-opacity-80 backdrop-blur-md absolute w-full top-0 z-20 text-white" id="vp-header-bg">
            <button onclick="UI.closeModal('profile-modal')" class="p-2 bg-black/30 rounded-full btn-tap text-white"><i class="ph ph-arrow-right text-lg"></i></button>
            <span id="vp-header-name" class="font-bold text-lg">الملف الشخصي</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll pb-10 relative">
            <div class="h-64 bg-gradient-to-tr from-blue-600 to-indigo-800 relative flex items-end justify-center pb-4 pt-16" id="vp-cover">
                <div class="absolute -bottom-16 flex flex-col items-center">
                    <img id="vp-image" src="" class="w-32 h-32 rounded-full border-4 border-white object-cover bg-white shadow-xl">
                </div>
            </div>
            
            <div class="px-4 mt-20 text-center">
                <h2 id="vp-name" class="text-3xl font-black leading-tight theme-text">...</h2>
                <p id="vp-username" class="text-gray-500 text-sm mt-1 font-medium">@...</p>
                <p id="vp-bio" class="mt-4 opacity-80 leading-relaxed text-center max-w-sm mx-auto">...</p>
                
                <div class="flex justify-center mt-6 gap-3" id="vp-action-container"></div>
            </div>

            <div class="mt-8 px-4">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-bold text-xl theme-text">الأصدقاء</h3>
                    <span class="text-gray-500 font-bold" id="vp-friends-count-text">0</span>
                </div>
                <div class="friends-grid" id="vp-friends-grid">
                </div>
            </div>
            
        </div>
    </div>

    <!-- نافذة المحادثة المحدثة بالمطالب 3, 4, 5, 6, 7 -->
    <div id="chat-modal" class="hidden fixed inset-0 theme-bg z-[90] flex flex-col modal-slide-in">
        <!-- هيدر المحادثة -->
        <div class="theme-card p-3 border-b flex items-center justify-between shadow-sm z-20">
            <div class="flex items-center gap-3">
                <button onclick="UI.closeModal('chat-modal')" class="p-2 theme-bg border rounded-full btn-tap shrink-0"><i class="ph ph-arrow-right text-lg"></i></button>
                <div class="relative cursor-pointer shrink-0" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                    <img id="chat-user-img" src="" class="w-11 h-11 rounded-full object-cover">
                    <span id="chat-online-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full hidden"></span>
                </div>
                <div class="flex-1 overflow-hidden min-w-0 cursor-pointer" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                    <h3 id="chat-user-name" class="font-bold leading-tight truncate">...</h3>
                    <p id="chat-user-status" class="text-[11px] opacity-60 truncate mt-0.5">...</p>
                </div>
            </div>
            <!-- المطلب 6: حاوية كائن المحادثة (Pet) بالعكس من مكان الاسم -->
            <div id="chat-pet-container" class="w-10 h-10 flex items-center justify-center relative shrink-0">
                <!-- سيتم وضع الكائن هنا بواسطة جافاسكربت -->
            </div>
        </div>
        
        <div id="chat-background" class="flex-1 overflow-hidden flex flex-col relative chat-container-bg">
            <div id="chat-messages-container" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-4 flex flex-col relative z-10 pb-4 overflow-x-hidden">
                <!-- الرسائل -->
                <!-- المطلب 5: فقاعة الكتابة الحية -->
                <div id="live-typing-bubble" class="hidden self-start max-w-[80%] rounded-2xl rounded-bl-sm p-3 shadow-sm bubble-other opacity-80 mt-auto typing-cursor text-sm transition-opacity">
                    ...
                </div>
            </div>
        </div>

        <div id="replying-to-container" class="hidden theme-card border-t px-4 py-2 flex items-center justify-between shadow-[0_-2px_10px_rgba(0,0,0,0.02)] z-10 relative">
            <div class="flex flex-col border-r-4 border-blue-500 pr-3">
                <span class="text-xs font-bold text-blue-600" id="reply-to-name">الرد على...</span>
                <span class="text-sm opacity-80 truncate max-w-[250px]" id="reply-to-text">...</span>
            </div>
            <button onclick="App.cancelReply()" class="w-8 h-8 rounded-full theme-bg flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
        </div>

        <div class="p-3 theme-card border-t flex gap-2 items-end pb-safe z-20 relative">
            <textarea id="chat-input" placeholder="الرسالة..." class="flex-1 theme-bg border border-transparent rounded-3xl px-5 py-3 outline-none resize-none max-h-28 hide-scrollbar text-[15px] transition-colors theme-text focus:border-blue-500" rows="1" oninput="this.style.height = '';this.style.height = Math.min(this.scrollHeight, 112) + 'px'; App.handleTyping(this.value);"></textarea>
            <!-- المطلب 4: منع النزول بعد الضغط على إرسال باستخدام preventDefault -->
            <button onmousedown="event.preventDefault(); App.sendMessage();" ontouchstart="event.preventDefault(); App.sendMessage();" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 transition-colors text-white rounded-full flex items-center justify-center shrink-0 btn-tap shadow-md mb-0.5"><i class="ph-fill ph-paper-plane-right text-xl pointer-events-none"></i></button>
        </div>
    </div>

    <!-- المطلب 8: قائمة الخيارات المنبثقة بشكل يحاكي Telegram -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center" onclick="if(event.target === this) UI.closeModal('action-modal')">
        <div id="action-modal-content" class="telegram-menu flex flex-col text-sm font-semibold theme-text">
            <!-- سيتم إضافة الأزرار من خلال جافاسكربت -->
        </div>
    </div>

    <!-- عرض منشور مفرد -->
    <div id="single-post-modal" class="hidden fixed inset-0 theme-bg z-[85] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 theme-card shadow-sm sticky top-0 z-10">
            <button onclick="UI.closeModal('single-post-modal')" class="p-2 theme-bg rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">عرض المنشور</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-2" id="single-post-container">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // المطلب 9: استخدام signInWithRedirect لحل مشاكل Webview
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDe7WeScgMaRAK7PzExvkzppb2XOcdAI0k",
                authDomain: "communication-5dd27.firebaseapp.com",
                databaseURL: "https://communication-5dd27-default-rtdb.firebaseio.com",
                projectId: "communication-5dd27",
                storageBucket: "communication-5dd27.firebasestorage.app",
                messagingSenderId: "79255528858",
                appId: "1:79255528858:web:6c75eee637561056b28623"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xylo-app-123';

        const USERS_PATH = `artifacts/${appId}/public/data/users`;
        const POSTS_PATH = `artifacts/${appId}/public/data/posts`;
        const COMMENTS_PATH = `artifacts/${appId}/public/data/comments`;
        const REQUESTS_PATH = `artifacts/${appId}/public/data/requests`;
        const FRIENDS_PATH = `artifacts/${appId}/public/data/friends`;
        const MESSAGES_PATH = `artifacts/${appId}/public/data/messages`;
        const NOTES_PATH = `artifacts/${appId}/public/data/notes`;
        const NOTIFS_PATH = `artifacts/${appId}/public/data/notifications`;
        const TYPING_PATH = `artifacts/${appId}/public/data/typing`; // المطلب 5

        window.Memory = {
            users: {}, posts: [], comments: [], requests: [], friends: [], messages: [], notes: [], notifications: []
        };

        window.currentUser = null;
        window.currentChatUserId = null;
        window.currentPostIdForComment = null;
        window.currentManageNoteId = null;
        window.noteViewAuthorId = null; 
        window.replyingToMessage = null; 

        // المطلب 3: إصلاح ارتفاع الشاشة فوق الكيبورد
        if(window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.documentElement.style.setProperty('--vh', `${window.visualViewport.height * 0.01}px`);
                const chatModal = document.getElementById('chat-modal');
                if(!chatModal.classList.contains('hidden')) {
                    const container = document.getElementById('chat-messages-container');
                    if(container) container.scrollTop = container.scrollHeight;
                }
            });
            // Initial set
            document.documentElement.style.setProperty('--vh', `${window.visualViewport.height * 0.01}px`);
        }

        const escapeHTML = (str) => {
            if(!str) return '';
            return str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag] || tag));
        };

        // السحب للتحديث
        window.PullToRefresh = {
            startY: 0, isPulling: false, spinner: null, container: null,
            init: () => {
                PullToRefresh.container = document.getElementById('main-content-area');
                PullToRefresh.spinner = document.getElementById('ptr-spinner');
                
                PullToRefresh.container.addEventListener('touchstart', e => {
                    if (PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.startY = e.touches[0].clientY;
                        PullToRefresh.isPulling = true;
                        PullToRefresh.spinner.style.transition = 'none';
                    }
                }, {passive: true});

                PullToRefresh.container.addEventListener('touchmove', e => {
                    if (!PullToRefresh.isPulling) return;
                    const y = e.touches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    if (diff > 0 && PullToRefresh.container.scrollTop <= 0) {
                        e.preventDefault();
                        let pullDistance = Math.min(diff * 0.4, 70); 
                        PullToRefresh.spinner.style.transform = `translate(-50%, ${pullDistance}px) rotate(${pullDistance*2}deg)`;
                        PullToRefresh.spinner.style.opacity = Math.min(pullDistance / 50, 1);
                    }
                }, {passive: false});

                PullToRefresh.container.addEventListener('touchend', e => {
                    if (!PullToRefresh.isPulling) return;
                    PullToRefresh.isPulling = false;
                    PullToRefresh.spinner.style.transition = 'transform 0.3s, opacity 0.3s';
                    
                    const y = e.changedTouches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    
                    if (diff > 80 && PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.spinner.style.transform = `translate(-50%, 50px) rotate(360deg)`;
                        PullToRefresh.spinner.classList.add('animate-spin');
                        
                        setTimeout(() => {
                            App.renderFeed();
                            App.renderNotifications();
                            PullToRefresh.spinner.classList.remove('animate-spin');
                            PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                            PullToRefresh.spinner.style.opacity = 0;
                            UI.showMessage('تم التحديث');
                        }, 1000);
                    } else {
                        PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                        PullToRefresh.spinner.style.opacity = 0;
                    }
                }, {passive: true});
            }
        };

        window.Mentions = {
            activeInput: null,
            setup: () => {
                const inputs = ['post-text-input', 'note-text-input', 'comment-input'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('input', (e) => Mentions.checkTrigger(e.target));
                        el.addEventListener('blur', () => setTimeout(() => document.getElementById('mentions-dropdown').style.display = 'none', 200));
                    }
                });
            },
            checkTrigger: (input) => {
                Mentions.activeInput = input;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const words = textBeforeCursor.split(/\s/);
                const lastWord = words[words.length - 1];

                const dropdown = document.getElementById('mentions-dropdown');
                
                if (lastWord.startsWith('@')) {
                    const query = lastWord.substring(1).toLowerCase();
                    Mentions.showList(query, input);
                } else {
                    dropdown.style.display = 'none';
                }
            },
            showList: (query, input) => {
                const dropdown = document.getElementById('mentions-dropdown');
                dropdown.innerHTML = '';
                
                const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                
                let results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    friendsIds.includes(u.uid) &&
                    (u.username.toLowerCase().includes(query) || u.name.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const mentionsCount = currentUser.mentionsCount || {};
                results.sort((a,b) => (mentionsCount[b.uid] || 0) - (mentionsCount[a.uid] || 0));

                results.forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'p-3 flex items-center gap-3 border-b hover:opacity-80 cursor-pointer btn-tap';
                    item.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-8 h-8 rounded-full object-cover border">
                        <div>
                            <div class="font-bold text-sm">${u.name}</div>
                            <div class="text-[10px] opacity-60">@${u.username}</div>
                        </div>
                    `;
                    item.onmousedown = (e) => {
                        e.preventDefault(); 
                        Mentions.selectUser(u.username, u.uid);
                    };
                    dropdown.appendChild(item);
                });

                const rect = input.getBoundingClientRect();
                dropdown.style.bottom = 'auto';
                dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                if(input.id === 'comment-input' || input.id === 'post-text-input') {
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '60px'; 
                }
                
                dropdown.style.display = 'block';
            },
            selectUser: (username, uid) => {
                const input = Mentions.activeInput;
                if(!input) return;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const textAfterCursor = text.substring(cursorPos);
                
                const words = textBeforeCursor.split(/\s/);
                words.pop(); 
                
                const newTextBefore = (words.length > 0 ? words.join(' ') + ' ' : '') + '@' + username + ' ';
                input.value = newTextBefore + textAfterCursor;
                input.focus();
                input.setSelectionRange(newTextBefore.length, newTextBefore.length);
                
                document.getElementById('mentions-dropdown').style.display = 'none';
                App.incrementMentionCount(uid);
            }
        };

        window.UI = {
            showMessage: (msg) => {
                const box = document.getElementById('msg-box');
                document.getElementById('msg-box-text').innerText = msg;
                box.style.opacity = '1';
                setTimeout(() => { box.style.opacity = '0'; }, 3000);
            },
            switchAuth: (formId) => {
                ['login-form', 'register-form', 'forgot-form'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`${formId}-form`).classList.remove('hidden');
            },
            showScreen: (screenId) => {
                ['splash-screen', 'auth-screen', 'setup-profile-screen', 'main-app'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            switchTab: (tabId) => {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                    btn.querySelector('i').classList.remove('ph-fill');
                    btn.querySelector('i').classList.add('ph');
                });
                const activeBtn = document.querySelector(`.nav-btn[onclick="UI.switchTab('${tabId}')"]`);
                if(activeBtn) {
                    activeBtn.classList.remove('text-gray-500', 'border-transparent');
                    activeBtn.classList.add('text-blue-600', 'border-blue-600');
                    activeBtn.querySelector('i').classList.remove('ph');
                    activeBtn.querySelector('i').classList.add('ph-fill');
                }

                ['tab-home', 'tab-messages', 'tab-notes', 'tab-notifications', 'tab-settings'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                
                App.updateLastActive();
                
                if(tabId === 'messages') App.renderChats(); 
                if(tabId === 'notes') {
                    document.getElementById('badge-requests').classList.add('hidden');
                    App.switchFriendsSubTab('friends');
                }
                if(tabId === 'notifications') document.getElementById('badge-notifications').classList.add('hidden');

                document.getElementById('main-content-area').scrollTop = 0;
            },
            openModal: (modalId, data = null) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                // لا نطبق انميشن الدخول لقائمة الاكشن لكي نترك الانميشن الخاص بها
                if (modal.firstElementChild && (modal.firstElementChild.classList.contains('modal-slide-in') || modal.firstElementChild.classList.contains('modal-slide-out'))) {
                    modal.firstElementChild.classList.remove('modal-slide-out');
                    modal.firstElementChild.classList.add('modal-slide-in');
                }

                if (modalId === 'profile-modal' && data) {
                    App.renderUserProfile(data);
                } else if (modalId === 'chat-modal' && data) {
                    window.currentChatUserId = data;
                    App.cancelReply(); 
                    App.renderChatInfo(data);
                    App.renderMessages();
                    App.markChatAsRead(data); 
                } else if (modalId === 'comments-modal' && data) {
                    window.currentPostIdForComment = data;
                    document.getElementById('comment-my-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    App.renderComments();
                } else if (modalId === 'edit-profile-modal') {
                    document.getElementById('edit-name').value = currentUser.name || '';
                    document.getElementById('edit-bio').value = currentUser.bio || '';
                    document.getElementById('edit-profile-img').src = currentUser.photo || App.getDefaultAvatar();
                    
                    const usernameInput = document.getElementById('edit-username');
                    usernameInput.value = currentUser.username || '';
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) {
                        usernameInput.disabled = true;
                        UI.showMessage('تغيير المعرف معطل مؤقتاً (مرة كل 10 أيام)');
                    } else {
                        usernameInput.disabled = false;
                    }
                } else if (modalId === 'privacy-modal') {
                    document.getElementById('priv-requests').checked = currentUser.allowRequests !== false;
                    document.getElementById('priv-private').checked = currentUser.isPrivate === true;
                    document.getElementById('priv-friends-vis').value = currentUser.friendsVisibility || 'all';
                    document.getElementById('priv-msgs').value = currentUser.messagePrivacy || 'all';
                } else if (modalId === 'create-note-modal') {
                    document.getElementById('create-note-preview-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    document.getElementById('note-text-input').value = '';
                } else if (modalId === 'blocked-users-modal') {
                    App.renderBlockedUsers(); 
                }
            },
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal.firstElementChild && modal.firstElementChild.classList.contains('modal-slide-in')) {
                    modal.firstElementChild.classList.remove('modal-slide-in');
                    modal.firstElementChild.classList.add('modal-slide-out');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                } else {
                    modal.classList.add('hidden');
                }
            },
            openProfileByUsername: (username) => {
                const u = Object.values(Memory.users).find(user => user.username === username);
                if(u) {
                    UI.closeModal('comments-modal');
                    UI.closeModal('note-view-modal');
                    UI.openModal('profile-modal', u.uid);
                } else {
                    UI.showMessage('المستخدم غير موجود');
                }
            }
        };

        let tempPhotoBase64 = null;

        window.Auth = {
            init: async () => {
                UI.showScreen('splash-screen');

                // المطلب 9: التقاط نتيجة التحويل في حال كان قد تم تحويله لجوجل
                try {
                    const redirectResult = await getRedirectResult(auth);
                    if (redirectResult && redirectResult.user) {
                        const user = redirectResult.user;
                        const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                        if (!userDoc.exists()) {
                            await setDoc(doc(db, USERS_PATH, user.uid), {
                                uid: user.uid,
                                name: user.displayName || 'مستخدم زايلو',
                                email: user.email,
                                photo: user.photoURL || App.getDefaultAvatar(),
                                username: 'user_' + Math.floor(Math.random() * 100000),
                                bio: 'مرحباً، أنا أستخدم تطبيق زايلو!',
                                allowRequests: true,
                                isPrivate: false,
                                friendsVisibility: 'all',
                                messagePrivacy: 'all',
                                lastActive: Date.now(),
                                lastUsernameChange: 0,
                                blockedUsers: [],
                                mentionsCount: {}
                            });
                        }
                    }
                } catch(e) { console.error("Redirect Error: ", e); }

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e){}
                } 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                        if (userDoc.exists()) {
                            window.currentUser = userDoc.data();
                            if(!window.currentUser.blockedUsers) window.currentUser.blockedUsers = [];
                            if(!window.currentUser.mentionsCount) window.currentUser.mentionsCount = {};
                            
                            // تحميل الثيم
                            const savedTheme = localStorage.getItem('xylo-theme');
                            if(savedTheme === 'dark') {
                                document.body.classList.add('dark-theme');
                                const themeToggle = document.getElementById('theme-toggle');
                                if(themeToggle) themeToggle.checked = true;
                            }

                            // المطلب 2: تزامن الشاشة البداية، بمجرد التحميل نظهر التطبيق مباشرة وتختفي شاشة Z
                            setTimeout(() => { App.startCore(); }, 500); 
                            
                            const urlParams = new URLSearchParams(window.location.search);
                            const postIdParam = urlParams.get('post');
                            if(postIdParam) {
                                setTimeout(() => App.openSinglePost(postIdParam), 1000);
                            }
                        } else {
                            setTimeout(() => { UI.showScreen('setup-profile-screen'); }, 500);
                        }
                    } else {
                        // المطلب 2: انميشن ثانيتين لغير المسجل
                        window.currentUser = null;
                        setTimeout(() => { UI.showScreen('auth-screen'); }, 2000);
                    }
                });
            },
            register: async () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                if(!name || !email || !password) return UI.showMessage('يرجى ملء جميع الحقول');
                
                try {
                    UI.showMessage('جاري الإنشاء...');
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    window.tempRegData = { uid: cred.user.uid, name, email };
                    UI.showScreen('setup-profile-screen');
                } catch (error) {
                    UI.showMessage('حدث خطأ، ربما البريد مستخدم مسبقاً أو الرمز ضعيف');
                }
            },
            // المطلب 9: تصحيح تسجيل الدخول بكوكل للتوافق مع WebView
            loginWithGoogle: async () => {
                try {
                    UI.showMessage('جاري الاتصال بجوجل...');
                    await signInWithPopup(auth, googleProvider);
                    // إذا نجح المنبثق لا نفعل شيئا إضافيا، سيقوم onAuthStateChanged بالباقي
                } catch (error) {
                    console.error(error);
                    // إذا تم حظر النافذة أو نحن في WebView، نستخدم التحويل المباشر Redirect
                    if(error.code === 'auth/popup-blocked' || error.code === 'auth/unauthorized-domain' || error.message.includes('popup')) {
                        UI.showMessage('جاري التحويل المباشر لإكمال التسجيل...');
                        await signInWithRedirect(auth, googleProvider);
                    } else {
                        UI.showMessage('فشل تسجيل الدخول: ' + error.message);
                    }
                }
            },
            login: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if(!email || !password) return UI.showMessage('يرجى ملء الحقول');
                try {
                    UI.showMessage('جاري تسجيل الدخول...');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    UI.showMessage('البريد أو كلمة السر غير صحيحة');
                }
            },
            resetPassword: async () => {
                const email = document.getElementById('forgot-email').value;
                if(!email) return UI.showMessage('أدخل البريد الإلكتروني');
                try {
                    await sendPasswordResetEmail(auth, email);
                    UI.showMessage('تم إرسال رابط إعادة التعيين لبريدك');
                    UI.switchAuth('login');
                } catch(e) { UI.showMessage('حدث خطأ'); }
            },
            resetPasswordFromSettings: async () => {
                if(auth.currentUser && auth.currentUser.email) {
                    try {
                        await sendPasswordResetEmail(auth, auth.currentUser.email);
                        UI.showMessage('تم إرسال الرابط لبريدك');
                    } catch(e) { UI.showMessage('حدث خطأ'); }
                }
            },
            logout: async () => {
                App.updateLastActive(true); 
                await signOut(auth);
                window.location.reload();
            },
            handleImageUpload: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; const MAX_HEIGHT = 400;
                        let width = img.width; let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        tempPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        document.getElementById('profile-preview-img').src = tempPhotoBase64;
                        document.getElementById('profile-preview-img').classList.remove('hidden');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },
            completeProfileSetup: async () => {
                if(!window.tempRegData && !auth.currentUser) return;
                UI.showMessage('جاري حفظ الحساب...');
                const uid = window.tempRegData ? window.tempRegData.uid : auth.currentUser.uid;
                const name = window.tempRegData ? window.tempRegData.name : 'مستخدم';
                const email = window.tempRegData ? window.tempRegData.email : '';
                
                const userData = {
                    uid: uid,
                    name: name,
                    email: email,
                    photo: tempPhotoBase64 || App.getDefaultAvatar(),
                    username: 'user_' + Math.floor(Math.random() * 1000000),
                    bio: 'مرحباً، أنا أستخدم تطبيق زايلو!',
                    allowRequests: true,
                    isPrivate: false,
                    friendsVisibility: 'all',
                    messagePrivacy: 'all',
                    lastActive: Date.now(),
                    lastUsernameChange: 0,
                    blockedUsers: [],
                    mentionsCount: {}
                };

                await setDoc(doc(db, USERS_PATH, uid), userData);
                window.currentUser = userData;
                App.startCore();
            }
        };

        window.App = {
            getDefaultAvatar: () => "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>",
            
            toggleTheme: (isDark) => {
                if(isDark) {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('xylo-theme', 'dark');
                } else {
                    document.body.classList.remove('dark-theme');
                    localStorage.setItem('xylo-theme', 'light');
                }
            },

            startCore: () => {
                UI.showScreen('main-app');
                App.updateUIWithUserData();
                App.setupListeners();
                App.updateLastActive();
                Mentions.setup();
                PullToRefresh.init();
                setInterval(App.updateLastActive, 60000);
                
                const themeToggle = document.getElementById('theme-toggle');
                if(themeToggle) themeToggle.checked = document.body.classList.contains('dark-theme');
            },

            updateUIWithUserData: () => {
                const photo = currentUser.photo || App.getDefaultAvatar();
                document.getElementById('current-user-avatar-home').src = photo;
                document.getElementById('current-user-avatar-note').src = photo;
                document.getElementById('settings-avatar').src = photo;
                document.getElementById('settings-name').innerText = currentUser.name;
                document.getElementById('create-post-avatar').src = photo;
            },

            updateLastActive: async (forceOffline = false) => {
                if(!currentUser) return;
                const now = forceOffline ? (Date.now() - (6 * 60 * 1000)) : Date.now();
                currentUser.lastActive = now;
                try {
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { lastActive: now });
                } catch(e){}
            },

            setupListeners: () => {
                const errHandler = (e) => console.error("Firebase Read Error:", e);

                onSnapshot(collection(db, USERS_PATH), (snap) => {
                    snap.docs.forEach(d => {
                        const data = d.data();
                        Memory.users[d.id] = data;
                        if(d.id === currentUser.uid) {
                            currentUser.blockedUsers = data.blockedUsers || [];
                            currentUser.mentionsCount = data.mentionsCount || {};
                            App.updateUIWithUserData();
                        }
                    });
                    App.renderChats(); 
                    App.renderFeed(); 
                }, errHandler);

                onSnapshot(collection(db, POSTS_PATH), (snap) => {
                    Memory.posts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFeed();
                }, errHandler);

                onSnapshot(collection(db, COMMENTS_PATH), (snap) => {
                    Memory.comments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(window.currentPostIdForComment) App.renderComments();
                    App.renderFeed(); 
                }, errHandler);

                onSnapshot(collection(db, REQUESTS_PATH), (snap) => {
                    Memory.requests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFriendsTab('requests'); 
                }, errHandler);

                onSnapshot(collection(db, FRIENDS_PATH), (snap) => {
                    Memory.friends = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderNotes();
                    App.renderFriendsTab('friends'); 
                }, errHandler);

                onSnapshot(collection(db, NOTES_PATH), (snap) => {
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    Memory.notes = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                        .filter(n => (now - n.timestamp) < oneDay);
                    App.renderNotes();
                }, errHandler);

                onSnapshot(collection(db, MESSAGES_PATH), (snap) => {
                    Memory.messages = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderChats();
                    if(window.currentChatUserId) {
                        const unreadInChat = snap.docs.filter(d => d.data().senderId === window.currentChatUserId && !d.data().read && d.data().participants.includes(currentUser.uid));
                        if(unreadInChat.length > 0) {
                            unreadInChat.forEach(d => updateDoc(d.ref, {read: true}));
                        }
                        App.renderMessages();
                    }
                }, errHandler);

                // المطلب 5: الاستماع للكتابة الحية
                onSnapshot(collection(db, TYPING_PATH), (snap) => {
                    if(!window.currentChatUserId) return;
                    // نبحث عن وثيقة حيث الطرف الآخر هو من يكتب لي
                    const typingDoc = snap.docs.find(d => d.id === `${window.currentChatUserId}_${currentUser.uid}`);
                    const bubble = document.getElementById('live-typing-bubble');
                    if(typingDoc && typingDoc.data().text) {
                        // إذا كانت الكتابة منذ أقل من 5 ثواني
                        if(Date.now() - typingDoc.data().timestamp < 5000) {
                            bubble.innerText = typingDoc.data().text;
                            bubble.classList.remove('hidden');
                            // التمرير للأسفل لرؤية الكتابة
                            const container = document.getElementById('chat-messages-container');
                            container.scrollTop = container.scrollHeight;
                            return;
                        }
                    }
                    bubble.classList.add('hidden');
                }, errHandler);

                onSnapshot(collection(db, NOTIFS_PATH), (snap) => {
                    Memory.notifications = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                            .filter(n => n.to === currentUser.uid);
                    App.renderNotifications();
                }, errHandler);
            },

            // المطلب 5: دالة تحديث حالة الكتابة الحية في القاعدة
            handleTyping: async (text) => {
                const otherUid = window.currentChatUserId;
                if(!otherUid || !currentUser) return;
                try {
                    await setDoc(doc(db, TYPING_PATH, `${currentUser.uid}_${otherUid}`), {
                        text: text,
                        timestamp: Date.now()
                    });
                } catch(e){}
            },

            // المطلب 6: دالة عرض الكائن المطور (Xylo Pet)
            updateChatPet: (msgs) => {
                const container = document.getElementById('chat-pet-container');
                if(!msgs || msgs.length === 0) {
                    container.innerHTML = ''; return;
                }
                const lastMsg = msgs[msgs.length - 1];
                const daysSinceLastMsg = (Date.now() - lastMsg.timestamp) / (1000 * 60 * 60 * 24);
                
                // إذا مر 3 أيام، يعود للمستوى الأول
                let level = 1;
                if(daysSinceLastMsg <= 3) {
                    if(msgs.length > 50) level = 3;
                    else if(msgs.length > 10) level = 2;
                }

                let svgContent = '';
                if(level === 1) {
                    // كائن لطيف بسيط
                    svgContent = `<svg class="w-8 h-8 pet-animate" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#60A5FA"/><path d="M35 45 Q 40 40 45 45" stroke="white" stroke-width="4" stroke-linecap="round"/><path d="M55 45 Q 60 40 65 45" stroke="white" stroke-width="4" stroke-linecap="round"/><path d="M45 60 Q 50 65 55 60" stroke="white" stroke-width="4" stroke-linecap="round"/></svg>`;
                } else if (level === 2) {
                    // كائن أكبر قليلا مع نظارات
                    svgContent = `<svg class="w-9 h-9 pet-animate pet-glow" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#3B82F6"/><circle cx="35" cy="45" r="10" fill="white"/><circle cx="65" cy="45" r="10" fill="white"/><circle cx="35" cy="45" r="4" fill="#1E3A8A"/><circle cx="65" cy="45" r="4" fill="#1E3A8A"/><path d="M45 45 L 55 45" stroke="white" stroke-width="3"/><path d="M40 70 Q 50 80 60 70" stroke="white" stroke-width="5" stroke-linecap="round"/></svg>`;
                } else {
                    // كائن متطور يرتدي تاج
                    svgContent = `<svg class="w-10 h-10 pet-animate pet-glow" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 L 30 10 L 50 25 L 70 10 L 80 30 Z" fill="#FBBF24"/><circle cx="50" cy="55" r="45" fill="#2563EB"/><circle cx="35" cy="50" r="12" fill="white"/><circle cx="65" cy="50" r="12" fill="white"/><circle cx="35" cy="50" r="6" fill="#1E3A8A"/><circle cx="37" cy="48" r="2" fill="white"/><circle cx="65" cy="50" r="6" fill="#1E3A8A"/><circle cx="67" cy="48" r="2" fill="white"/><path d="M40 75 Q 50 85 60 75" stroke="white" stroke-width="6" stroke-linecap="round"/><path d="M10 50 L 20 50 M 80 50 L 90 50 M 15 35 L 22 42 M 85 35 L 78 42" stroke="#60A5FA" stroke-width="3" stroke-linecap="round"/></svg>`;
                }
                
                container.innerHTML = svgContent;
            },

            isFriend: (uid1, uid2) => {
                return Memory.friends.some(f => 
                    (f.user1 === uid1 && f.user2 === uid2) || 
                    (f.user1 === uid2 && f.user2 === uid1)
                );
            },
            isBlocked: (uid) => {
                return currentUser.blockedUsers?.includes(uid);
            },
            timeAgo: (timestamp) => {
                if(!timestamp) return 'غير معروف';
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                if (seconds < 60) return "الآن";
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `منذ ${minutes} دقيقة`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `منذ ${hours} ساعة`;
                const days = Math.floor(hours / 24);
                return `منذ ${days} يوم`;
            },
            isOnline: (lastActive) => {
                if(!lastActive) return false;
                return (Date.now() - lastActive) < (5 * 60 * 1000);
            },
            parseMentions: (text) => {
                const escaped = escapeHTML(text);
                return escaped.replace(/@([\w_.]+)/g, (match, username) => {
                    const exists = Object.values(Memory.users).find(u => u.username === username);
                    if(exists) {
                        return `<span class="text-blue-500 font-bold cursor-pointer hover:underline" onclick="event.stopPropagation(); UI.openProfileByUsername('${username}')">${match}</span>`;
                    }
                    return match; 
                });
            },
            notifyMentions: async (text, type, linkId) => {
                const matches = text.match(/@([\w_.]+)/g);
                if(!matches) return;
                const usernames = matches.map(m => m.substring(1));
                const usersArray = Object.values(Memory.users);
                
                for(let un of usernames) {
                    const mentionedUser = usersArray.find(u => u.username === un);
                    if(mentionedUser && mentionedUser.uid !== currentUser.uid && !App.isBlocked(mentionedUser.uid)) {
                        await App.sendNotification(mentionedUser.uid, `قام بذكرك في ${type}`, linkId);
                    }
                }
            },
            incrementMentionCount: async (uid) => {
                let counts = currentUser.mentionsCount || {};
                counts[uid] = (counts[uid] || 0) + 1;
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { mentionsCount: counts });
            },

            // --- رندر الرئيسية ---
            renderFeed: () => {
                const container = document.getElementById('feed-container');
                container.innerHTML = '';
                
                const sortedPosts = [...Memory.posts].sort((a,b) => b.timestamp - a.timestamp);
                let visibleCount = 0;

                sortedPosts.forEach(post => {
                    const author = Memory.users[post.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    if(author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid)) return;
                    
                    visibleCount++;
                    const isLiked = post.likes && post.likes.includes(currentUser.uid);
                    const likesCount = post.likes ? post.likes.length : 0;
                    const commentsCount = Memory.comments.filter(c => c.postId === post.id).length;
                    const parsedText = App.parseMentions(post.text);

                    const postEl = document.createElement('div');
                    postEl.className = 'theme-card rounded-2xl shadow-sm border overflow-hidden mb-3';
                    postEl.innerHTML = `
                        <div class="p-3.5 flex items-center justify-between">
                            <div class="flex items-center gap-3 cursor-pointer group btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                                <img src="${author.photo || App.getDefaultAvatar()}" class="w-11 h-11 rounded-full object-cover border border-gray-100">
                                <div>
                                    <h4 class="font-bold leading-tight group-hover:text-blue-600 transition-colors flex items-center gap-1 theme-text">${author.name}</h4>
                                    <span class="text-xs opacity-60">${App.timeAgo(post.timestamp)}</span>
                                </div>
                            </div>
                            ${post.authorId === currentUser.uid ? `<button onclick="App.deletePost('${post.id}')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors btn-tap"><i class="ph ph-trash text-lg"></i></button>` : ''}
                        </div>
                        <div class="px-4 py-2 theme-text text-[15px] leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-4 py-3 text-xs opacity-60 flex justify-between items-center mt-2 border-b" style="border-color: var(--border-color);">
                            <div class="flex items-center gap-1"><i class="ph-fill ph-thumbs-up text-blue-500"></i> ${likesCount}</div>
                            <div>${commentsCount} تعليق</div>
                        </div>
                        <div class="flex p-1">
                            <button onclick="App.toggleLike('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl btn-tap font-semibold transition-colors ${isLiked ? 'text-blue-600 bg-blue-50' : 'theme-text hover:bg-gray-100/10'}">
                                <i class="${isLiked ? 'ph-fill' : 'ph'} ph-thumbs-up text-xl"></i> أعجبني
                            </button>
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl theme-text font-semibold hover:bg-gray-100/10 transition-colors btn-tap">
                                <i class="ph ph-chat-centered text-xl"></i> تعليق
                            </button>
                            <button onclick="App.sharePost('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl theme-text font-semibold hover:bg-gray-100/10 transition-colors btn-tap">
                                <i class="ph ph-share-network text-xl"></i> مشاركة
                            </button>
                        </div>
                    `;
                    container.appendChild(postEl);
                });

                if(visibleCount === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-newspaper text-4xl mb-2 block mx-auto"></i>لا توجد منشورات حالياً</div>';
                }
            },

            createPost: async () => {
                const text = document.getElementById('post-text-input').value.trim();
                if(!text) return UI.showMessage('لا يمكن نشر منشور فارغ');
                
                UI.closeModal('create-post-modal');
                document.getElementById('post-text-input').value = '';
                
                const postRef = await addDoc(collection(db, POSTS_PATH), {
                    authorId: currentUser.uid, text: text, timestamp: Date.now(), likes: []
                });
                App.notifyMentions(text, 'منشور', postRef.id);
                UI.showMessage('تم النشر بنجاح');
            },

            deletePost: async (postId) => {
                if(confirm('هل متأكد من حذف المنشور؟')) {
                    await deleteDoc(doc(db, POSTS_PATH, postId));
                    UI.showMessage('تم حذف المنشور');
                }
            },

            toggleLike: async (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                if(!post) return;
                
                let newLikes = post.likes ? [...post.likes] : [];
                if(newLikes.includes(currentUser.uid)) {
                    newLikes = newLikes.filter(id => id !== currentUser.uid);
                } else {
                    newLikes.push(currentUser.uid);
                    if(post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                        App.sendNotification(post.authorId, 'أعجب بمنشورك', postId);
                    }
                }
                await updateDoc(doc(db, POSTS_PATH, postId), { likes: newLikes });
            },

            sharePost: async (postId) => {
                const shareUrl = window.location.origin + window.location.pathname + '?post=' + postId;
                if (navigator.share) {
                    try { await navigator.share({ title: 'تطبيق زايلو', url: shareUrl }); } catch (err) {}
                } else {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try { document.execCommand("copy"); UI.showMessage("تم نسخ الرابط!"); } 
                    catch (err) { UI.showMessage("تعذر النسخ"); }
                    document.body.removeChild(tempInput);
                }
            },

            openSinglePost: (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                const container = document.getElementById('single-post-container');
                
                if(!post || App.isBlocked(post.authorId)) {
                    container.innerHTML = '<div class="text-center py-20 opacity-60">المنشور غير متوفر أو تم حذفه</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const author = Memory.users[post.authorId];
                if(!author || (author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid))) {
                    container.innerHTML = '<div class="text-center py-20 opacity-60">هذا المنشور خاص ولا تملك صلاحية الوصول إليه</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const parsedText = App.parseMentions(post.text);
                const likesCount = post.likes ? post.likes.length : 0;
                
                container.innerHTML = `
                    <div class="theme-card rounded-2xl shadow-sm border overflow-hidden mt-4">
                        <div class="p-4 flex items-center gap-3 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            <div>
                                <h4 class="font-bold text-lg flex items-center gap-1 theme-text">${author.name}</h4>
                                <span class="text-sm opacity-60">${App.timeAgo(post.timestamp)}</span>
                            </div>
                        </div>
                        <div class="px-5 py-3 theme-text text-lg leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-5 py-3 text-sm opacity-60 border-t mt-2 flex justify-between" style="border-color: var(--border-color);">
                            <span class="font-bold text-blue-600">${likesCount} إعجابات</span>
                        </div>
                        <div class="p-4">
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap shadow-md">عرض التعليقات</button>
                        </div>
                    </div>
                `;
                UI.openModal('single-post-modal');
            },

            // --- رندر التعليقات ---
            renderComments: () => {
                if(!window.currentPostIdForComment) return;
                const container = document.getElementById('comments-list');
                container.innerHTML = '';
                
                const postComments = Memory.comments
                    .filter(c => c.postId === window.currentPostIdForComment)
                    .sort((a,b) => a.timestamp - b.timestamp);

                if(postComments.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-chat-centered text-4xl mb-2 block mx-auto"></i>لا توجد تعليقات، كن أول من يعلق</div>';
                    return;
                }

                postComments.forEach(c => {
                    const author = Memory.users[c.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    const parsedText = App.parseMentions(c.text);

                    const el = document.createElement('div');
                    el.className = 'flex gap-3 items-start';
                    el.innerHTML = `
                        <img src="${author.photo || App.getDefaultAvatar()}" class="w-10 h-10 rounded-full object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openProfileByUsername('${author.username}')">
                        <div class="flex-1">
                            <div class="theme-bg rounded-2xl rounded-tr-sm p-3.5 inline-block min-w-[50%] max-w-full shadow-sm border">
                                <h5 class="font-bold text-sm theme-text cursor-pointer flex items-center gap-1" onclick="UI.openProfileByUsername('${author.username}')">${author.name}</h5>
                                <p class="theme-text text-[15px] mt-1 break-words">${parsedText}</p>
                            </div>
                            <span class="text-[11px] opacity-60 mx-2 mt-1 block">${App.timeAgo(c.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
                setTimeout(() => container.scrollTop = container.scrollHeight, 10);
            },

            addComment: async () => {
                const inputEl = document.getElementById('comment-input');
                const text = inputEl.value.trim();
                const postId = window.currentPostIdForComment;
                if(!text || !postId) return;
                
                inputEl.value = '';
                // إبقاء التركيز للمطلب 4
                inputEl.focus(); 
                
                await addDoc(collection(db, COMMENTS_PATH), {
                    postId: postId, authorId: currentUser.uid, text: text, timestamp: Date.now()
                });

                const post = Memory.posts.find(p => p.id === postId);
                if(post && post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                    App.sendNotification(post.authorId, 'علق على منشورك', postId);
                }
                App.notifyMentions(text, 'تعليق', postId);
            },

            // --- الملاحظات (قصص / ستوري) ---
            renderNotes: () => {
                const container = document.getElementById('notes-container');
                const myBtnContainer = container.firstElementChild.outerHTML;
                container.innerHTML = myBtnContainer;

                const sortedNotes = [...Memory.notes].sort((a,b) => b.timestamp - a.timestamp);
                const visibleNotes = sortedNotes.filter(n => App.isFriend(currentUser.uid, n.authorId) && !App.isBlocked(n.authorId));
                
                const myActiveNote = sortedNotes.find(n => n.authorId === currentUser.uid);
                
                const myBtnEl = container.firstElementChild;
                const myAvatar = myBtnEl.querySelector('#current-user-avatar-note');
                const myPlusIcon = myBtnEl.querySelector('#my-note-plus-icon');
                
                if(myActiveNote) {
                    myAvatar.parentElement.classList.add('story-ring');
                    myAvatar.classList.replace('border-transparent', 'border-white');
                    myPlusIcon.classList.add('hidden');
                    myBtnEl.onclick = () => App.viewNoteFull(myActiveNote, currentUser);
                } else {
                    myAvatar.src = currentUser.photo || App.getDefaultAvatar();
                    myAvatar.parentElement.classList.remove('story-ring');
                    myAvatar.classList.replace('border-white', 'border-transparent');
                    myPlusIcon.classList.remove('hidden');
                    myBtnEl.onclick = App.checkAndCreateNote;
                }

                visibleNotes.forEach(note => {
                    const author = Memory.users[note.authorId];
                    if(!author) return;

                    const el = document.createElement('div');
                    el.className = 'inline-flex flex-col items-center cursor-pointer shrink-0 btn-tap w-16';
                    el.style.scrollSnapAlign = 'start';
                    const shortName = author.name.split(' ')[0];
                    
                    el.innerHTML = `
                        <div class="relative story-ring">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-16 h-16 rounded-full object-cover border-2 shadow-sm" style="border-color: var(--bg-color);">
                        </div>
                        <span class="text-[11px] font-bold mt-1 w-full text-center truncate theme-text">${shortName}</span>
                    `;
                    el.onclick = () => { App.viewNoteFull(note, author); };
                    container.appendChild(el);
                });
            },
            
            viewNoteFull: async (note, author) => {
                document.getElementById('nv-avatar').src = author.photo || App.getDefaultAvatar();
                document.getElementById('nv-name').innerText = author.name;
                document.getElementById('nv-time').innerText = App.timeAgo(note.timestamp);
                document.getElementById('nv-text').innerHTML = App.parseMentions(note.text);
                
                window.noteViewAuthorId = author.uid;
                window.noteViewId = note.id;
                
                if(author.uid !== currentUser.uid) {
                    let viewers = note.viewers || [];
                    if(!viewers.includes(currentUser.uid)) {
                        viewers.push(currentUser.uid);
                        try { await updateDoc(doc(db, NOTES_PATH, note.id), { viewers }); } catch(e){}
                    }
                    
                    document.getElementById('note-reply-section').classList.remove('hidden');
                    document.getElementById('note-reply-section').classList.add('flex');
                    document.getElementById('note-viewers-section').classList.add('hidden');
                    document.getElementById('nv-options-btn').classList.add('hidden');
                    document.getElementById('note-reply-input').value = '';
                } else {
                    document.getElementById('note-reply-section').classList.add('hidden');
                    document.getElementById('note-reply-section').classList.remove('flex');
                    document.getElementById('note-viewers-section').classList.remove('hidden');
                    document.getElementById('note-viewers-section').classList.add('flex');
                    document.getElementById('nv-options-btn').classList.remove('hidden');
                    
                    document.getElementById('note-viewers-count').innerText = (note.viewers || []).length;
                    
                    document.getElementById('nv-options-btn').onclick = () => {
                        App.openManageNote(note.id, note.text);
                        UI.closeModal('note-view-modal');
                    };
                }

                UI.openModal('note-view-modal');
            },
            
            showNoteViewers: () => {
                const note = Memory.notes.find(n => n.id === window.noteViewId);
                if(!note) return;
                const container = document.getElementById('viewers-list-container');
                container.innerHTML = '';
                const viewers = note.viewers || [];
                
                if(viewers.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-60 py-10 mt-10">لا يوجد مشاهدون بعد</div>';
                } else {
                    viewers.forEach(uid => {
                        const u = Memory.users[uid];
                        if(!u) return;
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 theme-bg rounded-2xl border mb-2 cursor-pointer btn-tap';
                        el.onclick = () => { UI.closeModal('viewers-list-modal'); UI.closeModal('note-view-modal'); UI.openModal('profile-modal', u.uid); };
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-10 h-10 rounded-full object-cover border">
                            <span class="font-bold theme-text">${u.name}</span>
                        `;
                        container.appendChild(el);
                    });
                }
                UI.openModal('viewers-list-modal');
            },

            viewProfileFromNote: () => {
                if(window.noteViewAuthorId) {
                    UI.closeModal('note-view-modal');
                    UI.openModal('profile-modal', window.noteViewAuthorId);
                }
            },
            sendNoteReply: async () => {
                const inputEl = document.getElementById('note-reply-input');
                const text = inputEl.value.trim();
                if(!text || !window.noteViewAuthorId) return;
                
                const note = Memory.notes.find(n => n.id === window.noteViewId);
                if(!note) return;
                
                // ترك التركيز لمنع نزول الكيبورد المطلب 4
                inputEl.value = '';
                inputEl.focus();

                await addDoc(collection(db, MESSAGES_PATH), {
                    participants: [currentUser.uid, window.noteViewAuthorId],
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    read: false,
                    isNoteReply: true,
                    replyNoteText: note.text 
                });

                UI.showMessage('تم إرسال الرد للخاص');
                UI.closeModal('note-view-modal');
            },

            checkAndCreateNote: () => {
                const myActiveNote = Memory.notes.find(n => n.authorId === currentUser.uid);
                if(myActiveNote) App.viewNoteFull(myActiveNote, currentUser); 
                else UI.openModal('create-note-modal');
            },

            createNote: async () => {
                const text = document.getElementById('note-text-input').value.trim();
                if(!text) return UI.showMessage('اكتب شيئاً');
                UI.closeModal('create-note-modal');
                await addDoc(collection(db, NOTES_PATH), {
                    authorId: currentUser.uid, text: text, timestamp: Date.now(), viewers: []
                });
                App.notifyMentions(text, 'ملاحظة', null);
                UI.showMessage('تمت الإضافة (صالحة لـ 24 ساعة)');
            },

            openManageNote: (id, currentText) => {
                window.currentManageNoteId = id;
                document.getElementById('edit-note-input').value = currentText;
                UI.openModal('manage-note-modal');
            },

            updateNote: async () => {
                const newText = document.getElementById('edit-note-input').value.trim();
                if(!newText || !window.currentManageNoteId) return;
                await updateDoc(doc(db, NOTES_PATH, window.currentManageNoteId), { text: newText });
                App.notifyMentions(newText, 'ملاحظة', null);
                UI.closeModal('manage-note-modal');
                UI.showMessage('تم تحديث الملاحظة');
            },

            deleteNote: async () => {
                if(!window.currentManageNoteId) return;
                await deleteDoc(doc(db, NOTES_PATH, window.currentManageNoteId));
                window.currentManageNoteId = null;
                UI.closeModal('manage-note-modal');
                UI.showMessage('تم حذف الملاحظة');
            },


            // --- تقسيم الأصدقاء ---
            switchFriendsSubTab: (tabId) => {
                ['requests', 'friends', 'suggestions'].forEach(id => {
                    document.getElementById(`subtab-${id}`).className = 'flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors';
                    document.getElementById(`subtab-content-${id}`).classList.add('hidden');
                });
                
                document.getElementById(`subtab-${tabId}`).className = 'flex-1 py-3 text-center text-sm font-bold sub-tab-active btn-tap transition-colors';
                document.getElementById(`subtab-content-${tabId}`).classList.remove('hidden');
                
                App.renderFriendsTab(tabId);
            },
            
            renderFriendsTab: (tabId) => {
                const container = document.getElementById(`subtab-content-${tabId}`);
                if(!container) return;
                container.innerHTML = '';

                if(tabId === 'requests') {
                    const myRequests = Memory.requests.filter(r => r.to === currentUser.uid);
                    if(myRequests.length > 0) document.getElementById('badge-requests').classList.remove('hidden');
                    else document.getElementById('badge-requests').classList.add('hidden');
                    
                    if(myRequests.length === 0) {
                        container.innerHTML = '<div class="text-center opacity-50 py-10 mt-6"><i class="ph ph-user-plus text-4xl mb-2 block mx-auto"></i>لا توجد طلبات جديدة</div>';
                        return;
                    }
                    myRequests.forEach(req => {
                        const fromUser = Memory.users[req.from];
                        if(!fromUser || App.isBlocked(fromUser.uid)) return;
                        const el = document.createElement('div');
                        el.className = 'flex flex-col p-3 theme-card rounded-2xl border shadow-sm gap-3';
                        el.innerHTML = `
                            <div class="flex items-center gap-3 cursor-pointer group" onclick="UI.openModal('profile-modal', '${fromUser.uid}')">
                                <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                                <div class="flex flex-col">
                                    <span class="font-bold theme-text group-hover:text-blue-600 truncate flex items-center gap-1">${fromUser.name}</span>
                                    <span class="text-xs opacity-60">${App.timeAgo(req.timestamp)}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 w-full">
                                <button onclick="App.acceptRequest('${req.id}', '${req.from}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl btn-tap shadow-sm transition-colors text-sm">قبول</button>
                                <button onclick="App.declineRequest('${req.id}')" class="flex-1 theme-bg border font-bold py-2 rounded-xl btn-tap transition-colors text-sm">رفض</button>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else if (tabId === 'friends') {
                    const myFriendsRelations = Memory.friends.filter(f => f.user1 === currentUser.uid || f.user2 === currentUser.uid);
                    const myFriends = myFriendsRelations.map(f => {
                        const friendId = f.user1 === currentUser.uid ? f.user2 : f.user1;
                        return Memory.users[friendId];
                    }).filter(u => u !== undefined && !App.isBlocked(u.uid));

                    if(myFriends.length === 0) {
                        container.innerHTML = '<div class="text-center opacity-50 py-10 mt-6"><i class="ph ph-users text-4xl mb-2 block mx-auto"></i>ليس لديك أصدقاء حالياً</div>';
                        return;
                    }
                    myFriends.forEach(u => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 theme-card hover:opacity-80 rounded-2xl cursor-pointer btn-tap border shadow-sm transition-colors';
                        el.onclick = () => UI.openModal('profile-modal', u.uid);
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                            <div class="flex-1">
                                <h4 class="font-bold theme-text flex items-center gap-1">${u.name}</h4>
                                <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else if (tabId === 'suggestions') {
                    const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                    const requestedIds = Memory.requests.filter(r => r.from === currentUser.uid).map(r => r.to);
                    
                    let suggestions = Object.values(Memory.users).filter(u => 
                        u.uid !== currentUser.uid && 
                        !friendsIds.includes(u.uid) && 
                        !requestedIds.includes(u.uid) &&
                        !App.isBlocked(u.uid) &&
                        u.allowRequests !== false
                    );
                    
                    suggestions.sort(() => 0.5 - Math.random()); 
                    suggestions = suggestions.slice(0, 10); 

                    if(suggestions.length === 0) {
                        container.innerHTML = '<div class="text-center opacity-50 py-10 mt-6">لا توجد اقتراحات حالياً</div>';
                        return;
                    }
                    suggestions.forEach(u => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 theme-card rounded-2xl border shadow-sm';
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                                <h4 class="font-bold theme-text flex items-center gap-1">${u.name}</h4>
                                <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                            </div>
                            <button onclick="App.sendFriendRequest('${u.uid}')" class="bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full font-bold text-sm btn-tap hover:bg-blue-100">إضافة</button>
                        `;
                        container.appendChild(el);
                    });
                }
            },

            sendFriendRequest: async (toUid) => {
                await addDoc(collection(db, REQUESTS_PATH), {
                    from: currentUser.uid, to: toUid, timestamp: Date.now()
                });
                App.sendNotification(toUid, 'أرسل لك طلب صداقة', null);
                UI.showMessage('تم إرسال الطلب');
                App.renderFriendsTab('suggestions');
                if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(toUid);
            },
            cancelRequest: async (reqId, uid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('تم إلغاء الطلب');
                if(uid && !document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
            },
            acceptRequest: async (reqId, fromUid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                await addDoc(collection(db, FRIENDS_PATH), {
                    user1: currentUser.uid, user2: fromUid, timestamp: Date.now()
                });
                App.sendNotification(fromUid, 'وافق على طلب الصداقة', null);
                UI.showMessage('تم قبول الطلب');
                if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(fromUid);
            },
            declineRequest: async (reqId) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('تم رفض الطلب');
            },
            unfriend: async (uid) => {
                if(confirm('هل أنت متأكد من إزالة الصداقة؟')) {
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) {
                        await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));
                        UI.showMessage('تمت إزالة الصداقة');
                        UI.closeModal('action-modal'); 
                        if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
                    }
                }
            },

            blockUser: async (uid) => {
                if(confirm('هل أنت متأكد من حظر هذا المستخدم؟')) {
                    const updatedBlocks = [...(currentUser.blockedUsers || []), uid];
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                    currentUser.blockedUsers = updatedBlocks;
                    
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));

                    UI.closeModal('action-modal');
                    UI.closeModal('chat-modal');
                    UI.showMessage('تم الحظر بنجاح');
                    App.startCore(); 
                }
            },
            unblockUser: async (uid) => {
                const updatedBlocks = (currentUser.blockedUsers || []).filter(id => id !== uid);
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                currentUser.blockedUsers = updatedBlocks;
                UI.showMessage('تم إلغاء الحظر');
                if(!document.getElementById('blocked-users-modal').classList.contains('hidden')){
                    App.renderBlockedUsers();
                }
                if(!document.getElementById('profile-modal').classList.contains('hidden')){
                    App.renderUserProfile(uid);
                }
            },
            renderBlockedUsers: () => {
                const container = document.getElementById('blocked-list-container');
                container.innerHTML = '';
                const blockedList = currentUser.blockedUsers || [];
                if(blockedList.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-20 mt-10"><i class="ph ph-prohibit text-4xl mb-2 block mx-auto"></i>لا يوجد مستخدمين محظورين</div>';
                    return;
                }
                blockedList.forEach(uid => {
                    const u = Memory.users[uid];
                    if(!u) return;
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 theme-card rounded-2xl border mb-2';
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                        <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <h4 class="font-bold theme-text">${u.name}</h4>
                            <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                        </div>
                        <button class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full font-bold text-sm btn-tap" onclick="App.unblockUser('${u.uid}')">إلغاء الحظر</button>
                    `;
                    container.appendChild(el);
                });
            },

            // --- البحث ---
            searchUsers: () => {
                const query = document.getElementById('search-input').value.toLowerCase().trim();
                const container = document.getElementById('search-results');
                container.innerHTML = '';

                if(!query) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-magnifying-glass text-4xl mb-2 block mx-auto"></i>اكتب للبحث عن مستخدمين</div>';
                    return;
                }

                const results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    !App.isBlocked(u.uid) &&
                    (u.name.toLowerCase().includes(query) || u.username.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10">لا توجد نتائج</div>';
                    return;
                }

                results.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 theme-card hover:opacity-80 rounded-2xl cursor-pointer btn-tap border transition-colors';
                    el.onclick = () => {
                        UI.closeModal('search-modal');
                        UI.openModal('profile-modal', u.uid);
                    };
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold theme-text flex items-center gap-1">${u.name}</h4>
                            <p class="text-xs opacity-60 font-medium">@${u.username}</p>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            // --- الملف الشخصي  ---
            renderUserProfile: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;

                document.getElementById('vp-header-name').innerText = u.name;
                document.getElementById('vp-name').innerText = u.name;
                document.getElementById('vp-username').innerText = '@' + u.username;
                document.getElementById('vp-bio').innerText = u.bio || '';
                document.getElementById('vp-image').src = u.photo || App.getDefaultAvatar();
                
                const colors = ['from-blue-600 to-indigo-800', 'from-purple-600 to-pink-600', 'from-green-500 to-teal-700', 'from-orange-500 to-red-600'];
                const colorIdx = u.uid.charCodeAt(0) % colors.length;
                document.getElementById('vp-cover').className = `h-64 bg-gradient-to-tr ${colors[colorIdx]} relative flex items-end justify-center pb-4 pt-16`;

                const actionContainer = document.getElementById('vp-action-container');
                actionContainer.innerHTML = '';

                const isMe = uid === currentUser.uid;
                const isFriend = App.isFriend(currentUser.uid, uid);
                const hasSentReq = Memory.requests.some(r => r.from === currentUser.uid && r.to === uid);
                const hasReceivedReq = Memory.requests.some(r => r.from === uid && r.to === currentUser.uid);
                const receivedReqId = hasReceivedReq ? Memory.requests.find(r => r.from === uid && r.to === currentUser.uid).id : null;
                const sentReqId = hasSentReq ? Memory.requests.find(r => r.from === currentUser.uid && r.to === uid).id : null;
                const isBlocked = App.isBlocked(uid);

                if (isMe) {
                    actionContainer.innerHTML = `<button onclick="UI.openModal('edit-profile-modal')" class="bg-gray-100 text-gray-800 px-6 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm flex items-center gap-2"><i class="ph-fill ph-pencil-simple"></i> تعديل الحساب</button>`;
                } else if (isBlocked) {
                    actionContainer.innerHTML = `<button onclick="App.unblockUser('${uid}')" class="bg-gray-200 text-gray-800 px-6 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm flex items-center gap-2"><i class="ph-fill ph-lock-key-open"></i> إلغاء الحظر</button>`;
                } else {
                    let actionHtml = '';
                    if (isFriend) {
                        actionHtml = `
                            <button onclick="UI.closeModal('profile-modal'); UI.openModal('chat-modal', '${uid}')" class="bg-blue-600 text-white px-6 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm flex items-center gap-2"><i class="ph-fill ph-chat-circle-text"></i> مراسلة</button>
                            <button onclick="App.showChatOptions('${uid}')" class="bg-gray-100 text-gray-800 px-4 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm"><i class="ph-fill ph-user-minus"></i></button>
                        `;
                    } else if (hasReceivedReq) {
                        actionHtml = `
                            <button onclick="App.acceptRequest('${receivedReqId}', '${uid}')" class="bg-blue-600 text-white px-6 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm flex items-center gap-2"><i class="ph-fill ph-check"></i> قبول الطلب</button>
                        `;
                    } else if (hasSentReq) {
                        actionHtml = `
                            <button onclick="App.cancelRequest('${sentReqId}', '${uid}')" class="bg-gray-200 text-gray-800 px-6 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm flex items-center gap-2"><i class="ph-fill ph-x"></i> إلغاء الطلب</button>
                        `;
                    } else {
                        if(u.allowRequests !== false) {
                            actionHtml = `
                                <button onclick="App.sendFriendRequest('${uid}')" class="bg-blue-600 text-white px-6 py-2.5 rounded-full font-bold btn-tap text-sm shadow-sm flex items-center gap-2"><i class="ph-fill ph-user-plus"></i> إضافة صديق</button>
                            `;
                        } else {
                            actionHtml = `<span class="bg-gray-100 text-gray-500 px-6 py-2.5 rounded-full font-bold text-sm shadow-sm">لا يستقبل طلبات</span>`;
                        }
                    }
                    actionContainer.innerHTML = actionHtml;
                }

                const friendsGrid = document.getElementById('vp-friends-grid');
                friendsGrid.innerHTML = '';
                
                let canSeeFriends = false;
                if(isMe || u.friendsVisibility === 'all') canSeeFriends = true;
                else if (u.friendsVisibility === 'friends' && isFriend) canSeeFriends = true;

                if (canSeeFriends && !isBlocked) {
                    const userFriendsRelations = Memory.friends.filter(f => f.user1 === uid || f.user2 === uid);
                    const userFriendsIds = userFriendsRelations.map(f => f.user1 === uid ? f.user2 : f.user1);
                    document.getElementById('vp-friends-count-text').innerText = userFriendsIds.length;

                    if(userFriendsIds.length > 0) {
                        const friendsToShow = userFriendsIds.slice(0, 6);
                        friendsToShow.forEach(fid => {
                            const friend = Memory.users[fid];
                            if(friend) {
                                const el = document.createElement('div');
                                el.className = 'flex flex-col items-center gap-1 cursor-pointer btn-tap';
                                el.onclick = () => UI.openModal('profile-modal', fid);
                                el.innerHTML = `
                                    <img src="${friend.photo || App.getDefaultAvatar()}" class="w-full aspect-square rounded-xl object-cover border border-gray-200 shadow-sm">
                                    <span class="text-[11px] font-bold theme-text w-full text-center truncate px-1">${friend.name.split(' ')[0]}</span>
                                `;
                                friendsGrid.appendChild(el);
                            }
                        });
                    } else {
                        friendsGrid.innerHTML = '<div class="col-span-3 text-center opacity-50 py-4 text-sm">لا يوجد أصدقاء</div>';
                    }
                } else {
                    document.getElementById('vp-friends-count-text').innerText = '';
                    friendsGrid.innerHTML = '<div class="col-span-3 text-center opacity-50 py-4 text-sm"><i class="ph ph-lock-key text-xl block mb-1"></i>قائمة الأصدقاء خاصة</div>';
                }
            },

            // المطلب 8: خيارات الرسالة ستايل تليكرام
            showMessageOptions: (msgId, isMe, text, isPinned) => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <button onclick="App.copyText('${escapeHTML(text).replace(/'/g, "\\'")}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
                        <span>نسخ النص</span> <i class="ph-fill ph-copy text-lg text-gray-500"></i>
                    </button>
                    <button onclick="App.togglePinMessage('${msgId}', ${isPinned})" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap text-blue-600">
                        <span>${isPinned ? 'إلغاء التثبيت' : 'تثبيت'}</span> <i class="ph-fill ${isPinned ? 'ph-push-pin-slash' : 'ph-push-pin'} text-lg"></i>
                    </button>
                    ${isMe ? `
                    <button onclick="App.deleteMessage('${msgId}', 'all')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-red-50 btn-tap text-red-500">
                        <span>حذف للجميع</span> <i class="ph-fill ph-trash text-lg"></i>
                    </button>
                    ` : ''}
                    <button onclick="App.deleteMessage('${msgId}', 'me')" class="w-full flex justify-between items-center p-4 hover:bg-orange-50 btn-tap text-orange-500">
                        <span>حذف من عندي</span> <i class="ph-fill ph-trash-simple text-lg"></i>
                    </button>
                `;
                UI.openModal('action-modal');
            },
            copyText: (text) => {
                const tempInput = document.createElement("textarea");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try { document.execCommand("copy"); UI.showMessage("تم النسخ!"); } catch(e){}
                document.body.removeChild(tempInput);
                UI.closeModal('action-modal');
            },
            togglePinMessage: async (msgId, isPinned) => {
                await updateDoc(doc(db, MESSAGES_PATH, msgId), { pinned: !isPinned });
                UI.showMessage(isPinned ? "تم إلغاء التثبيت" : "تم تثبيت الرسالة");
                UI.closeModal('action-modal');
            },
            deleteMessage: async (msgId, type) => {
                if(type === 'all') {
                    await deleteDoc(doc(db, MESSAGES_PATH, msgId));
                } else if (type === 'me') {
                    await updateDoc(doc(db, MESSAGES_PATH, msgId), { deletedFor: arrayUnion(currentUser.uid) });
                }
                UI.closeModal('action-modal');
            },
            reactToMessage: async (msgId, reactionEmoji = '❤️') => {
                const msg = Memory.messages.find(m => m.id === msgId);
                if(!msg) return;
                const currentReactions = msg.reactions || {};
                
                if(currentReactions[currentUser.uid] === reactionEmoji) {
                    delete currentReactions[currentUser.uid];
                } else {
                    currentReactions[currentUser.uid] = reactionEmoji;
                }
                
                await updateDoc(doc(db, MESSAGES_PATH, msgId), { reactions: currentReactions });
            },

            showChatOptions: (otherUid) => {
                const isMyFriend = App.isFriend(currentUser.uid, otherUid);
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    ${isMyFriend ? `
                    <button onclick="App.unfriend('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-black/5 btn-tap">
                        <span>إزالة من الأصدقاء</span> <i class="ph-fill ph-user-minus text-lg text-gray-500"></i>
                    </button>
                    ` : ''}
                    <button onclick="App.blockUser('${otherUid}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-orange-50 btn-tap text-orange-500">
                        <span>حظر المستخدم</span> <i class="ph-fill ph-prohibit text-lg"></i>
                    </button>
                    <button onclick="App.deleteChatHistory('${otherUid}')" class="w-full flex justify-between items-center p-4 hover:bg-red-50 btn-tap text-red-500">
                        <span>حذف المحادثة</span> <i class="ph-fill ph-trash text-lg"></i>
                    </button>
                `;
                UI.openModal('action-modal');
            },
            deleteChatHistory: async (otherUid) => {
                if(confirm('هل أنت متأكد من حذف هذه المحادثة بالكامل؟')) {
                    const msgsToDelete = Memory.messages.filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid));
                    for(let msg of msgsToDelete) { await deleteDoc(doc(db, MESSAGES_PATH, msg.id)); }
                    UI.closeModal('action-modal');
                    UI.showMessage('تم حذف المحادثة');
                }
            },

            renderChats: () => {
                const container = document.getElementById('chats-container');
                container.innerHTML = '';
                
                const chatUsers = {};
                let totalUnreadCount = 0; 

                Memory.messages.forEach(msg => {
                    if(msg.participants.includes(currentUser.uid)) {
                        const otherUid = msg.participants.find(id => id !== currentUser.uid);
                        if(App.isBlocked(otherUid)) return;
                        if(msg.deletedFor && msg.deletedFor.includes(currentUser.uid)) return;

                        if(!chatUsers[otherUid]) chatUsers[otherUid] = { lastMsg: msg, unreadCount: 0 };
                        
                        if(chatUsers[otherUid].lastMsg.timestamp < msg.timestamp) {
                            chatUsers[otherUid].lastMsg = msg;
                        }
                        
                        if(msg.senderId === otherUid && !msg.read) {
                            chatUsers[otherUid].unreadCount++;
                            totalUnreadCount++;
                        }
                    }
                });

                const sortedChats = Object.entries(chatUsers).sort((a,b) => b[1].lastMsg.timestamp - a[1].lastMsg.timestamp);

                if(sortedChats.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-chat-circle-dots text-4xl mb-2 block mx-auto"></i>لا توجد رسائل بعد</div>';
                    document.getElementById('badge-messages').classList.add('hidden');
                    return;
                }

                sortedChats.forEach(([otherUid, chatData]) => {
                    const lastMsg = chatData.lastMsg;
                    const u = Memory.users[otherUid];
                    if(!u) return;

                    const isUnread = chatData.unreadCount > 0;
                    const isOnline = App.isOnline(u.lastActive);

                    const el = document.createElement('div');
                    const unreadClass = isUnread ? 'bg-blue-50/20' : 'hover:opacity-80';
                    el.className = `flex items-center gap-3 p-3 border-b cursor-pointer btn-tap transition-colors theme-card ${unreadClass}`;
                    
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showChatOptions(u.uid), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);
                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = () => {
                        if(pressTimer) clearTimeout(pressTimer);
                        UI.openModal('chat-modal', u.uid);
                    };

                    let tickHtml = '';
                    if(lastMsg.senderId === currentUser.uid) {
                        tickHtml = lastMsg.read ? '<i class="ph-fill ph-checks text-blue-500 text-[13px] ml-1"></i>' : '<i class="ph ph-check opacity-50 text-[13px] ml-1"></i>';
                    }

                    let msgPreview = lastMsg.isNoteReply ? `[رد على ملاحظة] ${lastMsg.text}` : lastMsg.text;

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-14 h-14 rounded-full object-cover border border-gray-100">
                            ${isOnline ? '<span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                        </div>
                        <div class="flex-1 overflow-hidden pr-1 relative">
                            <div class="flex justify-between items-center mb-0.5">
                                <h4 class="font-bold truncate text-[15px] flex items-center gap-1 ${isUnread ? 'theme-text' : 'opacity-90'}">${u.name}</h4>
                                <span class="text-xs ${isUnread ? 'font-bold text-blue-600' : 'opacity-60'} whitespace-nowrap">${App.timeAgo(lastMsg.timestamp)}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm truncate flex-1 flex items-center gap-0.5 ${isUnread ? 'text-unread' : (lastMsg.senderId !== currentUser.uid ? 'font-medium opacity-90' : 'opacity-60')}">
                                    ${tickHtml} ${msgPreview.replace(/\n/g, ' ')}
                                </p>
                                ${isUnread ? `<span class="bg-blue-600 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center shrink-0 shadow-sm mr-2">${chatData.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                });

                if(totalUnreadCount > 0) {
                    const badge = document.getElementById('badge-messages');
                    badge.classList.remove('hidden');
                    badge.innerText = totalUnreadCount > 9 ? '+9' : totalUnreadCount;
                } else {
                    document.getElementById('badge-messages').classList.add('hidden');
                }
            },

            markChatAsRead: async (otherUid) => {
                const unreadMsgs = Memory.messages.filter(m => 
                    m.participants.includes(currentUser.uid) && 
                    m.participants.includes(otherUid) &&
                    m.senderId === otherUid && 
                    !m.read
                );
                for(let msg of unreadMsgs) {
                    await updateDoc(doc(db, MESSAGES_PATH, msg.id), { read: true });
                }
            },

            renderChatInfo: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;
                document.getElementById('chat-user-img').src = u.photo || App.getDefaultAvatar();
                document.getElementById('chat-user-name').innerText = u.name;
                
                const isOnline = App.isOnline(u.lastActive);
                document.getElementById('chat-online-dot').style.display = isOnline ? 'block' : 'none';
                document.getElementById('chat-user-status').innerText = isOnline ? 'نشط الآن' : `آخر ظهور ${App.timeAgo(u.lastActive)}`;
            },

            setReplyMode: (msgId, text, senderName) => {
                window.replyingToMessage = msgId;
                document.getElementById('reply-to-name').innerText = `الرد على ${senderName}`;
                document.getElementById('reply-to-text').innerText = text;
                document.getElementById('replying-to-container').classList.remove('hidden');
                document.getElementById('chat-input').focus();
            },
            cancelReply: () => {
                window.replyingToMessage = null;
                document.getElementById('replying-to-container').classList.add('hidden');
            },

            renderMessages: () => {
                const otherUid = window.currentChatUserId;
                if(!otherUid) return;

                const container = document.getElementById('chat-messages-container');
                // حفظ وجود فقاعة الكتابة الحية
                const typingBubble = document.getElementById('live-typing-bubble');
                container.innerHTML = '';

                let msgs = Memory.messages
                    .filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid))
                    .sort((a,b) => a.timestamp - b.timestamp);
                
                msgs = msgs.filter(m => !(m.deletedFor && m.deletedFor.includes(currentUser.uid)));

                // المطلب 6: تحديث كائن المحادثة
                App.updateChatPet(msgs);

                const pinnedMsg = msgs.find(m => m.pinned);
                if(pinnedMsg) {
                    const pinEl = document.createElement('div');
                    pinEl.className = 'sticky top-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b p-2 mb-4 rounded-xl shadow-sm z-20 flex items-center justify-between cursor-pointer theme-text';
                    pinEl.style.borderColor = "var(--border-color)";
                    pinEl.innerHTML = `
                        <div class="flex-1 overflow-hidden pr-2 border-r-4 border-blue-500">
                            <span class="text-xs font-bold text-blue-600 block"><i class="ph-fill ph-push-pin"></i> رسالة مثبتة</span>
                            <span class="text-sm truncate block opacity-80">${escapeHTML(pinnedMsg.text)}</span>
                        </div>
                    `;
                    pinEl.onclick = () => { App.showMessageOptions(pinnedMsg.id, pinnedMsg.senderId === currentUser.uid, pinnedMsg.text, true) };
                    container.appendChild(pinEl);
                }

                if(msgs.length === 0) {
                    container.innerHTML += '<div class="text-center opacity-50 py-10 mt-auto theme-text">بدء محادثة جديدة 👋</div>';
                    container.appendChild(typingBubble);
                    return;
                }

                msgs.forEach(m => {
                    const isMe = m.senderId === currentUser.uid;
                    const row = document.createElement('div');
                    row.className = `msg-row flex w-full mb-1 ${isMe ? 'justify-end' : 'justify-start'}`;

                    const el = document.createElement('div');
                    el.className = `max-w-[80%] rounded-2xl p-3 shadow-sm relative break-words ${isMe ? 'bubble-me rounded-br-sm' : 'bubble-other rounded-bl-sm'}`;
                    
                    const pinIconHTML = m.pinned ? '<i class="ph-fill ph-push-pin opacity-50 text-[10px] absolute top-1 left-2"></i>' : '';

                    let tapCount = 0;
                    let tapTimer;
                    
                    const handleTap = (e) => {
                        tapCount++;
                        if (tapCount === 1) {
                            tapTimer = setTimeout(() => {
                                tapCount = 0;
                                App.showMessageOptions(m.id, isMe, m.text, m.pinned);
                            }, 300); 
                        } else if (tapCount === 2) {
                            clearTimeout(tapTimer);
                            tapCount = 0;
                            App.reactToMessage(m.id, '❤️');
                        }
                    };

                    el.onclick = handleTap; // قائمة الإعدادات تظهر فقط عند الضغط على نفس الرسالة

                    // المطلب 7: معالجة السحب (Swipe) الصارم أفقيًا فقط وتجاهل لمسات الجوانب للرد
                    let startX = 0, startY = 0, currentX = 0;
                    let isSwiping = false;
                    const replyIcon = document.createElement('i');
                    replyIcon.className = `ph-fill ph-reply reply-icon-indicator ${isMe ? '-left-8' : '-right-8'}`;
                    row.appendChild(replyIcon);

                    row.addEventListener('touchstart', (e) => { 
                        startX = e.touches[0].clientX; 
                        startY = e.touches[0].clientY;
                        isSwiping = false;
                    }, {passive: true});

                    row.addEventListener('touchmove', (e) => {
                        if(!startX || !startY) return;
                        currentX = e.touches[0].clientX;
                        let currentY = e.touches[0].clientY;
                        let diffX = currentX - startX;
                        let diffY = currentY - startY;

                        // التحقق من أن السحب أفقي بحت لتفادي أخطاء التمرير للأسفل/الأعلى
                        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
                            isSwiping = true;
                            if((isMe && diffX < 0) || (!isMe && diffX > 0)) {
                                if(e.cancelable) e.preventDefault();
                                let translate = Math.abs(diffX) > 70 ? 70 * Math.sign(diffX) : diffX;
                                row.style.transform = `translateX(${translate}px)`;
                                replyIcon.style.opacity = Math.abs(translate) / 70;
                            }
                        }
                    }, {passive: false});

                    row.addEventListener('touchend', (e) => {
                        if(!isSwiping) { startX = 0; startY = 0; return; }
                        row.style.transform = `translateX(0)`;
                        replyIcon.style.opacity = 0;
                        let diffX = currentX - startX;
                        // يجب سحب مسافة جيدة لتفعيل الرد
                        if (Math.abs(diffX) > 50 && ((isMe && diffX < 0) || (!isMe && diffX > 0))) {
                            const senderName = isMe ? 'نفسك' : Memory.users[m.senderId].name;
                            App.setReplyMode(m.id, m.text, senderName);
                        }
                        startX = 0; startY = 0; isSwiping = false;
                    });

                    const tickHtml = isMe ? (m.read ? '<i class="ph-fill ph-checks text-blue-200"></i>' : '<i class="ph ph-check opacity-70"></i>') : '';
                    
                    let replyHtml = '';
                    if(m.replyToId) {
                        const repliedMsg = Memory.messages.find(msg => msg.id === m.replyToId);
                        if(repliedMsg) {
                            replyHtml = `
                            <div class="bg-black/10 rounded-lg p-2 mb-2 border-r-4 ${isMe ? 'border-white text-white' : 'border-blue-500 theme-text'}">
                                <span class="text-xs font-bold block opacity-90">${repliedMsg.senderId === currentUser.uid ? 'أنت' : Memory.users[repliedMsg.senderId].name}</span>
                                <span class="text-xs truncate block opacity-80">${escapeHTML(repliedMsg.text)}</span>
                            </div>`;
                        }
                    } else if (m.isNoteReply && m.replyNoteText) {
                        replyHtml = `
                            <div class="bg-black/10 rounded-lg p-2 mb-2 border-r-4 border-green-500 text-white">
                                <span class="text-xs font-bold block opacity-90">رد على ملاحظة</span>
                                <span class="text-xs truncate block opacity-80">${escapeHTML(m.replyNoteText)}</span>
                            </div>`;
                    }

                    let reactionHtml = '';
                    if(m.reactions && Object.keys(m.reactions).length > 0) {
                        const reactValues = Object.values(m.reactions);
                        reactionHtml = `<div class="reaction-badge ${isMe ? '-left-2' : '-right-2'}">${reactValues[0]}</div>`;
                    }

                    el.innerHTML = `
                        ${pinIconHTML}
                        ${replyHtml}
                        <p class="text-[15px] leading-relaxed whitespace-pre-wrap">${escapeHTML(m.text)}</p>
                        <span class="text-[10px] mt-1.5 flex justify-end items-center gap-1 font-medium opacity-80">
                            ${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            ${tickHtml}
                        </span>
                        ${reactionHtml}
                    `;
                    
                    row.appendChild(el);
                    container.appendChild(row);
                });

                // إرجاع فقاعة الكتابة الحية لأسفل المحادثة
                container.appendChild(typingBubble);
                container.scrollTop = container.scrollHeight;
            },

            sendMessage: async () => {
                const otherUid = window.currentChatUserId;
                const inputEl = document.getElementById('chat-input');
                const text = inputEl.value.trim();
                if(!text || !otherUid) return;

                // المطلب 4: ترك التركيز على الحقل
                inputEl.value = '';
                inputEl.style.height = ''; 
                inputEl.focus(); 
                
                // تنظيف مسار الكتابة الحية
                try { await deleteDoc(doc(db, TYPING_PATH, `${currentUser.uid}_${otherUid}`)); } catch(e){}

                const payload = {
                    participants: [currentUser.uid, otherUid],
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    read: false 
                };

                if(window.replyingToMessage) {
                    payload.replyToId = window.replyingToMessage;
                    App.cancelReply();
                }
                
                await addDoc(collection(db, MESSAGES_PATH), payload);
                App.renderMessages(); 
            },

            // --- الإشعارات ---
            sendNotification: async (toUid, text, linkId) => {
                if(toUid === currentUser.uid) return;
                await addDoc(collection(db, NOTIFS_PATH), {
                    to: toUid, from: currentUser.uid, text: text, linkId: linkId, timestamp: Date.now(), read: false
                });
            },
            deleteNotification: async (notifId) => {
                await deleteDoc(doc(db, NOTIFS_PATH, notifId));
                UI.closeModal('action-modal');
                UI.showMessage('تم حذف الإشعار');
            },
            markNotificationRead: async (notifId) => {
                await updateDoc(doc(db, NOTIFS_PATH, notifId), { read: true });
            },
            showNotifOptions: (notifId) => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <button onclick="App.deleteNotification('${notifId}')" class="w-full flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-red-50 btn-tap text-red-500">
                        <span>حذف الإشعار</span> <i class="ph-fill ph-trash text-lg"></i>
                    </button>
                `;
                UI.openModal('action-modal');
            },
            renderNotifications: () => {
                const container = document.getElementById('notifications-container');
                container.innerHTML = '';
                
                const notifs = [...Memory.notifications].sort((a,b) => b.timestamp - a.timestamp);
                const unreadExists = notifs.some(n => !n.read && !App.isBlocked(n.from));
                
                if(notifs.length > 0 && unreadExists) document.getElementById('badge-notifications').classList.remove('hidden');
                else document.getElementById('badge-notifications').classList.add('hidden');
                
                if(notifs.length === 0) {
                    container.innerHTML = '<div class="text-center opacity-50 py-10 mt-10"><i class="ph ph-bell-ringing text-4xl mb-2 block mx-auto"></i>لا توجد إشعارات</div>';
                    return;
                }

                notifs.forEach(n => {
                    const fromUser = Memory.users[n.from];
                    if(!fromUser || App.isBlocked(n.from)) return; 

                    const el = document.createElement('div');
                    const isUnread = !n.read;
                    el.className = `flex items-center gap-3 p-3.5 border-b cursor-pointer transition-colors btn-tap theme-card ${isUnread ? 'bg-blue-50/20' : 'hover:opacity-80'}`;
                    
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showNotifOptions(n.id), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);
                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = () => {
                        if(pressTimer) clearTimeout(pressTimer);
                        if(isUnread) App.markNotificationRead(n.id);
                        if(n.linkId) UI.openModal('comments-modal', n.linkId);
                        else UI.openModal('profile-modal', n.from);
                    };

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            ${isUnread ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-600 rounded-full border-2 border-white"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <p class="text-[15px] leading-tight ${isUnread ? 'theme-text font-bold' : 'opacity-80'}"><span class="font-bold flex items-center gap-1">${fromUser.name}</span> ${n.text}</p>
                            <span class="text-xs font-semibold ${isUnread ? 'text-blue-600' : 'opacity-60'} mt-1 block">${App.timeAgo(n.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            // --- الإعدادات وتعديل الملف ---
            handleEditImage: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 300; canvas.height = 300;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 300, 300);
                        const b64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('edit-profile-img').src = b64;
                        window.tempEditPhoto = b64;
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },

            saveProfile: async () => {
                const name = document.getElementById('edit-name').value.trim();
                const usernameInput = document.getElementById('edit-username');
                const username = usernameInput.value.trim();
                const bio = document.getElementById('edit-bio').value.trim();
                
                if(!name || (!username && !usernameInput.disabled)) return UI.showMessage('الاسم والمعرف مطلوبان');
                const updates = { name, bio };

                if(!usernameInput.disabled && username !== currentUser.username) {
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) return UI.showMessage('عذراً، يمكنك تغيير المعرف مرة واحدة فقط كل 10 أيام');

                    const isTaken = Object.values(Memory.users).some(u => u.username === username && u.uid !== currentUser.uid);
                    if(isTaken) return UI.showMessage('المعرف مستخدم من قبل شخص آخر، يرجى اختيار معرف مختلف');

                    updates.username = username;
                    updates.lastUsernameChange = Date.now();
                }

                if(window.tempEditPhoto) updates.photo = window.tempEditPhoto;

                await updateDoc(doc(db, USERS_PATH, currentUser.uid), updates);
                Object.assign(currentUser, updates);
                window.tempEditPhoto = null;
                App.updateUIWithUserData();
                UI.closeModal('edit-profile-modal');
                UI.showMessage('تم حفظ التغييرات');
            },

            updatePrivacy: async (key, value) => {
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { [key]: value });
                currentUser[key] = value;
                UI.showMessage('تم تحديث الخصوصية');
            }

        };

        window.onload = () => {
            Auth.init();
        };

    </script>
</body>
</html>
