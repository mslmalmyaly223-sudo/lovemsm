<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ุฒุงููู - Xylo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    
    <style>
        /* ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู ุงูุฃุณุงุณูุฉ */
        html, body {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: none;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; 
            touch-action: pan-y;
        }

        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            will-change: scroll-position;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ุดุงุดุฉ ุงูุจุฏุงูุฉ ุงููุฎูุฉ (ุงููุทูุจ 8) */
        #splash-screen {
            background-color: #0a192f; /* ูุญูู ุนููู */
        }
        @keyframes glow-z {
            0% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3); transform: scale(0.95); opacity: 0; }
            50% { text-shadow: 0 0 20px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.6); transform: scale(1.05); opacity: 1; }
            100% { text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.5); transform: scale(1); opacity: 1; }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .elegant-z {
            font-family: 'Great Vibes', cursive;
            color: #ffd700; /* ุฐูุจู */
            font-size: 10rem;
            animation: glow-z 2s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            line-height: 1;
        }
        .elegant-text {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: fade-in-up 1s ease-out 1.5s forwards;
            opacity: 0;
            letter-spacing: 2px;
        }

        .modal-slide-in { animation: slideIn 0.35s forwards cubic-bezier(0.175, 0.885, 0.32, 1.1); }
        .modal-slide-out { animation: slideOut 0.3s forwards cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0.8; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        .btn-tap {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-tap:active { transform: scale(0.92); opacity: 0.8; }
        .btn-tap::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            background: rgba(255,255,255,0.2); border-radius: 50%; transform: translate(-50%, -50%) scale(0);
            opacity: 0; transition: transform 0.3s, opacity 0.3s;
        }
        .btn-tap:active::after { transform: translate(-50%, -50%) scale(2); opacity: 1; transition: 0s; }

        .bg-xylo { background: linear-gradient(135deg, #1d4ed8, #6d28d9); }
        .text-xylo { color: #4f46e5; }
        
        .ptr-container { transition: transform 0.3s ease; position: relative; }
        #ptr-spinner { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .text-unread { font-weight: 900 !important; color: #000 !important; }
        
        #mentions-dropdown {
            position: absolute; bottom: 100%; left: 0; right: 0; background: white; border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 200; display: none;
        }

        /* ุณุญุจ ุงูุฑุณุงูุฉ */
        .msg-bubble { transition: transform 0.2s ease-out; touch-action: pan-y; }
        
        /* ุฎูููุฉ ุงููุญุงุฏุซุฉ ููุญุณุงุจ ุงููููุฒ */
        .premium-chat-bg {
            background-color: #e6f0ff;
            background-image: radial-gradient(#cce0ff 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .sub-tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .sub-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; font-weight: normal; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-gray-800 antialiased pb-safe">

    <!-- 1. ุดุงุดุฉ ุงูุจุฏุงูุฉ (Splash Screen) -->
    <div id="splash-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="elegant-z">Z</div>
        <h1 class="text-4xl font-black mt-4 elegant-text">ุฒุงููู</h1>
    </div>

    <!-- 2. ูุณู ุงููุตุงุฏูุฉ -->
    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-white overflow-y-auto hide-scrollbar smooth-scroll">
        <div class="min-h-screen flex flex-col items-center justify-center p-6">
            <h1 class="text-6xl font-black xylo-brand mb-10 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">ุฒุงููู</h1>
            
            <div id="login-form" class="w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">ุชุณุฌูู ุงูุฏุฎูู</h2>
                <input type="email" id="login-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="login-password" placeholder="ูููุฉ ุงูุณุฑ" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.login()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">ุชุณุฌูู ุงูุฏุฎูู</button>
                <div class="flex justify-between text-sm text-blue-600 font-semibold mt-4">
                    <button onclick="UI.switchAuth('register')" class="p-2 btn-tap">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</button>
                    <button onclick="UI.switchAuth('forgot')" class="p-2 btn-tap">ูุณูุช ูููุฉ ุงูุณุฑุ</button>
                </div>
            </div>

            <div id="register-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">ุญุณุงุจ ุฌุฏูุฏ</h2>
                <input type="text" id="reg-name" placeholder="ุงุณู ุงูุญุณุงุจ" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="email" id="reg-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="reg-password" placeholder="ูููุฉ ุงูุณุฑ" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.register()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">ุฅูุดุงุก ุญุณุงุจ ูุจุงุดุฑุฉ</button>
                
                <div class="relative flex py-4 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">ุฃู</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- ุงููุทูุจ 1: ุฒุฑ ุชุณุฌูู ุงูุฏุฎูู ุจุฌูุฌู ุจุงูุดูู ุงูุฑุณูู -->
                <button onclick="Auth.loginWithGoogle()" class="btn-tap w-full bg-white border border-gray-300 text-[#3c4043] font-medium py-3 rounded-full flex items-center justify-center gap-3 shadow-sm hover:bg-gray-50 transition-colors">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48" class="abcRioButtonSvg"><g><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></g></svg>
                    Continue with Google
                </button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">ูุฏู ุญุณุงุจ ุจุงููุนู</button>
            </div>

            <div id="forgot-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">ุงุณุชุนุงุฏุฉ ูููุฉ ุงูุณุฑ</h2>
                <p class="text-sm text-gray-500 text-center mb-4">ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู ูุณูุฑุณู ูู ุฑุงุจุทุงู ูุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงูุณุฑ.</p>
                <input type="email" id="forgot-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.resetPassword()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">ุฅุฑุณุงู ุงูุฑูุฒ</button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">ุงูุนูุฏุฉ ูุชุณุฌูู ุงูุฏุฎูู</button>
            </div>
        </div>
    </div>

    <!-- 3. ุฅุนุฏุงุฏ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ -->
    <div id="setup-profile-screen" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 smooth-scroll">
        <h2 class="text-3xl font-bold mb-2 text-center text-gray-800">ุงุฎุชูุงุฑ ุตูุฑุฉ ููุญุณุงุจ</h2>
        <p class="text-gray-500 mb-8 text-center">ุงุฌุนู ุญุณุงุจู ูููุฒุงู ุจุฅุถุงูุฉ ุตูุฑุฉ ุดุฎุตูุฉ</p>
        
        <label for="profile-upload" class="relative cursor-pointer mb-8 btn-tap inline-block">
            <div id="profile-preview-container" class="w-40 h-40 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-4 border-dashed border-blue-400 shadow-inner">
                <i class="ph ph-camera text-5xl text-gray-400"></i>
                <img id="profile-preview-img" class="hidden w-full h-full object-cover">
            </div>
            <div class="absolute bottom-1 right-1 bg-blue-600 p-3 rounded-full text-white border-4 border-white shadow-md">
                <i class="ph ph-plus font-bold text-lg"></i>
            </div>
            <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="Auth.handleImageUpload(event)">
        </label>

        <button onclick="Auth.completeProfileSetup()" class="btn-tap w-full max-w-xs bg-xylo text-white font-bold py-4 rounded-xl shadow-lg">ุงูุชุงูู</button>
    </div>

    <!-- 4. ุงูุชุทุจูู ุงูุฑุฆูุณู -->
    <div id="main-app" class="hidden flex-1 flex flex-col h-screen w-full bg-gray-100 relative">
        
        <header class="bg-white px-4 py-3 flex justify-between items-center z-20 relative shadow-sm">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter" style="letter-spacing: 1px;">ุฒุงููู</h1>
            <div class="flex gap-3">
                <button onclick="UI.openModal('search-modal')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center btn-tap">
                    <i class="ph ph-magnifying-glass text-xl text-gray-700"></i>
                </button>
            </div>
        </header>

        <nav class="bg-white border-b border-gray-200 w-full z-10 shadow-sm sticky top-0">
            <div class="flex justify-between items-center px-2">
                <button onclick="UI.switchTab('home')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-blue-600 border-b-2 border-blue-600 transition-colors btn-tap">
                    <i class="ph-fill ph-house text-2xl"></i>
                </button>
                <button onclick="UI.switchTab('notes')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-users text-2xl"></i>
                    <span id="badge-requests" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('messages')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-chat-circle-text text-2xl"></i>
                    <span id="badge-messages" class="hidden absolute top-1 right-1/4 bg-blue-600 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('notifications')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-bell text-2xl"></i>
                    <span id="badge-notifications" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('settings')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors btn-tap">
                    <i class="ph ph-list text-2xl"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto hide-scrollbar smooth-scroll relative ptr-container" id="main-content-area">
            <div id="ptr-spinner" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center">
                <i class="ph ph-arrow-circle-down animate-spin text-blue-600 text-2xl"></i>
            </div>
            
            <!-- ุงููุณู ุงูุฃูู: ุงูุฑุฆูุณูุฉ -->
            <div id="tab-home" class="p-2 space-y-3 pb-6">
                <div class="bg-white p-3 rounded-xl shadow-sm flex gap-3 items-center">
                    <img id="current-user-avatar-home" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <div class="flex-1 bg-gray-100 hover:bg-gray-200 transition-colors rounded-full px-4 py-2.5 flex items-center cursor-pointer btn-tap" onclick="UI.openModal('create-post-modal')">
                        <span class="text-gray-500 text-sm">ุจู ุชููุฑุ</span>
                    </div>
                </div>
                <div id="feed-container" class="space-y-3">
                    <div class="text-center text-gray-400 py-10"><i class="ph ph-spinner-gap animate-spin text-3xl mx-auto mb-2"></i>ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>

            <!-- ุงููุณู ุงูุซุงูู: ุงูุฑุณุงุฆู -->
            <div id="tab-messages" class="hidden p-2">
                <div class="flex justify-between items-center p-2 mb-2">
                    <h2 class="text-xl font-bold">ุงูุฑุณุงุฆู</h2>
                </div>
                <div id="chats-container" class="bg-white rounded-xl shadow-sm overflow-hidden min-h-[400px]">
                </div>
            </div>

            <!-- ุงููุณู ุงูุซุงูุซ: ุงูุฃุตุฏูุงุก ูุงูููุงุญุธุงุช -->
            <div id="tab-notes" class="hidden p-2 space-y-3 flex flex-col h-full">
                <!-- ุดุฑูุท ุงูููุงุญุธุงุช ุงูุฃููู -->
                <div class="bg-white rounded-xl shadow-sm p-4 shrink-0">
                    <div class="flex overflow-x-auto smooth-scroll hide-scrollbar gap-3 pb-2 pt-2 items-start" id="notes-container" style="scroll-snap-type: x mandatory;">
                        <!-- ุฒุฑ ุฃูุช -->
                        <div class="inline-flex flex-col items-center relative cursor-pointer shrink-0 btn-tap w-20" onclick="App.checkAndCreateNote()" style="scroll-snap-align: start;">
                            <div class="relative">
                                <img id="current-user-avatar-note" class="w-16 h-16 rounded-full object-cover border-2 border-transparent ring-2 ring-gray-200 p-0.5">
                                <div class="absolute bottom-0 right-0 bg-white rounded-full p-0.5 shadow-sm" id="my-note-plus-icon">
                                    <div class="bg-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-white">
                                        <i class="ph ph-plus text-xs font-bold"></i>
                                    </div>
                                </div>
                            </div>
                            <span class="text-[11px] font-bold mt-1 text-gray-800 w-full text-center truncate">ุฃูุช</span>
                            <div id="my-note-text-container" class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1.5 rounded-lg mt-1 w-full text-center truncate border border-gray-200">
                                ุฅุถุงูุฉ ููุงุญุธุฉ
                            </div>
                        </div>
                        <!-- ููุงุญุธุงุช ุฃุฎุฑู -->
                    </div>
                </div>

                <!-- ุงููุทูุจ 9: ุชูุณูู ูุณู ุงูุฃุตุฏูุงุก -->
                <div class="bg-white rounded-xl shadow-sm flex-1 flex flex-col overflow-hidden">
                    <div class="flex border-b border-gray-100 bg-gray-50 shrink-0">
                        <button onclick="App.switchFriendsSubTab('requests')" id="subtab-requests" class="flex-1 py-3 text-center text-sm font-bold sub-tab-active btn-tap transition-colors">ุทูุจุงุช ุงูุตุฏุงูุฉ</button>
                        <button onclick="App.switchFriendsSubTab('friends')" id="subtab-friends" class="flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors">ุงูุฃุตุฏูุงุก</button>
                        <button onclick="App.switchFriendsSubTab('suggestions')" id="subtab-suggestions" class="flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors">ุงูุชุฑุงุญุงุช</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto smooth-scroll p-3 relative">
                        <!-- ุงูุญุงููุงุช -->
                        <div id="subtab-content-requests" class="space-y-3"></div>
                        <div id="subtab-content-friends" class="hidden space-y-3"></div>
                        <div id="subtab-content-suggestions" class="hidden space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- ุงููุณู ุงูุฑุงุจุน: ุงูุฅุดุนุงุฑุงุช -->
            <div id="tab-notifications" class="hidden p-2">
                <h2 class="text-xl font-bold p-2 mb-2">ุงูุฅุดุนุงุฑุงุช</h2>
                <div id="notifications-container" class="bg-white rounded-xl shadow-sm overflow-hidden min-h-[400px]">
                </div>
            </div>

            <!-- ุงููุณู ุงูุฎุงูุณ: ุงูุฅุนุฏุงุฏุงุช -->
            <div id="tab-settings" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-6">ุงููุงุฆูุฉ</h2>
                
                <div class="bg-white rounded-xl p-4 shadow-sm flex items-center gap-4 mb-6 cursor-pointer btn-tap border border-gray-50" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <img id="settings-avatar" src="" class="w-14 h-14 rounded-full object-cover bg-gray-200 border border-gray-100">
                    <div class="flex-1 flex items-center gap-1">
                        <h3 id="settings-name" class="font-bold text-lg leading-tight">...</h3>
                        <span id="settings-premium-badge"></span>
                    </div>
                    <i class="ph ph-caret-left text-gray-400 text-xl"></i>
                </div>

                <div class="space-y-3">
                    <button onclick="UI.openModal('edit-profile-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-user-pen text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">ุชุนุฏูู ุงูููู ุงูุดุฎุตู</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <!-- ุงููุทูุจ 10: ุฒุฑ ุงูุงุดุชุฑุงู ุงููููุฒ -->
                    <button onclick="UI.openModal('premium-modal')" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap text-white relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full animate-[shimmer_3s_infinite]"></div>
                        <div class="w-10 h-10 rounded-full bg-white/20 text-yellow-300 flex items-center justify-center backdrop-blur-sm"><i class="ph-fill ph-crown text-xl"></i></div>
                        <span class="font-bold flex-1 text-right">ุงูุงุดุชุฑุงู ุงููููุฒ</span>
                        <i class="ph ph-caret-left text-white/70"></i>
                    </button>

                    <button onclick="UI.openModal('privacy-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="ph-fill ph-lock-key text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">ุงูุฎุตูุตูุฉ</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('account-settings-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ph-fill ph-gear text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ ูุงูุฃูุงู</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <!-- ุฒุฑ ููุญุฉ ุชุญูู ุงููุงูู ูุธูุฑ ููุท ูููุงูู -->
                    <button id="admin-panel-btn" onclick="UI.openModal('admin-modal')" class="hidden w-full bg-gray-900 p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center"><i class="ph-fill ph-shield-star text-xl"></i></div>
                        <span class="font-bold flex-1 text-right text-white">ููุญุฉ ุชุญูู ุงููุงูู</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="Auth.logout()" class="w-full bg-red-50 p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap mt-8 border border-red-100">
                        <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="ph-fill ph-sign-out text-xl"></i></div>
                        <span class="font-bold flex-1 text-right text-red-600">ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- ุฑุณุงุฆู ุงููุธุงู -->
    <div id="msg-box" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-[200] opacity-0 pointer-events-none transition-opacity duration-300 flex items-center gap-2 text-sm font-semibold">
        <span id="msg-box-text">ุฑุณุงูุฉ</span>
    </div>

    <!-- ูุงูุฐุฉ ุงูุจุญุซ -->
    <div id="search-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3">
            <button onclick="UI.closeModal('search-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <div class="flex-1 relative">
                <input type="text" id="search-input" oninput="App.searchUsers()" placeholder="ุงุจุญุซ ุนู ุฃุตุฏูุงุก..." class="w-full bg-gray-100 rounded-full py-2.5 px-4 pr-10 outline-none focus:ring-2 focus:ring-blue-100 transition-shadow">
                <i class="ph ph-magnifying-glass absolute right-3 top-3 text-gray-400 text-lg"></i>
            </div>
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto smooth-scroll p-2 space-y-1">
            <div class="text-center text-gray-400 py-10 mt-10">
                <i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50 block mx-auto"></i>
                ุงูุชุจ ููุจุญุซ ุนู ูุณุชุฎุฏููู
            </div>
        </div>
    </div>

    <!-- ูุงุฆูุฉ ุงูููุดู -->
    <div id="mentions-dropdown" class="smooth-scroll border-t-2 border-blue-500">
    </div>

    <!-- ูุงูุฐุฉ ุฅูุดุงุก ููุดูุฑ -->
    <div id="create-post-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in relative">
        <div class="p-4 border-b flex items-center justify-between bg-white shadow-sm z-10">
            <button onclick="UI.closeModal('create-post-modal')" class="p-2 text-gray-600 font-bold btn-tap rounded-lg hover:bg-gray-50">ุฅูุบุงุก</button>
            <span class="font-bold text-lg">ุฅูุดุงุก ููุดูุฑ</span>
            <button onclick="App.createPost()" class="bg-blue-600 text-white px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">ูุดุฑ</button>
        </div>
        <div class="p-4 flex gap-3 flex-1 overflow-y-auto smooth-scroll relative">
            <img id="create-post-avatar" src="" class="w-12 h-12 rounded-full object-cover border border-gray-100">
            <textarea id="post-text-input" placeholder="ุจู ุชููุฑุ ุงุณุชุฎุฏู @ ูุฐูุฑ ุตุฏูู" class="flex-1 resize-none outline-none text-lg pt-2 hide-scrollbar bg-transparent" rows="10"></textarea>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุฅูุดุงุก ููุงุญุธุฉ -->
    <div id="create-note-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in relative">
        <div class="p-4 flex items-center justify-between absolute w-full top-0 z-10 bg-gradient-to-b from-black/50 to-transparent border-none">
            <button onclick="UI.closeModal('create-note-modal')" class="p-2 text-white font-bold btn-tap drop-shadow-md">ุฅูุบุงุก</button>
            <button onclick="App.createNote()" class="bg-white text-gray-900 px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">ูุดุงุฑูุฉ</button>
        </div>
        <div class="flex-1 bg-gradient-to-br from-gray-800 to-gray-900 p-8 flex flex-col items-center justify-center relative">
            <img id="create-note-preview-avatar" src="" class="w-20 h-20 rounded-full border-4 border-gray-700 mb-6 object-cover shadow-lg">
            <textarea id="note-text-input" placeholder="ุงูุชุจ ููุงุญุธุฉ ูู 24 ุณุงุนุฉ... (ุงุณุชุฎุฏู @)" class="w-full bg-transparent text-white text-center text-3xl outline-none resize-none placeholder-white/30 font-bold" rows="3" maxlength="60"></textarea>
            <p class="text-white/50 text-xs mt-4">ุงูุญุฏ ุงูุฃูุตู 60 ุญุฑูุงู</p>
        </div>
    </div>

    <!-- ุงููุทูุจ 2: ูุงูุฐุฉ ุนุฑุถ ุงูููุงุญุธุฉ (ุชุดุจู ุงููุตุต/ุงูุณุชูุฑู) -->
    <div id="note-view-modal" class="hidden fixed inset-0 bg-black/95 z-[100] flex flex-col modal-slide-in">
        <div class="p-4 flex items-center gap-3 absolute top-0 w-full z-10 bg-gradient-to-b from-black/60 to-transparent">
            <img id="nv-avatar" class="w-10 h-10 rounded-full border border-gray-600 object-cover cursor-pointer btn-tap" onclick="App.viewProfileFromNote()">
            <div class="flex-1 flex flex-col cursor-pointer" onclick="App.viewProfileFromNote()">
                <div class="flex items-center gap-1">
                    <h3 id="nv-name" class="text-white font-bold text-sm">...</h3>
                    <span id="nv-premium-badge"></span>
                </div>
                <span id="nv-time" class="text-gray-300 text-[10px]">...</span>
            </div>
            <button onclick="UI.closeModal('note-view-modal')" class="w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
        </div>
        
        <div class="flex-1 flex items-center justify-center p-6 relative">
            <div id="nv-text" class="text-white text-3xl font-black text-center leading-relaxed whitespace-pre-wrap">...</div>
        </div>

        <div id="note-reply-section" class="p-4 w-full flex gap-3 items-center z-10 bg-gradient-to-t from-black/80 to-transparent pb-safe hidden">
            <input type="text" id="note-reply-input" placeholder="ุฅุฑุณุงู ุฑุณุงูุฉ..." class="flex-1 bg-white/10 text-white placeholder-white/50 border border-white/20 rounded-full px-5 py-3 outline-none text-sm focus:bg-white/20 transition-colors backdrop-blur-sm">
            <button onclick="App.likeNote()" class="w-12 h-12 bg-white/10 hover:bg-white/20 text-white rounded-full flex items-center justify-center btn-tap border border-white/20 transition-colors shrink-0"><i class="ph-fill ph-heart text-2xl"></i></button>
            <button onclick="App.sendNoteReply()" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shadow-lg shrink-0"><i class="ph-fill ph-paper-plane-right text-xl"></i></button>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุงูููุงุญุธุฉ (ุชุนุฏูู/ุญุฐู) -->
    <div id="manage-note-modal" class="hidden fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">ุฅุฏุงุฑุฉ ุงูููุงุญุธุฉ</h3>
            </div>
            <div class="p-4 space-y-4">
                <textarea id="edit-note-input" class="w-full bg-gray-100 p-4 rounded-xl outline-none text-center font-bold text-lg resize-none" rows="2" maxlength="60"></textarea>
                <div class="flex flex-col gap-2">
                    <button onclick="App.updateNote()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap">ุชุญุฏูุซ ุงูููุงุญุธุฉ</button>
                    <button onclick="App.deleteNote()" class="w-full bg-red-100 text-red-600 font-bold py-3 rounded-xl btn-tap">ุญุฐู ุงูููุงุญุธุฉ</button>
                    <button onclick="UI.closeModal('manage-note-modal')" class="w-full text-gray-500 font-bold py-3 rounded-xl btn-tap">ุฅูุบุงุก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงูุชุนูููุงุช -->
    <div id="comments-modal" class="hidden fixed inset-0 z-[80] flex flex-col justify-end bg-black/50">
        <div class="bg-white w-full h-[85vh] rounded-t-3xl flex flex-col modal-slide-in shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="font-bold text-lg">ุงูุชุนูููุงุช</span>
                <button onclick="UI.closeModal('comments-modal')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
            </div>
            <div id="comments-list" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-5">
            </div>
            <div class="p-3 border-t flex gap-2 items-center bg-white pb-safe z-10">
                <img id="comment-my-avatar" src="" class="w-9 h-9 rounded-full object-cover">
                <input type="text" id="comment-input" placeholder="ุงุถู ุชุนูููุงู... (ุงุณุชุฎุฏู @)" class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 outline-none text-sm focus:bg-gray-200 transition-colors">
                <button onclick="App.addComment()" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shrink-0 shadow-md"><i class="ph-fill ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุชุนุฏูู ุงูููู ุงูุดุฎุตู -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm z-10">
            <button onclick="UI.closeModal('edit-profile-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">ุชุนุฏูู ุงูููู ุงูุดุฎุตู</span>
            <button onclick="App.saveProfile()" class="bg-gray-900 text-white px-4 py-1.5 rounded-full font-bold btn-tap text-sm">ุญูุธ</button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto smooth-scroll flex-1">
            <div class="flex flex-col items-center mb-4">
                <label for="edit-profile-pic" class="relative cursor-pointer group btn-tap">
                    <img id="edit-profile-img" src="" class="w-28 h-28 rounded-full object-cover border-4 border-gray-100 shadow-sm">
                    <div class="absolute bottom-0 right-0 bg-blue-600 p-2.5 rounded-full text-white border-2 border-white shadow-md group-hover:bg-blue-700 transition-colors"><i class="ph ph-camera"></i></div>
                    <input type="file" id="edit-profile-pic" accept="image/*" class="hidden" onchange="App.handleEditImage(event)">
                </label>
            </div>
            <div class="bg-gray-50 p-4 rounded-2xl space-y-4 border border-gray-100">
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">ุงูุงุณู</label>
                    <input type="text" id="edit-name" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 font-bold text-lg transition-colors">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">ุงููุนุฑู (ูุฑุฉ ูุงุญุฏุฉ ูู 10 ุฃูุงู)</label>
                    <input type="text" id="edit-username" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 dir-ltr text-left font-mono text-lg transition-colors disabled:text-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed rounded-t-md px-2" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_.]/g, '')">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">ุงููุจุฐุฉ (Bio)</label>
                    <textarea id="edit-bio" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 resize-none transition-colors" rows="3"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ุงููุทูุจ 10: ูุงูุฐุฉ ุงูุงุดุชุฑุงู ุงููููุฒ -->
    <div id="premium-modal" class="hidden fixed inset-0 bg-white z-[75] flex flex-col modal-slide-in">
        <div class="p-4 flex justify-between items-center bg-white z-10 sticky top-0">
            <button onclick="UI.closeModal('premium-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll px-6 pb-10 flex flex-col items-center">
            <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-yellow-400 to-yellow-600 flex items-center justify-center shadow-[0_0_30px_rgba(234,179,8,0.4)] mb-6 mt-4">
                <i class="ph-fill ph-crown text-5xl text-white"></i>
            </div>
            <h2 class="text-3xl font-black text-gray-900 mb-2">ุฒุงููู ุงููููุฒ</h2>
            <p class="text-gray-500 text-center mb-8">ุงุฑุชูู ุจุชุฌุฑุจุชู ูุงุญุตู ุนูู ููุฒุงุช ุญุตุฑูุฉ ุชุฌุนูู ูููุฒุงู.</p>

            <div id="premium-active-status" class="hidden w-full bg-green-50 border border-green-200 p-4 rounded-2xl mb-6 text-center">
                <h3 class="font-bold text-green-700 text-lg mb-1">ุญุณุงุจู ูููุฒ ุญุงููุงู ๐</h3>
                <p class="text-sm text-green-600" id="premium-expiry-text"></p>
            </div>

            <div class="w-full space-y-4">
                <input type="text" id="premium-code-input" placeholder="ุฃุฏุฎู ููุฏ ุงูุชูุนูู ููุง..." class="w-full bg-gray-100 border border-gray-200 p-4 rounded-xl outline-none focus:border-blue-500 text-center font-bold text-lg dir-ltr">
                <button onclick="App.verifyPremiumCode()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-md btn-tap">ุชุฃููุฏ ุงูููุฏ</button>
                <button onclick="App.showPremiumFeatures()" class="w-full bg-blue-50 text-blue-700 font-bold py-4 rounded-xl btn-tap border border-blue-100">ูููุฒุงุช ุงูุญุณุงุจ ุงููููุฒ</button>
                <button onclick="window.open('https://t.me/mslmh19', '_blank')" class="w-full bg-[#0088cc]/10 text-[#0088cc] font-bold py-4 rounded-xl btn-tap flex items-center justify-center gap-2">
                    <i class="ph-fill ph-telegram-logo text-xl"></i> ุงูุญุตูู ุนูู ููุฏ ูููุฒ
                </button>
            </div>
        </div>
    </div>

    <!-- ุงููุทูุจ 10: ูุงูุฐุฉ ููุญุฉ ุชุญูู ุงููุงูู -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-50 z-[80] flex flex-col modal-slide-in">
        <div class="bg-white p-4 border-b flex items-center gap-3 shadow-sm z-10">
            <button onclick="UI.closeModal('admin-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">ููุญุฉ ุงูุชุญูู (ุงูุฅุฏุงุฑุฉ)</span>
        </div>
        <div class="p-4 space-y-3 flex-1 overflow-y-auto">
            <button onclick="UI.openModal('admin-subs-modal')" class="w-full bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 btn-tap">
                <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-users-three text-2xl"></i></div>
                <div class="flex-1 text-right">
                    <h3 class="font-bold text-lg text-gray-800">ุงูุงุดุชุฑุงูุงุช ุงููููุฒุฉ</h3>
                    <p class="text-xs text-gray-500 mt-1">ุฅูุดุงุก ูุฅุฏุงุฑุฉ ุฃููุงุฏ ุงูุชูุนูู</p>
                </div>
                <i class="ph ph-caret-left text-gray-400"></i>
            </button>
        </div>
    </div>

    <div id="admin-subs-modal" class="hidden fixed inset-0 bg-white z-[85] flex flex-col modal-slide-in">
        <div class="bg-gray-50 p-4 border-b flex items-center gap-3 shadow-sm z-10">
            <button onclick="UI.closeModal('admin-subs-modal')" class="p-2 bg-white border rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช</span>
        </div>
        <div class="p-6 space-y-6 flex-1 overflow-y-auto">
            <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                <h3 class="font-bold text-blue-800 mb-4 text-lg">ุฅูุดุงุก ููุฏ ุฌุฏูุฏ</h3>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="App.generateCode(1)" class="bg-white border border-blue-200 text-blue-700 py-2 rounded-lg font-bold btn-tap text-sm hover:bg-blue-100 transition-colors">ุดูุฑ ูุงุญุฏ</button>
                    <button onclick="App.generateCode(3)" class="bg-white border border-blue-200 text-blue-700 py-2 rounded-lg font-bold btn-tap text-sm hover:bg-blue-100 transition-colors">3 ุฃุดูุฑ</button>
                    <button onclick="App.generateCode(6)" class="bg-white border border-blue-200 text-blue-700 py-2 rounded-lg font-bold btn-tap text-sm hover:bg-blue-100 transition-colors">6 ุฃุดูุฑ</button>
                    <button onclick="App.generateCode(12)" class="bg-white border border-blue-200 text-blue-700 py-2 rounded-lg font-bold btn-tap text-sm hover:bg-blue-100 transition-colors">ุณูุฉ ูุงููุฉ</button>
                </div>
                <div id="generated-code-result" class="hidden bg-white p-3 rounded-lg border border-blue-200 text-center flex items-center justify-between">
                    <span id="new-code-text" class="font-mono font-bold text-lg tracking-wider text-gray-800 dir-ltr select-all"></span>
                    <button onclick="App.copyGeneratedCode()" class="text-blue-600 p-2"><i class="ph-fill ph-copy text-xl"></i></button>
                </div>
            </div>

            <div class="bg-red-50 p-5 rounded-2xl border border-red-100">
                <h3 class="font-bold text-red-800 mb-4 text-lg">ุญุฐู ูุชุนุทูู ููุฏ</h3>
                <input type="text" id="admin-revoke-code" placeholder="ุฃุฏุฎู ุงูููุฏ ููุง..." class="w-full bg-white border border-red-200 p-3 rounded-xl outline-none mb-3 font-mono dir-ltr text-center">
                <button onclick="App.revokeCode()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl btn-tap shadow-sm hover:bg-red-700 transition-colors">ุญุฐู ูุชุนุทูู</button>
            </div>
        </div>
    </div>


    <!-- ูุงูุฐุฉ ุงูุฎุตูุตูุฉ -->
    <div id="privacy-modal" class="hidden fixed inset-0 bg-gray-50 z-[70] flex flex-col modal-slide-in">
        <div class="bg-white p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('privacy-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">ุฅุนุฏุงุฏุงุช ุงูุฎุตูุตูุฉ</span>
        </div>
        <div class="p-4 space-y-3 smooth-scroll overflow-y-auto">
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100">
                <div>
                    <h4 class="font-bold text-gray-800">ุงุณุชูุจุงู ุทูุจุงุช ุงูุตุฏุงูุฉ</h4>
                    <p class="text-xs text-gray-500 mt-0.5">ุงูุณูุงุญ ููุขุฎุฑูู ุจุฅุฑุณุงู ุทูุจุงุช ูู</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-requests" class="sr-only peer" onchange="App.updatePrivacy('allowRequests', this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100">
                <div>
                    <h4 class="font-bold text-gray-800">ุญุณุงุจ ุฎุงุต</h4>
                    <p class="text-xs text-gray-500 mt-0.5">ุฅุฎูุงุก ููุดูุฑุงุชู ุนู ุบูุฑ ุงูุฃุตุฏูุงุก</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-private" class="sr-only peer" onchange="App.updatePrivacy('isPrivate', this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            
            <!-- ููุฒุฉ ุงูุชุฎูู ูููููุฒูู -->
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100" id="stealth-mode-container">
                <div>
                    <h4 class="font-bold text-gray-800 flex items-center gap-1">ูุถุน ุงูุชุฎูู <i class="ph-fill ph-crown text-yellow-500 text-sm"></i></h4>
                    <p class="text-xs text-gray-500 mt-0.5">ุฅุฎูุงุก ุขุฎุฑ ุธููุฑ ูุนูุงูุฉ ุงููุฑุงุกุฉ</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-stealth" class="sr-only peer" onchange="App.toggleStealthMode(this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border border-gray-100">
                <h4 class="font-bold border-b pb-2 text-gray-800">ูู ููููู ุฑุคูุฉ ุฃุตุฏูุงุฆู</h4>
                <select id="priv-friends-vis" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200 focus:border-blue-500" onchange="App.updatePrivacy('friendsVisibility', this.value)">
                    <option value="all">ุงูุฌููุน</option>
                    <option value="friends">ุงูุฃุตุฏูุงุก ููุท</option>
                    <option value="only_me">ุฃูุง ููุท</option>
                </select>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border border-gray-100">
                <h4 class="font-bold border-b pb-2 text-gray-800">ูู ููููู ูุฑุงุณูุชู</h4>
                <select id="priv-msgs" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200 focus:border-blue-500" onchange="App.updatePrivacy('messagePrivacy', this.value)">
                    <option value="all">ุงูุฌููุน</option>
                    <option value="friends">ุงูุฃุตุฏูุงุก ููุท</option>
                    <option value="closed">ูุบูู (ูุง ุฃุญุฏ)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ุงููุทูุจ 11: ูุงูุฐุฉ ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ ูุงูุฃูุงู (ุชู ุฏูุฌ ุงููุญุธูุฑูู ููููุฉ ุงูุณุฑ) -->
    <div id="account-settings-modal" class="hidden fixed inset-0 bg-gray-50 z-[70] flex flex-col modal-slide-in">
        <div class="bg-white p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('account-settings-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ ูุงูุฃูุงู</span>
        </div>
        <div class="p-4 space-y-4">
            
            <button onclick="UI.openModal('blocked-users-modal')" class="w-full bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 btn-tap">
                <div class="w-12 h-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center"><i class="ph-fill ph-prohibit text-2xl"></i></div>
                <div class="flex-1 text-right">
                    <h3 class="font-bold text-lg text-gray-800">ุงููุณุชุฎุฏููู ุงููุญุธูุฑูู</h3>
                    <p class="text-xs text-gray-500 mt-0.5">ุฅุฏุงุฑุฉ ุงูุฃุดุฎุงุต ุงููุญุธูุฑูู</p>
                </div>
                <i class="ph ph-caret-left text-gray-400"></i>
            </button>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <button onclick="document.getElementById('password-section-content').classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('-rotate-90')" class="w-full p-5 flex items-center gap-4 btn-tap">
                    <div class="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i class="ph-fill ph-shield-warning text-2xl"></i></div>
                    <div class="flex-1 text-right">
                        <h3 class="font-bold text-lg text-gray-800">ุชุบููุฑ ูููุฉ ุงูุณุฑ</h3>
                    </div>
                    <i class="ph ph-caret-down text-gray-400 chevron transition-transform duration-300"></i>
                </button>
                <div id="password-section-content" class="hidden px-5 pb-5 pt-2 border-t border-gray-50">
                    <p class="text-sm text-gray-500 mb-4">ุณูุชู ุฅุฑุณุงู ุฑุงุจุท ูุจุฑูุฏู ุงูุฅููุชุฑููู ูุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงูุณุฑ ุงูุฎุงุตุฉ ุจู ุจุฃูุงู.</p>
                    <button onclick="Auth.resetPasswordFromSettings()" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-xl border border-red-100 btn-tap">ุฅุฑุณุงู ุฑุงุจุท ุงูุชุบููุฑ</button>
                </div>
            </div>
            
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงููุญุธูุฑูู -->
    <div id="blocked-users-modal" class="hidden fixed inset-0 bg-white z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm bg-white z-10 sticky top-0">
            <button onclick="UI.closeModal('blocked-users-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">ุงููุญุธูุฑูู</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-4" id="blocked-list-container">
        </div>
    </div>


    <!-- ููู ุดุฎุตู -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-white z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 bg-white/80 backdrop-blur-md absolute w-full top-0 z-20">
            <button onclick="UI.closeModal('profile-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span id="vp-header-name" class="font-bold text-lg">ุงูููู ุงูุดุฎุตู</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll pb-10">
            <div class="h-44 bg-gradient-to-tr from-blue-500 via-purple-500 to-pink-500 relative"></div>
            <div class="px-4 relative mb-6">
                <img id="vp-image" src="" class="w-28 h-28 rounded-full border-4 border-white absolute -top-14 object-cover bg-white shadow-md">
                <div class="flex justify-end pt-3 h-14 items-center gap-2" id="vp-action-container"></div>
                <div class="flex items-center gap-2 mt-4">
                    <h2 id="vp-name" class="text-3xl font-black leading-tight">...</h2>
                    <span id="vp-premium-badge"></span>
                </div>
                <p id="vp-username" class="text-gray-500 text-sm dir-ltr text-left w-max mt-1 font-medium bg-gray-100 px-2 py-0.5 rounded-md">@...</p>
                <p id="vp-bio" class="mt-4 text-gray-800 leading-relaxed">...</p>
            </div>
            <div class="flex border-y border-gray-100 py-4 px-4 text-center bg-gray-50">
                <div class="flex-1 border-l border-gray-200"><span class="font-black text-xl block text-gray-800" id="vp-friends-count">0</span><span class="text-xs text-gray-500 font-semibold uppercase tracking-wider">ุตุฏูู</span></div>
                <div class="flex-1"><span class="font-black text-xl block text-gray-800" id="vp-posts-count">0</span><span class="text-xs text-gray-500 font-semibold uppercase tracking-wider">ููุดูุฑ</span></div>
            </div>
            <div class="p-2 space-y-3 bg-gray-100 min-h-[50vh] pt-3" id="vp-posts-container">
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงููุญุงุฏุซุฉ (ุงูุดุงุช) -->
    <div id="chat-modal" class="hidden fixed inset-0 bg-gray-50 z-[90] flex flex-col modal-slide-in">
        <!-- ููุฏุฑ ุงููุญุงุฏุซุฉ -->
        <div class="bg-white p-3 border-b flex items-center justify-between shadow-sm z-20">
            <div class="flex items-center gap-3">
                <button onclick="UI.closeModal('chat-modal')" class="p-2 bg-gray-100 rounded-full btn-tap shrink-0"><i class="ph ph-arrow-right text-lg"></i></button>
                <div class="relative cursor-pointer shrink-0" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                    <img id="chat-user-img" src="" class="w-11 h-11 rounded-full object-cover">
                    <span id="chat-online-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full hidden"></span>
                </div>
                <div class="flex-1 overflow-hidden min-w-0" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                    <div class="flex items-center gap-1">
                        <h3 id="chat-user-name" class="font-bold leading-tight truncate">...</h3>
                        <span id="chat-header-premium-badge" class="shrink-0"></span>
                    </div>
                    <p id="chat-user-status" class="text-[11px] text-gray-500 truncate mt-0.5">...</p>
                </div>
            </div>
            <!-- ุงููุทูุจ 7: ูุงุฆู ุงููุญุงุฏุซุฉ (Xylo Pet) -->
            <div id="xylo-pet-container" class="shrink-0 bg-gray-50 p-2 rounded-xl flex flex-col items-center justify-center cursor-pointer ml-1 btn-tap border border-gray-100 min-w-[50px]">
                <span id="pet-emoji" class="text-2xl drop-shadow-sm transition-transform duration-300 transform hover:scale-110">๐ฅ</span>
                <span id="pet-streak" class="text-[9px] font-bold text-gray-500 mt-1">ููู 0</span>
            </div>
        </div>
        
        <!-- ุงูุญุงููุฉ ุงููุฎุตุตุฉ ูููุญุงุฏุซุฉ (ุงููุทูุจ 10: ุฎูููุฉ ูููููุฒูู) -->
        <div id="chat-background" class="flex-1 overflow-hidden flex flex-col relative bg-gray-50">
            <div id="chat-messages-container" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-4 flex flex-col relative z-10 pb-4">
                <!-- ุงูุฑุณุงุฆู -->
            </div>
        </div>

        <!-- ุญุงูุฉ ุงูุฑุฏ (ุงููุทูุจ 6) -->
        <div id="replying-to-container" class="hidden bg-gray-100 border-t border-gray-200 px-4 py-2 flex items-center justify-between shadow-[0_-2px_10px_rgba(0,0,0,0.02)] z-10 relative">
            <div class="flex flex-col border-r-4 border-blue-500 pr-3">
                <span class="text-xs font-bold text-blue-600" id="reply-to-name">ุงูุฑุฏ ุนูู...</span>
                <span class="text-sm text-gray-600 truncate max-w-[250px]" id="reply-to-text">...</span>
            </div>
            <button onclick="App.cancelReply()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
        </div>

        <div class="p-3 bg-white border-t flex gap-2 items-end pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.05)] relative z-20">
            <textarea id="chat-input" placeholder="ุงูุชุจ ุฑุณุงูุฉ..." class="flex-1 bg-gray-100 rounded-3xl px-5 py-3 outline-none resize-none max-h-28 hide-scrollbar text-[15px] focus:bg-gray-200 transition-colors border border-transparent focus:border-gray-300" rows="1" oninput="this.style.height = '';this.style.height = Math.min(this.scrollHeight, 112) + 'px'"></textarea>
            <button onclick="App.sendMessage()" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 transition-colors text-white rounded-full flex items-center justify-center shrink-0 btn-tap shadow-md mb-0.5"><i class="ph-fill ph-paper-plane-right text-xl"></i></button>
        </div>
    </div>

    <!-- ูุงุฆูุฉ ุงูุฎูุงุฑุงุช ุงูููุจุซูุฉ ุงูุนุงูุฉ (ุงููุทูุจ 4 ูุบูุฑูุง) -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-end justify-center">
        <div class="bg-white w-full rounded-t-3xl p-4 modal-slide-in shadow-[0_-10px_40px_rgba(0,0,0,0.2)] pb-safe">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            <div id="action-modal-content" class="space-y-2">
            </div>
            <button onclick="UI.closeModal('action-modal')" class="w-full bg-gray-100 text-gray-800 font-bold py-4 rounded-2xl mt-4 btn-tap">ุฅูุบุงุก</button>
        </div>
    </div>

    <!-- ุนุฑุถ ููุดูุฑ ููุฑุฏ -->
    <div id="single-post-modal" class="hidden fixed inset-0 bg-gray-100 z-[85] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 bg-white shadow-sm sticky top-0 z-10">
            <button onclick="UI.closeModal('single-post-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">ุนุฑุถ ุงูููุดูุฑ</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-2" id="single-post-container">
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDe7WeScgMaRAK7PzExvkzppb2XOcdAI0k",
                authDomain: "communication-5dd27.firebaseapp.com",
                databaseURL: "https://communication-5dd27-default-rtdb.firebaseio.com",
                projectId: "communication-5dd27",
                storageBucket: "communication-5dd27.firebasestorage.app",
                messagingSenderId: "79255528858",
                appId: "1:79255528858:web:6c75eee637561056b28623"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xylo-app-123';

        const USERS_PATH = `artifacts/${appId}/public/data/users`;
        const POSTS_PATH = `artifacts/${appId}/public/data/posts`;
        const COMMENTS_PATH = `artifacts/${appId}/public/data/comments`;
        const REQUESTS_PATH = `artifacts/${appId}/public/data/requests`;
        const FRIENDS_PATH = `artifacts/${appId}/public/data/friends`;
        const MESSAGES_PATH = `artifacts/${appId}/public/data/messages`;
        const NOTES_PATH = `artifacts/${appId}/public/data/notes`;
        const NOTIFS_PATH = `artifacts/${appId}/public/data/notifications`;
        const PREMIUM_CODES_PATH = `artifacts/${appId}/public/data/premium_codes`; // ูููุญุฉ ุงููุงูู

        window.Memory = {
            users: {}, posts: [], comments: [], requests: [], friends: [], messages: [], notes: [], notifications: [], premiumCodes: []
        };

        window.currentUser = null;
        window.currentChatUserId = null;
        window.currentPostIdForComment = null;
        window.currentManageNoteId = null;
        window.noteViewAuthorId = null; 
        window.replyingToMessage = null; // ุงููุทูุจ 6

        const escapeHTML = (str) => {
            if(!str) return '';
            return str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag] || tag));
        };

        const adminEmail = 'mslmalmyaly223@gmail.com';

        // ุงููุทูุจ 6: ูุธุงู ุงูุณุญุจ ููุชุญุฏูุซ
        window.PullToRefresh = {
            startY: 0, isPulling: false, spinner: null, container: null,
            init: () => {
                PullToRefresh.container = document.getElementById('main-content-area');
                PullToRefresh.spinner = document.getElementById('ptr-spinner');
                
                PullToRefresh.container.addEventListener('touchstart', e => {
                    if (PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.startY = e.touches[0].clientY;
                        PullToRefresh.isPulling = true;
                        PullToRefresh.spinner.style.transition = 'none';
                    }
                }, {passive: true});

                PullToRefresh.container.addEventListener('touchmove', e => {
                    if (!PullToRefresh.isPulling) return;
                    const y = e.touches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    if (diff > 0 && PullToRefresh.container.scrollTop <= 0) {
                        e.preventDefault();
                        let pullDistance = Math.min(diff * 0.4, 70); 
                        PullToRefresh.spinner.style.transform = `translate(-50%, ${pullDistance}px) rotate(${pullDistance*2}deg)`;
                        PullToRefresh.spinner.style.opacity = Math.min(pullDistance / 50, 1);
                    }
                }, {passive: false});

                PullToRefresh.container.addEventListener('touchend', e => {
                    if (!PullToRefresh.isPulling) return;
                    PullToRefresh.isPulling = false;
                    PullToRefresh.spinner.style.transition = 'transform 0.3s, opacity 0.3s';
                    
                    const y = e.changedTouches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    
                    if (diff > 80 && PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.spinner.style.transform = `translate(-50%, 50px) rotate(360deg)`;
                        PullToRefresh.spinner.classList.add('animate-spin');
                        
                        setTimeout(() => {
                            App.renderFeed();
                            App.renderNotifications();
                            PullToRefresh.spinner.classList.remove('animate-spin');
                            PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                            PullToRefresh.spinner.style.opacity = 0;
                            UI.showMessage('ุชู ุงูุชุญุฏูุซ');
                        }, 1000);
                    } else {
                        PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                        PullToRefresh.spinner.style.opacity = 0;
                    }
                }, {passive: true});
            }
        };

        window.Mentions = {
            activeInput: null,
            setup: () => {
                const inputs = ['post-text-input', 'note-text-input', 'comment-input'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('input', (e) => Mentions.checkTrigger(e.target));
                        el.addEventListener('blur', () => setTimeout(() => document.getElementById('mentions-dropdown').style.display = 'none', 200));
                    }
                });
            },
            checkTrigger: (input) => {
                Mentions.activeInput = input;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const words = textBeforeCursor.split(/\s/);
                const lastWord = words[words.length - 1];

                const dropdown = document.getElementById('mentions-dropdown');
                
                if (lastWord.startsWith('@')) {
                    const query = lastWord.substring(1).toLowerCase();
                    Mentions.showList(query, input);
                } else {
                    dropdown.style.display = 'none';
                }
            },
            showList: (query, input) => {
                const dropdown = document.getElementById('mentions-dropdown');
                dropdown.innerHTML = '';
                
                const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                
                let results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    friendsIds.includes(u.uid) &&
                    (u.username.toLowerCase().includes(query) || u.name.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const mentionsCount = currentUser.mentionsCount || {};
                results.sort((a,b) => (mentionsCount[b.uid] || 0) - (mentionsCount[a.uid] || 0));

                results.forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'p-3 flex items-center gap-3 border-b hover:bg-gray-50 cursor-pointer btn-tap';
                    item.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-8 h-8 rounded-full object-cover border">
                        <div>
                            <div class="font-bold text-sm text-gray-800">${u.name}</div>
                            <div class="text-[10px] text-gray-500">@${u.username}</div>
                        </div>
                    `;
                    item.onmousedown = (e) => {
                        e.preventDefault(); 
                        Mentions.selectUser(u.username, u.uid);
                    };
                    dropdown.appendChild(item);
                });

                const rect = input.getBoundingClientRect();
                dropdown.style.bottom = 'auto';
                dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                if(input.id === 'comment-input' || input.id === 'post-text-input') {
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '60px'; 
                }
                
                dropdown.style.display = 'block';
            },
            selectUser: (username, uid) => {
                const input = Mentions.activeInput;
                if(!input) return;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const textAfterCursor = text.substring(cursorPos);
                
                const words = textBeforeCursor.split(/\s/);
                words.pop(); 
                
                const newTextBefore = (words.length > 0 ? words.join(' ') + ' ' : '') + '@' + username + ' ';
                input.value = newTextBefore + textAfterCursor;
                input.focus();
                input.setSelectionRange(newTextBefore.length, newTextBefore.length);
                
                document.getElementById('mentions-dropdown').style.display = 'none';
                App.incrementMentionCount(uid);
            }
        };

        window.UI = {
            showMessage: (msg) => {
                const box = document.getElementById('msg-box');
                document.getElementById('msg-box-text').innerText = msg;
                box.style.opacity = '1';
                setTimeout(() => { box.style.opacity = '0'; }, 3000);
            },
            switchAuth: (formId) => {
                ['login-form', 'register-form', 'forgot-form'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`${formId}-form`).classList.remove('hidden');
            },
            showScreen: (screenId) => {
                ['splash-screen', 'auth-screen', 'setup-profile-screen', 'main-app'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            switchTab: (tabId) => {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                    btn.querySelector('i').classList.remove('ph-fill');
                    btn.querySelector('i').classList.add('ph');
                });
                const activeBtn = document.querySelector(`.nav-btn[onclick="UI.switchTab('${tabId}')"]`);
                if(activeBtn) {
                    activeBtn.classList.remove('text-gray-500', 'border-transparent');
                    activeBtn.classList.add('text-blue-600', 'border-blue-600');
                    activeBtn.querySelector('i').classList.remove('ph');
                    activeBtn.querySelector('i').classList.add('ph-fill');
                }

                ['tab-home', 'tab-messages', 'tab-notes', 'tab-notifications', 'tab-settings'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                
                App.updateLastActive();
                
                if(tabId === 'messages') App.renderChats(); 
                if(tabId === 'notes') {
                    document.getElementById('badge-requests').classList.add('hidden');
                    App.switchFriendsSubTab('friends'); // ุงูุชุฑุงุถู
                }
                if(tabId === 'notifications') document.getElementById('badge-notifications').classList.add('hidden');

                document.getElementById('main-content-area').scrollTop = 0;
            },
            openModal: (modalId, data = null) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                if (modal.firstElementChild.classList.contains('modal-slide-in') || modal.firstElementChild.classList.contains('modal-slide-out')) {
                    modal.firstElementChild.classList.remove('modal-slide-out');
                    modal.firstElementChild.classList.add('modal-slide-in');
                }

                if (modalId === 'profile-modal' && data) {
                    App.renderUserProfile(data);
                } else if (modalId === 'chat-modal' && data) {
                    window.currentChatUserId = data;
                    App.cancelReply(); // ูุณุญ ุงูุฑุฏ ุงูุณุงุจู
                    App.renderChatInfo(data);
                    App.renderMessages();
                    App.markChatAsRead(data); 
                } else if (modalId === 'comments-modal' && data) {
                    window.currentPostIdForComment = data;
                    document.getElementById('comment-my-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    App.renderComments();
                } else if (modalId === 'edit-profile-modal') {
                    document.getElementById('edit-name').value = currentUser.name || '';
                    document.getElementById('edit-bio').value = currentUser.bio || '';
                    document.getElementById('edit-profile-img').src = currentUser.photo || App.getDefaultAvatar();
                    
                    const usernameInput = document.getElementById('edit-username');
                    usernameInput.value = currentUser.username || '';
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) {
                        usernameInput.disabled = true;
                        UI.showMessage('ุชุบููุฑ ุงููุนุฑู ูุนุทู ูุคูุชุงู (ูุฑุฉ ูู 10 ุฃูุงู)');
                    } else {
                        usernameInput.disabled = false;
                    }
                } else if (modalId === 'privacy-modal') {
                    document.getElementById('priv-requests').checked = currentUser.allowRequests !== false;
                    document.getElementById('priv-private').checked = currentUser.isPrivate === true;
                    document.getElementById('priv-friends-vis').value = currentUser.friendsVisibility || 'all';
                    document.getElementById('priv-msgs').value = currentUser.messagePrivacy || 'all';
                    
                    // ุงูุชุฎูู
                    if(App.isPremium()) {
                        document.getElementById('stealth-mode-container').classList.remove('opacity-50', 'pointer-events-none');
                        document.getElementById('priv-stealth').checked = currentUser.stealthMode === true;
                    } else {
                        document.getElementById('stealth-mode-container').classList.add('opacity-50', 'pointer-events-none');
                        document.getElementById('priv-stealth').checked = false;
                    }

                } else if (modalId === 'create-note-modal') {
                    document.getElementById('create-note-preview-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    document.getElementById('note-text-input').value = '';
                } else if (modalId === 'blocked-users-modal') {
                    App.renderBlockedUsers(); 
                } else if (modalId === 'premium-modal') {
                    App.renderPremiumModal();
                }
            },
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal.firstElementChild.classList.contains('modal-slide-in')) {
                    modal.firstElementChild.classList.remove('modal-slide-in');
                    modal.firstElementChild.classList.add('modal-slide-out');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                } else {
                    modal.classList.add('hidden');
                }
            },
            openProfileByUsername: (username) => {
                const u = Object.values(Memory.users).find(user => user.username === username);
                if(u) {
                    UI.closeModal('comments-modal');
                    UI.closeModal('note-view-modal');
                    UI.openModal('profile-modal', u.uid);
                } else {
                    UI.showMessage('ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ');
                }
            }
        };

        let tempPhotoBase64 = null;

        window.Auth = {
            init: async () => {
                // ุงููุทูุจ 8: ุฅุธูุงุฑ ุดุงุดุฉ ุงูุจุฏุงูุฉ 
                UI.showScreen('splash-screen');

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e){}
                } else if (!auth.currentUser) {
                    setTimeout(() => {
                        if(!auth.currentUser) UI.showScreen('auth-screen');
                    }, 3000); // ููุช ูุงูู ูุฑุคูุฉ ุงูุงูููุดู ุงููุฎู
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                        if (userDoc.exists()) {
                            window.currentUser = userDoc.data();
                            if(!window.currentUser.blockedUsers) window.currentUser.blockedUsers = [];
                            if(!window.currentUser.mentionsCount) window.currentUser.mentionsCount = {};
                            
                            setTimeout(() => { App.startCore(); }, 1500); // ุชูุฏูุฏ ุจุณูุท ูุงุณุชูุชุงุน ุจุงูุดุนุงุฑ
                            
                            const urlParams = new URLSearchParams(window.location.search);
                            const postIdParam = urlParams.get('post');
                            if(postIdParam) {
                                setTimeout(() => App.openSinglePost(postIdParam), 2500);
                            }
                        } else {
                            setTimeout(() => { UI.showScreen('setup-profile-screen'); }, 1500);
                        }
                    } else {
                        window.currentUser = null;
                        setTimeout(() => { UI.showScreen('auth-screen'); }, 3000);
                    }
                });
            },
            register: async () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                if(!name || !email || !password) return UI.showMessage('ูุฑุฌู ููุก ุฌููุน ุงูุญููู');
                
                try {
                    UI.showMessage('ุฌุงุฑู ุงูุฅูุดุงุก...');
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    window.tempRegData = { uid: cred.user.uid, name, email };
                    UI.showScreen('setup-profile-screen');
                } catch (error) {
                    UI.showMessage('ุญุฏุซ ุฎุทุฃุ ุฑุจูุง ุงูุจุฑูุฏ ูุณุชุฎุฏู ูุณุจูุงู ุฃู ุงูุฑูุฒ ุถุนูู');
                }
            },
            // ุงููุทูุจ 1: ุชุตุญูุญ ุชุณุฌูู ุงูุฏุฎูู ุจุฌูุฌู
            loginWithGoogle: async () => {
                try {
                    UI.showMessage('ุฌุงุฑู ุงูุชุญููู ูุฌูุฌู...');
                    // ูุณุชุฎุฏู signInWithPopup ูุฎูุงุฑ ุฃูู ูู ุงูููุจ
                    const result = await signInWithPopup(auth, googleProvider).catch(async (e) => {
                        if(e.code === 'auth/popup-blocked' || e.code === 'auth/unauthorized-domain') {
                            UI.showMessage('ุชู ุญุธุฑ ุงููุงูุฐุฉ ุฃู ุงูุฏูููู ุบูุฑ ูุตุฑุญ. ุญุงูู ุนุจุฑ ูุชุตูุญ ุฎุงุฑุฌู.');
                            throw e;
                        } else {
                            // ูุญุงููุฉ ุงูุชุญููู ูุจุฏูู
                            return await signInWithRedirect(auth, googleProvider);
                        }
                    });
                    
                    if(!result) return; // ููุฏ ุงูุชุญููู

                    const user = result.user;
                    const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                    if (!userDoc.exists()) {
                        await setDoc(doc(db, USERS_PATH, user.uid), {
                            uid: user.uid,
                            name: user.displayName || 'ูุณุชุฎุฏู ุฒุงููู',
                            email: user.email,
                            photo: user.photoURL || App.getDefaultAvatar(),
                            username: 'user_' + Math.floor(Math.random() * 100000),
                            bio: 'ูุฑุญุจุงูุ ุฃูุง ุฃุณุชุฎุฏู ุชุทุจูู ุฒุงููู!',
                            allowRequests: true,
                            isPrivate: false,
                            friendsVisibility: 'all',
                            messagePrivacy: 'all',
                            lastActive: Date.now(),
                            lastUsernameChange: 0,
                            blockedUsers: [],
                            mentionsCount: {}
                        });
                    }
                } catch (error) {
                    console.error(error);
                    UI.showMessage('ูุดู ุชุณุฌูู ุงูุฏุฎูู. ' + (error.message.includes('invalid') ? 'ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช Firebase' : ''));
                }
            },
            login: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if(!email || !password) return UI.showMessage('ูุฑุฌู ููุก ุงูุญููู');
                try {
                    UI.showMessage('ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎูู...');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    UI.showMessage('ุงูุจุฑูุฏ ุฃู ูููุฉ ุงูุณุฑ ุบูุฑ ุตุญูุญุฉ');
                }
            },
            resetPassword: async () => {
                const email = document.getElementById('forgot-email').value;
                if(!email) return UI.showMessage('ุฃุฏุฎู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู');
                try {
                    await sendPasswordResetEmail(auth, email);
                    UI.showMessage('ุชู ุฅุฑุณุงู ุฑุงุจุท ุฅุนุงุฏุฉ ุงูุชุนููู ูุจุฑูุฏู');
                    UI.switchAuth('login');
                } catch(e) { UI.showMessage('ุญุฏุซ ุฎุทุฃ'); }
            },
            resetPasswordFromSettings: async () => {
                if(auth.currentUser && auth.currentUser.email) {
                    try {
                        await sendPasswordResetEmail(auth, auth.currentUser.email);
                        UI.showMessage('ุชู ุฅุฑุณุงู ุงูุฑุงุจุท ูุจุฑูุฏู');
                    } catch(e) { UI.showMessage('ุญุฏุซ ุฎุทุฃ'); }
                }
            },
            logout: async () => {
                App.updateLastActive(true); // ุชุญุฏูุซ ูุบูุฑ ูุชุตู ููุฑุงู
                await signOut(auth);
                window.location.reload();
            },
            handleImageUpload: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; const MAX_HEIGHT = 400;
                        let width = img.width; let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        tempPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        document.getElementById('profile-preview-img').src = tempPhotoBase64;
                        document.getElementById('profile-preview-img').classList.remove('hidden');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },
            completeProfileSetup: async () => {
                if(!window.tempRegData && !auth.currentUser) return;
                UI.showMessage('ุฌุงุฑู ุญูุธ ุงูุญุณุงุจ...');
                const uid = window.tempRegData ? window.tempRegData.uid : auth.currentUser.uid;
                const name = window.tempRegData ? window.tempRegData.name : 'ูุณุชุฎุฏู';
                const email = window.tempRegData ? window.tempRegData.email : '';
                
                const userData = {
                    uid: uid,
                    name: name,
                    email: email,
                    photo: tempPhotoBase64 || App.getDefaultAvatar(),
                    username: 'user_' + Math.floor(Math.random() * 1000000),
                    bio: 'ูุฑุญุจุงูุ ุฃูุง ุฃุณุชุฎุฏู ุชุทุจูู ุฒุงููู!',
                    allowRequests: true,
                    isPrivate: false,
                    friendsVisibility: 'all',
                    messagePrivacy: 'all',
                    lastActive: Date.now(),
                    lastUsernameChange: 0,
                    blockedUsers: [],
                    mentionsCount: {}
                };

                await setDoc(doc(db, USERS_PATH, uid), userData);
                window.currentUser = userData;
                App.startCore();
            }
        };

        window.App = {
            getDefaultAvatar: () => "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>",
            
            // ุงููุทูุจ 10: ููุทู ุงูุญุณุงุจ ุงููููุฒ
            isPremium: (u = currentUser) => {
                if(!u) return false;
                if(u.email === adminEmail) return true; // ุงููุงูู ุฏุงุฆููุง ูููุฒ
                return u.isPremium === true && u.premiumUntil && u.premiumUntil > Date.now();
            },
            isStealthActive: (u = currentUser) => {
                return App.isPremium(u) && u.stealthMode === true;
            },
            getPremiumBadgeHTML: (u) => {
                return App.isPremium(u) ? '<i class="ph-fill ph-seal-check text-blue-500 text-sm ml-1" title="ุญุณุงุจ ูููุฒ"></i>' : '';
            },

            startCore: () => {
                UI.showScreen('main-app');
                App.updateUIWithUserData();
                App.setupListeners();
                App.updateLastActive();
                Mentions.setup();
                PullToRefresh.init();
                setInterval(App.updateLastActive, 60000);
                
                // ุฅุธูุงุฑ ููุญุฉ ุงูุชุญูู ูููุงูู
                if(currentUser.email === adminEmail) {
                    document.getElementById('admin-panel-btn').classList.remove('hidden');
                }
            },

            updateUIWithUserData: () => {
                const photo = currentUser.photo || App.getDefaultAvatar();
                document.getElementById('current-user-avatar-home').src = photo;
                document.getElementById('current-user-avatar-note').src = photo;
                document.getElementById('settings-avatar').src = photo;
                document.getElementById('settings-name').innerText = currentUser.name;
                document.getElementById('settings-premium-badge').innerHTML = App.getPremiumBadgeHTML(currentUser);
                document.getElementById('create-post-avatar').src = photo;
            },

            updateLastActive: async (forceOffline = false) => {
                if(!currentUser) return;
                // ุฅุฐุง ูุงู ุงูุชุฎูู ููุนู ูุงููุณุชุฎุฏู ูุชุตูุ ูุง ูุญุฏุซ ููุช ุงูุธููุฑ (ููุจูู ุบูุฑ ูุชุตู ููุขุฎุฑูู)
                if(App.isStealthActive() && !forceOffline) return;
                
                const now = forceOffline ? (Date.now() - (6 * 60 * 1000)) : Date.now();
                currentUser.lastActive = now;
                try {
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { lastActive: now });
                } catch(e){}
            },

            setupListeners: () => {
                const errHandler = (e) => console.error("Firebase Read Error:", e);

                onSnapshot(collection(db, USERS_PATH), (snap) => {
                    snap.docs.forEach(d => {
                        const data = d.data();
                        Memory.users[d.id] = data;
                        if(d.id === currentUser.uid) {
                            currentUser.blockedUsers = data.blockedUsers || [];
                            currentUser.mentionsCount = data.mentionsCount || {};
                            currentUser.isPremium = data.isPremium;
                            currentUser.premiumUntil = data.premiumUntil;
                            currentUser.stealthMode = data.stealthMode;
                            App.updateUIWithUserData();
                        }
                    });
                    App.renderChats(); 
                    App.renderFeed(); // ุฅุนุงุฏุฉ ุฑุณู ูุชุญุฏูุซ ุงูุนูุงูุงุช ุงูุฒุฑูุงุก
                }, errHandler);

                onSnapshot(collection(db, POSTS_PATH), (snap) => {
                    Memory.posts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFeed();
                }, errHandler);

                onSnapshot(collection(db, COMMENTS_PATH), (snap) => {
                    Memory.comments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(window.currentPostIdForComment) App.renderComments();
                    App.renderFeed(); 
                }, errHandler);

                onSnapshot(collection(db, REQUESTS_PATH), (snap) => {
                    Memory.requests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFriendsTab('requests'); // ุงููุทูุจ 9
                }, errHandler);

                onSnapshot(collection(db, FRIENDS_PATH), (snap) => {
                    Memory.friends = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderNotes();
                    App.renderFriendsTab('friends'); // ุงููุทูุจ 9
                }, errHandler);

                onSnapshot(collection(db, NOTES_PATH), (snap) => {
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    Memory.notes = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                        .filter(n => (now - n.timestamp) < oneDay);
                    App.renderNotes();
                }, errHandler);

                onSnapshot(collection(db, MESSAGES_PATH), (snap) => {
                    Memory.messages = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderChats();
                    if(window.currentChatUserId) {
                        App.renderMessages();
                        App.markChatAsRead(window.currentChatUserId);
                    }
                }, errHandler);

                onSnapshot(collection(db, NOTIFS_PATH), (snap) => {
                    Memory.notifications = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                            .filter(n => n.to === currentUser.uid);
                    App.renderNotifications();
                }, errHandler);

                // ุงูุงุณุชูุงุน ููุฃููุงุฏ ูููุฏูุฑ ููุท
                if(currentUser.email === adminEmail) {
                    onSnapshot(collection(db, PREMIUM_CODES_PATH), (snap) => {
                        Memory.premiumCodes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    }, errHandler);
                }
            },

            isFriend: (uid1, uid2) => {
                return Memory.friends.some(f => 
                    (f.user1 === uid1 && f.user2 === uid2) || 
                    (f.user1 === uid2 && f.user2 === uid1)
                );
            },
            isBlocked: (uid) => {
                return currentUser.blockedUsers?.includes(uid);
            },
            timeAgo: (timestamp) => {
                if(!timestamp) return 'ุบูุฑ ูุนุฑูู';
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                if (seconds < 60) return "ุงูุขู";
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `ููุฐ ${minutes} ุฏูููุฉ`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `ููุฐ ${hours} ุณุงุนุฉ`;
                const days = Math.floor(hours / 24);
                return `ููุฐ ${days} ููู`;
            },
            isOnline: (lastActive) => {
                if(!lastActive) return false;
                // ุฅุฎูุงุก ุงูุงุชุตุงู ููู ูุนู ูุถุน ุงูุชุฎูู
                const user = Object.values(Memory.users).find(u => u.lastActive === lastActive);
                if(user && App.isStealthActive(user)) return false;
                
                return (Date.now() - lastActive) < (5 * 60 * 1000);
            },
            parseMentions: (text) => {
                const escaped = escapeHTML(text);
                return escaped.replace(/@([\w_.]+)/g, (match, username) => {
                    const exists = Object.values(Memory.users).find(u => u.username === username);
                    if(exists) {
                        return `<span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="event.stopPropagation(); UI.openProfileByUsername('${username}')">${match}${App.getPremiumBadgeHTML(exists)}</span>`;
                    }
                    return match; 
                });
            },
            notifyMentions: async (text, type, linkId) => {
                const matches = text.match(/@([\w_.]+)/g);
                if(!matches) return;
                const usernames = matches.map(m => m.substring(1));
                const usersArray = Object.values(Memory.users);
                
                for(let un of usernames) {
                    const mentionedUser = usersArray.find(u => u.username === un);
                    if(mentionedUser && mentionedUser.uid !== currentUser.uid && !App.isBlocked(mentionedUser.uid)) {
                        await App.sendNotification(mentionedUser.uid, `ูุงู ุจุฐูุฑู ูู ${type}`, linkId);
                    }
                }
            },
            incrementMentionCount: async (uid) => {
                let counts = currentUser.mentionsCount || {};
                counts[uid] = (counts[uid] || 0) + 1;
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { mentionsCount: counts });
            },

            // --- ุฑูุฏุฑ ุงูุฑุฆูุณูุฉ ---
            renderFeed: () => {
                const container = document.getElementById('feed-container');
                container.innerHTML = '';
                
                const sortedPosts = [...Memory.posts].sort((a,b) => b.timestamp - a.timestamp);
                let visibleCount = 0;

                sortedPosts.forEach(post => {
                    const author = Memory.users[post.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    if(author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid)) return;
                    
                    visibleCount++;
                    const isLiked = post.likes && post.likes.includes(currentUser.uid);
                    const likesCount = post.likes ? post.likes.length : 0;
                    const commentsCount = Memory.comments.filter(c => c.postId === post.id).length;
                    const parsedText = App.parseMentions(post.text);

                    const postEl = document.createElement('div');
                    postEl.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-3';
                    postEl.innerHTML = `
                        <div class="p-3.5 flex items-center justify-between">
                            <div class="flex items-center gap-3 cursor-pointer group btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                                <img src="${author.photo || App.getDefaultAvatar()}" class="w-11 h-11 rounded-full object-cover border border-gray-100">
                                <div>
                                    <h4 class="font-bold leading-tight group-hover:text-blue-600 transition-colors flex items-center gap-1">${author.name} ${App.getPremiumBadgeHTML(author)}</h4>
                                    <span class="text-xs text-gray-400">${App.timeAgo(post.timestamp)}</span>
                                </div>
                            </div>
                            ${post.authorId === currentUser.uid || currentUser.email === adminEmail ? `<button onclick="App.deletePost('${post.id}')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors btn-tap"><i class="ph ph-trash text-lg"></i></button>` : ''}
                        </div>
                        <div class="px-4 py-2 text-gray-800 text-[15px] leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-4 py-3 text-xs text-gray-400 flex justify-between items-center mt-2 border-b border-gray-50">
                            <div class="flex items-center gap-1"><i class="ph-fill ph-thumbs-up text-blue-500"></i> ${likesCount}</div>
                            <div>${commentsCount} ุชุนููู</div>
                        </div>
                        <div class="flex p-1">
                            <button onclick="App.toggleLike('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl btn-tap font-semibold transition-colors ${isLiked ? 'text-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'}">
                                <i class="${isLiked ? 'ph-fill' : 'ph'} ph-thumbs-up text-xl"></i> ุฃุนุฌุจูู
                            </button>
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl text-gray-500 font-semibold hover:bg-gray-50 transition-colors btn-tap">
                                <i class="ph ph-chat-centered text-xl"></i> ุชุนููู
                            </button>
                            <button onclick="App.sharePost('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl text-gray-500 font-semibold hover:bg-gray-50 transition-colors btn-tap">
                                <i class="ph ph-share-network text-xl"></i> ูุดุงุฑูุฉ
                            </button>
                        </div>
                    `;
                    container.appendChild(postEl);
                });

                if(visibleCount === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-newspaper text-4xl mb-2 opacity-50 block mx-auto"></i>ูุง ุชูุฌุฏ ููุดูุฑุงุช ุญุงููุงู</div>';
                }
            },

            createPost: async () => {
                const text = document.getElementById('post-text-input').value.trim();
                if(!text) return UI.showMessage('ูุง ูููู ูุดุฑ ููุดูุฑ ูุงุฑุบ');
                
                UI.closeModal('create-post-modal');
                document.getElementById('post-text-input').value = '';
                
                const postRef = await addDoc(collection(db, POSTS_PATH), {
                    authorId: currentUser.uid, text: text, timestamp: Date.now(), likes: []
                });
                App.notifyMentions(text, 'ููุดูุฑ', postRef.id);
                UI.showMessage('ุชู ุงููุดุฑ ุจูุฌุงุญ');
            },

            deletePost: async (postId) => {
                if(confirm('ูู ูุชุฃูุฏ ูู ุญุฐู ุงูููุดูุฑุ')) {
                    await deleteDoc(doc(db, POSTS_PATH, postId));
                    UI.showMessage('ุชู ุญุฐู ุงูููุดูุฑ');
                }
            },

            toggleLike: async (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                if(!post) return;
                
                let newLikes = post.likes ? [...post.likes] : [];
                if(newLikes.includes(currentUser.uid)) {
                    newLikes = newLikes.filter(id => id !== currentUser.uid);
                } else {
                    newLikes.push(currentUser.uid);
                    if(post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                        App.sendNotification(post.authorId, 'ุฃุนุฌุจ ุจููุดูุฑู', postId);
                    }
                }
                await updateDoc(doc(db, POSTS_PATH, postId), { likes: newLikes });
            },

            sharePost: async (postId) => {
                const shareUrl = window.location.origin + window.location.pathname + '?post=' + postId;
                if (navigator.share) {
                    try { await navigator.share({ title: 'ุชุทุจูู ุฒุงููู', url: shareUrl }); } catch (err) {}
                } else {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try { document.execCommand("copy"); UI.showMessage("ุชู ูุณุฎ ุงูุฑุงุจุท!"); } 
                    catch (err) { UI.showMessage("ุชุนุฐุฑ ุงููุณุฎ"); }
                    document.body.removeChild(tempInput);
                }
            },

            openSinglePost: (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                const container = document.getElementById('single-post-container');
                
                if(!post || App.isBlocked(post.authorId)) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-500">ุงูููุดูุฑ ุบูุฑ ูุชููุฑ ุฃู ุชู ุญุฐูู</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const author = Memory.users[post.authorId];
                if(!author || (author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid))) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-500">ูุฐุง ุงูููุดูุฑ ุฎุงุต ููุง ุชููู ุตูุงุญูุฉ ุงููุตูู ุฅููู</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const parsedText = App.parseMentions(post.text);
                const likesCount = post.likes ? post.likes.length : 0;
                
                container.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mt-4">
                        <div class="p-4 flex items-center gap-3 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            <div>
                                <h4 class="font-bold text-lg flex items-center gap-1">${author.name} ${App.getPremiumBadgeHTML(author)}</h4>
                                <span class="text-sm text-gray-400">${App.timeAgo(post.timestamp)}</span>
                            </div>
                        </div>
                        <div class="px-5 py-3 text-gray-800 text-lg leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-5 py-3 text-sm text-gray-500 border-t border-gray-50 mt-2 flex justify-between">
                            <span class="font-bold text-blue-600">${likesCount} ุฅุนุฌุงุจุงุช</span>
                        </div>
                        <div class="p-4">
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap shadow-md">ุนุฑุถ ุงูุชุนูููุงุช</button>
                        </div>
                    </div>
                `;
                UI.openModal('single-post-modal');
            },

            // --- ุฑูุฏุฑ ุงูุชุนูููุงุช ---
            renderComments: () => {
                if(!window.currentPostIdForComment) return;
                const container = document.getElementById('comments-list');
                container.innerHTML = '';
                
                const postComments = Memory.comments
                    .filter(c => c.postId === window.currentPostIdForComment)
                    .sort((a,b) => a.timestamp - b.timestamp);

                if(postComments.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-chat-centered text-4xl mb-2 opacity-50 block mx-auto"></i>ูุง ุชูุฌุฏ ุชุนูููุงุชุ ูู ุฃูู ูู ูุนูู</div>';
                    return;
                }

                postComments.forEach(c => {
                    const author = Memory.users[c.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    const parsedText = App.parseMentions(c.text);

                    const el = document.createElement('div');
                    el.className = 'flex gap-3 items-start';
                    el.innerHTML = `
                        <img src="${author.photo || App.getDefaultAvatar()}" class="w-10 h-10 rounded-full object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openProfileByUsername('${author.username}')">
                        <div class="flex-1">
                            <div class="bg-gray-100 rounded-2xl rounded-tr-sm p-3.5 inline-block min-w-[50%] max-w-full shadow-sm">
                                <h5 class="font-bold text-sm text-gray-900 cursor-pointer flex items-center gap-1" onclick="UI.openProfileByUsername('${author.username}')">${author.name} ${App.getPremiumBadgeHTML(author)}</h5>
                                <p class="text-gray-800 text-[15px] mt-1 break-words">${parsedText}</p>
                            </div>
                            <span class="text-[11px] text-gray-400 mx-2 mt-1 block">${App.timeAgo(c.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
                setTimeout(() => container.scrollTop = container.scrollHeight, 10);
            },

            addComment: async () => {
                const text = document.getElementById('comment-input').value.trim();
                const postId = window.currentPostIdForComment;
                if(!text || !postId) return;
                
                document.getElementById('comment-input').value = '';
                
                await addDoc(collection(db, COMMENTS_PATH), {
                    postId: postId, authorId: currentUser.uid, text: text, timestamp: Date.now()
                });

                const post = Memory.posts.find(p => p.id === postId);
                if(post && post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                    App.sendNotification(post.authorId, 'ุนูู ุนูู ููุดูุฑู', postId);
                }
                App.notifyMentions(text, 'ุชุนููู', postId);
            },

            // --- ุงูููุงุญุธุงุช (ุงููุทูุจ 2) ---
            renderNotes: () => {
                const container = document.getElementById('notes-container');
                const myBtnContainer = container.firstElementChild.outerHTML;
                container.innerHTML = myBtnContainer;

                const sortedNotes = [...Memory.notes].sort((a,b) => b.timestamp - a.timestamp);
                const visibleNotes = sortedNotes.filter(n => App.isFriend(currentUser.uid, n.authorId) && !App.isBlocked(n.authorId));
                
                const myActiveNote = sortedNotes.find(n => n.authorId === currentUser.uid);
                
                const myBtnEl = container.firstElementChild;
                const myAvatar = myBtnEl.querySelector('#current-user-avatar-note');
                const myPlusIcon = myBtnEl.querySelector('#my-note-plus-icon');
                const myTextCont = myBtnEl.querySelector('#my-note-text-container');
                
                if(myActiveNote) {
                    myTextCont.innerText = myActiveNote.text;
                    myTextCont.classList.replace('bg-gray-100', 'bg-gray-800');
                    myTextCont.classList.replace('text-gray-500', 'text-white');
                    myAvatar.classList.replace('border-transparent', 'border-gray-800');
                    myPlusIcon.classList.add('hidden');
                    myBtnEl.onclick = () => App.openManageNote(myActiveNote.id, myActiveNote.text);
                } else {
                    myAvatar.src = currentUser.photo || App.getDefaultAvatar();
                    myPlusIcon.classList.remove('hidden');
                }

                visibleNotes.forEach(note => {
                    const author = Memory.users[note.authorId];
                    if(!author) return;

                    const el = document.createElement('div');
                    el.className = 'inline-flex flex-col items-center cursor-pointer shrink-0 btn-tap w-20';
                    el.style.scrollSnapAlign = 'start';
                    const shortName = author.name.split(' ')[0];
                    
                    el.innerHTML = `
                        <div class="relative">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-16 h-16 rounded-full object-cover border-2 border-transparent ring-2 ring-blue-500 p-0.5 shadow-sm">
                        </div>
                        <span class="text-[11px] font-bold mt-1 text-gray-800 w-full text-center truncate">${shortName}</span>
                        <div class="bg-gray-100 text-gray-700 text-[10px] px-2 py-1.5 rounded-lg mt-1 w-full text-center truncate border border-gray-200 shadow-sm leading-tight">
                            ${escapeHTML(note.text)}
                        </div>
                    `;
                    el.onclick = () => { App.viewNoteFull(note, author); };
                    container.appendChild(el);
                });
            },
            
            viewNoteFull: (note, author) => {
                document.getElementById('nv-avatar').src = author.photo || App.getDefaultAvatar();
                document.getElementById('nv-name').innerText = author.name;
                document.getElementById('nv-premium-badge').innerHTML = App.getPremiumBadgeHTML(author);
                document.getElementById('nv-time').innerText = App.timeAgo(note.timestamp);
                document.getElementById('nv-text').innerHTML = App.parseMentions(note.text);
                
                window.noteViewAuthorId = author.uid;
                window.noteViewId = note.id;
                
                if(author.uid !== currentUser.uid) {
                    document.getElementById('note-reply-section').classList.remove('hidden');
                    document.getElementById('note-reply-input').value = '';
                } else {
                    document.getElementById('note-reply-section').classList.add('hidden');
                }

                UI.openModal('note-view-modal');
            },
            viewProfileFromNote: () => {
                if(window.noteViewAuthorId) {
                    UI.closeModal('note-view-modal');
                    UI.openModal('profile-modal', window.noteViewAuthorId);
                }
            },
            sendNoteReply: async () => {
                const text = document.getElementById('note-reply-input').value.trim();
                if(!text || !window.noteViewAuthorId) return;
                
                const note = Memory.notes.find(n => n.id === window.noteViewId);
                if(!note) return;

                const replyText = `[ุฑุฏ ุนูู ููุงุญุธุฉ: "${note.text}"]\n${text}`;
                
                await addDoc(collection(db, MESSAGES_PATH), {
                    participants: [currentUser.uid, window.noteViewAuthorId],
                    senderId: currentUser.uid,
                    text: replyText,
                    timestamp: Date.now(),
                    read: false
                });

                UI.showMessage('ุชู ุฅุฑุณุงู ุงูุฑุฏ ููุฎุงุต');
                UI.closeModal('note-view-modal');
            },
            likeNote: async () => {
                if(!window.noteViewAuthorId) return;
                App.sendNotification(window.noteViewAuthorId, 'ุชูุงุนู ุจู โค๏ธ ูุน ููุงุญุธุชู', null);
                UI.showMessage('ุชู ุงูุฅุนุฌุงุจ');
            },

            checkAndCreateNote: () => {
                const myActiveNote = Memory.notes.find(n => n.authorId === currentUser.uid);
                if(myActiveNote) App.openManageNote(myActiveNote.id, myActiveNote.text);
                else UI.openModal('create-note-modal');
            },

            createNote: async () => {
                const text = document.getElementById('note-text-input').value.trim();
                if(!text) return UI.showMessage('ุงูุชุจ ุดูุฆุงู');
                UI.closeModal('create-note-modal');
                await addDoc(collection(db, NOTES_PATH), {
                    authorId: currentUser.uid, text: text, timestamp: Date.now()
                });
                App.notifyMentions(text, 'ููุงุญุธุฉ', null);
                UI.showMessage('ุชูุช ุงูุฅุถุงูุฉ (ุตุงูุญุฉ ูู 24 ุณุงุนุฉ)');
            },

            openManageNote: (id, currentText) => {
                window.currentManageNoteId = id;
                document.getElementById('edit-note-input').value = currentText;
                UI.openModal('manage-note-modal');
            },

            updateNote: async () => {
                const newText = document.getElementById('edit-note-input').value.trim();
                if(!newText || !window.currentManageNoteId) return;
                await updateDoc(doc(db, NOTES_PATH, window.currentManageNoteId), { text: newText });
                App.notifyMentions(newText, 'ููุงุญุธุฉ', null);
                UI.closeModal('manage-note-modal');
                UI.showMessage('ุชู ุชุญุฏูุซ ุงูููุงุญุธุฉ');
            },

            deleteNote: async () => {
                if(!window.currentManageNoteId) return;
                await deleteDoc(doc(db, NOTES_PATH, window.currentManageNoteId));
                window.currentManageNoteId = null;
                UI.closeModal('manage-note-modal');
                UI.showMessage('ุชู ุญุฐู ุงูููุงุญุธุฉ');
                
                const myBtnEl = document.getElementById('notes-container').firstElementChild;
                myBtnEl.querySelector('#my-note-text-container').innerText = 'ุฅุถุงูุฉ ููุงุญุธุฉ';
                myBtnEl.querySelector('#my-note-text-container').classList.replace('text-white', 'text-gray-500');
                myBtnEl.querySelector('#my-note-text-container').classList.replace('bg-gray-800', 'bg-gray-100');
                myBtnEl.querySelector('#current-user-avatar-note').classList.replace('border-gray-800', 'border-transparent');
                myBtnEl.querySelector('#my-note-plus-icon').classList.remove('hidden');
                myBtnEl.onclick = App.checkAndCreateNote;
            },


            // --- ุงููุทูุจ 9: ุชูุณูู ุงูุฃุตุฏูุงุก ---
            switchFriendsSubTab: (tabId) => {
                ['requests', 'friends', 'suggestions'].forEach(id => {
                    document.getElementById(`subtab-${id}`).className = 'flex-1 py-3 text-center text-sm font-bold sub-tab-inactive btn-tap transition-colors';
                    document.getElementById(`subtab-content-${id}`).classList.add('hidden');
                });
                
                document.getElementById(`subtab-${tabId}`).className = 'flex-1 py-3 text-center text-sm font-bold sub-tab-active btn-tap transition-colors';
                document.getElementById(`subtab-content-${tabId}`).classList.remove('hidden');
                
                App.renderFriendsTab(tabId);
            },
            
            renderFriendsTab: (tabId) => {
                const container = document.getElementById(`subtab-content-${tabId}`);
                if(!container) return;
                container.innerHTML = '';

                if(tabId === 'requests') {
                    const myRequests = Memory.requests.filter(r => r.to === currentUser.uid);
                    if(myRequests.length > 0) document.getElementById('badge-requests').classList.remove('hidden');
                    else document.getElementById('badge-requests').classList.add('hidden');
                    
                    if(myRequests.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-6"><i class="ph ph-user-plus text-4xl mb-2 opacity-50 block mx-auto"></i>ูุง ุชูุฌุฏ ุทูุจุงุช ุฌุฏูุฏุฉ</div>';
                        return;
                    }
                    myRequests.forEach(req => {
                        const fromUser = Memory.users[req.from];
                        if(!fromUser || App.isBlocked(fromUser.uid)) return;
                        const el = document.createElement('div');
                        el.className = 'flex flex-col p-3 bg-white rounded-2xl border border-gray-100 shadow-sm gap-3';
                        el.innerHTML = `
                            <div class="flex items-center gap-3 cursor-pointer group" onclick="UI.openModal('profile-modal', '${fromUser.uid}')">
                                <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-800 group-hover:text-blue-600 truncate flex items-center gap-1">${fromUser.name} ${App.getPremiumBadgeHTML(fromUser)}</span>
                                    <span class="text-xs text-gray-500">${App.timeAgo(req.timestamp)}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 w-full">
                                <button onclick="App.acceptRequest('${req.id}', '${req.from}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl btn-tap shadow-sm transition-colors text-sm">ูุจูู</button>
                                <button onclick="App.declineRequest('${req.id}')" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-xl btn-tap transition-colors text-sm">ุฑูุถ</button>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else if (tabId === 'friends') {
                    const myFriendsRelations = Memory.friends.filter(f => f.user1 === currentUser.uid || f.user2 === currentUser.uid);
                    const myFriends = myFriendsRelations.map(f => {
                        const friendId = f.user1 === currentUser.uid ? f.user2 : f.user1;
                        return Memory.users[friendId];
                    }).filter(u => u !== undefined && !App.isBlocked(u.uid));

                    if(myFriends.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-6"><i class="ph ph-users text-4xl mb-2 opacity-50 block mx-auto"></i>ููุณ ูุฏูู ุฃุตุฏูุงุก ุญุงููุงู</div>';
                        return;
                    }
                    myFriends.forEach(u => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 bg-white hover:bg-gray-50 rounded-2xl cursor-pointer btn-tap border border-gray-50 shadow-sm transition-colors';
                        el.onclick = () => UI.openModal('profile-modal', u.uid);
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 flex items-center gap-1">${u.name} ${App.getPremiumBadgeHTML(u)}</h4>
                                <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else if (tabId === 'suggestions') {
                    const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                    const requestedIds = Memory.requests.filter(r => r.from === currentUser.uid).map(r => r.to);
                    
                    let suggestions = Object.values(Memory.users).filter(u => 
                        u.uid !== currentUser.uid && 
                        !friendsIds.includes(u.uid) && 
                        !requestedIds.includes(u.uid) &&
                        !App.isBlocked(u.uid) &&
                        u.allowRequests !== false
                    );
                    
                    // ุฅุนุทุงุก ุงูุฃูุถููุฉ ูููุดุชุฑููู ุงููููุฒูู ูู ุงูุงูุชุฑุงุญุงุช
                    suggestions.sort((a,b) => {
                        if(App.isPremium(a) && !App.isPremium(b)) return -1;
                        if(!App.isPremium(a) && App.isPremium(b)) return 1;
                        return 0.5 - Math.random(); 
                    });
                    
                    suggestions = suggestions.slice(0, 10); // ุนุฑุถ 10 ููุท

                    if(suggestions.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-6">ูุง ุชูุฌุฏ ุงูุชุฑุงุญุงุช ุญุงููุงู</div>';
                        return;
                    }
                    suggestions.forEach(u => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 bg-white rounded-2xl border border-gray-50 shadow-sm';
                        el.innerHTML = `
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                                <h4 class="font-bold text-gray-800 flex items-center gap-1">${u.name} ${App.getPremiumBadgeHTML(u)}</h4>
                                <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                            </div>
                            <button onclick="App.sendFriendRequest('${u.uid}')" class="bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full font-bold text-sm btn-tap hover:bg-blue-100">ุฅุถุงูุฉ</button>
                        `;
                        container.appendChild(el);
                    });
                }
            },


            // --- ูุธุงู ุงูุตุฏุงูุฉ ูุงููุญุธูุฑูู ---
            sendFriendRequest: async (toUid) => {
                await addDoc(collection(db, REQUESTS_PATH), {
                    from: currentUser.uid, to: toUid, timestamp: Date.now()
                });
                App.sendNotification(toUid, 'ุฃุฑุณู ูู ุทูุจ ุตุฏุงูุฉ', null);
                UI.showMessage('ุชู ุฅุฑุณุงู ุงูุทูุจ');
                App.renderFriendsTab('suggestions');
                if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(toUid);
            },
            cancelRequest: async (reqId, uid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('ุชู ุฅูุบุงุก ุงูุทูุจ');
                if(uid && !document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
            },
            acceptRequest: async (reqId, fromUid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                await addDoc(collection(db, FRIENDS_PATH), {
                    user1: currentUser.uid, user2: fromUid, timestamp: Date.now()
                });
                App.sendNotification(fromUid, 'ูุงูู ุนูู ุทูุจ ุงูุตุฏุงูุฉ', null);
                UI.showMessage('ุชู ูุจูู ุงูุทูุจ');
                if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(fromUid);
            },
            declineRequest: async (reqId) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('ุชู ุฑูุถ ุงูุทูุจ');
            },
            unfriend: async (uid) => {
                if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุฒุงูุฉ ุงูุตุฏุงูุฉุ')) {
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) {
                        await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));
                        UI.showMessage('ุชูุช ุฅุฒุงูุฉ ุงูุตุฏุงูุฉ');
                        UI.closeModal('action-modal'); 
                        if(!document.getElementById('profile-modal').classList.contains('hidden')) App.renderUserProfile(uid);
                    }
                }
            },

            blockUser: async (uid) => {
                if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุธุฑ ูุฐุง ุงููุณุชุฎุฏูุ')) {
                    const updatedBlocks = [...(currentUser.blockedUsers || []), uid];
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                    currentUser.blockedUsers = updatedBlocks;
                    
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));

                    UI.closeModal('action-modal');
                    UI.closeModal('chat-modal');
                    UI.showMessage('ุชู ุงูุญุธุฑ ุจูุฌุงุญ');
                    App.startCore(); 
                }
            },
            unblockUser: async (uid) => {
                const updatedBlocks = (currentUser.blockedUsers || []).filter(id => id !== uid);
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                currentUser.blockedUsers = updatedBlocks;
                UI.showMessage('ุชู ุฅูุบุงุก ุงูุญุธุฑ');
                if(!document.getElementById('blocked-users-modal').classList.contains('hidden')){
                    App.renderBlockedUsers();
                }
                if(!document.getElementById('profile-modal').classList.contains('hidden')){
                    App.renderUserProfile(uid);
                }
            },
            renderBlockedUsers: () => {
                const container = document.getElementById('blocked-list-container');
                container.innerHTML = '';
                const blockedList = currentUser.blockedUsers || [];
                if(blockedList.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-20 mt-10"><i class="ph ph-prohibit text-4xl mb-2 opacity-50 block mx-auto"></i>ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุญุธูุฑูู</div>';
                    return;
                }
                blockedList.forEach(uid => {
                    const u = Memory.users[uid];
                    if(!u) return;
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-2xl border border-gray-100 mb-2';
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                        <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <h4 class="font-bold text-gray-800">${u.name}</h4>
                            <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                        </div>
                        <button class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full font-bold text-sm btn-tap" onclick="App.unblockUser('${u.uid}')">ุฅูุบุงุก ุงูุญุธุฑ</button>
                    `;
                    container.appendChild(el);
                });
            },


            // --- ุงูุจุญุซ ---
            searchUsers: () => {
                const query = document.getElementById('search-input').value.toLowerCase().trim();
                const container = document.getElementById('search-results');
                container.innerHTML = '';

                if(!query) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50 block mx-auto"></i>ุงูุชุจ ููุจุญุซ ุนู ูุณุชุฎุฏููู</div>';
                    return;
                }

                const results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    !App.isBlocked(u.uid) &&
                    (u.name.toLowerCase().includes(query) || u.username.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>';
                    return;
                }

                results.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-2xl cursor-pointer btn-tap border border-gray-100 transition-colors';
                    el.onclick = () => {
                        UI.closeModal('search-modal');
                        UI.openModal('profile-modal', u.uid);
                    };
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 flex items-center gap-1">${u.name} ${App.getPremiumBadgeHTML(u)}</h4>
                            <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            // --- ุงููุทูุจ 3 ู 4 ู 5 ู 6 ู 7 ู 10: ูุธุงู ุงููุญุงุฏุซุฉ ุงููุชูุฏู ---
            
            // ืืุทูุจ 7: ุญุณุงุจ ูุชุญุฏูุซ Xylo Pet (ุงูุณุชุฑูู)
            calculatePetStatus: (otherUid) => {
                const msgs = Memory.messages
                    .filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid))
                    .sort((a,b) => b.timestamp - a.timestamp); // ุงูุฃุญุฏุซ ุฃููุงู

                if(msgs.length === 0) return { emoji: '๐ฅ', days: 0 };

                let currentDayStr = new Date().toDateString();
                let daysCount = 0;
                let lastValidMsgTime = Date.now();
                
                // ููุชุจุณูุท ูู ูุฐุง ุงูุณูุงู: ูุญุณุจ ุงูุฃูุงู ุจูุงุกู ุนูู ุงููุฑููุงุช ุจูู ุงูุฑุณุงุฆู ุจุญุฏ ุฃูุตู 48 ุณุงุนุฉ
                // ูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ุชุฌุฏุฏ ุงูุณุชุฑูู ุฅุฐุง ูุงูุช ุฎูุงู 48 ุณุงุนุฉ ูู ุงูุณุงุจูุฉ
                const OneDayMs = 24 * 60 * 60 * 1000;
                let activeTime = msgs[0].timestamp;
                
                // ุฅุฐุง ูุงู ุขุฎุฑ ุฑุณุงูุฉ ูุฏููุฉ ุฌุฏุงู (> 48 ุณุงุนุฉ) ูุงูุณุชุฑูู ููุณูุฑ
                if(Date.now() - activeTime > 2 * OneDayMs) return { emoji: '๐ฅ', days: 0 };

                let streakStart = activeTime;
                for(let i = 1; i < msgs.length; i++) {
                    let diff = activeTime - msgs[i].timestamp;
                    if(diff <= 2 * OneDayMs) {
                        streakStart = msgs[i].timestamp;
                        activeTime = msgs[i].timestamp;
                    } else {
                        break; // ุงููุณุฑ ุงูุณุชุฑูู ููุง
                    }
                }

                daysCount = Math.floor((Date.now() - streakStart) / OneDayMs);
                
                let emoji = '๐ฅ';
                if(daysCount >= 7 && daysCount < 14) emoji = '๐ฅ';
                else if(daysCount >= 14 && daysCount < 21) emoji = '๐ฅ๐ฉ';
                else if(daysCount >= 21) emoji = '๐ฆ๐';
                else if(daysCount > 0) emoji = '๐ฃ';

                return { emoji, days: daysCount };
            },

            showChatOptions: (otherUid) => {
                const isMyFriend = App.isFriend(currentUser.uid, otherUid);
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <div class="text-center font-bold text-lg mb-4 text-gray-800 border-b pb-2">ุฎูุงุฑุงุช ุงููุญุงุฏุซุฉ</div>
                    ${isMyFriend ? `
                    <button onclick="App.unfriend('${otherUid}')" class="w-full bg-gray-50 text-gray-700 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-gray-100 mb-2">
                        <i class="ph-fill ph-user-minus text-xl"></i> ุฅุฒุงูุฉ ูู ุงูุฃุตุฏูุงุก
                    </button>
                    ` : ''}
                    <button onclick="App.blockUser('${otherUid}')" class="w-full bg-orange-50 text-orange-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-orange-100 mb-2">
                        <i class="ph-fill ph-prohibit text-xl"></i> ุญุธุฑ ุงููุณุชุฎุฏู
                    </button>
                    <button onclick="App.deleteChatHistory('${otherUid}')" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-red-100">
                        <i class="ph-fill ph-trash text-xl"></i> ุญุฐู ุงููุญุงุฏุซุฉ
                    </button>
                `;
                UI.openModal('action-modal');
            },
            deleteChatHistory: async (otherUid) => {
                if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุญุงุฏุซุฉ ุจุงููุงููุ')) {
                    const msgsToDelete = Memory.messages.filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid));
                    for(let msg of msgsToDelete) { await deleteDoc(doc(db, MESSAGES_PATH, msg.id)); }
                    UI.closeModal('action-modal');
                    UI.showMessage('ุชู ุญุฐู ุงููุญุงุฏุซุฉ');
                }
            },

            renderChats: () => {
                const container = document.getElementById('chats-container');
                container.innerHTML = '';
                
                const chatUsers = {};
                let totalUnreadCount = 0; // ุฅุฌูุงูู ุงูุบูุฑ ููุฑูุก ููุจุงุฏุฉ ุงูุญูุฑุงุก ุงูุณูููุฉ

                Memory.messages.forEach(msg => {
                    if(msg.participants.includes(currentUser.uid)) {
                        const otherUid = msg.participants.find(id => id !== currentUser.uid);
                        if(App.isBlocked(otherUid)) return;
                        
                        // ุชุฌุงูู ุงูุฑุณุงุฆู ุงููุญุฐููุฉ ูู ุนูุฏู
                        if(msg.deletedFor && msg.deletedFor.includes(currentUser.uid)) return;

                        if(!chatUsers[otherUid]) chatUsers[otherUid] = { lastMsg: msg, unreadCount: 0 };
                        
                        if(chatUsers[otherUid].lastMsg.timestamp < msg.timestamp) {
                            chatUsers[otherUid].lastMsg = msg;
                        }
                        
                        // ุงููุทูุจ 3: ุญุณุงุจ ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ุจุฏูุฉ
                        if(msg.senderId === otherUid && !msg.read) {
                            chatUsers[otherUid].unreadCount++;
                            totalUnreadCount++;
                        }
                    }
                });

                const sortedChats = Object.entries(chatUsers).sort((a,b) => b[1].lastMsg.timestamp - a[1].lastMsg.timestamp);

                if(sortedChats.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-chat-circle-dots text-4xl mb-2 opacity-50 block mx-auto"></i>ูุง ุชูุฌุฏ ุฑุณุงุฆู ุจุนุฏ</div>';
                    document.getElementById('badge-messages').classList.add('hidden');
                    return;
                }

                sortedChats.forEach(([otherUid, chatData]) => {
                    const lastMsg = chatData.lastMsg;
                    const u = Memory.users[otherUid];
                    if(!u) return;

                    const isUnread = chatData.unreadCount > 0;
                    const isOnline = App.isOnline(u.lastActive);

                    const el = document.createElement('div');
                    el.className = `flex items-center gap-3 p-3 border-b border-gray-50 cursor-pointer btn-tap transition-colors ${isUnread ? 'bg-blue-50/40' : 'hover:bg-gray-50'}`;
                    
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showChatOptions(u.uid), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);
                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = () => {
                        if(pressTimer) clearTimeout(pressTimer);
                        UI.openModal('chat-modal', u.uid);
                    };

                    // ุงููุทูุจ 5: ุนูุงูุฉ ุงูุตุญ ูููุฑุงุกุฉ
                    let tickHtml = '';
                    if(lastMsg.senderId === currentUser.uid) {
                        tickHtml = lastMsg.read ? '<i class="ph-fill ph-checks text-blue-500 text-[13px] ml-1"></i>' : '<i class="ph ph-check text-gray-400 text-[13px] ml-1"></i>';
                    }

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-14 h-14 rounded-full object-cover border border-gray-100">
                            ${isOnline ? '<span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                        </div>
                        <div class="flex-1 overflow-hidden pr-1 relative">
                            <div class="flex justify-between items-center mb-0.5">
                                <h4 class="font-bold truncate text-[15px] flex items-center gap-1 ${isUnread ? 'text-black' : 'text-gray-800'}">${u.name} ${App.getPremiumBadgeHTML(u)}</h4>
                                <span class="text-xs ${isUnread ? 'font-bold text-blue-600' : 'text-gray-400'} whitespace-nowrap">${App.timeAgo(lastMsg.timestamp)}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm truncate flex-1 flex items-center gap-0.5 ${isUnread ? 'text-unread' : (lastMsg.senderId !== currentUser.uid ? 'font-medium text-gray-800' : 'text-gray-500')}">
                                    ${tickHtml} ${lastMsg.text.replace(/\n/g, ' ')}
                                </p>
                                ${isUnread ? `<span class="bg-blue-600 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center shrink-0 shadow-sm mr-2">${chatData.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                });

                if(totalUnreadCount > 0) {
                    const badge = document.getElementById('badge-messages');
                    badge.classList.remove('hidden');
                    badge.innerText = totalUnreadCount > 9 ? '+9' : totalUnreadCount;
                } else {
                    document.getElementById('badge-messages').classList.add('hidden');
                }
            },

            markChatAsRead: async (otherUid) => {
                // ุงููุทูุจ 10: ุงูุชุฎูู (ูุง ุชุฑุณู ุฅุดุนุงุฑ ูุฑุงุกุฉ ุฅุฐุง ููุนู ุงูุชุฎูู)
                if(App.isStealthActive()) return; 

                const unreadMsgs = Memory.messages.filter(m => 
                    m.participants.includes(currentUser.uid) && 
                    m.participants.includes(otherUid) &&
                    m.senderId === otherUid && 
                    !m.read
                );
                for(let msg of unreadMsgs) {
                    await updateDoc(doc(db, MESSAGES_PATH, msg.id), { read: true });
                }
            },

            renderChatInfo: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;
                document.getElementById('chat-user-img').src = u.photo || App.getDefaultAvatar();
                document.getElementById('chat-user-name').innerText = u.name;
                document.getElementById('chat-header-premium-badge').innerHTML = App.getPremiumBadgeHTML(u);
                
                const isOnline = App.isOnline(u.lastActive);
                document.getElementById('chat-online-dot').style.display = isOnline ? 'block' : 'none';
                document.getElementById('chat-user-status').innerText = isOnline ? 'ูุดุท ุงูุขู' : `ุขุฎุฑ ุธููุฑ ${App.timeAgo(u.lastActive)}`;

                // ุงููุทูุจ 7: ุนุฑุถ ุงูุณุชุฑูู
                const petData = App.calculatePetStatus(uid);
                document.getElementById('pet-emoji').innerText = petData.emoji;
                document.getElementById('pet-streak').innerText = `ููู ${petData.days}`;

                // ุงููุทูุจ 10: ุชุทุจูู ุฎูููุฉ ูููุฒุฉ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู (ุฃูุง) ูููุฒ
                if(App.isPremium()) {
                    document.getElementById('chat-background').classList.add('premium-chat-bg');
                } else {
                    document.getElementById('chat-background').classList.remove('premium-chat-bg');
                }
            },

            // ุงููุทูุจ 4: ุฎูุงุฑุงุช ุงูุฑุณุงูุฉ ุงููุฑุฏูุฉ
            showMessageOptions: (msgId, isMe, text) => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <div class="text-center font-bold text-lg mb-4 text-gray-800 border-b pb-2">ุฎูุงุฑุงุช ุงูุฑุณุงูุฉ</div>
                    <button onclick="App.copyText('${escapeHTML(text).replace(/'/g, "\\'")}')" class="w-full bg-gray-50 text-gray-700 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-gray-100 mb-2">
                        <i class="ph-fill ph-copy text-xl"></i> ูุณุฎ ุงููุต
                    </button>
                    <button onclick="App.pinMessage('${msgId}')" class="w-full bg-blue-50 text-blue-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-blue-100 mb-2">
                        <i class="ph-fill ph-push-pin text-xl"></i> ุชุซุจูุช ุงูุฑุณุงูุฉ
                    </button>
                    ${isMe ? `
                    <button onclick="App.deleteMessage('${msgId}', 'all')" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-red-100 mb-2">
                        <i class="ph-fill ph-trash text-xl"></i> ุญุฐู ููุฌููุน
                    </button>
                    ` : ''}
                    <button onclick="App.deleteMessage('${msgId}', 'me')" class="w-full bg-orange-50 text-orange-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-orange-100">
                        <i class="ph-fill ph-trash-simple text-xl"></i> ุญุฐู ูู ุนูุฏู
                    </button>
                `;
                UI.openModal('action-modal');
            },
            copyText: (text) => {
                const tempInput = document.createElement("textarea");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try { document.execCommand("copy"); UI.showMessage("ุชู ุงููุณุฎ!"); } catch(e){}
                document.body.removeChild(tempInput);
                UI.closeModal('action-modal');
            },
            pinMessage: async (msgId) => {
                await updateDoc(doc(db, MESSAGES_PATH, msgId), { pinned: true });
                UI.showMessage("ุชู ุชุซุจูุช ุงูุฑุณุงูุฉ");
                UI.closeModal('action-modal');
            },
            deleteMessage: async (msgId, type) => {
                if(type === 'all') {
                    await deleteDoc(doc(db, MESSAGES_PATH, msgId));
                } else if (type === 'me') {
                    await updateDoc(doc(db, MESSAGES_PATH, msgId), { deletedFor: arrayUnion(currentUser.uid) });
                }
                UI.closeModal('action-modal');
            },

            // ุงููุทูุจ 6: ูุถุน ุงูุฑุฏ
            setReplyMode: (msgId, text, senderName) => {
                window.replyingToMessage = msgId;
                document.getElementById('reply-to-name').innerText = `ุงูุฑุฏ ุนูู ${senderName}`;
                document.getElementById('reply-to-text').innerText = text;
                document.getElementById('replying-to-container').classList.remove('hidden');
                document.getElementById('chat-input').focus();
            },
            cancelReply: () => {
                window.replyingToMessage = null;
                document.getElementById('replying-to-container').classList.add('hidden');
            },

            renderMessages: () => {
                const otherUid = window.currentChatUserId;
                if(!otherUid) return;

                const container = document.getElementById('chat-messages-container');
                container.innerHTML = '';

                let msgs = Memory.messages
                    .filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid))
                    .sort((a,b) => a.timestamp - b.timestamp);
                
                // ุชุตููุฉ ุงููุญุฐูู ูู ุนูุฏู
                msgs = msgs.filter(m => !(m.deletedFor && m.deletedFor.includes(currentUser.uid)));

                // ุฅุธูุงุฑ ุงููุซุจุช
                const pinnedMsg = msgs.find(m => m.pinned);
                if(pinnedMsg) {
                    const pinEl = document.createElement('div');
                    pinEl.className = 'sticky top-0 bg-white/90 backdrop-blur-md border-b border-gray-200 p-2 mb-4 rounded-xl shadow-sm z-20 flex items-center justify-between cursor-pointer';
                    pinEl.innerHTML = `
                        <div class="flex-1 overflow-hidden pr-2 border-r-4 border-blue-500">
                            <span class="text-xs font-bold text-blue-600 block"><i class="ph-fill ph-push-pin"></i> ุฑุณุงูุฉ ูุซุจุชุฉ</span>
                            <span class="text-sm text-gray-700 truncate block">${escapeHTML(pinnedMsg.text)}</span>
                        </div>
                    `;
                    pinEl.onclick = () => { /* ูููู ุงูุชูุฑูุฑ ููุฑุณุงูุฉ */ };
                    container.appendChild(pinEl);
                }

                if(msgs.length === 0) {
                    container.innerHTML += '<div class="text-center text-gray-400 py-10 mt-auto">ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ๐</div>';
                    return;
                }

                msgs.forEach(m => {
                    const isMe = m.senderId === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `msg-bubble max-w-[80%] rounded-2xl p-3 shadow-sm relative ${isMe ? 'bg-blue-600 text-white self-end rounded-br-sm' : 'bg-white border border-gray-100 text-gray-800 self-start rounded-bl-sm'}`;
                    
                    // ุงููุทูุจ 4: ุฎูุงุฑุงุช ุงูุฑุณุงูุฉ (ุนูุฏ ุงูุถุบุท)
                    el.onclick = () => App.showMessageOptions(m.id, isMe, m.text);

                    // ุงููุทูุจ 6: ุงูุณุญุจ ููุฑุฏ (Swipe to Reply)
                    let startX = 0; let currentX = 0;
                    el.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, {passive: true});
                    el.addEventListener('touchmove', (e) => {
                        currentX = e.touches[0].clientX;
                        let diff = currentX - startX;
                        // ุชุญุฏูุฏ ุงุชุฌุงู ุงูุณุญุจ ููุฑุฏ
                        if((isMe && diff < 0) || (!isMe && diff > 0)) {
                            let translate = Math.abs(diff) > 60 ? 60 * Math.sign(diff) : diff;
                            el.style.transform = `translateX(${translate}px)`;
                        }
                    }, {passive: true});
                    el.addEventListener('touchend', (e) => {
                        el.style.transform = `translateX(0)`;
                        let diff = currentX - startX;
                        if (Math.abs(diff) > 50 && ((isMe && diff < 0) || (!isMe && diff > 0))) {
                            const senderName = isMe ? 'ููุณู' : Memory.users[m.senderId].name;
                            App.setReplyMode(m.id, m.text, senderName);
                        }
                        startX = 0; currentX = 0;
                    });

                    // ุงููุทูุจ 5: ุนูุงูุงุช ุงููุฑุงุกุฉ
                    const tickHtml = isMe ? (m.read ? '<i class="ph-fill ph-checks text-blue-300"></i>' : '<i class="ph ph-check text-blue-200"></i>') : '';
                    
                    // ุชุถููู ุงูุฑุฏ ุฅู ูุฌุฏ
                    let replyHtml = '';
                    if(m.replyToId) {
                        const repliedMsg = Memory.messages.find(msg => msg.id === m.replyToId);
                        if(repliedMsg) {
                            replyHtml = `
                            <div class="bg-black/10 rounded-lg p-2 mb-2 border-r-2 ${isMe ? 'border-white' : 'border-blue-500'}">
                                <span class="text-xs font-bold block opacity-80">${repliedMsg.senderId === currentUser.uid ? 'ุฃูุช' : Memory.users[repliedMsg.senderId].name}</span>
                                <span class="text-xs truncate block opacity-90">${escapeHTML(repliedMsg.text)}</span>
                            </div>`;
                        }
                    }

                    el.innerHTML = `
                        ${replyHtml}
                        <p class="text-[15px] break-words leading-relaxed whitespace-pre-wrap">${escapeHTML(m.text)}</p>
                        <span class="text-[10px] mt-1.5 flex justify-end items-center gap-1 font-medium ${isMe ? 'text-blue-100' : 'text-gray-400'}">
                            ${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            ${tickHtml}
                        </span>
                    `;
                    container.appendChild(el);
                });

                container.scrollTop = container.scrollHeight;
            },

            sendMessage: async () => {
                const otherUid = window.currentChatUserId;
                const text = document.getElementById('chat-input').value.trim();
                if(!text || !otherUid) return;

                const inputEl = document.getElementById('chat-input');
                inputEl.value = '';
                inputEl.style.height = ''; 
                
                const payload = {
                    participants: [currentUser.uid, otherUid],
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    read: false // 1 tick by default until other reads
                };

                if(window.replyingToMessage) {
                    payload.replyToId = window.replyingToMessage;
                    App.cancelReply();
                }
                
                await addDoc(collection(db, MESSAGES_PATH), payload);
                App.renderMessages();
            },

            // --- ุงูุฅุดุนุงุฑุงุช ---
            sendNotification: async (toUid, text, linkId) => {
                if(toUid === currentUser.uid) return;
                await addDoc(collection(db, NOTIFS_PATH), {
                    to: toUid, from: currentUser.uid, text: text, linkId: linkId, timestamp: Date.now(), read: false
                });
            },
            deleteNotification: async (notifId) => {
                await deleteDoc(doc(db, NOTIFS_PATH, notifId));
                UI.closeModal('action-modal');
                UI.showMessage('ุชู ุญุฐู ุงูุฅุดุนุงุฑ');
            },
            markNotificationRead: async (notifId) => {
                await updateDoc(doc(db, NOTIFS_PATH, notifId), { read: true });
            },
            showNotifOptions: (notifId) => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <div class="text-center font-bold text-lg mb-4 text-gray-800 border-b pb-2">ุฎูุงุฑุงุช ุงูุฅุดุนุงุฑ</div>
                    <button onclick="App.deleteNotification('${notifId}')" class="w-full bg-red-50 text-red-600 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-red-100">
                        <i class="ph-fill ph-trash text-xl"></i> ุญุฐู ุงูุฅุดุนุงุฑ
                    </button>
                `;
                UI.openModal('action-modal');
            },
            renderNotifications: () => {
                const container = document.getElementById('notifications-container');
                container.innerHTML = '';
                
                const notifs = [...Memory.notifications].sort((a,b) => b.timestamp - a.timestamp);
                const unreadExists = notifs.some(n => !n.read && !App.isBlocked(n.from));
                
                if(notifs.length > 0 && unreadExists) document.getElementById('badge-notifications').classList.remove('hidden');
                else document.getElementById('badge-notifications').classList.add('hidden');
                
                if(notifs.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-bell-ringing text-4xl mb-2 opacity-50 block mx-auto"></i>ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</div>';
                    return;
                }

                notifs.forEach(n => {
                    const fromUser = Memory.users[n.from];
                    if(!fromUser || App.isBlocked(n.from)) return; 

                    const el = document.createElement('div');
                    const isUnread = !n.read;
                    el.className = `flex items-center gap-3 p-3.5 border-b border-gray-50 cursor-pointer transition-colors btn-tap ${isUnread ? 'bg-blue-50/30' : 'hover:bg-gray-50'}`;
                    
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showNotifOptions(n.id), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);
                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = () => {
                        if(pressTimer) clearTimeout(pressTimer);
                        if(isUnread) App.markNotificationRead(n.id);
                        if(n.linkId) UI.openModal('comments-modal', n.linkId);
                        else UI.openModal('profile-modal', n.from);
                    };

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            ${isUnread ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-600 rounded-full border-2 border-white"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <p class="text-[15px] leading-tight ${isUnread ? 'text-unread' : 'text-gray-800'}"><span class="font-bold flex items-center gap-1">${fromUser.name} ${App.getPremiumBadgeHTML(fromUser)}</span> ${n.text}</p>
                            <span class="text-xs font-semibold ${isUnread ? 'text-blue-600' : 'text-gray-400'} mt-1 block">${App.timeAgo(n.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            // --- ุงูุฅุนุฏุงุฏุงุช ูุชุนุฏูู ุงูููู ---
            handleEditImage: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 300; canvas.height = 300;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 300, 300);
                        const b64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('edit-profile-img').src = b64;
                        window.tempEditPhoto = b64;
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },

            saveProfile: async () => {
                const name = document.getElementById('edit-name').value.trim();
                const usernameInput = document.getElementById('edit-username');
                const username = usernameInput.value.trim();
                const bio = document.getElementById('edit-bio').value.trim();
                
                if(!name || (!username && !usernameInput.disabled)) return UI.showMessage('ุงูุงุณู ูุงููุนุฑู ูุทููุจุงู');
                const updates = { name, bio };

                if(!usernameInput.disabled && username !== currentUser.username) {
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) return UI.showMessage('ุนุฐุฑุงูุ ููููู ุชุบููุฑ ุงููุนุฑู ูุฑุฉ ูุงุญุฏุฉ ููุท ูู 10 ุฃูุงู');

                    const isTaken = Object.values(Memory.users).some(u => u.username === username && u.uid !== currentUser.uid);
                    if(isTaken) return UI.showMessage('ุงููุนุฑู ูุณุชุฎุฏู ูู ูุจู ุดุฎุต ุขุฎุฑุ ูุฑุฌู ุงุฎุชูุงุฑ ูุนุฑู ูุฎุชูู');

                    updates.username = username;
                    updates.lastUsernameChange = Date.now();
                }

                if(window.tempEditPhoto) updates.photo = window.tempEditPhoto;

                await updateDoc(doc(db, USERS_PATH, currentUser.uid), updates);
                Object.assign(currentUser, updates);
                window.tempEditPhoto = null;
                App.updateUIWithUserData();
                UI.closeModal('edit-profile-modal');
                UI.showMessage('ุชู ุญูุธ ุงูุชุบููุฑุงุช');
            },

            updatePrivacy: async (key, value) => {
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { [key]: value });
                currentUser[key] = value;
                UI.showMessage('ุชู ุชุญุฏูุซ ุงูุฎุตูุตูุฉ');
            },
            
            toggleStealthMode: async (isActive) => {
                if(!App.isPremium()) return UI.showMessage('ูุฐู ุงูููุฒุฉ ููุญุณุงุจุงุช ุงููููุฒุฉ ููุท');
                await App.updatePrivacy('stealthMode', isActive);
            },

            // --- ุงููุทูุจ 10: ูุธุงู ุงูุญุณุงุจ ุงููููุฒ (Premium) ---
            renderPremiumModal: () => {
                if(App.isPremium()) {
                    document.getElementById('premium-active-status').classList.remove('hidden');
                    if(currentUser.email === adminEmail) {
                        document.getElementById('premium-expiry-text').innerText = 'ุตูุงุญูุฉ ุฃุจุฏูุฉ (ุงููุงูู)';
                    } else {
                        document.getElementById('premium-expiry-text').innerText = `ููุชูู ูู: ${new Date(currentUser.premiumUntil).toLocaleDateString()}`;
                    }
                } else {
                    document.getElementById('premium-active-status').classList.add('hidden');
                }
            },
            showPremiumFeatures: () => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <div class="text-center font-black text-xl mb-4 text-yellow-600 border-b pb-3 border-yellow-100"><i class="ph-fill ph-crown"></i> ูููุฒุงุช ุฒุงููู ุงููููุฒ</div>
                    <ul class="space-y-4 text-right px-2">
                        <li class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0"><i class="ph-fill ph-seal-check"></i></div><span class="font-bold text-gray-700">ุนูุงูุฉ ุชูุซูู ุฒุฑูุงุก ุนูู ุงูุญุณุงุจ</span></li>
                        <li class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center shrink-0"><i class="ph-fill ph-eye-slash"></i></div><span class="font-bold text-gray-700">ูุฑุงุกุฉ ุงูุฑุณุงุฆู ุจุฏูู ุนูู ุงูุทุฑู ุงูุขุฎุฑ</span></li>
                        <li class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shrink-0"><i class="ph-fill ph-clock-counter-clockwise"></i></div><span class="font-bold text-gray-700">ุฅุฎูุงุก ุขุฎุฑ ุธููุฑ ูู ุนู ุงูุฌููุน</span></li>
                        <li class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center shrink-0"><i class="ph-fill ph-star"></i></div><span class="font-bold text-gray-700">ุฃูุถููุฉ ูู ุงูุงูุชุฑุงุญุงุช ูุงูุธููุฑ</span></li>
                        <li class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center shrink-0"><i class="ph-fill ph-image"></i></div><span class="font-bold text-gray-700">ุฎูููุฉ ูุญุงุฏุซุงุช ุฎุงุตุฉ ูุฌุฐุงุจุฉ</span></li>
                    </ul>
                `;
                UI.openModal('action-modal');
            },
            verifyPremiumCode: async () => {
                const code = document.getElementById('premium-code-input').value.trim();
                if(!code) return UI.showMessage('ุฃุฏุฎู ููุฏ ุงูุชูุนูู');
                UI.showMessage('ุฌุงุฑู ุงูุชุญูู...');
                
                // ุงูุจุญุซ ุนู ุงูููุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุญุงูุงุฉ ุฌูุจ ูู ุงูุฃููุงุฏ ููุชุญูู ูููุง)
                const docRef = doc(db, PREMIUM_CODES_PATH, code);
                try {
                    const snap = await getDoc(docRef);
                    if(snap.exists()) {
                        const data = snap.data();
                        const extraMs = data.months * 30 * 24 * 60 * 60 * 1000;
                        const currentUntil = (currentUser.premiumUntil && currentUser.premiumUntil > Date.now()) ? currentUser.premiumUntil : Date.now();
                        const newUntil = currentUntil + extraMs;

                        await updateDoc(doc(db, USERS_PATH, currentUser.uid), {
                            isPremium: true,
                            premiumUntil: newUntil
                        });
                        
                        // ุญุฐู ุงูููุฏ ุจุนุฏ ุงูุงุณุชุฎุฏุงู
                        await deleteDoc(docRef);
                        
                        document.getElementById('premium-code-input').value = '';
                        UI.showMessage('ุชู ุชูุนูู ุงูุญุณุงุจ ุงููููุฒ ุจูุฌุงุญ! ๐');
                        App.renderPremiumModal();
                        App.updateUIWithUserData();
                    } else {
                        UI.showMessage('ุงูููุฏ ุบูุฑ ุตุญูุญ ุฃู ูุณุชุฎุฏู ูุณุจูุงู');
                    }
                } catch(e) {
                    UI.showMessage('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู');
                }
            },

            // --- ููุญุฉ ุงููุงูู ---
            generateCode: async (months) => {
                if(currentUser.email !== adminEmail) return;
                const code = 'XYLO-' + Math.random().toString(36).substring(2, 10).toUpperCase();
                await setDoc(doc(db, PREMIUM_CODES_PATH, code), {
                    code: code,
                    months: months,
                    createdAt: Date.now()
                });
                
                document.getElementById('new-code-text').innerText = code;
                document.getElementById('generated-code-result').classList.remove('hidden');
                UI.showMessage(`ุชู ุฅูุดุงุก ููุฏ ${months} ุฃุดูุฑ`);
            },
            copyGeneratedCode: () => {
                const text = document.getElementById('new-code-text').innerText;
                App.copyText(text);
            },
            revokeCode: async () => {
                if(currentUser.email !== adminEmail) return;
                const code = document.getElementById('admin-revoke-code').value.trim();
                if(!code) return UI.showMessage('ุฃุฏุฎู ุงูููุฏ');
                
                await deleteDoc(doc(db, PREMIUM_CODES_PATH, code));
                document.getElementById('admin-revoke-code').value = '';
                UI.showMessage('ุชู ุญุฐู ุงูููุฏ ูุฅุจุทุงูู ูู ุงููุธุงู');
                // ููุงุญุธุฉ: ุฅุจุทุงู ููุนูู ูุณุชุฎุฏู ุงุณุชุฎุฏูู ูุชุทูุจ ูุธุงู ุฃุฐููุงุช ุฃุนูุฏุ ููุชูู ุจุญุฐูู ูู ุงูุฃููุงุฏ ุงููุชุงุญุฉ
            }

        };

        window.onload = () => {
            Auth.init();
        };

    </script>
</body>
</html>
