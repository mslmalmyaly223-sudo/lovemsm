<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>زايلو - Xylo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* إعدادات التطبيق الأساسية - المطلب 3 (سلاسة عالية) */
        html, body {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: none;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; 
            touch-action: pan-y;
        }

        /* حاويات التمرير بسلاسة 120 هرتز */
        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            will-change: scroll-position;
        }

        /* إخفاء شريط التمرير */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes pulse-xylo {
            0% { transform: scale(0.8); opacity: 0; filter: blur(10px); letter-spacing: -10px; }
            50% { transform: scale(1.05); opacity: 1; filter: blur(0px); letter-spacing: 5px; }
            80% { transform: scale(0.95); opacity: 1; letter-spacing: 2px; }
            100% { transform: scale(1); opacity: 1; filter: blur(0px); letter-spacing: 2px; }
        }
        .xylo-brand {
            animation: pulse-xylo 2.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            background: linear-gradient(135deg, #2563eb, #9333ea, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 10px 30px rgba(147, 51, 234, 0.3);
            display: inline-block;
        }

        .modal-slide-in { animation: slideIn 0.35s forwards cubic-bezier(0.175, 0.885, 0.32, 1.1); }
        .modal-slide-out { animation: slideOut 0.3s forwards cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0.8; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* المطلب 4: تفاعلات الأزرار السلسة والجميلة */
        .btn-tap {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-tap:active {
            transform: scale(0.92);
            opacity: 0.8;
        }
        .btn-tap::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        .btn-tap:active::after {
            transform: translate(-50%, -50%) scale(2);
            opacity: 1;
            transition: 0s;
        }

        .bg-xylo { background: linear-gradient(135deg, #1d4ed8, #6d28d9); }
        .text-xylo { color: #4f46e5; }
        
        /* السحب للتحديث (المطلب 6) */
        .ptr-container {
            transition: transform 0.3s ease;
            position: relative;
        }
        #ptr-spinner {
            position: absolute;
            top: -50px; left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .text-unread { font-weight: 900 !important; color: #000 !important; }
        
        /* قائمة المنشن */
        #mentions-dropdown {
            position: absolute;
            bottom: 100%; left: 0; right: 0;
            background: white; border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            max-height: 200px; overflow-y: auto;
            z-index: 200; display: none;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-gray-800 antialiased pb-safe">

    <!-- 1. شاشة البداية (Splash Screen) -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="text-7xl font-black xylo-brand">زايلو</h1>
        <div class="mt-8">
            <i class="ph ph-spinner-gap animate-spin text-3xl text-blue-600 opacity-50"></i>
        </div>
    </div>

    <!-- 2. قسم المصادقة -->
    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-white overflow-y-auto hide-scrollbar smooth-scroll">
        <div class="min-h-screen flex flex-col items-center justify-center p-6">
            <h1 class="text-6xl font-black xylo-brand mb-10">زايلو</h1>
            
            <div id="login-form" class="w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">تسجيل الدخول</h2>
                <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="login-password" placeholder="كلمة السر" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.login()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">تسجيل الدخول</button>
                <div class="flex justify-between text-sm text-blue-600 font-semibold mt-4">
                    <button onclick="UI.switchAuth('register')" class="p-2 btn-tap">إنشاء حساب جديد</button>
                    <button onclick="UI.switchAuth('forgot')" class="p-2 btn-tap">نسيت كلمة السر؟</button>
                </div>
            </div>

            <div id="register-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">حساب جديد</h2>
                <input type="text" id="reg-name" placeholder="اسم الحساب" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="email" id="reg-email" placeholder="البريد الإلكتروني" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <input type="password" id="reg-password" placeholder="رمز الحساب" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.register()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">إنشاء حساب مباشرة</button>
                
                <div class="relative flex py-4 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">أو</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <button onclick="Auth.loginWithGoogle()" class="btn-tap w-full bg-white border-2 border-gray-200 text-gray-700 font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-sm">
                    <i class="ph-fill ph-google-logo text-red-500 text-xl"></i> تسجيل بحساب كوكل
                </button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">لدي حساب بالفعل</button>
            </div>

            <div id="forgot-form" class="hidden w-full max-w-sm space-y-4">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">استعادة كلمة السر</h2>
                <p class="text-sm text-gray-500 text-center mb-4">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لإعادة تعيين كلمة السر.</p>
                <input type="email" id="forgot-email" placeholder="البريد الإلكتروني" class="w-full bg-gray-100 p-4 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-right dir-rtl">
                <button onclick="Auth.resetPassword()" class="btn-tap w-full bg-xylo text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30">إرسال الرمز</button>
                <button onclick="UI.switchAuth('login')" class="w-full text-center text-blue-600 font-semibold mt-4 p-2 btn-tap">العودة لتسجيل الدخول</button>
            </div>
        </div>
    </div>

    <!-- 3. إعداد الصورة الشخصية -->
    <div id="setup-profile-screen" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 smooth-scroll">
        <h2 class="text-3xl font-bold mb-2 text-center text-gray-800">اختيار صورة للحساب</h2>
        <p class="text-gray-500 mb-8 text-center">اجعل حسابك مميزاً بإضافة صورة شخصية</p>
        
        <label for="profile-upload" class="relative cursor-pointer mb-8 btn-tap inline-block">
            <div id="profile-preview-container" class="w-40 h-40 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-4 border-dashed border-blue-400 shadow-inner">
                <i class="ph ph-camera text-5xl text-gray-400"></i>
                <img id="profile-preview-img" class="hidden w-full h-full object-cover">
            </div>
            <div class="absolute bottom-1 right-1 bg-blue-600 p-3 rounded-full text-white border-4 border-white shadow-md">
                <i class="ph ph-plus font-bold text-lg"></i>
            </div>
            <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="Auth.handleImageUpload(event)">
        </label>

        <button onclick="Auth.completeProfileSetup()" class="btn-tap w-full max-w-xs bg-xylo text-white font-bold py-4 rounded-xl shadow-lg">التالي</button>
    </div>

    <!-- 4. التطبيق الرئيسي -->
    <div id="main-app" class="hidden flex-1 flex flex-col h-screen w-full bg-gray-100 relative">
        
        <header class="bg-white px-4 py-3 flex justify-between items-center z-20 relative shadow-sm">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter" style="letter-spacing: 1px;">زايلو</h1>
            <div class="flex gap-3">
                <button onclick="UI.openModal('search-modal')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center btn-tap">
                    <i class="ph ph-magnifying-glass text-xl text-gray-700"></i>
                </button>
            </div>
        </header>

        <nav class="bg-white border-b border-gray-200 w-full z-10 shadow-sm sticky top-0">
            <div class="flex justify-between items-center px-2">
                <button onclick="UI.switchTab('home')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-blue-600 border-b-2 border-blue-600 transition-colors btn-tap">
                    <i class="ph-fill ph-house text-2xl"></i>
                </button>
                <button onclick="UI.switchTab('notes')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-users text-2xl"></i>
                    <span id="badge-requests" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('messages')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-chat-circle-text text-2xl"></i>
                    <span id="badge-messages" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('notifications')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors relative btn-tap">
                    <i class="ph ph-bell text-2xl"></i>
                    <span id="badge-notifications" class="hidden absolute top-2 right-1/4 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                <button onclick="UI.switchTab('settings')" class="nav-btn flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-b-2 border-transparent transition-colors btn-tap">
                    <i class="ph ph-list text-2xl"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto hide-scrollbar smooth-scroll relative ptr-container" id="main-content-area">
            <div id="ptr-spinner" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center">
                <i class="ph ph-arrow-circle-down animate-spin text-blue-600 text-2xl"></i>
            </div>
            
            <!-- القسم الأول: الرئيسية -->
            <div id="tab-home" class="p-2 space-y-3 pb-6">
                <div class="bg-white p-3 rounded-xl shadow-sm flex gap-3 items-center">
                    <img id="current-user-avatar-home" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <div class="flex-1 bg-gray-100 hover:bg-gray-200 transition-colors rounded-full px-4 py-2.5 flex items-center cursor-pointer btn-tap" onclick="UI.openModal('create-post-modal')">
                        <span class="text-gray-500 text-sm">بم تفكر؟</span>
                    </div>
                </div>
                <div id="feed-container" class="space-y-3">
                    <div class="text-center text-gray-400 py-10"><i class="ph ph-spinner-gap animate-spin text-3xl mx-auto mb-2"></i>جاري التحميل...</div>
                </div>
            </div>

            <!-- القسم الثاني: الرسائل -->
            <div id="tab-messages" class="hidden p-2">
                <div class="flex justify-between items-center p-2 mb-2">
                    <h2 class="text-xl font-bold">الرسائل</h2>
                </div>
                <div id="chats-container" class="bg-white rounded-xl shadow-sm overflow-hidden min-h-[400px]">
                </div>
            </div>

            <!-- القسم الثالث: الأصدقاء والملاحظات (تم حل المطلب 1 و 2 و 9) -->
            <div id="tab-notes" class="hidden p-2 space-y-3">
                <!-- إزالة نص ملاحظات الأصدقاء وتمكين التمرير الأفقي بسلاسة -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex overflow-x-auto smooth-scroll hide-scrollbar gap-3 pb-2 pt-2 items-start" id="notes-container" style="scroll-snap-type: x mandatory;">
                        <!-- زر أنت -->
                        <div class="inline-flex flex-col items-center relative cursor-pointer shrink-0 btn-tap w-20" onclick="App.checkAndCreateNote()" style="scroll-snap-align: start;">
                            <div class="relative">
                                <img id="current-user-avatar-note" class="w-16 h-16 rounded-full object-cover border-2 border-transparent ring-2 ring-gray-200 p-0.5">
                                <div class="absolute bottom-0 right-0 bg-white rounded-full p-0.5 shadow-sm" id="my-note-plus-icon">
                                    <div class="bg-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-white">
                                        <i class="ph ph-plus text-xs font-bold"></i>
                                    </div>
                                </div>
                            </div>
                            <span class="text-[11px] font-bold mt-1 text-gray-800 w-full text-center truncate">أنت</span>
                            <div id="my-note-text-container" class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1.5 rounded-lg mt-1 w-full text-center truncate border border-gray-200">
                                إضافة ملاحظة
                            </div>
                        </div>
                        <!-- ملاحظات أخرى تحقن هنا -->
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-4 min-h-[300px]">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-gray-800 text-sm">طلبات الصداقة</h3>
                        <button onclick="UI.openModal('friends-list-modal')" class="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-1.5 rounded-full btn-tap flex items-center gap-1">
                            <i class="ph-fill ph-users"></i> الأصدقاء
                        </button>
                    </div>
                    <div id="friend-requests-container" class="space-y-3 mt-2">
                    </div>
                </div>
            </div>

            <!-- القسم الرابع: الإشعارات -->
            <div id="tab-notifications" class="hidden p-2">
                <h2 class="text-xl font-bold p-2 mb-2">الإشعارات</h2>
                <div id="notifications-container" class="bg-white rounded-xl shadow-sm overflow-hidden min-h-[400px]">
                </div>
            </div>

            <!-- القسم الخامس: الإعدادات -->
            <div id="tab-settings" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-6">القائمة</h2>
                
                <div class="bg-white rounded-xl p-4 shadow-sm flex items-center gap-4 mb-6 cursor-pointer btn-tap border border-gray-50" onclick="UI.openModal('profile-modal', window.currentUser.uid)">
                    <img id="settings-avatar" src="" class="w-14 h-14 rounded-full object-cover bg-gray-200 border border-gray-100">
                    <div class="flex-1">
                        <h3 id="settings-name" class="font-bold text-lg leading-tight">...</h3>
                        <p class="text-gray-500 text-sm mt-0.5">عرض ملفك الشخصي</p>
                    </div>
                    <i class="ph ph-caret-left text-gray-400 text-xl"></i>
                </div>

                <div class="space-y-3">
                    <button onclick="UI.openModal('edit-profile-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="ph-fill ph-user-pen text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">تعديل الملف الشخصي</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('privacy-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="ph-fill ph-lock-key text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">الخصوصية</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="UI.openModal('account-settings-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ph-fill ph-gear text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">إعدادات الحساب</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>
                    
                    <!-- المطلب 7: زر المحظورين -->
                    <button onclick="UI.openModal('blocked-users-modal')" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex items-center gap-4 btn-tap">
                        <div class="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center"><i class="ph-fill ph-prohibit text-xl"></i></div>
                        <span class="font-semibold flex-1 text-right text-gray-700">المحظورين</span>
                        <i class="ph ph-caret-left text-gray-400"></i>
                    </button>

                    <button onclick="Auth.logout()" class="w-full bg-red-50 p-4 rounded-xl shadow-sm flex items-center gap-4 btn-tap mt-8 border border-red-100">
                        <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="ph-fill ph-sign-out text-xl"></i></div>
                        <span class="font-bold flex-1 text-right text-red-600">تسجيل الخروج</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- رسائل النظام -->
    <div id="msg-box" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-[200] opacity-0 pointer-events-none transition-opacity duration-300 flex items-center gap-2 text-sm font-semibold">
        <span id="msg-box-text">رسالة</span>
    </div>

    <!-- نافذة البحث -->
    <div id="search-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3">
            <button onclick="UI.closeModal('search-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <div class="flex-1 relative">
                <input type="text" id="search-input" oninput="App.searchUsers()" placeholder="ابحث عن أصدقاء..." class="w-full bg-gray-100 rounded-full py-2.5 px-4 pr-10 outline-none focus:ring-2 focus:ring-blue-100 transition-shadow">
                <i class="ph ph-magnifying-glass absolute right-3 top-3 text-gray-400 text-lg"></i>
            </div>
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto smooth-scroll p-2 space-y-1">
            <div class="text-center text-gray-400 py-10 mt-10">
                <i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50 block mx-auto"></i>
                اكتب للبحث عن مستخدمين
            </div>
        </div>
    </div>

    <!-- المطلب 5: نافذة المنشن -->
    <div id="mentions-dropdown" class="smooth-scroll border-t-2 border-blue-500">
        <!-- تحقن نتائج المنشن هنا -->
    </div>

    <!-- نافذة إنشاء منشور -->
    <div id="create-post-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in relative">
        <div class="p-4 border-b flex items-center justify-between bg-white shadow-sm z-10">
            <button onclick="UI.closeModal('create-post-modal')" class="p-2 text-gray-600 font-bold btn-tap rounded-lg hover:bg-gray-50">إلغاء</button>
            <span class="font-bold text-lg">إنشاء منشور</span>
            <button onclick="App.createPost()" class="bg-blue-600 text-white px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">نشر</button>
        </div>
        <div class="p-4 flex gap-3 flex-1 overflow-y-auto smooth-scroll relative">
            <img id="create-post-avatar" src="" class="w-12 h-12 rounded-full object-cover border border-gray-100">
            <textarea id="post-text-input" placeholder="بم تفكر؟ استخدم @ لذكر صديق" class="flex-1 resize-none outline-none text-lg pt-2 hide-scrollbar bg-transparent" rows="10"></textarea>
        </div>
    </div>

    <!-- نافذة إنشاء ملاحظة -->
    <div id="create-note-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in relative">
        <div class="p-4 flex items-center justify-between absolute w-full top-0 z-10 bg-gradient-to-b from-black/50 to-transparent border-none">
            <button onclick="UI.closeModal('create-note-modal')" class="p-2 text-white font-bold btn-tap drop-shadow-md">إلغاء</button>
            <button onclick="App.createNote()" class="bg-white text-gray-900 px-5 py-1.5 rounded-full font-bold btn-tap shadow-md">مشاركة</button>
        </div>
        <div class="flex-1 bg-gradient-to-br from-gray-800 to-gray-900 p-8 flex flex-col items-center justify-center relative">
            <img id="create-note-preview-avatar" src="" class="w-20 h-20 rounded-full border-4 border-gray-700 mb-6 object-cover shadow-lg">
            <textarea id="note-text-input" placeholder="اكتب ملاحظة لـ 24 ساعة... (استخدم @)" class="w-full bg-transparent text-white text-center text-3xl outline-none resize-none placeholder-white/30 font-bold" rows="3" maxlength="60"></textarea>
            <p class="text-white/50 text-xs mt-4">الحد الأقصى 60 حرفاً</p>
        </div>
    </div>

    <!-- المطلب 9: نافذة عرض الملاحظة -->
    <div id="note-view-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex flex-col justify-center items-center p-4 modal-slide-in" onclick="UI.closeModal('note-view-modal')">
        <div class="w-full max-w-sm flex flex-col items-center" onclick="event.stopPropagation()">
            <img id="nv-avatar" class="w-24 h-24 rounded-full border-4 border-gray-700 mb-4 object-cover">
            <h3 id="nv-name" class="text-white font-bold text-xl mb-1">...</h3>
            <span id="nv-time" class="text-gray-400 text-sm mb-8">...</span>
            <div id="nv-text" class="text-white text-3xl font-black text-center leading-relaxed whitespace-pre-wrap">...</div>
        </div>
    </div>

    <!-- نافذة إدارة الملاحظة (تعديل/حذف) -->
    <div id="manage-note-modal" class="hidden fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden modal-slide-in shadow-2xl relative">
            <div class="p-4 border-b text-center">
                <h3 class="font-bold text-lg">إدارة الملاحظة</h3>
            </div>
            <div class="p-4 space-y-4">
                <textarea id="edit-note-input" class="w-full bg-gray-100 p-4 rounded-xl outline-none text-center font-bold text-lg resize-none" rows="2" maxlength="60"></textarea>
                <div class="flex flex-col gap-2">
                    <button onclick="App.updateNote()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap">تحديث الملاحظة</button>
                    <button onclick="App.deleteNote()" class="w-full bg-red-100 text-red-600 font-bold py-3 rounded-xl btn-tap">حذف الملاحظة</button>
                    <button onclick="UI.closeModal('manage-note-modal')" class="w-full text-gray-500 font-bold py-3 rounded-xl btn-tap">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة التعليقات -->
    <div id="comments-modal" class="hidden fixed inset-0 z-[80] flex flex-col justify-end bg-black/50">
        <div class="bg-white w-full h-[85vh] rounded-t-3xl flex flex-col modal-slide-in shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative">
            <div class="p-4 flex justify-between items-center border-b">
                <span class="font-bold text-lg">التعليقات</span>
                <button onclick="UI.closeModal('comments-modal')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center btn-tap"><i class="ph ph-x"></i></button>
            </div>
            <div id="comments-list" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-5">
            </div>
            <div class="p-3 border-t flex gap-2 items-center bg-white pb-safe z-10">
                <img id="comment-my-avatar" src="" class="w-9 h-9 rounded-full object-cover">
                <input type="text" id="comment-input" placeholder="اضف تعليقاً... (استخدم @)" class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 outline-none text-sm focus:bg-gray-200 transition-colors">
                <button onclick="App.addComment()" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center btn-tap shrink-0 shadow-md"><i class="ph-fill ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- نافذة المحظورين (المطلب 7) -->
    <div id="blocked-users-modal" class="hidden fixed inset-0 bg-white z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm bg-white z-10 sticky top-0">
            <button onclick="UI.closeModal('blocked-users-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">المحظورين</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-2" id="blocked-list-container">
            <!-- تحقن قائمة المحظورين هنا -->
        </div>
    </div>

    <!-- نافذة تعديل الملف الشخصي (المطلب 11) -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-white z-[70] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm z-10">
            <button onclick="UI.closeModal('edit-profile-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">تعديل الملف الشخصي</span>
            <button onclick="App.saveProfile()" class="bg-gray-900 text-white px-4 py-1.5 rounded-full font-bold btn-tap text-sm">حفظ</button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto smooth-scroll flex-1">
            <div class="flex flex-col items-center mb-4">
                <label for="edit-profile-pic" class="relative cursor-pointer group btn-tap">
                    <img id="edit-profile-img" src="" class="w-28 h-28 rounded-full object-cover border-4 border-gray-100 shadow-sm">
                    <div class="absolute bottom-0 right-0 bg-blue-600 p-2.5 rounded-full text-white border-2 border-white shadow-md group-hover:bg-blue-700 transition-colors"><i class="ph ph-camera"></i></div>
                    <input type="file" id="edit-profile-pic" accept="image/*" class="hidden" onchange="App.handleEditImage(event)">
                </label>
            </div>
            <div class="bg-gray-50 p-4 rounded-2xl space-y-4 border border-gray-100">
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">الاسم</label>
                    <input type="text" id="edit-name" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 font-bold text-lg transition-colors">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">المعرف (مرة واحدة كل 10 أيام)</label>
                    <input type="text" id="edit-username" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 dir-ltr text-left font-mono text-lg transition-colors disabled:text-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed rounded-t-md px-2" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_.]/g, '')">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">النبذة (Bio)</label>
                    <textarea id="edit-bio" class="w-full bg-transparent border-b border-gray-300 py-2 outline-none focus:border-blue-600 resize-none transition-colors" rows="3"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الخصوصية -->
    <div id="privacy-modal" class="hidden fixed inset-0 bg-gray-50 z-[70] flex flex-col modal-slide-in">
        <div class="bg-white p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('privacy-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">إعدادات الخصوصية</span>
        </div>
        <div class="p-4 space-y-3 smooth-scroll overflow-y-auto">
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100">
                <div>
                    <h4 class="font-bold text-gray-800">استقبال طلبات الصداقة</h4>
                    <p class="text-xs text-gray-500 mt-0.5">السماح للآخرين بإرسال طلبات لك</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-requests" class="sr-only peer" onchange="App.updatePrivacy('allowRequests', this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100">
                <div>
                    <h4 class="font-bold text-gray-800">حساب خاص</h4>
                    <p class="text-xs text-gray-500 mt-0.5">إخفاء منشوراتك عن غير الأصدقاء</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="priv-private" class="sr-only peer" onchange="App.updatePrivacy('isPrivate', this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border border-gray-100">
                <h4 class="font-bold border-b pb-2 text-gray-800">من يمكنه رؤية أصدقائي</h4>
                <select id="priv-friends-vis" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200 focus:border-blue-500" onchange="App.updatePrivacy('friendsVisibility', this.value)">
                    <option value="all">الجميع</option>
                    <option value="friends">الأصدقاء فقط</option>
                    <option value="only_me">أنا فقط</option>
                </select>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border border-gray-100">
                <h4 class="font-bold border-b pb-2 text-gray-800">من يمكنه مراسلتي</h4>
                <select id="priv-msgs" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200 focus:border-blue-500" onchange="App.updatePrivacy('messagePrivacy', this.value)">
                    <option value="all">الجميع</option>
                    <option value="friends">الأصدقاء فقط</option>
                    <option value="closed">مغلق (لا أحد)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- نافذة إعدادات الحساب -->
    <div id="account-settings-modal" class="hidden fixed inset-0 bg-gray-50 z-[70] flex flex-col modal-slide-in">
        <div class="bg-white p-4 border-b flex items-center gap-3 shadow-sm">
            <button onclick="UI.closeModal('account-settings-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">إعدادات الحساب والأمان</span>
        </div>
        <div class="p-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm space-y-4 border border-gray-100">
                <h4 class="font-bold text-red-600 text-lg flex items-center gap-2"><i class="ph ph-shield-warning"></i> تغيير كلمة السر</h4>
                <p class="text-sm text-gray-500">سيتم إرسال رابط لبريدك الإلكتروني لإعادة تعيين كلمة السر الخاصة بك.</p>
                <button onclick="Auth.resetPasswordFromSettings()" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-xl border border-red-100 btn-tap mt-2">إرسال رابط التغيير</button>
            </div>
        </div>
    </div>

    <!-- نافذة الأصدقاء -->
    <div id="friends-list-modal" class="hidden fixed inset-0 bg-white z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 shadow-sm bg-white z-10 sticky top-0">
            <button onclick="UI.closeModal('friends-list-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg flex-1">الأصدقاء</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-2" id="friends-list-container">
        </div>
    </div>

    <!-- ملف شخصي -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-white z-[80] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 bg-white/80 backdrop-blur-md absolute w-full top-0 z-20">
            <button onclick="UI.closeModal('profile-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span id="vp-header-name" class="font-bold text-lg">الملف الشخصي</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll pb-10">
            <div class="h-44 bg-gradient-to-tr from-blue-500 via-purple-500 to-pink-500 relative"></div>
            <div class="px-4 relative mb-6">
                <img id="vp-image" src="" class="w-28 h-28 rounded-full border-4 border-white absolute -top-14 object-cover bg-white shadow-md">
                <div class="flex justify-end pt-3 h-14 items-center gap-2" id="vp-action-container"></div>
                <h2 id="vp-name" class="text-3xl font-black mt-4 leading-tight">...</h2>
                <p id="vp-username" class="text-gray-500 text-sm dir-ltr text-left w-max mt-1 font-medium bg-gray-100 px-2 py-0.5 rounded-md">@...</p>
                <p id="vp-bio" class="mt-4 text-gray-800 leading-relaxed">...</p>
            </div>
            <div class="flex border-y border-gray-100 py-4 px-4 text-center bg-gray-50">
                <div class="flex-1 border-l border-gray-200"><span class="font-black text-xl block text-gray-800" id="vp-friends-count">0</span><span class="text-xs text-gray-500 font-semibold uppercase tracking-wider">صديق</span></div>
                <div class="flex-1"><span class="font-black text-xl block text-gray-800" id="vp-posts-count">0</span><span class="text-xs text-gray-500 font-semibold uppercase tracking-wider">منشور</span></div>
            </div>
            <div class="p-2 space-y-3 bg-gray-100 min-h-[50vh] pt-3" id="vp-posts-container">
            </div>
        </div>
    </div>

    <!-- نافذة المحادثة (الشات) -->
    <div id="chat-modal" class="hidden fixed inset-0 bg-gray-50 z-[90] flex flex-col modal-slide-in">
        <div class="bg-white p-3 border-b flex items-center gap-3 shadow-sm z-10">
            <button onclick="UI.closeModal('chat-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <div class="relative cursor-pointer" onclick="UI.openModal('profile-modal', window.currentChatUserId)">
                <img id="chat-user-img" src="" class="w-11 h-11 rounded-full object-cover">
                <span id="chat-online-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full hidden"></span>
            </div>
            <div class="flex-1 overflow-hidden">
                <h3 id="chat-user-name" class="font-bold leading-tight truncate">...</h3>
                <p id="chat-user-status" class="text-xs text-gray-500 truncate mt-0.5">...</p>
            </div>
        </div>
        <div id="chat-messages-container" class="flex-1 overflow-y-auto smooth-scroll p-4 space-y-4 flex flex-col relative">
        </div>
        <div class="p-3 bg-white border-t flex gap-2 items-end pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.05)] relative z-10">
            <textarea id="chat-input" placeholder="اكتب رسالة..." class="flex-1 bg-gray-100 rounded-3xl px-5 py-3 outline-none resize-none max-h-28 hide-scrollbar text-[15px] focus:bg-gray-200 transition-colors" rows="1" oninput="this.style.height = '';this.style.height = Math.min(this.scrollHeight, 112) + 'px'"></textarea>
            <button onclick="App.sendMessage()" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 transition-colors text-white rounded-full flex items-center justify-center shrink-0 btn-tap shadow-md mb-0.5"><i class="ph-fill ph-paper-plane-right text-xl"></i></button>
        </div>
    </div>

    <!-- قائمة الخيارات المنبثقة (المطلب 8 وغيرها) -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-end justify-center">
        <div class="bg-white w-full rounded-t-3xl p-4 modal-slide-in shadow-[0_-10px_40px_rgba(0,0,0,0.2)]">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            <div id="action-modal-content" class="space-y-2">
            </div>
            <button onclick="UI.closeModal('action-modal')" class="w-full bg-gray-100 text-gray-800 font-bold py-4 rounded-2xl mt-4 btn-tap">إلغاء</button>
        </div>
    </div>

    <!-- عرض منشور مفرد -->
    <div id="single-post-modal" class="hidden fixed inset-0 bg-gray-100 z-[85] flex flex-col modal-slide-in">
        <div class="p-4 border-b flex items-center gap-3 bg-white shadow-sm sticky top-0 z-10">
            <button onclick="UI.closeModal('single-post-modal')" class="p-2 bg-gray-100 rounded-full btn-tap"><i class="ph ph-arrow-right text-lg"></i></button>
            <span class="font-bold text-lg">عرض المنشور</span>
        </div>
        <div class="flex-1 overflow-y-auto smooth-scroll p-2" id="single-post-container">
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDe7WeScgMaRAK7PzExvkzppb2XOcdAI0k",
                authDomain: "communication-5dd27.firebaseapp.com",
                databaseURL: "https://communication-5dd27-default-rtdb.firebaseio.com",
                projectId: "communication-5dd27",
                storageBucket: "communication-5dd27.firebasestorage.app",
                messagingSenderId: "79255528858",
                appId: "1:79255528858:web:6c75eee637561056b28623"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xylo-app-123';

        const USERS_PATH = `artifacts/${appId}/public/data/users`;
        const POSTS_PATH = `artifacts/${appId}/public/data/posts`;
        const COMMENTS_PATH = `artifacts/${appId}/public/data/comments`;
        const REQUESTS_PATH = `artifacts/${appId}/public/data/requests`;
        const FRIENDS_PATH = `artifacts/${appId}/public/data/friends`;
        const MESSAGES_PATH = `artifacts/${appId}/public/data/messages`;
        const NOTES_PATH = `artifacts/${appId}/public/data/notes`;
        const NOTIFS_PATH = `artifacts/${appId}/public/data/notifications`;

        window.Memory = {
            users: {},
            posts: [],
            comments: [],
            requests: [],
            friends: [],
            messages: [],
            notes: [],
            notifications: []
        };

        window.currentUser = null;
        window.currentChatUserId = null;
        window.currentPostIdForComment = null;
        window.currentManageNoteId = null;

        const escapeHTML = (str) => {
            return str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag] || tag));
        };

        // المطلب 6: نظام السحب للتحديث
        window.PullToRefresh = {
            startY: 0,
            isPulling: false,
            spinner: null,
            container: null,
            init: () => {
                PullToRefresh.container = document.getElementById('main-content-area');
                PullToRefresh.spinner = document.getElementById('ptr-spinner');
                
                PullToRefresh.container.addEventListener('touchstart', e => {
                    if (PullToRefresh.container.scrollTop <= 0) {
                        PullToRefresh.startY = e.touches[0].clientY;
                        PullToRefresh.isPulling = true;
                        PullToRefresh.spinner.style.transition = 'none';
                    }
                }, {passive: true});

                PullToRefresh.container.addEventListener('touchmove', e => {
                    if (!PullToRefresh.isPulling) return;
                    const y = e.touches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    if (diff > 0 && PullToRefresh.container.scrollTop <= 0) {
                        e.preventDefault(); // منع سحب المتصفح الافتراضي
                        let pullDistance = Math.min(diff * 0.4, 70); // مقاومة السحب
                        PullToRefresh.spinner.style.transform = `translate(-50%, ${pullDistance}px) rotate(${pullDistance*2}deg)`;
                        PullToRefresh.spinner.style.opacity = Math.min(pullDistance / 50, 1);
                    }
                }, {passive: false});

                PullToRefresh.container.addEventListener('touchend', e => {
                    if (!PullToRefresh.isPulling) return;
                    PullToRefresh.isPulling = false;
                    PullToRefresh.spinner.style.transition = 'transform 0.3s, opacity 0.3s';
                    
                    const y = e.changedTouches[0].clientY;
                    const diff = y - PullToRefresh.startY;
                    
                    if (diff > 80 && PullToRefresh.container.scrollTop <= 0) {
                        // تفعيل التحديث
                        PullToRefresh.spinner.style.transform = `translate(-50%, 50px) rotate(360deg)`;
                        PullToRefresh.spinner.classList.add('animate-spin');
                        
                        // محاكاة تحميل
                        setTimeout(() => {
                            App.renderFeed();
                            App.renderNotifications();
                            PullToRefresh.spinner.classList.remove('animate-spin');
                            PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                            PullToRefresh.spinner.style.opacity = 0;
                            UI.showMessage('تم التحديث');
                        }, 1000);
                    } else {
                        // إلغاء
                        PullToRefresh.spinner.style.transform = `translate(-50%, -50px)`;
                        PullToRefresh.spinner.style.opacity = 0;
                    }
                }, {passive: true});
            }
        };

        // المطلب 5: نظام المنشن
        window.Mentions = {
            activeInput: null,
            setup: () => {
                const inputs = ['post-text-input', 'note-text-input', 'comment-input'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('input', (e) => Mentions.checkTrigger(e.target));
                        el.addEventListener('blur', () => setTimeout(() => document.getElementById('mentions-dropdown').style.display = 'none', 200));
                    }
                });
            },
            checkTrigger: (input) => {
                Mentions.activeInput = input;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const words = textBeforeCursor.split(/\s/);
                const lastWord = words[words.length - 1];

                const dropdown = document.getElementById('mentions-dropdown');
                
                if (lastWord.startsWith('@')) {
                    const query = lastWord.substring(1).toLowerCase();
                    Mentions.showList(query, input);
                } else {
                    dropdown.style.display = 'none';
                }
            },
            showList: (query, input) => {
                const dropdown = document.getElementById('mentions-dropdown');
                dropdown.innerHTML = '';
                
                // تصفية الأصدقاء فقط (أو الكل حسب الرغبة، الأفضل الأصدقاء)
                const friendsIds = Memory.friends.map(f => f.user1 === currentUser.uid ? f.user2 : (f.user2 === currentUser.uid ? f.user1 : null)).filter(id => id);
                
                let results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    friendsIds.includes(u.uid) &&
                    (u.username.toLowerCase().includes(query) || u.name.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // ترتيب حسب الاكثر تفضيلاً
                const mentionsCount = currentUser.mentionsCount || {};
                results.sort((a,b) => (mentionsCount[b.uid] || 0) - (mentionsCount[a.uid] || 0));

                results.forEach(u => {
                    const item = document.createElement('div');
                    item.className = 'p-3 flex items-center gap-3 border-b hover:bg-gray-50 cursor-pointer btn-tap';
                    item.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-8 h-8 rounded-full object-cover border">
                        <div>
                            <div class="font-bold text-sm text-gray-800">${u.name}</div>
                            <div class="text-[10px] text-gray-500">@${u.username}</div>
                        </div>
                    `;
                    item.onmousedown = (e) => {
                        e.preventDefault(); // لمنع فقدان التركيز (blur)
                        Mentions.selectUser(u.username, u.uid);
                    };
                    dropdown.appendChild(item);
                });

                // موقع القائمة المنسدلة بناء على مكان الإدخال
                const rect = input.getBoundingClientRect();
                dropdown.style.bottom = 'auto';
                dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                if(input.id === 'comment-input' || input.id === 'post-text-input') {
                    // نظرا لتصميم المودل، سنثبت القائمة أسفل النافذة أو فوق الكيبورد
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '60px'; // تقريباً فوق حقل التعليق
                }
                
                dropdown.style.display = 'block';
            },
            selectUser: (username, uid) => {
                const input = Mentions.activeInput;
                if(!input) return;
                const text = input.value;
                const cursorPos = input.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const textAfterCursor = text.substring(cursorPos);
                
                const words = textBeforeCursor.split(/\s/);
                words.pop(); // حذف كلمة المنشن
                
                const newTextBefore = (words.length > 0 ? words.join(' ') + ' ' : '') + '@' + username + ' ';
                input.value = newTextBefore + textAfterCursor;
                input.focus();
                input.setSelectionRange(newTextBefore.length, newTextBefore.length);
                
                document.getElementById('mentions-dropdown').style.display = 'none';
                
                // زيادة عداد التفضيل
                App.incrementMentionCount(uid);
            }
        };

        window.UI = {
            showMessage: (msg) => {
                const box = document.getElementById('msg-box');
                document.getElementById('msg-box-text').innerText = msg;
                box.style.opacity = '1';
                setTimeout(() => { box.style.opacity = '0'; }, 3000);
            },
            switchAuth: (formId) => {
                ['login-form', 'register-form', 'forgot-form'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`${formId}-form`).classList.remove('hidden');
            },
            showScreen: (screenId) => {
                ['splash-screen', 'auth-screen', 'setup-profile-screen', 'main-app'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            switchTab: (tabId) => {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                    btn.querySelector('i').classList.remove('ph-fill');
                    btn.querySelector('i').classList.add('ph');
                });
                const activeBtn = document.querySelector(`.nav-btn[onclick="UI.switchTab('${tabId}')"]`);
                if(activeBtn) {
                    activeBtn.classList.remove('text-gray-500', 'border-transparent');
                    activeBtn.classList.add('text-blue-600', 'border-blue-600');
                    activeBtn.querySelector('i').classList.remove('ph');
                    activeBtn.querySelector('i').classList.add('ph-fill');
                }

                ['tab-home', 'tab-messages', 'tab-notes', 'tab-notifications', 'tab-settings'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                
                App.updateLastActive();
                
                if(tabId === 'messages') document.getElementById('badge-messages').classList.add('hidden');
                if(tabId === 'notes') document.getElementById('badge-requests').classList.add('hidden');
                if(tabId === 'notifications') document.getElementById('badge-notifications').classList.add('hidden');

                document.getElementById('main-content-area').scrollTop = 0;
            },
            openModal: (modalId, data = null) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                if (modal.firstElementChild.classList.contains('modal-slide-in') || modal.firstElementChild.classList.contains('modal-slide-out')) {
                    modal.firstElementChild.classList.remove('modal-slide-out');
                    modal.firstElementChild.classList.add('modal-slide-in');
                }

                if (modalId === 'profile-modal' && data) {
                    App.renderUserProfile(data);
                } else if (modalId === 'chat-modal' && data) {
                    window.currentChatUserId = data;
                    App.renderChatInfo(data);
                    App.renderMessages();
                    App.markChatAsRead(data); // المطلب 10
                } else if (modalId === 'comments-modal' && data) {
                    window.currentPostIdForComment = data;
                    document.getElementById('comment-my-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    App.renderComments();
                } else if (modalId === 'edit-profile-modal') {
                    document.getElementById('edit-name').value = currentUser.name || '';
                    document.getElementById('edit-bio').value = currentUser.bio || '';
                    document.getElementById('edit-profile-img').src = currentUser.photo || App.getDefaultAvatar();
                    
                    // المطلب 11: تعطيل الإدخال إذا تم التغيير قريبا
                    const usernameInput = document.getElementById('edit-username');
                    usernameInput.value = currentUser.username || '';
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    if (Date.now() - lastChange < tenDaysInMs) {
                        usernameInput.disabled = true;
                        UI.showMessage('تغيير المعرف معطل مؤقتاً (مرة كل 10 أيام)');
                    } else {
                        usernameInput.disabled = false;
                    }

                } else if (modalId === 'privacy-modal') {
                    document.getElementById('priv-requests').checked = currentUser.allowRequests !== false;
                    document.getElementById('priv-private').checked = currentUser.isPrivate === true;
                    document.getElementById('priv-friends-vis').value = currentUser.friendsVisibility || 'all';
                    document.getElementById('priv-msgs').value = currentUser.messagePrivacy || 'all';
                } else if (modalId === 'create-note-modal') {
                    document.getElementById('create-note-preview-avatar').src = currentUser.photo || App.getDefaultAvatar();
                    document.getElementById('note-text-input').value = '';
                } else if (modalId === 'friends-list-modal') {
                    App.renderFriendsList();
                } else if (modalId === 'blocked-users-modal') {
                    App.renderBlockedUsers(); // المطلب 7
                }
            },
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal.firstElementChild.classList.contains('modal-slide-in')) {
                    modal.firstElementChild.classList.remove('modal-slide-in');
                    modal.firstElementChild.classList.add('modal-slide-out');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                } else {
                    modal.classList.add('hidden');
                }
            },
            openProfileByUsername: (username) => {
                const u = Object.values(Memory.users).find(user => user.username === username);
                if(u) {
                    UI.closeModal('comments-modal');
                    UI.closeModal('note-view-modal');
                    UI.openModal('profile-modal', u.uid);
                } else {
                    UI.showMessage('المستخدم غير موجود');
                }
            }
        };

        let tempPhotoBase64 = null;

        window.Auth = {
            init: async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e){}
                } else if (!auth.currentUser) {
                    setTimeout(() => {
                        if(!auth.currentUser) UI.showScreen('auth-screen');
                    }, 2500); 
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                        if (userDoc.exists()) {
                            window.currentUser = userDoc.data();
                            if(!window.currentUser.blockedUsers) window.currentUser.blockedUsers = [];
                            if(!window.currentUser.mentionsCount) window.currentUser.mentionsCount = {};
                            App.startCore();
                            
                            const urlParams = new URLSearchParams(window.location.search);
                            const postIdParam = urlParams.get('post');
                            if(postIdParam) {
                                setTimeout(() => App.openSinglePost(postIdParam), 1000);
                            }
                        } else {
                            UI.showScreen('setup-profile-screen');
                        }
                    } else {
                        window.currentUser = null;
                        UI.showScreen('auth-screen');
                    }
                });
            },
            register: async () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                if(!name || !email || !password) return UI.showMessage('يرجى ملء جميع الحقول');
                
                try {
                    UI.showMessage('جاري الإنشاء...');
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    window.tempRegData = { uid: cred.user.uid, name, email };
                    UI.showScreen('setup-profile-screen');
                } catch (error) {
                    UI.showMessage('حدث خطأ، ربما البريد مستخدم مسبقاً أو الرمز ضعيف');
                }
            },
            loginWithGoogle: async () => {
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    const user = result.user;
                    const userDoc = await getDoc(doc(db, USERS_PATH, user.uid));
                    if (!userDoc.exists()) {
                        await setDoc(doc(db, USERS_PATH, user.uid), {
                            uid: user.uid,
                            name: user.displayName || 'مستخدم زايلو',
                            email: user.email,
                            photo: user.photoURL || App.getDefaultAvatar(),
                            username: 'user_' + Math.floor(Math.random() * 100000),
                            bio: 'مرحباً، أنا أستخدم تطبيق زايلو!',
                            allowRequests: true,
                            isPrivate: false,
                            friendsVisibility: 'all',
                            messagePrivacy: 'all',
                            lastActive: Date.now(),
                            lastUsernameChange: 0,
                            blockedUsers: [],
                            mentionsCount: {}
                        });
                    }
                } catch (error) {
                    UI.showMessage('فشل تسجيل الدخول بجوجل');
                }
            },
            login: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if(!email || !password) return UI.showMessage('يرجى ملء الحقول');
                try {
                    UI.showMessage('جاري تسجيل الدخول...');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    UI.showMessage('البريد أو كلمة السر غير صحيحة');
                }
            },
            resetPassword: async () => {
                const email = document.getElementById('forgot-email').value;
                if(!email) return UI.showMessage('أدخل البريد الإلكتروني');
                try {
                    await sendPasswordResetEmail(auth, email);
                    UI.showMessage('تم إرسال رابط إعادة التعيين لبريدك');
                    UI.switchAuth('login');
                } catch(e) { UI.showMessage('حدث خطأ'); }
            },
            resetPasswordFromSettings: async () => {
                if(auth.currentUser && auth.currentUser.email) {
                    try {
                        await sendPasswordResetEmail(auth, auth.currentUser.email);
                        UI.showMessage('تم إرسال الرابط لبريدك');
                    } catch(e) { UI.showMessage('حدث خطأ'); }
                }
            },
            logout: async () => {
                await signOut(auth);
                window.location.reload();
            },
            handleImageUpload: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; const MAX_HEIGHT = 400;
                        let width = img.width; let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        tempPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        document.getElementById('profile-preview-img').src = tempPhotoBase64;
                        document.getElementById('profile-preview-img').classList.remove('hidden');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },
            completeProfileSetup: async () => {
                if(!window.tempRegData && !auth.currentUser) return;
                UI.showMessage('جاري حفظ الحساب...');
                const uid = window.tempRegData ? window.tempRegData.uid : auth.currentUser.uid;
                const name = window.tempRegData ? window.tempRegData.name : 'مستخدم';
                const email = window.tempRegData ? window.tempRegData.email : '';
                
                const userData = {
                    uid: uid,
                    name: name,
                    email: email,
                    photo: tempPhotoBase64 || App.getDefaultAvatar(),
                    username: 'user_' + Math.floor(Math.random() * 1000000),
                    bio: 'مرحباً، أنا أستخدم تطبيق زايلو!',
                    allowRequests: true,
                    isPrivate: false,
                    friendsVisibility: 'all',
                    messagePrivacy: 'all',
                    lastActive: Date.now(),
                    lastUsernameChange: 0,
                    blockedUsers: [],
                    mentionsCount: {}
                };

                await setDoc(doc(db, USERS_PATH, uid), userData);
                window.currentUser = userData;
                App.startCore();
            }
        };

        window.App = {
            getDefaultAvatar: () => "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>",
            
            startCore: () => {
                UI.showScreen('main-app');
                App.updateUIWithUserData();
                App.setupListeners();
                App.updateLastActive();
                Mentions.setup();
                PullToRefresh.init();
                setInterval(App.updateLastActive, 60000);
            },

            updateUIWithUserData: () => {
                const photo = currentUser.photo || App.getDefaultAvatar();
                document.getElementById('current-user-avatar-home').src = photo;
                document.getElementById('current-user-avatar-note').src = photo;
                document.getElementById('settings-avatar').src = photo;
                document.getElementById('settings-name').innerText = currentUser.name;
                document.getElementById('create-post-avatar').src = photo;
            },

            updateLastActive: async () => {
                if(!currentUser) return;
                const now = Date.now();
                currentUser.lastActive = now;
                try {
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { lastActive: now });
                } catch(e){}
            },

            setupListeners: () => {
                const errHandler = (e) => console.error("Firebase Read Error:", e);

                onSnapshot(collection(db, USERS_PATH), (snap) => {
                    snap.docs.forEach(d => {
                        const data = d.data();
                        Memory.users[d.id] = data;
                        if(d.id === currentUser.uid) {
                            currentUser.blockedUsers = data.blockedUsers || [];
                            currentUser.mentionsCount = data.mentionsCount || {};
                        }
                    });
                    App.renderChats(); 
                }, errHandler);

                onSnapshot(collection(db, POSTS_PATH), (snap) => {
                    Memory.posts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFeed();
                }, errHandler);

                onSnapshot(collection(db, COMMENTS_PATH), (snap) => {
                    Memory.comments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(window.currentPostIdForComment) App.renderComments();
                    App.renderFeed(); 
                }, errHandler);

                onSnapshot(collection(db, REQUESTS_PATH), (snap) => {
                    Memory.requests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderFriendRequests();
                }, errHandler);

                onSnapshot(collection(db, FRIENDS_PATH), (snap) => {
                    Memory.friends = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderNotes();
                }, errHandler);

                onSnapshot(collection(db, NOTES_PATH), (snap) => {
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    Memory.notes = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                        .filter(n => (now - n.timestamp) < oneDay);
                    App.renderNotes();
                }, errHandler);

                onSnapshot(collection(db, MESSAGES_PATH), (snap) => {
                    Memory.messages = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderChats();
                    if(window.currentChatUserId) App.renderMessages();
                }, errHandler);

                onSnapshot(collection(db, NOTIFS_PATH), (snap) => {
                    Memory.notifications = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                            .filter(n => n.to === currentUser.uid);
                    App.renderNotifications();
                }, errHandler);
            },

            isFriend: (uid1, uid2) => {
                return Memory.friends.some(f => 
                    (f.user1 === uid1 && f.user2 === uid2) || 
                    (f.user1 === uid2 && f.user2 === uid1)
                );
            },
            isBlocked: (uid) => {
                return currentUser.blockedUsers?.includes(uid);
            },
            timeAgo: (timestamp) => {
                if(!timestamp) return 'غير معروف';
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                if (seconds < 60) return "الآن";
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `منذ ${minutes} دقيقة`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `منذ ${hours} ساعة`;
                const days = Math.floor(hours / 24);
                return `منذ ${days} يوم`;
            },
            isOnline: (lastActive) => {
                if(!lastActive) return false;
                return (Date.now() - lastActive) < (5 * 60 * 1000);
            },
            parseMentions: (text) => {
                const escaped = escapeHTML(text);
                return escaped.replace(/@([\w_.]+)/g, (match, username) => {
                    const exists = Object.values(Memory.users).some(u => u.username === username);
                    if(exists) {
                        return `<span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="event.stopPropagation(); UI.openProfileByUsername('${username}')">${match}</span>`;
                    }
                    return match; 
                });
            },
            notifyMentions: async (text, type, linkId) => {
                const matches = text.match(/@([\w_.]+)/g);
                if(!matches) return;
                const usernames = matches.map(m => m.substring(1));
                const usersArray = Object.values(Memory.users);
                
                for(let un of usernames) {
                    const mentionedUser = usersArray.find(u => u.username === un);
                    if(mentionedUser && mentionedUser.uid !== currentUser.uid && !App.isBlocked(mentionedUser.uid)) {
                        await App.sendNotification(mentionedUser.uid, `قام بذكرك في ${type}`, linkId);
                    }
                }
            },
            incrementMentionCount: async (uid) => {
                let counts = currentUser.mentionsCount || {};
                counts[uid] = (counts[uid] || 0) + 1;
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { mentionsCount: counts });
            },

            // --- رندر الرئيسية ---
            renderFeed: () => {
                const container = document.getElementById('feed-container');
                container.innerHTML = '';
                
                const sortedPosts = [...Memory.posts].sort((a,b) => b.timestamp - a.timestamp);
                let visibleCount = 0;

                sortedPosts.forEach(post => {
                    const author = Memory.users[post.authorId];
                    if(!author || App.isBlocked(author.uid)) return;

                    if(author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid)) return;
                    
                    visibleCount++;
                    const isLiked = post.likes && post.likes.includes(currentUser.uid);
                    const likesCount = post.likes ? post.likes.length : 0;
                    const commentsCount = Memory.comments.filter(c => c.postId === post.id).length;

                    const parsedText = App.parseMentions(post.text);

                    const postEl = document.createElement('div');
                    postEl.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-3';
                    postEl.innerHTML = `
                        <div class="p-3.5 flex items-center justify-between">
                            <div class="flex items-center gap-3 cursor-pointer group btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                                <img src="${author.photo || App.getDefaultAvatar()}" class="w-11 h-11 rounded-full object-cover border border-gray-100">
                                <div>
                                    <h4 class="font-bold leading-tight group-hover:text-blue-600 transition-colors">${author.name}</h4>
                                    <span class="text-xs text-gray-400">${App.timeAgo(post.timestamp)}</span>
                                </div>
                            </div>
                            ${post.authorId === currentUser.uid ? `<button onclick="App.deletePost('${post.id}')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors btn-tap"><i class="ph ph-trash text-lg"></i></button>` : ''}
                        </div>
                        <div class="px-4 py-2 text-gray-800 text-[15px] leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-4 py-3 text-xs text-gray-400 flex justify-between items-center mt-2 border-b border-gray-50">
                            <div class="flex items-center gap-1"><i class="ph-fill ph-thumbs-up text-blue-500"></i> ${likesCount}</div>
                            <div>${commentsCount} تعليق</div>
                        </div>
                        <div class="flex p-1">
                            <button onclick="App.toggleLike('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl btn-tap font-semibold transition-colors ${isLiked ? 'text-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'}">
                                <i class="${isLiked ? 'ph-fill' : 'ph'} ph-thumbs-up text-xl"></i> أعجبني
                            </button>
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl text-gray-500 font-semibold hover:bg-gray-50 transition-colors btn-tap">
                                <i class="ph ph-chat-centered text-xl"></i> تعليق
                            </button>
                            <button onclick="App.sharePost('${post.id}')" class="flex-1 flex justify-center items-center gap-1.5 py-2.5 rounded-xl text-gray-500 font-semibold hover:bg-gray-50 transition-colors btn-tap">
                                <i class="ph ph-share-network text-xl"></i> مشاركة
                            </button>
                        </div>
                    `;
                    container.appendChild(postEl);
                });

                if(visibleCount === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-newspaper text-4xl mb-2 opacity-50 block mx-auto"></i>لا توجد منشورات حالياً</div>';
                }
            },

            createPost: async () => {
                const text = document.getElementById('post-text-input').value.trim();
                if(!text) return UI.showMessage('لا يمكن نشر منشور فارغ');
                
                UI.closeModal('create-post-modal');
                document.getElementById('post-text-input').value = '';
                
                const postRef = await addDoc(collection(db, POSTS_PATH), {
                    authorId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    likes: []
                });
                
                App.notifyMentions(text, 'منشور', postRef.id);
                UI.showMessage('تم النشر بنجاح');
            },

            deletePost: async (postId) => {
                if(confirm('هل متأكد من حذف المنشور؟')) {
                    await deleteDoc(doc(db, POSTS_PATH, postId));
                    UI.showMessage('تم حذف المنشور');
                }
            },

            toggleLike: async (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                if(!post) return;
                
                let newLikes = post.likes ? [...post.likes] : [];
                if(newLikes.includes(currentUser.uid)) {
                    newLikes = newLikes.filter(id => id !== currentUser.uid);
                } else {
                    newLikes.push(currentUser.uid);
                    if(post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                        App.sendNotification(post.authorId, 'أعجب بمنشورك', postId);
                    }
                }
                await updateDoc(doc(db, POSTS_PATH, postId), { likes: newLikes });
            },

            sharePost: async (postId) => {
                const shareUrl = window.location.origin + window.location.pathname + '?post=' + postId;
                if (navigator.share) {
                    try { await navigator.share({ title: 'تطبيق زايلو', url: shareUrl }); } catch (err) {}
                } else {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try { document.execCommand("copy"); UI.showMessage("تم نسخ الرابط!"); } 
                    catch (err) { UI.showMessage("تعذر النسخ"); }
                    document.body.removeChild(tempInput);
                }
            },

            openSinglePost: (postId) => {
                const post = Memory.posts.find(p => p.id === postId);
                const container = document.getElementById('single-post-container');
                
                if(!post || App.isBlocked(post.authorId)) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-500">المنشور غير متوفر أو تم حذفه</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const author = Memory.users[post.authorId];
                if(!author || (author.isPrivate && author.uid !== currentUser.uid && !App.isFriend(currentUser.uid, author.uid))) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-500">هذا المنشور خاص ولا تملك صلاحية الوصول إليه</div>';
                    UI.openModal('single-post-modal');
                    return;
                }

                const parsedText = App.parseMentions(post.text);
                const isLiked = post.likes && post.likes.includes(currentUser.uid);
                const likesCount = post.likes ? post.likes.length : 0;
                
                container.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mt-4">
                        <div class="p-4 flex items-center gap-3 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${author.uid}')">
                            <img src="${author.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            <div>
                                <h4 class="font-bold text-lg">${author.name}</h4>
                                <span class="text-sm text-gray-400">${App.timeAgo(post.timestamp)}</span>
                            </div>
                        </div>
                        <div class="px-5 py-3 text-gray-800 text-lg leading-relaxed whitespace-pre-wrap">${parsedText}</div>
                        <div class="px-5 py-3 text-sm text-gray-500 border-t border-gray-50 mt-2 flex justify-between">
                            <span class="font-bold text-blue-600">${likesCount} إعجابات</span>
                        </div>
                        <div class="p-4">
                            <button onclick="UI.openModal('comments-modal', '${post.id}')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl btn-tap shadow-md">عرض التعليقات</button>
                        </div>
                    </div>
                `;
                UI.openModal('single-post-modal');
            },

            // --- رندر التعليقات ---
            renderComments: () => {
                if(!window.currentPostIdForComment) return;
                const container = document.getElementById('comments-list');
                container.innerHTML = '';
                
                const postComments = Memory.comments
                    .filter(c => c.postId === window.currentPostIdForComment)
                    .sort((a,b) => a.timestamp - b.timestamp);

                if(postComments.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-chat-centered text-4xl mb-2 opacity-50 block mx-auto"></i>لا توجد تعليقات، كن أول من يعلق</div>';
                    return;
                }

                postComments.forEach(c => {
                    const author = Memory.users[c.authorId];
                    if(!author || App.isBlocked(author.uid)) return;
                    
                    const parsedText = App.parseMentions(c.text);

                    const el = document.createElement('div');
                    el.className = 'flex gap-3 items-start';
                    el.innerHTML = `
                        <img src="${author.photo || App.getDefaultAvatar()}" class="w-10 h-10 rounded-full object-cover border border-gray-100 cursor-pointer btn-tap" onclick="UI.openProfileByUsername('${author.username}')">
                        <div class="flex-1">
                            <div class="bg-gray-100 rounded-2xl rounded-tr-sm p-3.5 inline-block min-w-[50%] max-w-full shadow-sm">
                                <h5 class="font-bold text-sm text-gray-900 cursor-pointer" onclick="UI.openProfileByUsername('${author.username}')">${author.name}</h5>
                                <p class="text-gray-800 text-[15px] mt-1 break-words">${parsedText}</p>
                            </div>
                            <span class="text-[11px] text-gray-400 mx-2 mt-1 block">${App.timeAgo(c.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
                
                setTimeout(() => container.scrollTop = container.scrollHeight, 10);
            },

            addComment: async () => {
                const text = document.getElementById('comment-input').value.trim();
                const postId = window.currentPostIdForComment;
                if(!text || !postId) return;
                
                document.getElementById('comment-input').value = '';
                
                await addDoc(collection(db, COMMENTS_PATH), {
                    postId: postId,
                    authorId: currentUser.uid,
                    text: text,
                    timestamp: Date.now()
                });

                const post = Memory.posts.find(p => p.id === postId);
                if(post && post.authorId !== currentUser.uid && !App.isBlocked(post.authorId)) {
                    App.sendNotification(post.authorId, 'علق على منشورك', postId);
                }

                App.notifyMentions(text, 'تعليق', postId);
            },

            // --- الملاحظات (المطلب 1 و 2 و 9) ---
            renderNotes: () => {
                const container = document.getElementById('notes-container');
                const myBtnContainer = container.firstElementChild.outerHTML;
                container.innerHTML = myBtnContainer;

                const sortedNotes = [...Memory.notes].sort((a,b) => b.timestamp - a.timestamp);
                const visibleNotes = sortedNotes.filter(n => App.isFriend(currentUser.uid, n.authorId) && !App.isBlocked(n.authorId));
                
                const myActiveNote = sortedNotes.find(n => n.authorId === currentUser.uid);
                
                const myBtnEl = container.firstElementChild;
                const myAvatar = myBtnEl.querySelector('#current-user-avatar-note');
                const myPlusIcon = myBtnEl.querySelector('#my-note-plus-icon');
                const myTextCont = myBtnEl.querySelector('#my-note-text-container');
                
                if(myActiveNote) {
                    myTextCont.innerText = myActiveNote.text;
                    myTextCont.classList.replace('bg-gray-100', 'bg-gray-800');
                    myTextCont.classList.replace('text-gray-500', 'text-white');
                    myAvatar.classList.replace('border-transparent', 'border-gray-800');
                    myPlusIcon.classList.add('hidden');
                    myBtnEl.onclick = () => App.openManageNote(myActiveNote.id, myActiveNote.text);
                } else {
                    myAvatar.src = currentUser.photo || App.getDefaultAvatar();
                    myPlusIcon.classList.remove('hidden');
                }

                visibleNotes.forEach(note => {
                    const author = Memory.users[note.authorId];
                    if(!author) return;

                    const el = document.createElement('div');
                    el.className = 'inline-flex flex-col items-center cursor-pointer shrink-0 btn-tap w-20';
                    el.style.scrollSnapAlign = 'start';
                    
                    const shortName = author.name.split(' ')[0];
                    
                    el.innerHTML = `
                        <img src="${author.photo || App.getDefaultAvatar()}" class="w-16 h-16 rounded-full object-cover border-2 border-transparent ring-2 ring-blue-500 p-0.5 shadow-sm">
                        <span class="text-[11px] font-bold mt-1 text-gray-800 w-full text-center truncate">${shortName}</span>
                        <div class="bg-gray-100 text-gray-700 text-[10px] px-2 py-1.5 rounded-lg mt-1 w-full text-center truncate border border-gray-200 shadow-sm leading-tight">
                            ${escapeHTML(note.text)}
                        </div>
                    `;
                    el.onclick = () => {
                        App.viewNoteFull(note, author);
                    };
                    container.appendChild(el);
                });
            },
            
            viewNoteFull: (note, author) => {
                document.getElementById('nv-avatar').src = author.photo || App.getDefaultAvatar();
                document.getElementById('nv-name').innerText = author.name;
                document.getElementById('nv-time').innerText = App.timeAgo(note.timestamp);
                document.getElementById('nv-text').innerHTML = App.parseMentions(note.text);
                UI.openModal('note-view-modal');
            },

            checkAndCreateNote: () => {
                const myActiveNote = Memory.notes.find(n => n.authorId === currentUser.uid);
                if(myActiveNote) {
                    App.openManageNote(myActiveNote.id, myActiveNote.text);
                } else {
                    UI.openModal('create-note-modal');
                }
            },

            createNote: async () => {
                const text = document.getElementById('note-text-input').value.trim();
                if(!text) return UI.showMessage('اكتب شيئاً');
                
                UI.closeModal('create-note-modal');
                
                await addDoc(collection(db, NOTES_PATH), {
                    authorId: currentUser.uid,
                    text: text,
                    timestamp: Date.now()
                });
                
                App.notifyMentions(text, 'ملاحظة', null);
                UI.showMessage('تمت الإضافة (صالحة لـ 24 ساعة)');
            },

            openManageNote: (id, currentText) => {
                window.currentManageNoteId = id;
                document.getElementById('edit-note-input').value = currentText;
                UI.openModal('manage-note-modal');
            },

            updateNote: async () => {
                const newText = document.getElementById('edit-note-input').value.trim();
                if(!newText || !window.currentManageNoteId) return;
                await updateDoc(doc(db, NOTES_PATH, window.currentManageNoteId), { text: newText });
                App.notifyMentions(newText, 'ملاحظة', null);
                UI.closeModal('manage-note-modal');
                UI.showMessage('تم تحديث الملاحظة');
            },

            deleteNote: async () => {
                if(!window.currentManageNoteId) return;
                await deleteDoc(doc(db, NOTES_PATH, window.currentManageNoteId));
                window.currentManageNoteId = null;
                UI.closeModal('manage-note-modal');
                UI.showMessage('تم حذف الملاحظة');
                
                const container = document.getElementById('notes-container');
                const myBtnEl = container.firstElementChild;
                const myTextCont = myBtnEl.querySelector('#my-note-text-container');
                const myAvatar = myBtnEl.querySelector('#current-user-avatar-note');
                const myPlusIcon = myBtnEl.querySelector('#my-note-plus-icon');
                
                myTextCont.innerText = 'إضافة ملاحظة';
                myTextCont.classList.replace('text-white', 'text-gray-500');
                myTextCont.classList.replace('bg-gray-800', 'bg-gray-100');
                myAvatar.classList.replace('border-gray-800', 'border-transparent');
                myPlusIcon.classList.remove('hidden');
                myBtnEl.onclick = App.checkAndCreateNote;
            },


            // --- البحث ---
            searchUsers: () => {
                const query = document.getElementById('search-input').value.toLowerCase().trim();
                const container = document.getElementById('search-results');
                container.innerHTML = '';

                if(!query) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50 block mx-auto"></i>اكتب للبحث عن مستخدمين</div>';
                    return;
                }

                const results = Object.values(Memory.users).filter(u => 
                    u.uid !== currentUser.uid && 
                    !App.isBlocked(u.uid) &&
                    (u.name.toLowerCase().includes(query) || u.username.toLowerCase().includes(query))
                );

                if(results.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10">لا توجد نتائج</div>';
                    return;
                }

                results.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-2xl cursor-pointer btn-tap border border-gray-100 transition-colors';
                    el.onclick = () => {
                        UI.closeModal('search-modal');
                        UI.openModal('profile-modal', u.uid);
                    };
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${u.name}</h4>
                            <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            // --- الملف الشخصي ---
            renderUserProfile: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;
                
                const isMe = uid === currentUser.uid;
                const isMyFriend = App.isFriend(currentUser.uid, uid);
                const isBlocked = App.isBlocked(uid);
                
                document.getElementById('vp-image').src = u.photo || App.getDefaultAvatar();
                document.getElementById('vp-name').innerText = u.name;
                document.getElementById('vp-username').innerText = `@${u.username}`;
                document.getElementById('vp-bio').innerText = u.bio || 'لا توجد نبذة';
                
                const userFriends = Memory.friends.filter(f => f.user1 === uid || f.user2 === uid).length;
                const userPosts = Memory.posts.filter(p => p.authorId === uid).length;
                
                let showFriendsCount = true;
                if(!isMe) {
                    if(u.friendsVisibility === 'only_me') showFriendsCount = false;
                    if(u.friendsVisibility === 'friends' && !isMyFriend) showFriendsCount = false;
                }
                
                document.getElementById('vp-friends-count').innerText = showFriendsCount ? userFriends : '-';
                document.getElementById('vp-posts-count').innerText = userPosts;

                const actionContainer = document.getElementById('vp-action-container');
                actionContainer.innerHTML = '';
                
                if(!isMe) {
                    if(isBlocked) {
                        const blockBtn = document.createElement('button');
                        blockBtn.className = 'px-4 h-10 bg-gray-200 text-gray-800 font-bold rounded-full btn-tap flex items-center gap-1.5 shadow-sm';
                        blockBtn.innerHTML = '<i class="ph-fill ph-lock-key-open"></i> إلغاء الحظر';
                        blockBtn.onclick = () => App.unblockUser(uid);
                        actionContainer.appendChild(blockBtn);
                    } else {
                        let canMessage = true;
                        if(u.messagePrivacy === 'closed') canMessage = false;
                        if(u.messagePrivacy === 'friends' && !isMyFriend) canMessage = false;

                        if(canMessage) {
                            const msgBtn = document.createElement('button');
                            msgBtn.className = 'w-10 h-10 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-full flex items-center justify-center ml-2 btn-tap transition-colors border border-gray-200';
                            msgBtn.innerHTML = '<i class="ph-fill ph-chat-circle-text text-xl"></i>';
                            msgBtn.onclick = () => {
                                UI.closeModal('profile-modal');
                                UI.openModal('chat-modal', uid);
                            };
                            actionContainer.appendChild(msgBtn);
                        }

                        if(isMyFriend) {
                            const unfriendBtn = document.createElement('button');
                            unfriendBtn.className = 'px-4 h-10 bg-gray-100 text-gray-800 font-bold rounded-full btn-tap flex items-center gap-1.5 border border-gray-200 shadow-sm';
                            unfriendBtn.innerHTML = '<i class="ph-fill ph-user-minus"></i> إزالة صديق';
                            unfriendBtn.onclick = () => App.unfriend(uid);
                            actionContainer.appendChild(unfriendBtn);
                        } else {
                            const reqSent = Memory.requests.find(r => r.from === currentUser.uid && r.to === uid);
                            const reqReceived = Memory.requests.find(r => r.from === uid && r.to === currentUser.uid);

                            if(reqSent) {
                                const cancelBtn = document.createElement('button');
                                cancelBtn.className = 'px-4 h-10 bg-gray-200 text-gray-700 font-bold rounded-full btn-tap flex items-center gap-1.5 shadow-sm';
                                cancelBtn.innerHTML = '<i class="ph-fill ph-clock"></i> تم الإرسال';
                                cancelBtn.onclick = () => App.cancelRequest(reqSent.id, uid);
                                actionContainer.appendChild(cancelBtn);
                            } else if(reqReceived) {
                                const accBtn = document.createElement('button');
                                accBtn.className = 'px-4 h-10 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full btn-tap flex items-center gap-1.5 shadow-md transition-colors';
                                accBtn.innerHTML = '<i class="ph-fill ph-check"></i> قبول الطلب';
                                accBtn.onclick = () => App.acceptRequest(reqReceived.id, uid);
                                actionContainer.appendChild(accBtn);
                            } else if (u.allowRequests !== false) {
                                const addBtn = document.createElement('button');
                                addBtn.className = 'px-4 h-10 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full btn-tap flex items-center gap-1.5 shadow-md transition-colors';
                                addBtn.innerHTML = '<i class="ph-fill ph-user-plus"></i> إضافة صديق';
                                addBtn.onclick = () => App.sendFriendRequest(uid);
                                actionContainer.appendChild(addBtn);
                            }
                        }
                    }
                } else {
                     const editBtn = document.createElement('button');
                     editBtn.className = 'px-5 h-10 bg-gray-900 text-white font-bold rounded-full btn-tap shadow-md';
                     editBtn.innerText = 'تعديل الملف';
                     editBtn.onclick = () => UI.openModal('edit-profile-modal');
                     actionContainer.appendChild(editBtn);
                }

                const postsContainer = document.getElementById('vp-posts-container');
                postsContainer.innerHTML = '';
                
                if(!isMe && (isBlocked || (u.isPrivate && !isMyFriend))) {
                    postsContainer.innerHTML = `
                        <div class="text-center py-16 text-gray-400 mt-4 bg-white rounded-2xl border border-gray-100 mx-2 shadow-sm">
                            <i class="ph-fill ph-lock-key text-5xl mb-3 text-gray-300"></i>
                            <h4 class="font-bold text-gray-700 text-lg mb-1">${isBlocked ? 'حساب محظور' : 'هذا الحساب خاص'}</h4>
                            <p class="text-sm">${isBlocked ? 'قم بإلغاء الحظر لرؤية المنشورات' : 'تابع هذا الحساب لرؤية صوره ومقاطع الفيديو الخاصة به.'}</p>
                        </div>
                    `;
                } else {
                    const userPostsArr = Memory.posts.filter(p => p.authorId === uid).sort((a,b) => b.timestamp - a.timestamp);
                    if(userPostsArr.length === 0) {
                        postsContainer.innerHTML = '<div class="text-center text-gray-400 py-10">لا توجد منشورات</div>';
                    } else {
                        userPostsArr.forEach(post => {
                            const parsedText = App.parseMentions(post.text);
                            const postEl = document.createElement('div');
                            postEl.className = 'bg-white p-4 rounded-2xl border border-gray-100 shadow-sm mx-2 mb-3 cursor-pointer btn-tap';
                            postEl.onclick = () => App.openSinglePost(post.id);
                            postEl.innerHTML = `
                                <p class="text-gray-800 text-[15px] mb-2 whitespace-pre-wrap leading-relaxed">${parsedText}</p>
                                <span class="text-xs font-semibold text-gray-400">${App.timeAgo(post.timestamp)}</span>
                            `;
                            postsContainer.appendChild(postEl);
                        });
                    }
                }
            },

            // --- نظام الصداقة والمحظورين ---
            sendFriendRequest: async (toUid) => {
                await addDoc(collection(db, REQUESTS_PATH), {
                    from: currentUser.uid,
                    to: toUid,
                    timestamp: Date.now()
                });
                App.sendNotification(toUid, 'أرسل لك طلب صداقة', null);
                UI.showMessage('تم إرسال الطلب');
                App.renderUserProfile(toUid);
            },

            cancelRequest: async (reqId, uid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                UI.showMessage('تم إلغاء الطلب');
                if(uid) App.renderUserProfile(uid);
            },

            acceptRequest: async (reqId, fromUid) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
                await addDoc(collection(db, FRIENDS_PATH), {
                    user1: currentUser.uid,
                    user2: fromUid,
                    timestamp: Date.now()
                });
                App.sendNotification(fromUid, 'وافق على طلب الصداقة', null);
                UI.showMessage('تم قبول الطلب');
                if(document.getElementById('profile-modal').classList.contains('hidden') === false){
                    App.renderUserProfile(fromUid);
                }
            },

            declineRequest: async (reqId) => {
                await deleteDoc(doc(db, REQUESTS_PATH, reqId));
            },

            unfriend: async (uid) => {
                if(confirm('هل أنت متأكد من إزالة الصداقة؟')) {
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) {
                        await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));
                        UI.showMessage('تمت إزالة الصداقة');
                        UI.closeModal('action-modal'); // إغلاقه لو مفتوح من الشات
                        if(document.getElementById('profile-modal').classList.contains('hidden') === false){
                            App.renderUserProfile(uid);
                        }
                    }
                }
            },

            blockUser: async (uid) => {
                if(confirm('هل أنت متأكد من حظر هذا المستخدم؟ لن يتمكن من رؤية منشوراتك أو مراسلتك.')) {
                    const updatedBlocks = [...(currentUser.blockedUsers || []), uid];
                    await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                    currentUser.blockedUsers = updatedBlocks;
                    
                    // حذف الصداقة إن وجدت
                    const friendship = Memory.friends.find(f => 
                        (f.user1 === currentUser.uid && f.user2 === uid) || 
                        (f.user1 === uid && f.user2 === currentUser.uid)
                    );
                    if(friendship) await deleteDoc(doc(db, FRIENDS_PATH, friendship.id));

                    UI.closeModal('action-modal');
                    UI.showMessage('تم الحظر بنجاح');
                    App.startCore(); // ريفرش للقوائم
                }
            },
            
            unblockUser: async (uid) => {
                const updatedBlocks = (currentUser.blockedUsers || []).filter(id => id !== uid);
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { blockedUsers: updatedBlocks });
                currentUser.blockedUsers = updatedBlocks;
                UI.showMessage('تم إلغاء الحظر');
                if(!document.getElementById('blocked-users-modal').classList.contains('hidden')){
                    App.renderBlockedUsers();
                }
                if(!document.getElementById('profile-modal').classList.contains('hidden')){
                    App.renderUserProfile(uid);
                }
            },

            renderBlockedUsers: () => {
                const container = document.getElementById('blocked-list-container');
                container.innerHTML = '';
                
                const blockedList = currentUser.blockedUsers || [];
                if(blockedList.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-20 mt-10"><i class="ph ph-prohibit text-4xl mb-2 opacity-50 block mx-auto"></i>لا يوجد مستخدمين محظورين</div>';
                    return;
                }

                blockedList.forEach(uid => {
                    const u = Memory.users[uid];
                    if(!u) return;
                    
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-2xl border border-gray-50 mb-2';
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200 cursor-pointer btn-tap" onclick="UI.openModal('profile-modal', '${u.uid}')">
                        <div class="flex-1 cursor-pointer" onclick="UI.openModal('profile-modal', '${u.uid}')">
                            <h4 class="font-bold text-gray-800">${u.name}</h4>
                            <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                        </div>
                        <button class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full font-bold text-sm btn-tap" onclick="App.unblockUser('${u.uid}')">إلغاء الحظر</button>
                    `;
                    container.appendChild(el);
                });
            },

            renderFriendRequests: () => {
                const container = document.getElementById('friend-requests-container');
                container.innerHTML = '';
                
                const myRequests = Memory.requests.filter(r => r.to === currentUser.uid);
                
                if(myRequests.length > 0) {
                    document.getElementById('badge-requests').classList.remove('hidden');
                } else {
                    document.getElementById('badge-requests').classList.add('hidden');
                    container.innerHTML = '<div class="text-center text-gray-400 py-6 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">لا توجد طلبات جديدة</div>';
                    return;
                }

                myRequests.forEach(req => {
                    const fromUser = Memory.users[req.from];
                    if(!fromUser || App.isBlocked(fromUser.uid)) return;

                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-2xl border border-gray-100';
                    el.innerHTML = `
                        <div class="flex items-center gap-3 cursor-pointer group btn-tap" onclick="UI.openModal('profile-modal', '${fromUser.uid}')">
                            <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                            <div class="flex flex-col">
                                <span class="font-bold text-sm text-gray-800 group-hover:text-blue-600 truncate max-w-[120px] transition-colors">${fromUser.name}</span>
                                <span class="text-xs text-gray-500">${App.timeAgo(req.timestamp)}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.acceptRequest('${req.id}', '${req.from}')" class="bg-blue-600 hover:bg-blue-700 text-white w-9 h-9 rounded-full flex items-center justify-center btn-tap shadow-md transition-colors"><i class="ph-fill ph-check text-lg"></i></button>
                            <button onclick="App.declineRequest('${req.id}')" class="bg-gray-200 hover:bg-gray-300 text-gray-600 w-9 h-9 rounded-full flex items-center justify-center btn-tap transition-colors"><i class="ph-fill ph-x text-lg"></i></button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            renderFriendsList: () => {
                const container = document.getElementById('friends-list-container');
                container.innerHTML = '';
                
                const myFriendsRelations = Memory.friends.filter(f => f.user1 === currentUser.uid || f.user2 === currentUser.uid);
                const myFriends = myFriendsRelations.map(f => {
                    const friendId = f.user1 === currentUser.uid ? f.user2 : f.user1;
                    return Memory.users[friendId];
                }).filter(u => u !== undefined && !App.isBlocked(u.uid));

                if(myFriends.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-20 mt-10"><i class="ph ph-users text-4xl mb-2 opacity-50 block mx-auto"></i>ليس لديك أصدقاء حالياً</div>';
                    return;
                }

                myFriends.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-2xl cursor-pointer btn-tap border border-gray-50 mb-2 transition-colors';
                    el.onclick = () => {
                        UI.closeModal('friends-list-modal');
                        UI.openModal('profile-modal', u.uid);
                    };
                    el.innerHTML = `
                        <img src="${u.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${u.name}</h4>
                            <p class="text-xs text-gray-500 font-medium">@${u.username}</p>
                        </div>
                        <button class="w-8 h-8 rounded-full bg-white border shadow-sm flex items-center justify-center text-gray-500"><i class="ph ph-caret-left"></i></button>
                    `;
                    container.appendChild(el);
                });
            },

            // --- نظام الرسائل والمحادثات ---
            showChatOptions: (otherUid) => {
                const isMyFriend = App.isFriend(currentUser.uid, otherUid);
                const content = document.getElementById('action-modal-content');
                
                content.innerHTML = `
                    <div class="text-center font-bold text-lg mb-4 text-gray-800 border-b pb-2">خيارات المحادثة</div>
                    ${isMyFriend ? `
                    <button onclick="App.unfriend('${otherUid}')" class="w-full bg-gray-50 text-gray-700 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-gray-100 mb-2">
                        <i class="ph-fill ph-user-minus text-xl"></i> إزالة من الأصدقاء
                    </button>
                    ` : ''}
                    <button onclick="App.blockUser('${otherUid}')" class="w-full bg-orange-50 text-orange-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-orange-100 mb-2">
                        <i class="ph-fill ph-prohibit text-xl"></i> حظر المستخدم
                    </button>
                    <button onclick="App.deleteChatHistory('${otherUid}')" class="w-full bg-red-50 text-red-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-red-100">
                        <i class="ph-fill ph-trash text-xl"></i> حذف المحادثة
                    </button>
                `;
                UI.openModal('action-modal');
            },

            deleteChatHistory: async (otherUid) => {
                if(confirm('هل أنت متأكد من حذف هذه المحادثة بالكامل؟')) {
                    const msgsToDelete = Memory.messages.filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid));
                    for(let msg of msgsToDelete) {
                        await deleteDoc(doc(db, MESSAGES_PATH, msg.id));
                    }
                    UI.closeModal('action-modal');
                    UI.showMessage('تم حذف المحادثة');
                }
            },

            renderChats: () => {
                const container = document.getElementById('chats-container');
                container.innerHTML = '';
                
                const chatUsers = {};
                Memory.messages.forEach(msg => {
                    if(msg.participants.includes(currentUser.uid)) {
                        const otherUid = msg.participants.find(id => id !== currentUser.uid);
                        if(App.isBlocked(otherUid)) return; // المطلب 7: اخفاء شات المحظورين
                        
                        if(!chatUsers[otherUid] || chatUsers[otherUid].timestamp < msg.timestamp) {
                            chatUsers[otherUid] = msg;
                        }
                    }
                });

                const sortedChats = Object.entries(chatUsers).sort((a,b) => b[1].timestamp - a[1].timestamp);
                let unread = false;

                if(sortedChats.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-chat-circle-dots text-4xl mb-2 opacity-50 block mx-auto"></i>لا توجد رسائل بعد</div>';
                    return;
                }

                sortedChats.forEach(([otherUid, lastMsg]) => {
                    const u = Memory.users[otherUid];
                    if(!u) return;

                    const isUnread = lastMsg.senderId !== currentUser.uid && !lastMsg.read; // المطلب 10
                    if(isUnread) unread = true;
                    const isOnline = App.isOnline(u.lastActive);

                    const el = document.createElement('div');
                    el.className = `flex items-center gap-3 p-3 border-b border-gray-50 cursor-pointer btn-tap transition-colors ${isUnread ? 'bg-blue-50/30' : 'hover:bg-gray-50'}`;
                    
                    // المطلب 8: الضغط المطول للشات
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showChatOptions(u.uid), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);

                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = () => {
                        if(pressTimer) clearTimeout(pressTimer);
                        UI.openModal('chat-modal', u.uid);
                    };

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${u.photo || App.getDefaultAvatar()}" class="w-14 h-14 rounded-full object-cover border border-gray-100">
                            ${isOnline ? '<span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                        </div>
                        <div class="flex-1 overflow-hidden pr-1">
                            <div class="flex justify-between items-center mb-0.5">
                                <h4 class="font-bold truncate text-[15px] ${isUnread ? 'text-black' : 'text-gray-800'}">${u.name}</h4>
                                <span class="text-xs ${isUnread ? 'font-bold text-blue-600' : 'text-gray-400'} whitespace-nowrap">${App.timeAgo(lastMsg.timestamp)}</span>
                            </div>
                            <p class="text-sm truncate ${isUnread ? 'text-unread' : (lastMsg.senderId !== currentUser.uid ? 'font-medium text-gray-800' : 'text-gray-500')}">
                                ${lastMsg.senderId === currentUser.uid ? 'أنت: ' : ''}${lastMsg.text}
                            </p>
                        </div>
                    `;
                    container.appendChild(el);
                });

                if(unread) document.getElementById('badge-messages').classList.remove('hidden');
                else document.getElementById('badge-messages').classList.add('hidden');
            },

            markChatAsRead: async (otherUid) => {
                const unreadMsgs = Memory.messages.filter(m => 
                    m.participants.includes(currentUser.uid) && 
                    m.participants.includes(otherUid) &&
                    m.senderId === otherUid && 
                    !m.read
                );
                
                for(let msg of unreadMsgs) {
                    await updateDoc(doc(db, MESSAGES_PATH, msg.id), { read: true });
                }
            },

            renderChatInfo: (uid) => {
                const u = Memory.users[uid];
                if(!u) return;
                document.getElementById('chat-user-img').src = u.photo || App.getDefaultAvatar();
                document.getElementById('chat-user-name').innerText = u.name;
                
                const isOnline = App.isOnline(u.lastActive);
                document.getElementById('chat-online-dot').style.display = isOnline ? 'block' : 'none';
                document.getElementById('chat-user-status').innerText = isOnline ? 'نشط الآن' : `آخر ظهور ${App.timeAgo(u.lastActive)}`;
            },

            renderMessages: () => {
                const otherUid = window.currentChatUserId;
                if(!otherUid) return;

                const container = document.getElementById('chat-messages-container');
                container.innerHTML = '';

                const msgs = Memory.messages
                    .filter(m => m.participants.includes(currentUser.uid) && m.participants.includes(otherUid))
                    .sort((a,b) => a.timestamp - b.timestamp);

                if(msgs.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-auto">بدء محادثة جديدة 👋</div>';
                    return;
                }

                msgs.forEach(m => {
                    const isMe = m.senderId === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `max-w-[80%] rounded-2xl p-3 shadow-sm ${isMe ? 'bg-blue-600 text-white self-end rounded-br-sm' : 'bg-white border border-gray-100 text-gray-800 self-start rounded-bl-sm'}`;
                    el.innerHTML = `
                        <p class="text-[15px] break-words leading-relaxed">${m.text}</p>
                        <span class="text-[10px] mt-1.5 flex justify-end items-center gap-1 font-medium ${isMe ? 'text-blue-200' : 'text-gray-400'}">
                            ${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            ${isMe ? (m.read ? '<i class="ph-fill ph-checks text-white/80"></i>' : '<i class="ph ph-check"></i>') : ''}
                        </span>
                    `;
                    container.appendChild(el);
                });

                container.scrollTop = container.scrollHeight;
            },

            sendMessage: async () => {
                const otherUid = window.currentChatUserId;
                const text = document.getElementById('chat-input').value.trim();
                if(!text || !otherUid) return;

                const inputEl = document.getElementById('chat-input');
                inputEl.value = '';
                inputEl.style.height = ''; 
                
                await addDoc(collection(db, MESSAGES_PATH), {
                    participants: [currentUser.uid, otherUid],
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: Date.now(),
                    read: false // المطلب 10
                });
                
                App.renderMessages();
            },

            // --- الإشعارات ---
            sendNotification: async (toUid, text, linkId) => {
                if(toUid === currentUser.uid) return;
                await addDoc(collection(db, NOTIFS_PATH), {
                    to: toUid,
                    from: currentUser.uid,
                    text: text,
                    linkId: linkId,
                    timestamp: Date.now(),
                    read: false // المطلب 10
                });
            },

            deleteNotification: async (notifId) => {
                await deleteDoc(doc(db, NOTIFS_PATH, notifId));
                UI.closeModal('action-modal');
                UI.showMessage('تم حذف الإشعار');
            },
            
            markNotificationRead: async (notifId) => {
                await updateDoc(doc(db, NOTIFS_PATH, notifId), { read: true });
            },

            showNotifOptions: (notifId) => {
                const content = document.getElementById('action-modal-content');
                content.innerHTML = `
                    <div class="text-center font-bold text-lg mb-4 text-gray-800 border-b pb-2">خيارات الإشعار</div>
                    <button onclick="App.deleteNotification('${notifId}')" class="w-full bg-red-50 text-red-600 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 btn-tap border border-red-100">
                        <i class="ph-fill ph-trash text-xl"></i> حذف الإشعار
                    </button>
                `;
                UI.openModal('action-modal');
            },

            renderNotifications: () => {
                const container = document.getElementById('notifications-container');
                container.innerHTML = '';
                
                const notifs = [...Memory.notifications].sort((a,b) => b.timestamp - a.timestamp);
                const unreadExists = notifs.some(n => !n.read && !App.isBlocked(n.from));
                
                if(notifs.length > 0 && unreadExists) {
                    document.getElementById('badge-notifications').classList.remove('hidden');
                } else {
                    document.getElementById('badge-notifications').classList.add('hidden');
                }
                
                if(notifs.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 mt-10"><i class="ph ph-bell-ringing text-4xl mb-2 opacity-50 block mx-auto"></i>لا توجد إشعارات</div>';
                    return;
                }

                notifs.forEach(n => {
                    const fromUser = Memory.users[n.from];
                    if(!fromUser || App.isBlocked(n.from)) return; // المطلب 7

                    const el = document.createElement('div');
                    const isUnread = !n.read;
                    // المطلب 10: خط غامق للإشعار غير المقروء
                    el.className = `flex items-center gap-3 p-3.5 border-b border-gray-50 cursor-pointer transition-colors btn-tap ${isUnread ? 'bg-blue-50/30' : 'hover:bg-gray-50'}`;
                    
                    let pressTimer;
                    const startPress = () => { pressTimer = setTimeout(() => App.showNotifOptions(n.id), 600); };
                    const cancelPress = () => clearTimeout(pressTimer);

                    el.addEventListener('mousedown', startPress);
                    el.addEventListener('touchstart', startPress, {passive: true});
                    el.addEventListener('mouseup', cancelPress);
                    el.addEventListener('mouseleave', cancelPress);
                    el.addEventListener('touchend', cancelPress);
                    el.addEventListener('touchmove', cancelPress);

                    el.onclick = (e) => {
                        if(pressTimer) clearTimeout(pressTimer);
                        if(isUnread) App.markNotificationRead(n.id);
                        if(n.linkId) UI.openModal('comments-modal', n.linkId);
                        else UI.openModal('profile-modal', n.from);
                    };

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${fromUser.photo || App.getDefaultAvatar()}" class="w-12 h-12 rounded-full object-cover border border-gray-100">
                            ${isUnread ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-600 rounded-full border-2 border-white"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <p class="text-[15px] leading-tight ${isUnread ? 'text-unread' : 'text-gray-800'}"><span class="font-bold">${fromUser.name}</span> ${n.text}</p>
                            <span class="text-xs font-semibold ${isUnread ? 'text-blue-600' : 'text-gray-400'} mt-1 block">${App.timeAgo(n.timestamp)}</span>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            // --- الإعدادات وتعديل الملف ---
            handleEditImage: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 300; canvas.height = 300;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 300, 300);
                        const b64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('edit-profile-img').src = b64;
                        window.tempEditPhoto = b64;
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },

            saveProfile: async () => {
                const name = document.getElementById('edit-name').value.trim();
                const usernameInput = document.getElementById('edit-username');
                const username = usernameInput.value.trim();
                const bio = document.getElementById('edit-bio').value.trim();
                
                if(!name || (!username && !usernameInput.disabled)) return UI.showMessage('الاسم والمعرف مطلوبان');

                const updates = { name, bio };

                if(!usernameInput.disabled && username !== currentUser.username) {
                    const tenDaysInMs = 10 * 24 * 60 * 60 * 1000;
                    const lastChange = currentUser.lastUsernameChange || 0;
                    
                    if (Date.now() - lastChange < tenDaysInMs) {
                        return UI.showMessage('عذراً، يمكنك تغيير المعرف مرة واحدة فقط كل 10 أيام');
                    }

                    const isTaken = Object.values(Memory.users).some(u => u.username === username && u.uid !== currentUser.uid);
                    if(isTaken) return UI.showMessage('المعرف مستخدم من قبل شخص آخر، يرجى اختيار معرف مختلف');

                    updates.username = username;
                    updates.lastUsernameChange = Date.now();
                }

                if(window.tempEditPhoto) updates.photo = window.tempEditPhoto;

                await updateDoc(doc(db, USERS_PATH, currentUser.uid), updates);
                
                Object.assign(currentUser, updates);
                window.tempEditPhoto = null;
                App.updateUIWithUserData();
                UI.closeModal('edit-profile-modal');
                UI.showMessage('تم حفظ التغييرات');
            },

            updatePrivacy: async (key, value) => {
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { [key]: value });
                currentUser[key] = value;
                UI.showMessage('تم تحديث الخصوصية');
            }
        };

        window.onload = () => {
            Auth.init();
        };

    </script>
</body>
</html>